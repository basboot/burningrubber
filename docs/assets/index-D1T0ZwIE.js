var Ad=Object.defineProperty;var Sd=(r,t,e)=>t in r?Ad(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var bt=(r,t,e)=>Sd(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Ed={851:(r,t,e)=>{e.d(t,{A:()=>h});var s=e(1),i=e.n(s),n=e(935),o=e.n(n),a=o()(i());a.push([r.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const h=a},296:(r,t,e)=>{e.d(t,{A:()=>h});var s=e(1),i=e.n(s),n=e(935),o=e.n(n),a=o()(i());a.push([r.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const h=a},935:r=>{r.exports=function(t){var e=[];return e.toString=function(){return this.map(function(i){var n="",o=typeof i[5]<"u";return i[4]&&(n+="@supports (".concat(i[4],") {")),i[2]&&(n+="@media ".concat(i[2]," {")),o&&(n+="@layer".concat(i[5].length>0?" ".concat(i[5]):""," {")),n+=t(i),o&&(n+="}"),i[2]&&(n+="}"),i[4]&&(n+="}"),n}).join("")},e.i=function(i,n,o,a,h){typeof i=="string"&&(i=[[null,i,void 0]]);var l={};if(o)for(var c=0;c<this.length;c++){var u=this[c][0];u!=null&&(l[u]=!0)}for(var d=0;d<i.length;d++){var f=[].concat(i[d]);o&&l[f[0]]||(typeof h<"u"&&(typeof f[5]>"u"||(f[1]="@layer".concat(f[5].length>0?" ".concat(f[5]):""," {").concat(f[1],"}")),f[5]=h),n&&(f[2]&&(f[1]="@media ".concat(f[2]," {").concat(f[1],"}")),f[2]=n),a&&(f[4]?(f[1]="@supports (".concat(f[4],") {").concat(f[1],"}"),f[4]=a):f[4]="".concat(a)),e.push(f))}},e}},1:r=>{r.exports=function(t){var e=t[1],s=t[3];if(!s)return e;if(typeof btoa=="function"){var i=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),n="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(i),o="/*# ".concat(n," */");return[e].concat([o]).join(`
`)}return[e].join(`
`)}}},Qh={};function Zt(r){var t=Qh[r];if(t!==void 0)return t.exports;var e=Qh[r]={id:r,exports:{}};return Ed[r](e,e.exports,Zt),e.exports}Zt.n=r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return Zt.d(t,{a:t}),t};Zt.d=(r,t)=>{for(var e in t)Zt.o(t,e)&&!Zt.o(r,e)&&Object.defineProperty(r,e,{enumerable:!0,get:t[e]})};Zt.o=(r,t)=>Object.prototype.hasOwnProperty.call(r,t);Zt.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})};var m={};Zt.d(m,{eKr:()=>Va,yVm:()=>Un,a7j:()=>Xl,U_w:()=>lh,JF2:()=>za,htg:()=>Ri,HXL:()=>ih,mcg:()=>Fa,Agj:()=>fe,J3_:()=>Lf,Wgv:()=>Wa,u6S:()=>ff,x7M:()=>Ot,X55:()=>He,m3M:()=>pn,aE5:()=>lf,YJU:()=>ze,eZi:()=>qo,GNv:()=>mn,Y56:()=>jo,_0v:()=>Ar,vhs:()=>_r,vrQ:()=>Ln,Z8b:()=>pc,Yfw:()=>it,IcQ:()=>z,kgJ:()=>$o,GTT:()=>Yc,ypY:()=>Cn,i7d:()=>Mc,fQ3:()=>Vf,HlI:()=>Hr,jlt:()=>Gr,VQc:()=>ne,zD7:()=>ah,AUF:()=>as,JoF:()=>js,MlA:()=>Nt,PZh:()=>ti,qA:()=>gn,CrD:()=>Ts,dQK:()=>os,D3r:()=>Ye,Qpo:()=>br,D9n:()=>yr,b6v:()=>_n,mvh:()=>$r,Bpo:()=>X,Q1f:()=>k,IKv:()=>Xc,fcV:()=>ri,Glf:()=>Gc,uAl:()=>Ue,ElT:()=>$t,Z8r:()=>pa,QSL:()=>Nc,sPV:()=>xr,nAn:()=>As,zCU:()=>wr,QrV:()=>te,fF9:()=>yp,Jqv:()=>xc,d_u:()=>wc,xI8:()=>Ba,yar:()=>jt,SP7:()=>jc,oRy:()=>jr,f5X:()=>th,V1c:()=>_a,Mlx:()=>$c,ZiM:()=>Zo,ZCo:()=>vn,J5p:()=>Zc,mL_:()=>me,Guw:()=>gc,N5j:()=>ql,pgY:()=>mc,OP3:()=>mr,rl5:()=>tu,eod:()=>Zf,q5Z:()=>Xt,YUC:()=>Xa,saR:()=>Tr,hvr:()=>Qo,Qol:()=>fc,Wf4:()=>dc,JCs:()=>ut,gJV:()=>Te,fWD:()=>Ec,Va_:()=>Ns,N$8:()=>ge,_jQ:()=>Qf,rxj:()=>La,rhv:()=>Na,wCu:()=>oe,HAp:()=>mf,Zy1:()=>Dc,bkB:()=>yt,wfL:()=>vr,sVA:()=>da,$Gs:()=>qa,CJ0:()=>Cr,NWh:()=>xs,tWi:()=>Ua,xAj:()=>Oa,zWh:()=>_c,i_4:()=>xp,iIx:()=>Jt,Hxo:()=>vc,c9e:()=>Wo,KQV:()=>ci,weH:()=>ht,jXp:()=>vp,zzY:()=>gr,yRQ:()=>fr,MtE:()=>Qc,rPj:()=>An,KLc:()=>De,Fir:()=>J,V5f:()=>xa,Xj7:()=>ya,Wud:()=>or,FVg:()=>Ra,g5Y:()=>Ma,YQB:()=>Pa,KPb:()=>Ia,nHK:()=>Qr,Jrb:()=>iu,TX_:()=>gp,Olt:()=>ou,r3n:()=>Ni,Fvk:()=>ep,gpR:()=>Sr,vYh:()=>Pt,hnk:()=>It,D2R:()=>Bi,n1o:()=>Ka,h9O:()=>Lc,X5j:()=>ns,p3P:()=>eh,RLG:()=>ka,fBU:()=>Ya,Adb:()=>Lt,bEs:()=>rs,wCy:()=>ot,CbD:()=>vt,x_C:()=>tn,pGf:()=>oh,ibQ:()=>zc,shR:()=>bn,Yjk:()=>nh,_u1:()=>sp,OBI:()=>nu,klh:()=>un,s3S:()=>Wc,D$R:()=>Tn,xth:()=>Vr,JU7:()=>Jf,h9x:()=>Ic,N1A:()=>ch,e_k:()=>kt,aHM:()=>fi,tlv:()=>Ef,Vi9:()=>Sc,ieR:()=>Ac,$bb:()=>Vt,VyI:()=>V,imn:()=>Ll,uqu:()=>Ce,QnL:()=>Ro,vnc:()=>Ga,wk_:()=>Ho,GH0:()=>at,_1r:()=>Yr,l0X:()=>zo,bT:()=>Kl,HHX:()=>Vo,jtW:()=>ec,tjk:()=>Fs,rWe:()=>Ks,j9l:()=>Wl,l0$:()=>dh,sGJ:()=>vs,NVp:()=>$a,cPK:()=>ue,XoL:()=>rh,RmF:()=>de,DXI:()=>Xr,tCD:()=>ip,J3D:()=>Wr,vCJ:()=>Kf,e6k:()=>zl,f9l:()=>Qe,v9m:()=>Kr,yRJ:()=>Uc,EU6:()=>Yo,m3O:()=>gs,Ryz:()=>Ws,OxP:()=>dn,LEs:()=>Jr,Ec:()=>li,Pi5:()=>Zr,gmH:()=>ms,tS:()=>uh,XxX:()=>Kt,bCz:()=>zr,nYS:()=>di,yiT:()=>Aa,NHl:()=>Ki,mO8:()=>Ea,PXI:()=>wa,bn5:()=>Ca,Ywr:()=>Xs,cMd:()=>ui,Bs6:()=>Ta,G0k:()=>Ji,pyn:()=>Sa,QeM:()=>va,aPX:()=>Xf,ITP:()=>ba,BY0:()=>Gs,MFw:()=>Bn,sBn:()=>kn,S3L:()=>Ti,XKQ:()=>xn,ESI:()=>kc,uxz:()=>Pc,o8N:()=>Yi,u_r:()=>Qi,RlV:()=>ei,gVA:()=>Go,M_G:()=>On,BpG:()=>Ha,GRB:()=>_f,kM6:()=>jl,dO8:()=>Yl,jgM:()=>Oo,FWq:()=>Rn,s3j:()=>Bd,hlw:()=>rc,L0q:()=>nc,B7e:()=>ic,PGN:()=>sc,H_X:()=>Et,S_d:()=>uc,_Tq:()=>cc,U7E:()=>hc,IOH:()=>ac,Z58:()=>Ie,yh2:()=>jf,ff$:()=>No,cWi:()=>Pl,NBt:()=>Qa,oNz:()=>Cf,QlU:()=>qc,Xey:()=>Os,jft:()=>Sp,_r8:()=>Bt,bTC:()=>Gl,Mtr:()=>ye,ypk:()=>re,mnM:()=>lt,q7S:()=>bp,bAZ:()=>wn,ABN:()=>Hl,VK6:()=>Sf,Hj2:()=>sh,Df8:()=>Xo,oOx:()=>Oi,kxk:()=>je,DT1:()=>Ur,FLG:()=>si,qN_:()=>hh,Z37:()=>qr,FtL:()=>Tc,Z6X:()=>ru,iQT:()=>ke,ziO:()=>Bc,OEF:()=>us,uuE:()=>Ee,tiv:()=>yn,T$Y:()=>Jc,EYj:()=>Fn,nOB:()=>pr,Tap:()=>At,FAs:()=>Cc,B_P:()=>bc,aA5:()=>zf,J3s:()=>fh,Y0Q:()=>Dn,M4G:()=>ni,l$l:()=>Kc,dLy:()=>Cs,WZP:()=>N,eB6:()=>to,nFK:()=>Uo,l9z:()=>Rc,YOF:()=>Wf,yhB:()=>Ht,J0N:()=>fa,Miz:()=>T,Bj4:()=>ko,Rcs:()=>ls,vJ4:()=>Es,TqC:()=>ja,nM0:()=>Da,X1u:()=>ii,SpZ:()=>Vl,DX8:()=>Di,Yx$:()=>Hc,HK4:()=>Oc,yt5:()=>Sl,vAR:()=>tp,SE$:()=>ws,qE8:()=>tt,Pz7:()=>au,sX_:()=>hi,JuI:()=>Pd,pxT:()=>ys,Nl$:()=>ma,zDr:()=>dp,OwT:()=>ap,P$G:()=>up,mHV:()=>lp,kEA:()=>fp,Fx_:()=>_p,WFC:()=>pp,vKu:()=>rp,aDq:()=>np,jIg:()=>cp,UH3:()=>hp,AJO:()=>op,U4:()=>Zl,xAc:()=>Ql,_3Y:()=>Nf,K6X:()=>pf,C1Y:()=>Ul,Aw1:()=>Lo,tm8:()=>Jl,LBV:()=>tc,A8$:()=>gf,F5e:()=>Of,ran:()=>Bf,c8L:()=>lc,o6M:()=>oc,hsx:()=>ss,l9E:()=>yc,aSf:()=>Fc,CcK:()=>$l,nU8:()=>Za,td6:()=>Nn,Zex:()=>hu,bkJ:()=>ct,mXP:()=>Tp,vt$:()=>Zi,hCA:()=>Ze,pjR:()=>$,U43:()=>is,pSZ:()=>Rd,y17:()=>Md,Ew7:()=>cs,hG1:()=>Ff,jVr:()=>Cp,_SZ:()=>_t,xWn:()=>El,ehJ:()=>Id,t6s:()=>E,Eyn:()=>ca});var ca={};Zt.r(ca);Zt.d(ca,{getAttributeComponentSize:()=>Ol,getAttributePointerType:()=>Nl,getGLTypeFromSource:()=>Bl,getGlTypeSizeBytes:()=>Do,getMaxShaderComplexity:()=>ga,isAttributeInSource:()=>Fl});var ua={};Zt.r(ua);Zt.d(ua,{circle:()=>df,line:()=>Fo,point:()=>cf,roundRect:()=>Bo,vector:()=>uf});var da={};Zt.r(da);Zt.d(da,{ActionCompleteEvent:()=>Va,ActionStartEvent:()=>za,ActivateEvent:()=>Fa,AddEvent:()=>Wa,CollisionEndEvent:()=>gn,CollisionPostSolveEvent:()=>br,CollisionPreSolveEvent:()=>yr,CollisionStartEvent:()=>_n,ContactEndEvent:()=>xr,ContactStartEvent:()=>wr,DeactivateEvent:()=>Ba,EnterTriggerEvent:()=>La,EnterViewPortEvent:()=>Na,EventTypes:()=>vr,ExitTriggerEvent:()=>Ua,ExitViewPortEvent:()=>Oa,GameEvent:()=>J,GameStartEvent:()=>xa,GameStopEvent:()=>ya,GamepadAxisEvent:()=>Ra,GamepadButtonEvent:()=>Ma,GamepadConnectEvent:()=>Pa,GamepadDisconnectEvent:()=>Ia,HiddenEvent:()=>ka,InitializeEvent:()=>tn,KillEvent:()=>Vr,PostCollisionEvent:()=>di,PostDebugDrawEvent:()=>Aa,PostDrawEvent:()=>Ki,PostFrameEvent:()=>Ea,PostKillEvent:()=>wa,PostTransformDrawEvent:()=>Ca,PostUpdateEvent:()=>Xs,PreCollisionEvent:()=>ui,PreDebugDrawEvent:()=>Ta,PreDrawEvent:()=>Ji,PreFrameEvent:()=>Sa,PreKillEvent:()=>va,PreTransformDrawEvent:()=>ba,PreUpdateEvent:()=>Gs,RemoveEvent:()=>Ha,VisibleEvent:()=>Da});var fa={};Zt.r(fa);Zt.d(fa,{ConsoleAppender:()=>pa,DrawUtil:()=>ua,EasingFunctions:()=>ut,LogLevel:()=>Vt,Logger:()=>V,Observable:()=>ue,ScreenAppender:()=>Pl,addItemToArray:()=>Dd,contains:()=>Il,delay:()=>ur,fail:()=>Ml,getPosition:()=>cn,isObject:()=>rr,mergeDeep:()=>dr,omit:()=>Rl,removeItemFromArray:()=>$i});function Al(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(r){window.setInterval(r,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(e){return new Promise((s,i)=>{t.call(this,e,s,i)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(r){const t=Date.now();return setTimeout(function(){r({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(r){clearTimeout(r)})}class Jt{static useCanvasGraphicsContext(){Jt.enable("use-canvas-context")}static useLegacyImageRenderer(){Jt.enable("use-legacy-image-renderer")}static freeze(){Jt._FROZEN=!0}static _reset(){Jt._FROZEN=!1,Jt._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Jt._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Jt._FLAGS[t]=!1}static isEnabled(t){return!!Jt._FLAGS[t]}static show(){return Object.keys(Jt._FLAGS)}}Jt._FROZEN=!1;Jt._FLAGS={};function hi(r,t){return{type:r,value:t}}class De{constructor(){this._isCompleted=!1,this.promise=new Promise((t,e)=>{this._resolver=t,this._rejecter=e})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class yt{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,e){var s;return this._empty=!1,this._listeners[t]=(s=this._listeners[t])!==null&&s!==void 0?s:[],this._listeners[t].push(e),{close:()=>this.off(t,e)}}once(t,e){var s;return this._empty=!1,this._listenersOnce[t]=(s=this._listenersOnce[t])!==null&&s!==void 0?s:[],this._listenersOnce[t].push(e),{close:()=>this.off(t,e)}}off(t,e){var s,i;if(e){const n=(s=this._listeners[t])===null||s===void 0?void 0:s.filter(a=>a!==e);this._listeners[t]=n;const o=(i=this._listenersOnce[t])===null||i===void 0?void 0:i.filter(a=>a!==e);this._listenersOnce[t]=o}else delete this._listeners[t]}emit(t,e){if(this._empty||this._paused)return;const s=this._listeners[t];if(s)for(let n=0;n<s.length;n++)s[n](e);const i=this._listenersOnce[t];if(this._listenersOnce[t]=[],i)for(let n=0;n<i.length;n++)i[n](e);for(let n=0;n<this._pipes.length;n++)this._pipes[n].emit(t,e)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}}}unpipe(t){const e=this._pipes.indexOf(t);e>-1&&this._pipes.splice(e,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var li;(function(r){r.Canvas="Canvas",r.Document="Document"})(li||(li={}));var Et;(function(r){r.ShortestPath="shortest-path",r.LongestPath="longest-path",r.Clockwise="clockwise",r.CounterClockwise="counter-clockwise"})(Et||(Et={}));const Ao=4294967295;class Yi{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let e=1;e<this._n;e++){const s=this._mt[e-1]^this._mt[e-1]>>>this._w-2;this._mt[e]=(this._f*((s&4294901760)>>>16)<<16)+this._f*(s&65535)+e>>>0}this._index=this._n}_twist(){const t=[0,this._a];let e=0,s=0;for(;s<this._n-this._m;s++)e=this._mt[s]&this._upperMask|this._mt[s+1]&this._lowerMask,this._mt[s]=this._mt[s+this._m]^e>>>1^t[e&1]&Ao;for(;s<this._n-1;s++)e=this._mt[s]&this._upperMask|this._mt[s+1]&this._lowerMask,this._mt[s]=this._mt[s+(this._m-this._n)]^e>>>1^t[e&1]&Ao;e=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^e>>>1^t[e&1]&Ao,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,e){return(e-t)*this.next()+t}integer(t,e){return Math.floor((e-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,e,s=!1){return s?this._pickSetWithDuplicates(t,e):this._pickSetWithoutDuplicates(t,e)}_pickSetWithoutDuplicates(t,e){if(e>t.length||e<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(e===t.length)return t;const s=new Array(e);let i=0;const n=t.slice(0);for(;i<e;){const o=this.integer(0,n.length-1);s[i++]=n[o],n.splice(o,1)}return s}_pickSetWithDuplicates(t,e){if(e<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const s=new Array(e);for(let i=0;i<e;i++)s[i]=this.pickOne(t);return s}shuffle(t){const e=t.slice(0);let s;for(let i=0;i<e.length-2;i++){const n=this.integer(i,e.length-1);s=e[i],e[i]=e[n],e[n]=s}return e}range(t,e,s){const i=new Array(t);for(let n=0;n<t;n++)i[n]=this.integer(e,s);return i}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const Ht=Math.PI*2;function Pd(r){return r>=0?r-Math.floor(r):r-Math.ceil(r)}function _t(r){return r===0?0:r<0?-1:1}function tt(r,t,e){return Math.min(Math.max(t,r),e)}function Sl(r,t,e){return Math.abs(r-t)<e}function ws(r){let t=r;if(r>=Ht)for(;t>=Ht;)t-=Ht;if(r<0)for(;t<0;)t+=Ht;return t}function El(r){return 180/Math.PI*r}function Id(r){return r/180*Math.PI}const Md=(r,t)=>Array.from(new Array(t-r+1),(e,s)=>s+r);function is(r,t,e=new Yi){return e?e.floating(r,t):r+Math.random()*(t-r)}function Rd(r,t,e=new Yi){return e?e.integer(r,t):Math.round(is(r,t))}class T{static get Zero(){return new T(0,0)}static get One(){return new T(1,1)}static get Half(){return new T(.5,.5)}static get Up(){return new T(0,-1)}static get Down(){return new T(0,1)}static get Left(){return new T(-1,0)}static get Right(){return new T(1,0)}static fromAngle(t){return new T(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}static min(t,e){return new T(Math.min(t.x,e.x),Math.min(t.y,e.y))}static max(t,e){return new T(Math.max(t.x,e.x),Math.max(t.y,e.y))}constructor(t,e){this._x=0,this._y=0,this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,e){this.x=t,this.y=e}equals(t,e=T.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}squareDistance(t){t||(t=T.Zero);const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}clampMagnitude(t){const e=this.magnitude,s=tt(e,0,t);return this.magnitude=s,this}get size(){return this.distance()}set size(t){const e=this.normalize().scale(t);this.setTo(e.x,e.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?T.Zero:new T(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,e){const s=e||new T(0,0);return t instanceof T?(s.x=this.x*t.x,s.y=this.y*t.y):(s.x=this.x*t,s.y=this.y*t),s}add(t,e){return e?(e.x=this.x+t.x,e.y=this.y+t.y,e):new T(this.x+t.x,this.y+t.y)}sub(t,e){const s=e||new T(0,0),i=this.x-t.x,n=this.y-t.y;return s.x=i,s.y=n,s}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof T)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new T(t*this.y,-t*this.x)}static cross(t,e){return new T(-t*e.y,t*e.x)}perpendicular(){return new T(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return ws(Math.atan2(this.y,this.x))}angleBetween(t,e){const s=this.toAngle(),i=ws(t);let n=0,o=0;switch(i>s?n=i-s:n=(Ht-s+i)%Ht,o=(n-Ht)%Ht,e){case Et.ShortestPath:return Math.abs(n)<Math.abs(o)?n:o;case Et.LongestPath:return Math.abs(n)>Math.abs(o)?n:o;case Et.Clockwise:return n;case Et.CounterClockwise:return o}}rotate(t,e,s){const i=s||new T(0,0);e||(e=new T(0,0));const n=Math.sin(t),o=Math.cos(t),a=o*(this.x-e.x)-n*(this.y-e.y)+e.x,h=n*(this.x-e.x)+o*(this.y-e.y)+e.y;return i.x=a,i.y=h,i}clone(t){const e=t??new T(0,0);return e.x=this.x,e.y=this.y,e}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}T.EQUALS_EPSILON=.001;function E(r,t){return new T(r,t)}class k{constructor(t,e,s,i){this.r=t,this.g=e,this.b=s,this.a=i??1}static fromRGB(t,e,s,i){return new k(t,e,s,i)}static fromRGBString(t){const e=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let s=null;if(s=t.match(e)){const i=parseInt(s[1],10),n=parseInt(s[2],10),o=parseInt(s[3],10);let a=1;return s[4]&&(a=parseFloat(s[4])),new k(i,n,o,a)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const e=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let s=null;if(s=t.match(e)){const i=parseInt(s[1],16),n=parseInt(s[2],16),o=parseInt(s[3],16);let a=1;return s[4]&&(a=parseInt(s[4],16)/255),new k(i,n,o,a)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,e,s,i=1){return new Ve(t,e,s,i).toRGBA()}lighten(t=.1){const e=Ve.fromRGBA(this.r,this.g,this.b,this.a);return e.l+=(1-e.l)*t,e.toRGBA()}darken(t=.1){const e=Ve.fromRGBA(this.r,this.g,this.b,this.a);return e.l-=e.l*t,e.toRGBA()}saturate(t=.1){const e=Ve.fromRGBA(this.r,this.g,this.b,this.a);return e.s+=e.s*t,e.toRGBA()}desaturate(t=.1){const e=Ve.fromRGBA(this.r,this.g,this.b,this.a);return e.s-=e.s*t,e.toRGBA()}multiply(t){const e=t.r/255*this.r/255*255,s=t.g/255*this.g/255*255,i=t.b/255*this.b/255*255,n=t.a*this.a;return new k(e,s,i,n)}screen(t){const e=t.invert(),s=t.invert();return e.multiply(s).invert()}invert(){return new k(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const e=(t.r+this.r)/2,s=(t.g+this.g)/2,i=(t.b+this.b)/2,n=(t.a+this.a)/2;return new k(e,s,i,n)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const e=Math.max(Math.round(t),0).toString(16);return e.length===1?"0"+e:e}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Ve.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const e=t||new k(this.r,this.g,this.b,this.a);return e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a,e}static get Black(){return k.fromHex("#000000")}static get White(){return k.fromHex("#FFFFFF")}static get Gray(){return k.fromHex("#808080")}static get LightGray(){return k.fromHex("#D3D3D3")}static get DarkGray(){return k.fromHex("#A9A9A9")}static get Yellow(){return k.fromHex("#FFFF00")}static get Orange(){return k.fromHex("#FFA500")}static get Red(){return k.fromHex("#FF0000")}static get Vermilion(){return k.fromHex("#FF5B31")}static get Rose(){return k.fromHex("#FF007F")}static get Pink(){return k.fromHex("#FFC0CB")}static get Magenta(){return k.fromHex("#FF00FF")}static get Violet(){return k.fromHex("#7F00FF")}static get Purple(){return k.fromHex("#800080")}static get Blue(){return k.fromHex("#0000FF")}static get Azure(){return k.fromHex("#007FFF")}static get Cyan(){return k.fromHex("#00FFFF")}static get Viridian(){return k.fromHex("#59978F")}static get Teal(){return k.fromHex("#008080")}static get Green(){return k.fromHex("#00FF00")}static get Chartreuse(){return k.fromHex("#7FFF00")}static get Transparent(){return k.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return k.fromHex("#176BAA")}static get Brown(){return k.fromHex("#964B00")}}class Ve{constructor(t,e,s,i){this.h=t,this.s=e,this.l=s,this.a=i}static hue2rgb(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+(e-t)*6*s:s<1/2?e:s<2/3?t+(e-t)*(2/3-s)*6:t}static fromRGBA(t,e,s,i){t/=255,e/=255,s/=255;const n=Math.max(t,e,s),o=Math.min(t,e,s);let a,h;const l=(n+o)/2;if(n===o)a=h=0;else{const c=n-o;switch(h=l>.5?c/(2-n-o):c/(n+o),n){case t:a=(e-s)/c+(e<s?6:0);break;case e:a=(s-t)/c+2;break;case s:a=(t-e)/c+4;break}a/=6}return new Ve(a,h,l,i)}toRGBA(){let t,e,s;if(this.s===0)t=e=s=this.l;else{const i=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,n=2*this.l-i;t=Ve.hue2rgb(n,i,this.h+1/3),e=Ve.hue2rgb(n,i,this.h),s=Ve.hue2rgb(n,i,this.h-1/3)}return new k(t*255,e*255,s*255,this.a)}toString(){const t=this.h.toFixed(0),e=this.s.toFixed(0),s=this.l.toFixed(0),i=this.a.toFixed(0);return`hsla(${t}, ${e}, ${s}, ${i})`}}var Vt;(function(r){r[r.Debug=0]="Debug",r[r.Info=1]="Info",r[r.Warn=2]="Warn",r[r.Error=3]="Error",r[r.Fatal=4]="Fatal"})(Vt||(Vt={}));class V{constructor(){if(this._appenders=[],this.defaultLevel=Vt.Info,this._logOnceSet=new Set,V._INSTANCE)throw new Error("Logger is a singleton");return V._INSTANCE=this,V._INSTANCE.addAppender(new pa),V._INSTANCE}static getInstance(){return V._INSTANCE==null&&(V._INSTANCE=new V),V._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,e){t==null&&(t=this.defaultLevel);const s=this._appenders.length;for(let i=0;i<s;i++)t>=this.defaultLevel&&this._appenders[i].log(t,e)}_logOnce(t,e){const s=t+e.join("+");this._logOnceSet.has(s)||(this._logOnceSet.add(s),this._log(t,e))}debug(...t){this._log(Vt.Debug,t)}debugOnce(...t){this._logOnce(Vt.Debug,t)}info(...t){this._log(Vt.Info,t)}infoOnce(...t){this._logOnce(Vt.Info,t)}warn(...t){this._log(Vt.Warn,t)}warnOnce(...t){this._logOnce(Vt.Warn,t)}error(...t){this._log(Vt.Error,t)}errorOnce(...t){this._logOnce(Vt.Error,t)}fatal(...t){this._log(Vt.Fatal,t)}fatalOnce(...t){this._logOnce(Vt.Fatal,t)}}V._INSTANCE=null;class pa{log(t,e){if(!console&&!console.log&&console.warn&&console.error)return;const s=[];s.unshift.apply(s,e),s.unshift("["+Vt[t]+"] : "),t<Vt.Warn?console.log.apply?console.log.apply(console,s):console.log(s.join(" ")):t<Vt.Error?console.warn.apply?console.warn.apply(console,s):console.warn(s.join(" ")):console.error.apply?console.error.apply(console,s):console.error(s.join(" "))}}class Pl{constructor(t){var e,s;this._messages=[],this._pos=10,this._color=k.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(s=(e=t.zIndex)===null||e===void 0?void 0:e.toString())!==null&&s!==void 0?s:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,e,s,i;const n=this._options;this.canvas.width=(t=n.width)!==null&&t!==void 0?t:n.engine.screen.resolution.width,this.canvas.height=(e=n.height)!==null&&e!==void 0?e:n.engine.screen.resolution.height,this.canvas.style.position="absolute";const o=n.engine.screen.screenToPageCoordinates(E(0,0));this.canvas.style.left=o.x+"px",this.canvas.style.top=o.y+"px",this._pos=(s=n.xPos)!==null&&s!==void 0?s:this._pos,this._color=(i=n.color)!==null&&i!==void 0?i:this._color}log(t,e){const s=e.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Vt[t]+"] : "+s);let i=10;this._messages=this._messages.slice(0,1e3);for(let n=0;n<this._messages.length;n++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[n],this._pos,i),i+=10}}var lt;(function(r){r.None="None",r.Top="Top",r.Bottom="Bottom",r.Left="Left",r.Right="Right"})(lt||(lt={}));(function(r){function t(s){return s===r.Top?r.Bottom:s===r.Bottom?r.Top:s===r.Left?r.Right:s===r.Right?r.Left:r.None}r.getOpposite=t;function e(s){return Math.abs(s.x)>=Math.abs(s.y)?s.x<=0?r.Left:r.Right:s.y<=0?r.Top:r.Bottom}r.fromDirection=e})(lt||(lt={}));class z{constructor(t=0,e=0,s=0,i=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=e,this.right=s,this.bottom=i)}clone(t){const e=t||new z(0,0,0,0);return e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?lt.Right:lt.Left:t.y<0?lt.Bottom:lt.Top:lt.None}static fromPoints(t){let e=1/0,s=1/0,i=-1/0,n=-1/0;for(let o=0;o<t.length;o++)t[o].x<e&&(e=t[o].x),t[o].x>i&&(i=t[o].x),t[o].y<s&&(s=t[o].y),t[o].y>n&&(n=t[o].y);return new z(e,s,i,n)}static fromDimension(t,e,s=T.Half,i=T.Zero){return new z(-t*s.x+i.x,-e*s.y+i.y,t-t*s.x+i.x,e-e*s.y+i.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new T((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new T(this.left,this.top)}get bottomRight(){return new T(this.right,this.bottom)}get topRight(){return new T(this.right,this.top)}get bottomLeft(){return new T(this.left,this.bottom)}translate(t){return new z(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,e=T.Zero){const s=this.getPoints().map(i=>i.rotate(t,e));return z.fromPoints(s)}scale(t,e=T.Zero){const s=this.translate(e);return new z(s.left*t.x,s.top*t.y,s.right*t.x,s.bottom*t.y)}transform(t){const e=t.data[0]*this.left,s=t.data[1]*this.left,i=t.data[0]*this.right,n=t.data[1]*this.right,o=t.data[2]*this.top,a=t.data[3]*this.top,h=t.data[2]*this.bottom,l=t.data[3]*this.bottom,c=t.getPosition(),u=Math.min(e,i)+Math.min(o,h)+c.x,d=Math.min(s,n)+Math.min(a,l)+c.y,f=Math.max(e,i)+Math.max(o,h)+c.x,p=Math.max(s,n)+Math.max(a,l)+c.y;return new z({left:u,top:d,right:f,bottom:p})}getPerimeter(){const t=this.width,e=this.height;return 2*(t+e)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new T(this.left,this.top)),this._points.push(new T(this.right,this.top)),this._points.push(new T(this.right,this.bottom)),this._points.push(new T(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,e=1/0){let s=-1/0,i=1/0;const n=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,o=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,a=(this.left-t.pos.x)*n,h=(this.right-t.pos.x)*n;s=Math.min(a,h),i=Math.max(a,h);const l=(this.top-t.pos.y)*o,c=(this.bottom-t.pos.y)*o;return s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c)),i>=Math.max(0,s)&&s<e}rayCastTime(t,e=1/0){let s=-1/0,i=1/0;const n=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,o=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,a=(this.left-t.pos.x)*n,h=(this.right-t.pos.x)*n;s=Math.min(a,h),i=Math.max(a,h);const l=(this.top-t.pos.y)*o,c=(this.bottom-t.pos.y)*o;return s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c)),i>=Math.max(0,s)&&s<e?s:-1}contains(t){return t instanceof T?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof z?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,e){const s=e||new z(0,0,0,0),i=Math.min(this.left,t.left),n=Math.min(this.top,t.top),o=Math.max(this.right,t.right),a=Math.max(this.bottom,t.bottom);return s.left=i,s.top=n,s.right=o,s.bottom=a,s}get dimensions(){return new T(this.width,this.height)}overlaps(t,e){const s=e||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const i=this.combine(t);return i.width+s<t.width+this.width&&i.height+s<t.height+this.height}intersect(t){const e=this.combine(t);if(e.width<t.width+this.width&&e.height<t.height+this.height&&!e.dimensions.equals(t.dimensions)&&!e.dimensions.equals(this.dimensions)){let s=0;this.right>=t.left&&this.right<=t.right?s=t.left-this.right:s=t.right-this.left;let i=0;return this.top<=t.bottom&&this.top>=t.top?i=t.bottom-this.top:i=t.top-this.bottom,Math.abs(s)<Math.abs(i)?new T(s,0):new T(0,i)}else if(e.dimensions.equals(t.dimensions)||e.dimensions.equals(this.dimensions)){let s=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?s=t.left-this.right:s=t.right-this.left:t.right-this.right<=this.left-t.left?s=this.left-t.right:s=this.right-t.left;let i=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?i=t.top-this.bottom:i=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?i=this.top-t.bottom:i=this.bottom-t.top,Math.abs(s)<Math.abs(i)?new T(s,0):new T(0,i)}else return null}intersectWithSide(t){const e=this.intersect(t);return z.getSideFromIntersection(e)}draw(t,e=k.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:e})}}function cn(r){if(r&&r.getBoundingClientRect){const t=r.getBoundingClientRect();return E(t.x+window.scrollX,t.y+window.scrollY)}return T.Zero}function Dd(r,t){return t.indexOf(r)===-1?(t.push(r),!0):!1}function $i(r,t){let e=-1;return(e=t.indexOf(r))>-1?(t.splice(e,1),!0):!1}function Il(r,t){for(let e=0;e<r.length;e++)if(r[e]===t)return!0;return!1}function Ml(r){throw new Error(r)}function ur(r,t){var e;const s=new De;return((e=t==null?void 0:t.schedule.bind(t))!==null&&e!==void 0?e:setTimeout)(()=>{s.resolve()},r),s.promise}function Rl(r,t){const e={};for(const s in r)t.includes(s)||(e[s]=r[s]);return e}function rr(r){return r&&typeof r=="object"&&!Array.isArray(r)}function dr(r,...t){if(!t.length)return r;const e=t.shift();if(rr(r)&&rr(e))for(const s in e)rr(e[s])?(r[s]||Object.assign(r,{[s]:{}}),dr(r[s],e[s])):Object.assign(r,{[s]:e[s]});return dr(r,...t)}var Ro;(function(r){r[r.X=12]="X",r[r.Y=13]="Y"})(Ro||(Ro={}));class Ce{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,e,s,i,n,o){const a=new Ce;return a.data[0]=2/(e-t),a.data[1]=0,a.data[2]=0,a.data[3]=0,a.data[4]=0,a.data[5]=2/(i-s),a.data[6]=0,a.data[7]=0,a.data[8]=0,a.data[9]=0,a.data[10]=-2/(o-n),a.data[11]=0,a.data[12]=-(e+t)/(e-t),a.data[13]=-(i+s)/(i-s),a.data[14]=-(o+n)/(o-n),a.data[15]=1,a}clone(t){const e=t||new Ce;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e.data[6]=this.data[6],e.data[7]=this.data[7],e.data[8]=this.data[8],e.data[9]=this.data[9],e.data[10]=this.data[10],e.data[11]=this.data[11],e.data[12]=this.data[12],e.data[13]=this.data[13],e.data[14]=this.data[14],e.data[15]=this.data[15],e}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const e=new Ce;return e.data=t,e}static identity(){const t=new Ce;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,e){const s=Ce.identity();return s.data[12]=t,s.data[13]=e,s}static scale(t,e){const s=Ce.identity();return s.data[0]=t,s.data[5]=e,s.data[10]=1,s.data[15]=1,s}static rotation(t){const e=Ce.identity();return e.data[0]=Math.cos(t),e.data[4]=-Math.sin(t),e.data[1]=Math.sin(t),e.data[5]=Math.cos(t),e}multiply(t,e){if(t instanceof T){const s=e||new T(0,0),i=t,n=i.x*this.data[0]+i.y*this.data[4]+this.data[12],o=i.x*this.data[1]+i.y*this.data[5]+this.data[13];return s.x=n,s.y=o,s}else{const s=e||new Ce,i=t,n=this.data[0],o=this.data[1],a=this.data[2],h=this.data[3],l=this.data[4],c=this.data[5],u=this.data[6],d=this.data[7],f=this.data[8],p=this.data[9],_=this.data[10],v=this.data[11],g=this.data[12],w=this.data[13],C=this.data[14],b=this.data[15],x=i.data[0],A=i.data[1],y=i.data[2],S=i.data[3],I=i.data[4],R=i.data[5],D=i.data[6],M=i.data[7],B=i.data[8],F=i.data[9],L=i.data[10],O=i.data[11],P=i.data[12],Y=i.data[13],W=i.data[14],q=i.data[15];s.data[0]=n*x+l*A+f*y+g*S,s.data[1]=o*x+c*A+p*y+w*S,s.data[2]=a*x+u*A+_*y+C*S,s.data[3]=h*x+d*A+v*y+b*S,s.data[4]=n*I+l*R+f*D+g*M,s.data[5]=o*I+c*R+p*D+w*M,s.data[6]=a*I+u*R+_*D+C*M,s.data[7]=h*I+d*R+v*D+b*M,s.data[8]=n*B+l*F+f*L+g*O,s.data[9]=o*B+c*F+p*L+w*O,s.data[10]=a*B+u*F+_*L+C*O,s.data[11]=h*B+d*F+v*L+b*O,s.data[12]=n*P+l*Y+f*W+g*q,s.data[13]=o*P+c*Y+p*W+w*q,s.data[14]=a*P+u*Y+_*W+C*q,s.data[15]=h*P+d*Y+v*W+b*q;const G=this.getScale();return s._scaleSignX=_t(G.x)*_t(s._scaleSignX),s._scaleSignY=_t(G.y)*_t(s._scaleSignY),s}}translate(t,e){const s=this.data[0],i=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=this.data[6],c=this.data[7],u=this.data[8],d=this.data[9],f=this.data[10],p=this.data[11],_=this.data[12],v=this.data[13],g=this.data[14],w=this.data[15],C=0,b=1;return this.data[12]=s*t+a*e+u*C+_*b,this.data[13]=i*t+h*e+d*C+v*b,this.data[14]=n*t+l*e+f*C+g*b,this.data[15]=o*t+c*e+p*C+w*b,this}setPosition(t,e){this.data[12]=t,this.data[13]=e}getPosition(){return E(this.data[12],this.data[13])}rotate(t){const e=this.data[0],s=this.data[1],i=this.data[2],n=this.data[3],o=this.data[4],a=this.data[5],h=this.data[6],l=this.data[7],c=Math.sin(t),u=Math.cos(t);return this.data[0]=u*e+c*o,this.data[1]=u*s+c*a,this.data[2]=u*i+c*h,this.data[3]=u*n+c*l,this.data[4]=u*o-c*e,this.data[5]=u*a-c*s,this.data[6]=u*h-c*i,this.data[7]=u*l-c*n,this}scale(t,e){const s=this.data[0],i=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5],l=this.data[6],c=this.data[7];return this.data[0]=s*t,this.data[1]=i*t,this.data[2]=n*t,this.data[3]=o*t,this.data[4]=a*e,this.data[5]=h*e,this.data[6]=l*e,this.data[7]=c*e,this}setRotation(t){const e=this.getScale(),s=Math.sin(t),i=Math.cos(t);this.data[0]=i*e.x,this.data[1]=s*e.y,this.data[4]=-s*e.x,this.data[5]=i*e.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return ws(t)}getScaleX(){const t=E(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=E(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return E(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=_t(t);const e=E(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[4]=e.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=_t(t);const e=E(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[5]=e.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const s=1/this.getBasisDeterminant(),i=this.data[0],n=this.data[4],o=this.data[1],a=this.data[5],h=t||Ce.identity();h.data[0]=a*s,h.data[1]=-o*s,h.data[4]=-n*s,h.data[5]=i*s;const l=this.data[12],c=this.data[13];return h.data[12]=-(l*h.data[0]+c*h.data[4]),h.data[13]=-(l*h.data[1]+c*h.data[5]),h}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class Ot{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new Ot;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,e){const s=Ot.identity();return s.data[4]=t,s.data[5]=e,s}static scale(t,e){const s=Ot.identity();return s.data[0]=t,s.data[3]=e,s._scale[0]=t,s._scale[1]=e,s}static rotation(t){const e=Ot.identity();return e.data[0]=Math.cos(t),e.data[1]=Math.sin(t),e.data[2]=-Math.sin(t),e.data[3]=Math.cos(t),e}setPosition(t,e){this.data[4]=t,this.data[5]=e}getPosition(){return E(this.data[4],this.data[5])}rotate(t){const e=this.data[0],s=this.data[1],i=this.data[2],n=this.data[3],o=Math.sin(t),a=Math.cos(t);return this.data[0]=a*e+o*i,this.data[1]=a*s+o*n,this.data[2]=a*i-o*e,this.data[3]=a*n-o*s,this}translate(t,e){const s=this.data[0],i=this.data[1],n=this.data[2],o=this.data[3],a=this.data[4],h=this.data[5];return this.data[4]=s*t+n*e+a,this.data[5]=i*t+o*e+h,this}scale(t,e){const s=this.data[0],i=this.data[1],n=this.data[2],o=this.data[3];return this.data[0]=s*t,this.data[1]=i*t,this.data[2]=n*e,this.data[3]=o*e,this._scale[0]=t,this._scale[1]=e,this._scaleSignX=_t(t),this._scaleSignY=_t(e),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const e=this.determinant();let s=e;e!==0&&(s=1/e);const i=this.data[0],n=this.data[2],o=this.data[1],a=this.data[3],h=t||Ot.identity();h.data[0]=a*s,h.data[1]=-o*s,h.data[2]=-n*s,h.data[3]=i*s;const l=this.data[4],c=this.data[5];return h.data[4]=-(l*h.data[0]+c*h.data[2]),h.data[5]=-(l*h.data[1]+c*h.data[3]),h}multiply(t,e){if(t instanceof T){const s=e||new T(0,0),i=t,n=i.x*this.data[0]+i.y*this.data[2]+this.data[4],o=i.x*this.data[1]+i.y*this.data[3]+this.data[5];return s.x=n,s.y=o,s}else{const s=e||new Ot,i=t,n=this.data[0],o=this.data[1],a=this.data[2],h=this.data[3],l=this.data[4],c=this.data[5],u=i.data[0],d=i.data[1],f=i.data[2],p=i.data[3],_=i.data[4],v=i.data[5];s.data[0]=n*u+a*d,s.data[1]=o*u+h*d,s.data[2]=n*f+a*p,s.data[3]=o*f+h*p,s.data[4]=n*_+a*v+l,s.data[5]=o*_+h*v+c;const g=this._scaleSignX,w=this._scaleSignY;return s._scaleSignX=g*_t(s._scaleSignX),s._scaleSignY=w*_t(s._scaleSignY),s}}multiplyQuadInPlace(t){const e=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],s=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=e,t[1]=s;const i=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],n=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=i,t[3]=n;const o=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],a=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=o,t[5]=a;const h=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],l=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=h,t[7]=l}to4x4(){const t=new Ce;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const e=this.getScale(),s=Math.sin(t),i=Math.cos(t);this.data[0]=i*e.x,this.data[1]=s*e.y,this.data[2]=-s*e.x,this.data[3]=i*e.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return ws(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return E(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=_t(t);const e=E(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=e.x*t,this.data[2]=e.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=_t(t);const e=E(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=e.x*t,this.data[3]=e.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const e=t||new Ot;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e._scaleSignX=this._scaleSignX,e._scaleSignY=this._scaleSignY,e}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class Mn{constructor(t,e,s=1){this.builder=t,this.cleaner=e,this._pool=[],this._size=0,this.grow(s)}grow(t){if(t>0){this._size+=t;for(let e=0;e<t;e++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}class kd{constructor(){this._pool=new Mn(()=>Ot.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,e){return this._currentTransform.translate(t,e)}rotate(t){return this._currentTransform.rotate(t)}scale(t,e){return this._currentTransform.scale(t,e)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class Fd{constructor(){this.opacity=1,this.z=0,this.tint=k.White,this.material=null}}class Dl{constructor(){this._pool=new Mn(()=>new Fd,t=>(t.opacity=1,t.z=0,t.tint=k.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var e;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(e=this.current.tint)===null||e===void 0?void 0:e.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Bd={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Rn{constructor(t,e,s=!1){this.path=t,this.responseType=e,this.bustCache=s,this.data=null,this.logger=V.getInstance(),this.events=new yt}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,e)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const s=new XMLHttpRequest;s.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),s.responseType=this.responseType,s.addEventListener("loadstart",i=>this.events.emit("loadstart",i)),s.addEventListener("progress",i=>this.events.emit("progress",i)),s.addEventListener("error",i=>this.events.emit("error",i)),s.addEventListener("load",i=>this.events.emit("load",i)),s.addEventListener("load",()=>{if(s.status!==0&&s.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",s.status),this.events.emit("error",s.response),e(new Error(s.statusText));return}if(s.response instanceof Blob&&s.response.type==="text/html"){const i=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",s.response),e(new Error(i));return}this.data=s.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),s.send()})}}function qe(r,t){return r&&(r.__isProxy===void 0?new Proxy(r,{set:(e,s,i)=>(e[s]!==i&&(e[s]=i,typeof s=="string"&&s[0]!=="_"&&t(e)),!0),get:(e,s)=>s!=="__isProxy"?e[s]:!0}):r)}const kl=(r=[],t,e)=>({get:(s,i)=>i==="__isProxy"?!0:typeof s[i]=="object"&&s[i]!=null?new Proxy(s[i],kl([...r,i],t,e)):s[i],set:(s,i,n)=>(typeof i=="string"&&i[0]!=="_"&&t(e),s[i]=n,!0)});function Od(r,t){return r&&(r.__isProxy===void 0?new Proxy(r,kl([],t,r)):r)}class Pt{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=qe(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=qe(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var e,s,i,n,o,a,h;this.id=Pt._ID++,this.transform=Ot.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=T.One,this._width=0,this._height=0,t&&(this.origin=(e=t.origin)!==null&&e!==void 0?e:this.origin,this.flipHorizontal=(s=t.flipHorizontal)!==null&&s!==void 0?s:this.flipHorizontal,this.flipVertical=(i=t.flipVertical)!==null&&i!==void 0?i:this.flipVertical,this.rotation=(n=t.rotation)!==null&&n!==void 0?n:this.rotation,this.opacity=(o=t.opacity)!==null&&o!==void 0?o:this.opacity,this.scale=(a=t.scale)!==null&&a!==void 0?a:this.scale,this.tint=(h=t.tint)!==null&&h!==void 0?h:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return z.fromDimension(this.width,this.height,T.Zero)}draw(t,e,s){this._preDraw(t,e,s),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,e,s){t.save(),t.translate(e,s),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var e;const s=this.scale.x>0?1:-1,i=this.scale.y>0?1:-1,n=(e=this.origin)!==null&&e!==void 0?e:E(this.width/2,this.height/2);t.translate(n.x,n.y),t.rotate(this.rotation),t.scale(s,i),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}Pt._ID=0;class je extends Pt{static from(t,e){return new je({image:t,...e})}constructor(t){var e,s;super(t),this._logger=V.getInstance(),this._dirty=!0,this.image=t.image;const{width:i,height:n}=t;this.sourceView=(e=t.sourceView)!==null&&e!==void 0?e:{x:0,y:0,width:i??0,height:n??0},this.destSize=(s=t.destSize)!==null&&s!==void 0?s:{width:i??0,height:n??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,e,s,i,n,o;const{width:a,height:h}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||a,this.sourceView.height=((e=this.sourceView)===null||e===void 0?void 0:e.height)||h,this.destSize.width=((s=this.destSize)===null||s===void 0?void 0:s.width)||((i=this.sourceView)===null||i===void 0?void 0:i.width)||a,this.destSize.height=((n=this.destSize)===null||n===void 0?void 0:n.height)||((o=this.sourceView)===null||o===void 0?void 0:o.height)||h,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,e,s){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,e,s)}_drawImage(t,e,s){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,e,s,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new je({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var Lt;(function(r){r.Pixel="Pixel",r.Blended="Blended"})(Lt||(Lt={}));function Zi(r){switch(r){case Lt.Pixel:return Lt.Pixel;case Lt.Blended:return Lt.Blended;default:return}}var vt;(function(r){r.Clamp="Clamp",r.Repeat="Repeat",r.Mirror="Mirror"})(vt||(vt={}));function Ze(r){switch(r){case vt.Clamp:return vt.Clamp;case vt.Repeat:return vt.Repeat;case vt.Mirror:return vt.Mirror;default:return vt.Clamp}}class At{constructor(t,e){var s;this._garbageCollector=e,this._textureMap=new Map,this._collect=i=>{var n;if(this._gl){const o=(n=i.dataset.originalSrc)!==null&&n!==void 0?n:i.constructor.name;return At._LOGGER.debug(`WebGL Texture for ${o} collected`),this.delete(i),!0}return!1},this._gl=t,At._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(At._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(s=this._garbageCollector.garbageCollector)===null||s===void 0||s.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,e,s=!1){var i,n;const o=this._gl;if(!o)return null;const{filtering:a,wrapping:h}={...e};let l=null;if(this.has(t)&&(l=this.get(t)),l)return s&&(o.bindTexture(o.TEXTURE_2D,l),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t)),(i=this._garbageCollector)===null||i===void 0||i.garbageCollector.touch(t),l;l=o.createTexture(),At.checkImageSizeSupportedAndLog(t),o.bindTexture(o.TEXTURE_2D,l),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let c;h&&(typeof h=="string"?c={x:h,y:h}:c={x:h.x,y:h.y});const{x:u,y:d}=c??At.wrapping;switch(u){case vt.Clamp:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);break;case vt.Repeat:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.REPEAT);break;case vt.Mirror:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.MIRRORED_REPEAT);break;default:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE)}switch(d){case vt.Clamp:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);break;case vt.Repeat:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.REPEAT);break;case vt.Mirror:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.MIRRORED_REPEAT);break;default:o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)}const f=a??At.filtering;return o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,f===Lt.Pixel?o.NEAREST:o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,f===Lt.Pixel?o.NEAREST:o.LINEAR),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),this._textureMap.set(t,l),(n=this._garbageCollector)===null||n===void 0||n.garbageCollector.addCollectableResource("texture",t),l}delete(t){const e=this._gl;if(e&&this.has(t)){const s=this.get(t);s&&(this._textureMap.delete(t),e.deleteTexture(s))}}static checkImageSizeSupportedAndLog(t){var e;const s=(e=t.dataset.originalSrc)!==null&&e!==void 0?e:"internal canvas bitmap";return t.width>At._MAX_TEXTURE_SIZE||t.height>At._MAX_TEXTURE_SIZE?(At._LOGGER.error(`The image [${s}] provided to Excalibur is too large for the device's maximum texture size of (${At._MAX_TEXTURE_SIZE}x${At._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&At._LOGGER.warn(`The image [${s}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}At._LOGGER=V.getInstance();At.filtering=Lt.Blended;At.wrapping={x:vt.Clamp,y:vt.Clamp};At._MAX_TEXTURE_SIZE=4096;const ot={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class rs{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,e,s){this._logger=V.getInstance(),this.data=new Image,this._readyFuture=new De,this.ready=this._readyFuture.promise,this.path=t;let i=!1,n;typeof e=="boolean"?i=e:{filtering:s,wrapping:n,bustCache:i}={...e},this._resource=new Rn(t,"blob",i),this.filtering=s??this.filtering,typeof n=="string"?this.wrapping={x:n,y:n}:this.wrapping=n??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,e){const s=new rs("");if(s._src="image-element",s.data=t,s.data.setAttribute("data-original-src","image-element"),e!=null&&e.filtering?s.data.setAttribute(ot.Filtering,e==null?void 0:e.filtering):s.data.setAttribute(ot.Filtering,Lt.Blended),e!=null&&e.wrapping){let i;typeof e.wrapping=="string"?i={x:e.wrapping,y:e.wrapping}:i={x:e.wrapping.x,y:e.wrapping.y},s.data.setAttribute(ot.WrappingX,i.x),s.data.setAttribute(ot.WrappingY,i.y)}else s.data.setAttribute(ot.WrappingX,vt.Clamp),s.data.setAttribute(ot.WrappingY,vt.Clamp);return At.checkImageSizeSupportedAndLog(t),s._readyFuture.resolve(t),s}static fromHtmlCanvasElement(t,e){const s=new rs("");if(s._src="canvas-element-blob",s.data.setAttribute("data-original-src","canvas-element-blob"),e!=null&&e.filtering?s.data.setAttribute(ot.Filtering,e==null?void 0:e.filtering):s.data.setAttribute(ot.Filtering,Lt.Blended),e!=null&&e.wrapping){let i;typeof e.wrapping=="string"?i={x:e.wrapping,y:e.wrapping}:i={x:e.wrapping.x,y:e.wrapping.y},s.data.setAttribute(ot.WrappingX,i.x),s.data.setAttribute(ot.WrappingY,i.y)}else s.data.setAttribute(ot.WrappingX,vt.Clamp),s.data.setAttribute(ot.WrappingY,vt.Clamp);return At.checkImageSizeSupportedAndLog(t),t.toBlob(i=>{const n=URL.createObjectURL(i);s.image.onload=()=>{URL.revokeObjectURL(n),s.data=s.image,s._readyFuture.resolve(s.image)},s.image.src=n}),s}static fromSvgString(t,e){const s=new Blob([t],{type:"image/svg+xml"}),i=URL.createObjectURL(s);return new rs(i,e)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,e,s,i;if(this.isLoaded())return this.data;try{let n;if(this.path.includes("data:image/"))n=this.path;else{const h=await this._resource.load();n=URL.createObjectURL(h)}const o=new Image,a=new De;o.onload=()=>a.resolve(),o.src=n,o.setAttribute("data-original-src",this.path),await a.promise,this.data=o,At.checkImageSizeSupportedAndLog(this.data)}catch(n){throw`Error loading ImageSource from path '${this.path}' with error [${n.message}]`}return this.data.setAttribute(ot.Filtering,this.filtering),this.data.setAttribute(ot.WrappingX,(e=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&e!==void 0?e:vt.Clamp),this.data.setAttribute(ot.WrappingY,(i=(s=this.wrapping)===null||s===void 0?void 0:s.y)!==null&&i!==void 0?i:vt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return je.from(this,t)}unload(){this.data=new Image}}class Ur extends Pt{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=V.getInstance();const{alphabet:e,spriteSheet:s,caseInsensitive:i,spacing:n,shadow:o,lineHeight:a}=t;this.alphabet=e,this.spriteSheet=s,this.caseInsensitive=i??this.caseInsensitive,this.spacing=n??this.spacing,this.shadow=o??this.shadow,this.lineHeight=a??this.lineHeight}_getCharacterSprites(t){const e=[],s=this.caseInsensitive?t.toLocaleLowerCase():t,i=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let n=0;n<s.length;n++){const o=s[n];let a=i.indexOf(o);a===-1&&(a=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${o}' in configured alphabet '${i}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const h=this.spriteSheet.sprites[a];h?e.push(h):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${o}' at index '${a}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return e}measureText(t,e){const s=this._getLinesFromText(t,e),i=s.reduce((h,l)=>h.length>l.length?h:l),n=this._getCharacterSprites(i);let o=0,a=0;for(const h of n)o+=h.width+this.spacing,a=Math.max(a,h.height);return z.fromDimension(o*this.scale.x,a*s.length*this.scale.y,T.Zero)}_drawImage(t,e,s,i){var n;let o=0,a=0,h=0;const l=this._getLinesFromText(this._text,i);for(const c of l){for(const u of this._getCharacterSprites(c))u.draw(t,e+o,s+a),o+=u.width+this.spacing,h=Math.max(h,u.height);o=0,a+=(n=this.lineHeight)!==null&&n!==void 0?n:h}}render(t,e,s,i,n,o){this._text=e;const a=this.measureText(e,o);this.width=a.width,this.height=a.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,i,n),this._drawImage(t,0,0,o),this._postDraw(t),t.restore()),this._preDraw(t,i,n),this._drawImage(t,0,0,o),this._postDraw(t)}clone(){return new Ur({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,e){var s;if(this._cachedText===t&&this._cachedRenderWidth===e&&(!((s=this._cachedLines)===null||s===void 0)&&s.length))return this._cachedLines;const i=t.split(`
`);if(e==null)return i;for(let n=0;n<i.length;n++){let o=i[n],a="";if(this.measureText(o).width>e){for(;this.measureText(o).width>e;)a=o[o.length-1]+a,o=o.slice(0,-1);i[n]=o,i[n+1]=a}}return this._cachedText=t,this._cachedLines=i,this._cachedRenderWidth=e,i}}class Dn extends je{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new De,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,e){return new Dn({sourceView:{...t.sourceView},width:t.width,height:t.height,...e,image:t.image})}_applyTiling(){const{width:t,height:e,filtering:s,wrapping:i}={...this._options},n=document.createElement("canvas");n.width=this.sourceView.width,n.height=this.sourceView.height,n.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const a=rs.fromHtmlCanvasElement(n,{wrapping:i??vt.Repeat,filtering:s});t&&(this.destSize.width=t,this.sourceView.width=t),e&&(this.destSize.height=e,this.sourceView.height=e),this.sourceView.x=0,this.sourceView.y=0,this.image=a,this.image.ready.then(()=>this._ready.resolve())}}class si{constructor(t){this.sprites=[];const{sprites:e,rows:s,columns:i}=t;this.sprites=e,this.rows=s??1,this.columns=i??this.sprites.length}getSprite(t,e,s){var i,n,o,a,h,l,c,u,d;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(e>=this.rows||e<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), y: ${e} should be between 0 and ${this.rows-1} rows`);const f=t+e*this.columns,p=this.sprites[f];if(p){if(s){const _=p.clone();return _.flipHorizontal=(i=s.flipHorizontal)!==null&&i!==void 0?i:_.flipHorizontal,_.flipVertical=(n=s.flipVertical)!==null&&n!==void 0?n:_.flipVertical,_.width=(o=s.width)!==null&&o!==void 0?o:_.width,_.height=(a=s.height)!==null&&a!==void 0?a:_.height,_.rotation=(h=s.rotation)!==null&&h!==void 0?h:_.rotation,_.scale=(l=s.scale)!==null&&l!==void 0?l:_.scale,_.opacity=(c=s.opacity)!==null&&c!==void 0?c:_.opacity,_.tint=(u=s.tint)!==null&&u!==void 0?u:_.tint,_.origin=(d=s.origin)!==null&&d!==void 0?d:_.origin,_}return p}throw Error(`Invalid sprite coordinates (${t}, ${e})`)}getTiledSprite(t,e,s){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(e>=this.rows||e<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${e}), y: ${e} should be between 0 and ${this.rows-1} rows`);const i=t+e*this.columns,n=this.sprites[i];if(n)return Dn.fromSprite(n,s);throw Error(`Invalid sprite coordinates (${t}, ${e})`)}static fromImageSourceWithSourceViews(t){const e=t.sourceViews.map(s=>new je({image:t.image,sourceView:s}));return new si({sprites:e})}static fromImageSource(t){var e;const s=[];t.spacing=(e=t.spacing)!==null&&e!==void 0?e:{};const{image:i,grid:{rows:n,columns:o,spriteWidth:a,spriteHeight:h},spacing:{originOffset:l,margin:c}}=t,u={x:0,y:0,...l},d={x:0,y:0,...c};for(let f=0;f<o;f++)for(let p=0;p<n;p++)s[f+p*o]=new je({image:i,sourceView:{x:f*a+d.x*f+u.x,y:p*h+d.y*p+u.y,width:a,height:h},destSize:{height:h,width:a}});return new si({sprites:s,rows:n,columns:o})}clone(){return new si({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Nd="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class _a{constructor(){this.fontSheet=Nd,this.size=16,this.load()}load(){return this._imageSource=new rs(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=si.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Ur({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,e,s){this._imageSource.isLoaded()&&this._spriteFont.render(t,e,null,s.x,s.y)}}class Ld{constructor(t,e){this._gl=t,this._texture=e}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class Jn{constructor(t){var e,s;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(e=t.antialias)!==null&&e!==void 0?e:this.antialias,this.samples=(s=t.samples)!==null&&s!==void 0?s:this._gl.getParameter(this._gl.MAX_SAMPLES);const i=this._gl;i.drawingBufferFormat?this.bufferFormat=i.drawingBufferFormat:this.transparency?this.bufferFormat=i.RGBA8:this.bufferFormat=i.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,e){const s=this._gl;this.width=t,this.height=e,s.bindTexture(s.TEXTURE_2D,this._frameTexture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,this.width,this.height,0,s.RGBA,s.UNSIGNED_BYTE,null),this._renderBuffer&&(s.bindRenderbuffer(s.RENDERBUFFER,this._renderBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,Math.min(this.samples,s.getParameter(s.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const e=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Ld(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const e=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.bindTexture(e.TEXTURE_2D,t),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const Ud=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,zd=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Do(r,t){switch(t){case r.INT:case r.UNSIGNED_INT:case r.FLOAT:return 4;case r.SHORT:return 2;case r.UNSIGNED_SHORT:return 2;case r.BYTE:return 1;case r.UNSIGNED_BYTE:return 1;default:return 1}}function Fl(r,t){const e=`(?<type>[a-z0-9]+)\\s+${t};`,i=new RegExp(e,"g").exec(r);return(i==null?void 0:i.length)>0}function Bl(r,t,e){var s;const i=`(?<type>[a-z0-9]+)\\s+${e};`,o=new RegExp(i,"g").exec(t);switch((s=o==null?void 0:o.groups)===null||s===void 0?void 0:s.type){case"float":case"vec2":case"vec3":case"vec4":return r.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return r.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return r.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return r.BOOL;case"short":return r.SHORT;case"ushort":return r.UNSIGNED_SHORT;case"ubyte":return r.UNSIGNED_BYTE;case"byte":return r.BYTE;default:return r.FLOAT}}function Ol(r,t){switch(t){case r.LOW_FLOAT:case r.HIGH_FLOAT:case r.FLOAT:return 1;case r.FLOAT_VEC2:return 2;case r.FLOAT_VEC3:return 3;case r.FLOAT_VEC4:return 4;case r.BYTE:return 1;case r.UNSIGNED_BYTE:return 1;case r.UNSIGNED_SHORT:case r.SHORT:return 1;default:return 1}}function Nl(r,t){switch(t){case r.LOW_FLOAT:case r.HIGH_FLOAT:case r.FLOAT:case r.FLOAT_VEC2:case r.FLOAT_VEC3:case r.FLOAT_VEC4:return r.FLOAT;case r.BYTE:return r.BYTE;case r.UNSIGNED_BYTE:return r.UNSIGNED_BYTE;case r.SHORT:return r.SHORT;case r.UNSIGNED_SHORT:return r.UNSIGNED_SHORT;default:return r.FLOAT}}function ga(r,t){const e=i=>{const n=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let o="";for(let a=0;a<i;a++)a===0?o+=`if (index <= ${a}.5) {
`:o+=`   else if (index <= ${a}.5) {
`,o+=`      fragColor = vec4(1.0);
`,o+=`   }
`;return n.replace("%%complexity%%",o)};let s=!1;do{const i=e(t),n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,i),r.compileShader(n),s=r.getShaderParameter(n,r.COMPILE_STATUS),s||(t=t/2|0)}while(!s);return t}class ye{get compiled(){return this._compiled}constructor(t){this._logger=V.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:e,vertexSource:s,fragmentSource:i,onPreLink:n,onPostCompile:o}=t;this._gl=e,this.vertexSource=s,this.fragmentSource=i,this._onPreLink=n,this._onPostCompile=o}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),ye._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return ye._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,e=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),s=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,e,s);const i=this.getAttributes();for(const o of i)this.attributes[o.name]=o;const n=this.getUniforms();for(const o of n)this.uniforms[o.name]=o;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),s=[];for(let i=0;i<e;i++){const n=t.getActiveUniform(this.program,i),o=t.getUniformLocation(this.program,n.name);s.push({name:n.name,glType:n.type,location:o})}return s}getAttributes(){const t=this._gl,e=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),s=[];for(let i=0;i<e;i++){const n=t.getActiveAttrib(this.program,i),o=t.getAttribLocation(this.program,n.name);s.push({name:n.name,glType:Nl(t,n.type),size:Ol(t,n.type),location:o,normalized:!1})}return s}setTexture(t,e){const s=this._gl;s.activeTexture(s.TEXTURE0+t),s.bindTexture(s.TEXTURE_2D,e)}setUniformInt(t,e){this.setUniform("uniform1i",t,~~e)}trySetUniformInt(t,e){return this.trySetUniform("uniform1i",t,~~e)}setUniformIntArray(t,e){this.setUniform("uniform1iv",t,e)}trySetUniformIntArray(t,e){return this.trySetUniform("uniform1iv",t,e)}setUniformBoolean(t,e){this.setUniform("uniform1i",t,e?1:0)}trySetUniformBoolean(t,e){return this.trySetUniform("uniform1i",t,e?1:0)}setUniformFloat(t,e){this.setUniform("uniform1f",t,e)}trySetUniformFloat(t,e){return this.trySetUniform("uniform1f",t,e)}setUniformFloatArray(t,e){this.setUniform("uniform1fv",t,e)}trySetUniformFloatArray(t,e){return this.trySetUniform("uniform1fv",t,e)}setUniformFloatVector(t,e){this.setUniform("uniform2f",t,e.x,e.y)}trySetUniformFloatVector(t,e){return this.trySetUniform("uniform2f",t,e.x,e.y)}setUniformFloatColor(t,e){this.setUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}trySetUniformFloatColor(t,e){return this.trySetUniform("uniform4f",t,e.r/255,e.g/255,e.b/255,e.a)}setUniformMatrix(t,e){this.setUniform("uniformMatrix4fv",t,!1,e.data)}setUniformAffineMatrix(t,e){this.setUniform("uniformMatrix4fv",t,!1,[e.data[0],e.data[1],0,0,e.data[2],e.data[3],0,0,0,0,1,0,e.data[4],e.data[5],0,1])}trySetUniformMatrix(t,e){return this.trySetUniform("uniformMatrix4fv",t,!1,e.data)}setUniform(t,e,...s){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${e}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const n=this._gl.getUniformLocation(this.program,e);if(n){const o=[n,...s];this._gl[t].apply(this._gl,o)}else throw Error(`Uniform ${t}:${e} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,e,...s){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${e}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const n=this._gl.getUniformLocation(this.program,e);if(n){const o=[n,...s];this._gl[t].apply(this._gl,o)}else return!1;return!0}_createProgram(t,e,s){const i=t.createProgram();if(i===null)throw Error("Could not create graphics shader program");if(t.attachShader(i,e),t.attachShader(i,s),this._onPreLink&&this._onPreLink(i),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(i)}]`);return i}_compileShader(t,e,s){const i=t.VERTEX_SHADER===s?"vertex":"fragment",n=t.createShader(s);if(n===null)throw Error(`Could not build shader: [${e}]`);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const a=t.getShaderInfoLog(n);throw Error(`Could not compile ${i} shader:

${a}${this._processSourceForError(e,a)}`)}return n}_processSourceForError(t,e){if(!t)return e;const s=t.split(`
`),i=e.search(/\d:\d/),n=e.indexOf(" ",i),[o,a]=e.slice(i,n).split(":").map(h=>Number(h));for(let h=0;h<s.length;h++)s[h]=`${h+1}: ${s[h]}${a===h+1?" <----- ERROR!":""}`;return`

Source:
`+s.join(`
`)}}ye._ACTIVE_SHADER_INSTANCE=null;class ls{constructor(t){this.type="dynamic";const{gl:e,size:s,type:i,data:n}=t;if(this._gl=e,this.buffer=this._gl.createBuffer(),!n&&!s)throw Error("Must either provide data or a size to the VertexBuffer");n?this.bufferData=n:this.bufferData=new Float32Array(s),this.type=i??this.type,e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.bufferData,this.type==="static"?e.STATIC_DRAW:e.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),t?e.bufferSubData(e.ARRAY_BUFFER,0,this.bufferData,0,t):e.bufferData(e.ARRAY_BUFFER,this.bufferData,this.type==="static"?e.STATIC_DRAW:e.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Es{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=V.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:e,shader:s,vertexBuffer:i,attributes:n,suppressWarnings:o}=t;this._gl=e,this._vertexBuffer=i,this._attributes=n,this._shader=s,this._suppressWarnings=o,s&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const n of this._attributes){const o=t[n[0]];if(!o){if(!Fl(this._shader.vertexSource,n[0]))throw Error(`The attribute named: ${n[0]} size ${n[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${n[0]} size ${n[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${n[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${n[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const a=Bl(this._gl,this._shader.vertexSource,n[0]);this._layout.push({name:n[0],glType:a,size:n[1],location:-1,normalized:!1})}if(o){if(o.size!==n[1])throw Error(`VertexLayout size definition for attribute: [${n[0]}, ${n[1]}], doesn't match shader source size ${o.size}:
 ${this._shader.vertexSource}`);this._layout.push(o)}}let e=0;for(const n of this._layout){const o=Do(this._gl,n.glType);this._vertexTotalSizeBytes+=o*n.size,e+=n.size}this._vertexBuffer.bufferData.length%e!==0&&this._logger.warn(`The vertex component size (${e})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const s=this._gl;this._vao=s.createVertexArray(),s.bindVertexArray(this._vao),this._vertexBuffer.bind();let i=0;for(const n of this._layout)n.location!==-1&&(n.glType===s.INT?s.vertexAttribIPointer(n.location,n.size,n.glType,this.totalVertexSizeBytes,i):s.vertexAttribPointer(n.location,n.size,n.glType,n.normalized,this.totalVertexSizeBytes,i),s.enableVertexAttribArray(n.location)),i+=Do(s,n.glType)*n.size;s.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,e){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const s=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(e),s.bindVertexArray(this._vao)}}class wt{static clear(){wt.DrawCallCount=0,wt.DrawnImagesCount=0}}wt.DrawCallCount=0;wt.DrawnImagesCount=0;class Vd{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=E(0,0),this._endScratch=E(0,0)}initialize(t,e){this._gl=t,this._context=e,this._shader=new ye({gl:t,vertexSource:Ud,fragmentSource:zd}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new ls({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Es({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,e,s){this._isFull()&&this.flush(),this._lineCount++;const i=this._context.getTransform(),n=i.multiply(t,this._startScratch),o=i.multiply(e,this._endScratch),a=this._vertexBuffer.bufferData;a[this._vertexIndex++]=n.x,a[this._vertexIndex++]=n.y,a[this._vertexIndex++]=s.r/255,a[this._vertexIndex++]=s.g/255,a[this._vertexIndex++]=s.b/255,a[this._vertexIndex++]=s.a,a[this._vertexIndex++]=o.x,a[this._vertexIndex++]=o.y,a[this._vertexIndex++]=s.r/255,a[this._vertexIndex++]=s.g/255,a[this._vertexIndex++]=s.b/255,a[this._vertexIndex++]=s.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),wt.DrawnImagesCount+=this._lineCount,wt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Wd=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Hd=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class qd{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new ye({gl:t,vertexSource:Wd,fragmentSource:Hd}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new ls({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,e,s){this._isFull()&&this.flush(),this._pointCount++;const i=this._context.getTransform(),n=this._context.opacity,o=this._context.snapToPixel,a=i.multiply(t);o&&(a.x=~~(a.x+$),a.y=~~(a.y+$));const h=this._buffer.bufferData;h[this._vertexIndex++]=a.x,h[this._vertexIndex++]=a.y,h[this._vertexIndex++]=e.r/255,h[this._vertexIndex++]=e.g/255,h[this._vertexIndex++]=e.b/255,h[this._vertexIndex++]=e.a*n,h[this._vertexIndex++]=s*Math.max(i.getScaleX(),i.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),wt.DrawnImagesCount+=this._pointCount,wt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Gd=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Xd=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class jd{constructor(t){this._gl=t,this._shader=new ye({gl:t,vertexSource:Gd,fragmentSource:Xd}),this._shader.compile(),this._buffer=new ls({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const e=this._gl,s=t.getShader();s.use(),t.getLayout().use(),e.activeTexture(e.TEXTURE0),s.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),e.drawArrays(e.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class kn{constructor(t,e,s){this._logger=V.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const i=e*6;if(!s)this.bufferData=new Uint32Array(i);else{const a=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(i),e>a&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${a}) requested quads(${e})`)}let n=0;for(let o=0;o<i;o+=6)this.bufferData[o+0]=n+0,this.bufferData[o+1]=n+1,this.bufferData[o+2]=n+2,this.bufferData[o+3]=n+2,this.bufferData[o+4]=n+1,this.bufferData[o+5]=n+3,n+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const Yd=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,$d=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class Zd{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=k.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,e){this._gl=t,this._context=e;const s=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),i=ga(t,s);this._maxTextures=Math.min(s,i);const n=this._transformFragmentSource(Yd,this._maxTextures);this._shader=new ye({gl:t,fragmentSource:n,vertexSource:$d}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((o,a)=>a)),this._buffer=new ls({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new kn(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,e){let s=t.replace("%%count%%",e.toString()),i="";for(let n=0;n<e;n++)n===0?i+=`if (v_textureIndex <= ${n}.5) {
`:i+=`   else if (v_textureIndex <= ${n}.5) {
`,i+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,i+=`      color = texture(u_textures[${n}], uv);
`,i+=`   }
`;return s=s.replace("%%texture_picker%%",i),s}_addImageAsTexture(t){if(this._images.has(t))return;const e=t.getAttribute(ot.Filtering),s=e?Zi(e):void 0,i=Ze(t.getAttribute(ot.WrappingX)),n=Ze(t.getAttribute(ot.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:s,wrapping:{x:i,y:n}},o);t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&(this._textures.push(a),this._textureToIndex.set(a,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let e=0;e<this._maxTextures;e++)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textures[e]||this._textures[0])}_getTextureIdForImage(t){var e;if(t){const s=this._context.textureLoader.get(t);return(e=this._textureToIndex.get(s))!==null&&e!==void 0?e:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}draw(t,e,s,i,n,o,a,h,l){var c,u,d,f;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const p=this._getImageWidth(t),_=this._getImageHeight(t);let v=p||i||0,g=_||n||0;this._view[0]=0,this._view[1]=0,this._view[2]=(c=i??p)!==null&&c!==void 0?c:0,this._view[3]=(u=n??_)!==null&&u!==void 0?u:0,this._dest[0]=e??1,this._dest[1]=s??1,o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(this._view[0]=e??1,this._view[1]=s??1,this._view[2]=(d=i??p)!==null&&d!==void 0?d:0,this._view[3]=(f=n??_)!==null&&f!==void 0?f:0,this._dest[0]=o,this._dest[1]=a,v=h,g=l),e=this._view[0],s=this._view[1];const w=this._view[2],C=this._view[3],b=this._context.getTransform(),x=this._context.opacity,A=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+v,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+g,this._quad[6]=this._dest[0]+v,this._quad[7]=this._dest[1]+g,b.multiplyQuadInPlace(this._quad),A&&(this._quad[0]=~~(this._quad[0]+_t(this._quad[0])*$),this._quad[1]=~~(this._quad[1]+_t(this._quad[1])*$),this._quad[2]=~~(this._quad[2]+_t(this._quad[2])*$),this._quad[3]=~~(this._quad[3]+_t(this._quad[3])*$),this._quad[4]=~~(this._quad[4]+_t(this._quad[4])*$),this._quad[5]=~~(this._quad[5]+_t(this._quad[5])*$),this._quad[6]=~~(this._quad[6]+_t(this._quad[6])*$),this._quad[7]=~~(this._quad[7]+_t(this._quad[7])*$));const y=this._context.tint||this._defaultTint,S=this._getTextureIdForImage(t),I=p||v,R=_||g,D=(e+this.uvPadding)/I,M=(s+this.uvPadding)/R,B=(e+w-this.uvPadding)/I,F=(s+C-this.uvPadding)/R,L=p,O=_,P=this._layout.vertexBuffer.bufferData;P[this._vertexIndex++]=this._quad[0],P[this._vertexIndex++]=this._quad[1],P[this._vertexIndex++]=x,P[this._vertexIndex++]=L,P[this._vertexIndex++]=O,P[this._vertexIndex++]=D,P[this._vertexIndex++]=M,P[this._vertexIndex++]=S,P[this._vertexIndex++]=y.r/255,P[this._vertexIndex++]=y.g/255,P[this._vertexIndex++]=y.b/255,P[this._vertexIndex++]=y.a,P[this._vertexIndex++]=this._quad[4],P[this._vertexIndex++]=this._quad[5],P[this._vertexIndex++]=x,P[this._vertexIndex++]=L,P[this._vertexIndex++]=O,P[this._vertexIndex++]=D,P[this._vertexIndex++]=F,P[this._vertexIndex++]=S,P[this._vertexIndex++]=y.r/255,P[this._vertexIndex++]=y.g/255,P[this._vertexIndex++]=y.b/255,P[this._vertexIndex++]=y.a,P[this._vertexIndex++]=this._quad[2],P[this._vertexIndex++]=this._quad[3],P[this._vertexIndex++]=x,P[this._vertexIndex++]=L,P[this._vertexIndex++]=O,P[this._vertexIndex++]=B,P[this._vertexIndex++]=M,P[this._vertexIndex++]=S,P[this._vertexIndex++]=y.r/255,P[this._vertexIndex++]=y.g/255,P[this._vertexIndex++]=y.b/255,P[this._vertexIndex++]=y.a,P[this._vertexIndex++]=this._quad[6],P[this._vertexIndex++]=this._quad[7],P[this._vertexIndex++]=x,P[this._vertexIndex++]=L,P[this._vertexIndex++]=O,P[this._vertexIndex++]=B,P[this._vertexIndex++]=F,P[this._vertexIndex++]=S,P[this._vertexIndex++]=y.r/255,P[this._vertexIndex++]=y.g/255,P[this._vertexIndex++]=y.b/255,P[this._vertexIndex++]=y.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),wt.DrawnImagesCount+=this._imageCount,wt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Qd=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,Jd=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Kd{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=k.Transparent,this._scratch1=E(0,0),this._scratch2=E(0,0),this._scratch3=E(0,0),this._scratch4=E(0,0)}initialize(t,e){this._gl=t,this._context=e,this._shader=new ye({gl:t,fragmentSource:Qd,vertexSource:Jd}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new ls({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new kn(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof T&&t[1]instanceof T?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,e,s,i=1){this._isFull()&&this.flush(),this._rectangleCount++;const n=this._context.getTransform(),o=this._context.opacity,a=this._context.snapToPixel,h=e.sub(t),l=h.magnitude,c=h.normalize().perpendicular(),u=i/2,d=n.multiply(c.scale(u,this._scratch1).add(t,this._scratch1),this._scratch1),f=n.multiply(c.scale(-u,this._scratch2).add(t,this._scratch2),this._scratch2),p=n.multiply(c.scale(u,this._scratch3).add(e,this._scratch3),this._scratch3),_=n.multiply(c.scale(-u,this._scratch4).add(e,this._scratch4),this._scratch4);a&&(d.x=~~(d.x+$),d.y=~~(d.y+$),p.x=~~(p.x+$),p.y=~~(p.y+$),f.x=~~(f.x+$),f.y=~~(f.y+$),_.x=~~(_.x+$),_.y=~~(_.y+$));const v=0,g=0,w=1,C=1,b=this._transparent,x=0,A=1,y=this._layout.vertexBuffer.bufferData;y[this._vertexIndex++]=d.x,y[this._vertexIndex++]=d.y,y[this._vertexIndex++]=v,y[this._vertexIndex++]=g,y[this._vertexIndex++]=l,y[this._vertexIndex++]=i,y[this._vertexIndex++]=o,y[this._vertexIndex++]=s.r/255,y[this._vertexIndex++]=s.g/255,y[this._vertexIndex++]=s.b/255,y[this._vertexIndex++]=s.a,y[this._vertexIndex++]=b.r/255,y[this._vertexIndex++]=b.g/255,y[this._vertexIndex++]=b.b/255,y[this._vertexIndex++]=b.a,y[this._vertexIndex++]=x/A,y[this._vertexIndex++]=f.x,y[this._vertexIndex++]=f.y,y[this._vertexIndex++]=v,y[this._vertexIndex++]=C,y[this._vertexIndex++]=l,y[this._vertexIndex++]=i,y[this._vertexIndex++]=o,y[this._vertexIndex++]=s.r/255,y[this._vertexIndex++]=s.g/255,y[this._vertexIndex++]=s.b/255,y[this._vertexIndex++]=s.a,y[this._vertexIndex++]=b.r/255,y[this._vertexIndex++]=b.g/255,y[this._vertexIndex++]=b.b/255,y[this._vertexIndex++]=b.a,y[this._vertexIndex++]=x/A,y[this._vertexIndex++]=p.x,y[this._vertexIndex++]=p.y,y[this._vertexIndex++]=w,y[this._vertexIndex++]=g,y[this._vertexIndex++]=l,y[this._vertexIndex++]=i,y[this._vertexIndex++]=o,y[this._vertexIndex++]=s.r/255,y[this._vertexIndex++]=s.g/255,y[this._vertexIndex++]=s.b/255,y[this._vertexIndex++]=s.a,y[this._vertexIndex++]=b.r/255,y[this._vertexIndex++]=b.g/255,y[this._vertexIndex++]=b.b/255,y[this._vertexIndex++]=b.a,y[this._vertexIndex++]=x/A,y[this._vertexIndex++]=_.x,y[this._vertexIndex++]=_.y,y[this._vertexIndex++]=w,y[this._vertexIndex++]=C,y[this._vertexIndex++]=l,y[this._vertexIndex++]=i,y[this._vertexIndex++]=o,y[this._vertexIndex++]=s.r/255,y[this._vertexIndex++]=s.g/255,y[this._vertexIndex++]=s.b/255,y[this._vertexIndex++]=s.a,y[this._vertexIndex++]=b.r/255,y[this._vertexIndex++]=b.g/255,y[this._vertexIndex++]=b.b/255,y[this._vertexIndex++]=b.a,y[this._vertexIndex++]=x/A}drawRectangle(t,e,s,i,n=k.Transparent,o=0){this._isFull()&&this.flush(),this._rectangleCount++;const a=this._context.getTransform(),h=this._context.opacity,l=this._context.snapToPixel,c=a.multiply(t.add(E(0,0))),u=a.multiply(t.add(E(e,0))),d=a.multiply(t.add(E(e,s))),f=a.multiply(t.add(E(0,s)));l&&(c.x=~~(c.x+$),c.y=~~(c.y+$),u.x=~~(u.x+$),u.y=~~(u.y+$),f.x=~~(f.x+$),f.y=~~(f.y+$),d.x=~~(d.x+$),d.y=~~(d.y+$));const p=0,_=0,v=1,g=1,w=this._layout.vertexBuffer.bufferData;w[this._vertexIndex++]=c.x,w[this._vertexIndex++]=c.y,w[this._vertexIndex++]=p,w[this._vertexIndex++]=_,w[this._vertexIndex++]=e,w[this._vertexIndex++]=s,w[this._vertexIndex++]=h,w[this._vertexIndex++]=i.r/255,w[this._vertexIndex++]=i.g/255,w[this._vertexIndex++]=i.b/255,w[this._vertexIndex++]=i.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=f.x,w[this._vertexIndex++]=f.y,w[this._vertexIndex++]=p,w[this._vertexIndex++]=g,w[this._vertexIndex++]=e,w[this._vertexIndex++]=s,w[this._vertexIndex++]=h,w[this._vertexIndex++]=i.r/255,w[this._vertexIndex++]=i.g/255,w[this._vertexIndex++]=i.b/255,w[this._vertexIndex++]=i.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=u.x,w[this._vertexIndex++]=u.y,w[this._vertexIndex++]=v,w[this._vertexIndex++]=_,w[this._vertexIndex++]=e,w[this._vertexIndex++]=s,w[this._vertexIndex++]=h,w[this._vertexIndex++]=i.r/255,w[this._vertexIndex++]=i.g/255,w[this._vertexIndex++]=i.b/255,w[this._vertexIndex++]=i.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o,w[this._vertexIndex++]=d.x,w[this._vertexIndex++]=d.y,w[this._vertexIndex++]=v,w[this._vertexIndex++]=g,w[this._vertexIndex++]=e,w[this._vertexIndex++]=s,w[this._vertexIndex++]=h,w[this._vertexIndex++]=i.r/255,w[this._vertexIndex++]=i.g/255,w[this._vertexIndex++]=i.b/255,w[this._vertexIndex++]=i.a,w[this._vertexIndex++]=n.r/255,w[this._vertexIndex++]=n.g/255,w[this._vertexIndex++]=n.b/255,w[this._vertexIndex++]=n.a,w[this._vertexIndex++]=o}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),wt.DrawnImagesCount+=this._rectangleCount,wt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const tf=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,ef=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class sf{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new ye({gl:t,fragmentSource:tf,vertexSource:ef}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._buffer=new ls({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new kn(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,e,s,i=k.Transparent,n=0){this._isFull()&&this.flush(),this._circleCount++;const o=this._context.getTransform(),a=this._context.opacity,h=this._context.snapToPixel,l=o.multiply(t.add(E(-e,-e))),c=o.multiply(t.add(E(e,-e))),u=o.multiply(t.add(E(e,e))),d=o.multiply(t.add(E(-e,e)));h&&(l.x=~~(l.x+$),l.y=~~(l.y+$),c.x=~~(c.x+$),c.y=~~(c.y+$),d.x=~~(d.x+$),d.y=~~(d.y+$),u.x=~~(u.x+$),u.y=~~(u.y+$));const f=0,p=0,_=1,v=1,g=this._layout.vertexBuffer.bufferData;g[this._vertexIndex++]=l.x,g[this._vertexIndex++]=l.y,g[this._vertexIndex++]=f,g[this._vertexIndex++]=p,g[this._vertexIndex++]=a,g[this._vertexIndex++]=s.r/255,g[this._vertexIndex++]=s.g/255,g[this._vertexIndex++]=s.b/255,g[this._vertexIndex++]=s.a,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a,g[this._vertexIndex++]=n/e,g[this._vertexIndex++]=d.x,g[this._vertexIndex++]=d.y,g[this._vertexIndex++]=f,g[this._vertexIndex++]=v,g[this._vertexIndex++]=a,g[this._vertexIndex++]=s.r/255,g[this._vertexIndex++]=s.g/255,g[this._vertexIndex++]=s.b/255,g[this._vertexIndex++]=s.a,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a,g[this._vertexIndex++]=n/e,g[this._vertexIndex++]=c.x,g[this._vertexIndex++]=c.y,g[this._vertexIndex++]=_,g[this._vertexIndex++]=p,g[this._vertexIndex++]=a,g[this._vertexIndex++]=s.r/255,g[this._vertexIndex++]=s.g/255,g[this._vertexIndex++]=s.b/255,g[this._vertexIndex++]=s.a,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a,g[this._vertexIndex++]=n/e,g[this._vertexIndex++]=u.x,g[this._vertexIndex++]=u.y,g[this._vertexIndex++]=_,g[this._vertexIndex++]=v,g[this._vertexIndex++]=a,g[this._vertexIndex++]=s.r/255,g[this._vertexIndex++]=s.g/255,g[this._vertexIndex++]=s.b/255,g[this._vertexIndex++]=s.a,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a,g[this._vertexIndex++]=n/e}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),wt.DrawnImagesCount+=this._circleCount,wt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class zr{constructor(t,e,s=100){this.builder=t,this.recycler=e,this.maxObjects=s,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=V.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const e=t(this);return e?this.done(...e):this.done()}borrow(t){const e=this.get();t(e),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const e of t){const s=this.objects.indexOf(e);this.objects[s]=this.builder(),this.totalAllocations++}return t}}class nf{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=Ot.identity(),this.state={z:0,opacity:1,tint:k.White,material:null},this.args=new Array(10)}}const rf=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Ll{constructor(t){this._logger=V.getInstance(),this._color=k.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:e,name:s,vertexSource:i,fragmentSource:n,graphicsContext:o,images:a}=t;if(this._name=s??"anonymous material",this._vertexSource=i??rf,this._fragmentSource=n,this._color=e??this._color,!o)throw Error(`Material ${s} must be provided an excalibur webgl graphics context`);if(o instanceof xs?(this._graphicsContext=o,this._initialize(o)):this._logger.warn(`Material ${s} was created in 2D Canvas mode, currently only WebGL is supported`),a)for(const h in a)this.addImageSource(h,a[h])}_initialize(t){if(this._initialized)return;const e=t.__gl;this._maxTextureSlots=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,e){this._images.size<this._maxTextureSlots?this._images.set(t,e):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const e=this._images.get(t);this._graphicsContext.textureLoader.delete(e.image),this._images.delete(t)}_loadImageSource(t){const e=t.image,s=e.getAttribute(ot.Filtering),i=s?Zi(s):void 0,n=Ze(e.getAttribute(ot.WrappingX)),o=Ze(e.getAttribute(ot.WrappingY)),a=e.getAttribute("forceUpload")==="true",h=this._graphicsContext.textureLoader.load(e,{filtering:i,wrapping:{x:n,y:o}},a);return e.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,h),h}uploadAndBind(t,e=2){let s=e;for(const[i,n]of this._images.entries()){if(!n.isLoaded()){this._logger.warnOnce(`Image named ${i} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const o=this._loadImageSource(n);t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,o),this._shader.trySetUniformInt(i,s),s++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Jh{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,e){this._gl=t,this._context=e,this._buffer=new ls({gl:t,size:6*4,type:"dynamic"}),this._layout=new Es({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new kn(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,e,s,i,n,o,a,h,l){var c,u,d,f;const p=this._gl,_=this._context.material;if(!_)return;const v=this._context.getTransform(),g=this._context.opacity,w=_.getShader(),C=this._layout.vertexBuffer.bufferData;let b=0,x=(t==null?void 0:t.width)||i||0,A=(t==null?void 0:t.height)||n||0,y=[0,0,(c=i??(t==null?void 0:t.width))!==null&&c!==void 0?c:0,(u=n??(t==null?void 0:t.height))!==null&&u!==void 0?u:0],S=[e??1,s??1];o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(y=[e??1,s??1,(d=i??(t==null?void 0:t.width))!==null&&d!==void 0?d:0,(f=n??(t==null?void 0:t.height))!==null&&f!==void 0?f:0],S=[o,a],x=h,A=l),e=y[0],s=y[1];const I=y[2],R=y[3],D=E(S[0],S[1]),M=E(S[0]+x,S[1]),B=E(S[0],S[1]+A),F=E(S[0]+x,S[1]+A),L=t.width||x,O=t.height||A,P=e/L,Y=s/O,W=(e+I-.01)/L,q=(s+R-.01)/O,G=v.getPosition(),nt=G.add(F),he=G.x/this._context.width,le=G.y/this._context.height,K=nt.x/this._context.width,pt=nt.y/this._context.height;C[b++]=D.x,C[b++]=D.y,C[b++]=P,C[b++]=Y,C[b++]=he,C[b++]=le,C[b++]=B.x,C[b++]=B.y,C[b++]=P,C[b++]=q,C[b++]=he,C[b++]=pt,C[b++]=M.x,C[b++]=M.y,C[b++]=W,C[b++]=Y,C[b++]=K,C[b++]=le,C[b++]=F.x,C[b++]=F.y,C[b++]=W,C[b++]=q,C[b++]=K,C[b++]=pt;const ie=this._addImageAsTexture(t);_.use(),this._layout.shader=w,this._layout.use(!0),w.trySetUniformFloat("u_time_ms",performance.now()),w.trySetUniformFloat("u_opacity",g),w.trySetUniformFloatVector("u_resolution",E(this._context.width,this._context.height)),w.trySetUniformFloatVector("u_graphic_resolution",E(L,O)),w.trySetUniformFloatVector("u_size",E(I,R)),w.trySetUniformMatrix("u_matrix",this._context.ortho),w.trySetUniformMatrix("u_transform",v.to4x4()),p.activeTexture(p.TEXTURE0+0),p.bindTexture(p.TEXTURE_2D,ie),w.trySetUniformInt("u_graphic",0),p.activeTexture(p.TEXTURE0+1),p.bindTexture(p.TEXTURE_2D,this._context.materialScreenTexture),w.trySetUniformInt("u_screen_texture",1),_.uploadAndBind(p),this._quads.bind(),p.drawElements(p.TRIANGLES,6,this._quads.bufferGlType,0),wt.DrawnImagesCount++,wt.DrawCallCount++}_addImageAsTexture(t){const e=t.getAttribute(ot.Filtering),s=e?Zi(e):void 0,i=Ze(t.getAttribute(ot.WrappingX)),n=Ze(t.getAttribute(ot.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:s,wrapping:{x:i,y:n}},o);return t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&this._textures.push(a),a}hasPendingDraws(){return!1}flush(){}}const of=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,af=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var te;(function(r){r.World="world",r.Screen="screen"})(te||(te={}));class ko extends T{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Bs extends T{constructor(t,e){super(t.x,t.y),this.original=t,this.change=e}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,e){this.x=t,this.y=e}}class Cs{constructor(){this._parent=null,this._children=[],this._pos=new Bs(E(0,0),()=>{this.flagDirty()}),this._globalPos=new ko({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:e}=this.parent.inverse.multiply(E(t,this.pos.y));this.pos.x=e}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:e}=this.parent.inverse.multiply(E(this.pos.x,t));this.pos.y=e}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Bs(E(1,1),()=>{this.flagDirty()}),this._globalScale=new ko({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const e=this.parent.globalScale.x;this.scale.x=t/e}else this.scale.x=t},setY:t=>{if(this.parent){const e=this.parent.globalScale.y;this.scale.y=t/e}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=Ot.identity(),this._inverse=Ot.identity(),this._scratch=Ot.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const e=this._parent._children.indexOf(this);e>-1&&this._parent._children.splice(e,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let e=t.clone();this.parent&&(e=this.parent.inverse.multiply(t)),e.equals(this._pos)||(this._pos=e,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const e=ws(t);e!==this._rotation&&this.flagDirty(),this._rotation=e}get rotation(){return this._rotation}set globalRotation(t){let e=0;this.parent&&(e=this.parent.globalRotation);const s=ws(t+e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let e=E(1,1);this.parent&&(e=this.parent.globalScale),this.scale=t.scale(E(1/e.x,1/e.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,e,s){this._pos.x=t.x,this._pos.y=t.y,this._rotation=ws(e),this._scale.x=s.x,this._scale.y=s.y,this.flagDirty()}isMirrored(){const t=_t(this.scale.x)>>>31,e=_t(this.scale.y)>>>31;return!!(t^e)}clone(t){const e=t??new Cs;return this._pos.clone(e._pos),e._z=this._z,e._rotation=this._rotation,this._scale.clone(e._scale),e.flagDirty(),e}cloneWithParent(t){const e=t??new Cs;return this._pos.clone(e._pos),e._z=this._z,e._rotation=this._rotation,this._scale.clone(e._scale),e.parent=this.parent,e.flagDirty(),e}toString(){return this.matrix.toString()}}function Ul(r){return!!r&&!!r.prototype&&!!r.prototype.constructor}function hf(r){return!!(r!=null&&r.clone)}class Ue{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const e in this)if(this.hasOwnProperty(e)){const s=this[e];hf(s)&&e!=="owner"&&e!=="clone"?t[e]=s.clone():t[e]=s}return t}}class ue{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const e=this.observers.indexOf(t);e!==-1&&this.observers.splice(e,1)}unsubscribe(t){const e=this.subscriptions.indexOf(t);e!==-1&&this.subscriptions.splice(e,1)}notifyAll(t){const e=this.observers.length;for(let i=0;i<e;i++)this.observers[i].notify(t);const s=this.subscriptions.length;for(let i=0;i<s;i++)this.subscriptions[i](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class N extends Ue{constructor(){super(...arguments),this._logger=V.getInstance(),this._parentComponent=null,this._transform=new Cs,this._addChildTransform=t=>{const e=t.get(N);e&&(e._transform.parent=this._transform,e._parentComponent=this)},this.zIndexChanged$=new ue,this._coordPlane=te.World}get(){return this._transform}onAdd(t){for(const e of t.children)this._addChildTransform(e);t.childrenAdded$.subscribe(e=>this._addChildTransform(e)),t.childrenRemoved$.subscribe(e=>{const s=e.get(N);s&&(s._transform.parent=null,s._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const e=this._transform.z;this._transform.z=t,e!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var e;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(e=this.owner)===null||e===void 0?void 0:e.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new N;return t._transform=this._transform.clone(),t}}var pn;(function(r){r.Forward="forward",r.Backward="backward"})(pn||(pn={}));var ze;(function(r){r.End="end",r.Loop="loop",r.PingPong="pingpong",r.Freeze="freeze"})(ze||(ze={}));const lf={Frame:"frame",Loop:"loop",End:"end"};class He extends Pt{constructor(t){var e,s,i;super(t),this.events=new yt,this.frames=[],this.strategy=ze.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(e=t.speed)!==null&&e!==void 0?e:this.speed,this.strategy=(s=t.strategy)!==null&&s!==void 0?s:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(i=t.frameDuration)!==null&&i!==void 0?i:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new He({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,e,s,i=ze.Loop){const n=t.sprites.length-1,o=e.filter(a=>a<0||a>n);return o.length&&He._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${o.join(",")} no frame will be shown`),new He({frames:t.sprites.filter((a,h)=>e.indexOf(h)>-1).map(a=>({graphic:a,duration:s})),strategy:i})}static fromSpriteSheetCoordinates(t){var e;const{spriteSheet:s,frameCoordinates:i,durationPerFrame:n,durationPerFrameMs:o,speed:a,strategy:h,reverse:l}=t,c=(e=n??o)!==null&&e!==void 0?e:100,u=[];for(const d of i){const{x:f,y:p,duration:_,options:v}=d,g=s.getSprite(f,p,v);g?u.push({graphic:g,duration:_??c}):He._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${f}, ${p}), please check your SpriteSheet to confirm that sprite exists`)}return new He({frames:u,strategy:h,speed:a,reverse:l})}get speed(){return this._speed}set speed(t){this._speed=tt(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?pn.Backward:pn.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=(t==null?void 0:t.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case ze.End:case ze.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,e){this._currentFrame=t,this._timeLeftInFrame=e??this.frameDuration;const s=this.frames[this._currentFrame];s&&!this._done&&(this._timeLeftInFrame=e??((s==null?void 0:s.duration)||this.frameDuration),this.events.emit("frame",{...s,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let e=-1;switch(this.strategy){case ze.Loop:{e=(t+1)%this.frames.length,e===0&&this.events.emit("loop",this);break}case ze.End:{e=t+1,e>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case ze.Freeze:{e=tt(t+1,0,this.frames.length-1),e>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case ze.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),e=t+this._pingPongDirection%this.frames.length;break}}return e}tick(t,e=0){this._idempotencyToken!==e&&(this._idempotencyToken=e,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,e,s){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,e,s)}}He._LOGGER=V.getInstance();class Bi extends Pt{constructor(t){var e;super(t),this._logger=V.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(e=t.useAnchor)!==null&&e!==void 0?e:this.useAnchor,this._updateDimensions()}clone(){return new Bi({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new z;for(const e of this.members)if(e instanceof Pt)e.localBounds.combine(t,t);else{const{graphic:s,offset:i,useBounds:n}=e;s?(n===void 0?!0:n)&&s.localBounds.translate(i).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(e)}.`)}return t}_isAnimationOrGroup(t){return t instanceof He||t instanceof Bi}tick(t,e){for(const s of this.members){let i;s instanceof Pt?i=s:i=s.graphic,this._isAnimationOrGroup(i)&&i.tick(t,e)}}reset(){for(const t of this.members){let e;t instanceof Pt?e=t:e=t.graphic,this._isAnimationOrGroup(e)&&e.reset()}}_preDraw(t,e,s){this._updateDimensions(),super._preDraw(t,this.useAnchor?e:0,this.useAnchor?s:0)}_drawImage(t,e,s){const i=T.Zero;for(const n of this.members){let o;n instanceof Pt?o=n:(o=n.graphic,n.offset.clone(i)),o&&(t.save(),t.translate(e,s),o.draw(t,i.x,i.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class Qi extends Pt{constructor(t){var e,s,i,n,o,a,h,l,c,u;super(Rl({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=qe(k.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(e=t.quality)!==null&&e!==void 0?e:this.quality,this.color=(s=t.color)!==null&&s!==void 0?s:k.Black,this.strokeColor=t==null?void 0:t.strokeColor,this.smoothing=(i=t.smoothing)!==null&&i!==void 0?i:this.smoothing,this.lineWidth=(n=t.lineWidth)!==null&&n!==void 0?n:this.lineWidth,this.lineDash=(o=t.lineDash)!==null&&o!==void 0?o:this.lineDash,this.lineCap=(a=t.lineCap)!==null&&a!==void 0?a:this.lineCap,this.padding=(h=t.padding)!==null&&h!==void 0?h:this.padding,this.filtering=(l=t.filtering)!==null&&l!==void 0?l:this.filtering),this._bitmap=document.createElement("canvas");const d=(c=t==null?void 0:t.width)!==null&&c!==void 0?c:this._bitmap.width,f=(u=t==null?void 0:t.height)!==null&&u!==void 0?u:this._bitmap.height;this.width=d,this.height=f;const p=this._bitmap.getContext("2d");if(p)this._ctx=p;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return z.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,T.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=qe(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=qe(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var e,s,i,n;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((e=this.lineDash)!==null&&e!==void 0?e:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(i=(s=this.strokeColor)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:"",t.fillStyle=(n=this.color)===null||n===void 0?void 0:n.toString()}_drawImage(t,e,s){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,e,s)}}var fr;(function(r){r.Em="em",r.Rem="rem",r.Px="px",r.Pt="pt",r.Percent="%"})(fr||(fr={}));var pr;(function(r){r.Left="left",r.Right="right",r.Center="center",r.Start="start",r.End="end"})(pr||(pr={}));var _r;(function(r){r.Top="top",r.Hanging="hanging",r.Middle="middle",r.Alphabetic="alphabetic",r.Ideographic="ideographic",r.Bottom="bottom"})(_r||(_r={}));var gr;(function(r){r.Normal="normal",r.Italic="italic",r.Oblique="oblique"})(gr||(gr={}));var mr;(function(r){r.LeftToRight="ltr",r.RightToLeft="rtl"})(mr||(mr={}));function Fo(r,t=k.Red,e,s,i,n,o=1,a="butt"){r.save(),r.beginPath(),r.lineWidth=o,r.lineCap=a,r.strokeStyle=t.toString(),r.moveTo(e,s),r.lineTo(i,n),r.closePath(),r.stroke(),r.restore()}function cf(r,t=k.Red,e){r.beginPath(),r.strokeStyle=t.toString(),r.arc(e.x,e.y,5,0,Math.PI*2),r.closePath(),r.stroke()}function uf(r,t,e,s,i=1){const n=t?t.toString():"blue",o=s.scale(i);r.beginPath(),r.strokeStyle=n,r.moveTo(e.x,e.y),r.lineTo(e.x+o.x,e.y+o.y),r.closePath(),r.stroke()}function Bo(r,t,e,s,i,n=5,o=k.White,a=null){let h;if(typeof n=="number")h={tl:n,tr:n,br:n,bl:n};else{const l={tl:0,tr:0,br:0,bl:0};for(const c in l)if(l.hasOwnProperty(c)){const u=c;h[u]=n[u]||l[u]}}r.beginPath(),r.moveTo(t+h.tl,e),r.lineTo(t+s-h.tr,e),r.quadraticCurveTo(t+s,e,t+s,e+h.tr),r.lineTo(t+s,e+i-h.br),r.quadraticCurveTo(t+s,e+i,t+s-h.br,e+i),r.lineTo(t+h.bl,e+i),r.quadraticCurveTo(t,e+i,t,e+i-h.bl),r.lineTo(t,e+h.tl),r.quadraticCurveTo(t,e,t+h.tl,e),r.closePath(),a&&(r.fillStyle=a.toString(),r.fill()),o&&(r.strokeStyle=o.toString(),r.stroke())}function df(r,t,e,s,i=k.White,n=null){r.beginPath(),r.arc(t,e,s,0,Math.PI*2),r.closePath(),n&&(r.fillStyle=n.toString(),r.fill()),i&&(r.strokeStyle=i.toString(),r.stroke())}class Mi{constructor(t,e,s,i){this.font=t,this.text=e,this.color=s,this.maxWidth=i,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const n=this.canvas.getContext("2d");if(!n)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=n,this.dimensions=this.measureText(e),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,e){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let s=null;e!=null?s=this._getLinesFromText(t,e):s=t.split(`
`);const i=s.reduce((d,f)=>d.length>f.length?d:f);this._applyFont(this.ctx);const n=this.ctx.measureText(i);let o=Math.abs(n.actualBoundingBoxAscent)+Math.abs(n.actualBoundingBoxDescent);const a=o*s.length;o=a;const h=a-Math.abs(n.actualBoundingBoxAscent),l=0,c=0;return new z({left:l-Math.abs(n.actualBoundingBoxLeft)-this.font.padding,top:c-Math.abs(n.actualBoundingBoxAscent)-this.font.padding,bottom:c+h+this.font.padding,right:l+Math.abs(n.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,e){let s=1;this.font.lineHeight&&(s=this.font.lineHeight/this.font.size),e.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,e.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*s}static getHashCode(t,e,s){var i;return e+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((i=t.strokeColor)===null||i===void 0?void 0:i.toString())+(s?s.toString():t.color.toString()))}getHashCode(t=!0){return Mi.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var e,s,i;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((e=this.font.lineDash)!==null&&e!==void 0?e:t.getLineDash()),t.strokeStyle=(i=(s=this.font.strokeColor)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,e,s){this._applyRasterProperties(t),this._applyFont(t);for(let i=0;i<e.length;i++){const n=e[i];this.color&&t.fillText(n,0,i*s),this.font.strokeColor&&t.strokeText(n,0,i*s)}this.font.showDebug&&(Fo(t,k.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),Fo(t,k.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const e=[];let s=0,i=0;const n=Math.min(4096,t.canvas.width),o=Math.min(4096,t.canvas.height);for(;s<t.canvas.width;){for(;i<t.canvas.height;){const a=document.createElement("canvas");a.width=n,a.height=o;const h=a.getContext("2d");if(!h)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");h.drawImage(t.canvas,s,i,n,o,0,0,n,o),e.push({x:s,y:i,canvas:a}),i+=o}s+=n,i=0}return e}flagDirty(){this._dirty=!0}render(t,e,s,i){var n;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const o=this.getHashCode();if(this._lastHashCode!==o&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,i),this._setDimension(this.dimensions,this.ctx);const a=this._getLinesFromText(this.text,i),h=(n=this.font.lineHeight)!==null&&n!==void 0?n:this.dimensions.height/a.length;if(this._drawText(this.ctx,a,h),t instanceof xs)for(const l of this._textFragments)t.textureLoader.delete(l.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof xs)for(const l of this._textFragments)t.textureLoader.load(l.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=o,this._dirty=!1}for(const a of this._textFragments)t.drawImage(a.canvas,0,0,a.canvas.width,a.canvas.height,a.x/this.font.quality+e-this.ctx.canvas.width/this.font.quality/2,a.y/this.font.quality+s-this.ctx.canvas.height/this.font.quality/2,a.canvas.width/this.font.quality,a.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof xs)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,e){var s;if(this._cachedText===t&&this._cachedRenderWidth===e&&(!((s=this._cachedLines)===null||s===void 0)&&s.length))return this._cachedLines;const i=t.split(`
`);if(e==null)return i;for(let n=0;n<i.length;n++){let o=i[n],a="";if(this.measureText(o).width>e){for(;this.measureText(o).width>e;)a=o[o.length-1]+a,o=o.slice(0,-1);i[n]=o,i[n+1]=a}}return this._cachedText=t,this._cachedLines=i,this._cachedRenderWidth=e,i}}class ht{static measureText(t,e,s){const i=Mi.getHashCode(e,t);if(ht._MEASURE_CACHE.has(i))return ht._MEASURE_CACHE.get(i);ht._LOGGER.debug("Font text measurement cache miss");const n=e.measureTextWithoutCache(t,s);return ht._MEASURE_CACHE.set(i,n),n}static getTextInstance(t,e,s){const i=Mi.getHashCode(e,t,s);let n=ht._TEXT_CACHE.get(i);return n||(n=new Mi(e,t,s),ht._TEXT_CACHE.set(i,n),ht._LOGGER.debug("Font text instance cache miss")),ht._TEXT_USAGE.set(n,performance.now()),n}static checkAndClearCache(){const t=[],e=new Set;for(const[i,n]of ht._TEXT_USAGE.entries())if(n+ht.FONT_TIMEOUT<performance.now())ht._LOGGER.debug(`Text cache entry timed out ${i.text}`),t.push(i),i.dispose();else{const o=i.getHashCode(!1);e.add(o)}t.forEach(i=>{ht._TEXT_USAGE.delete(i)}),this._TEXT_CACHE.clear();for(const[i]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(i.getHashCode(),i);const s=new Map;for(const i of e)ht._MEASURE_CACHE.has(i)&&s.set(i,ht._MEASURE_CACHE.get(i));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=s}static get cacheSize(){return ht._TEXT_USAGE.size}static clearCache(){for(const[t]of ht._TEXT_USAGE.entries())t.dispose();ht._TEXT_USAGE.clear(),ht._TEXT_CACHE.clear(),ht._MEASURE_CACHE.clear()}}ht.FONT_TIMEOUT=500;ht._LOGGER=V.getInstance();ht._TEXT_USAGE=new Map;ht._TEXT_CACHE=new Map;ht._MEASURE_CACHE=new Map;class ci extends Pt{constructor(t={}){var e,s,i,n,o,a,h,l,c,u,d,f,p,_,v,g,w,C,b,x;super(t),this.filtering=Lt.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=k.Black,this.family="sans-serif",this.style=gr.Normal,this.bold=!1,this.unit=fr.Px,this.textAlign=pr.Left,this.baseAlign=_r.Top,this.direction=mr.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new z,this._textMeasurement=new Mi(this,"",k.Black),this.smoothing=(e=t==null?void 0:t.smoothing)!==null&&e!==void 0?e:this.smoothing,this.padding=(s=t==null?void 0:t.padding)!==null&&s!==void 0?s:this.padding,this.color=(i=t==null?void 0:t.color)!==null&&i!==void 0?i:this.color,this.strokeColor=(n=t==null?void 0:t.strokeColor)!==null&&n!==void 0?n:this.strokeColor,this.lineDash=(o=t==null?void 0:t.lineDash)!==null&&o!==void 0?o:this.lineDash,this.lineWidth=(a=t==null?void 0:t.lineWidth)!==null&&a!==void 0?a:this.lineWidth,this.filtering=(h=t==null?void 0:t.filtering)!==null&&h!==void 0?h:this.filtering,this.family=(l=t==null?void 0:t.family)!==null&&l!==void 0?l:this.family,this.style=(c=t==null?void 0:t.style)!==null&&c!==void 0?c:this.style,this.bold=(u=t==null?void 0:t.bold)!==null&&u!==void 0?u:this.bold,this.size=(d=t==null?void 0:t.size)!==null&&d!==void 0?d:this.size,this.unit=(f=t==null?void 0:t.unit)!==null&&f!==void 0?f:this.unit,this.textAlign=(p=t==null?void 0:t.textAlign)!==null&&p!==void 0?p:this.textAlign,this.baseAlign=(_=t==null?void 0:t.baseAlign)!==null&&_!==void 0?_:this.baseAlign,this.direction=(v=t==null?void 0:t.direction)!==null&&v!==void 0?v:this.direction,this.lineHeight=(g=t==null?void 0:t.lineHeight)!==null&&g!==void 0?g:this.lineHeight,this.quality=(w=t==null?void 0:t.quality)!==null&&w!==void 0?w:this.quality,t!=null&&t.shadow&&(this.shadow={},this.shadow.blur=(C=t.shadow.blur)!==null&&C!==void 0?C:this.shadow.blur,this.shadow.offset=(b=t.shadow.offset)!==null&&b!==void 0?b:this.shadow.offset,this.shadow.color=(x=t.shadow.color)!==null&&x!==void 0?x:this.shadow.color)}clone(){return new ci({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,e,s){}_rotate(t){var e;const s=(e=this.origin)!==null&&e!==void 0?e:this._textBounds.center;t.translate(s.x,s.y),t.rotate(this.rotation),t.translate(-s.x,-s.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,e){return this._textMeasurement.measureText(t,e)}measureText(t,e){return ht.measureText(t,this,e)}_postDraw(t){t.restore()}render(t,e,s,i,n,o){const a=ht.getTextInstance(e,this,s);this._textBounds=a.dimensions,this._preDraw(t,i,n),a.render(t,i,n,o),this._postDraw(t)}}class Fn extends Pt{constructor(t){var e,s;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(e=t.font)!==null&&e!==void 0?e:new ci,this.color=(s=t.color)!==null&&s!==void 0?s:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,e;return new Fn({text:this.text.slice(),color:(e=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&e!==void 0?e:k.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:e}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=e}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,e,s){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,e,s)}_drawImage(t,e,s){var i;let n=k.Black;this.font instanceof ci&&(n=(i=this.color)!==null&&i!==void 0?i:this.font.color);const{width:o,height:a}=this.font.measureText(this._text,this.maxWidth);this._textWidth=o,this._textHeight=a,this.font.render(t,this._text,n,e,s,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(e-o,s-a,o*2,a*2),this.maxWidth!=null&&t.debug.drawRect(e,s,this.maxWidth,this.height,{color:k.Yellow}))}}function ma(r){return!!r.tick}class It extends Ue{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Bs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Bs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const e=this.graphics.current;(e instanceof Qi||e instanceof Fn)&&(e.color=this._color)}}constructor(t){super(),this._logger=V.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Bs(T.Zero,()=>this.recalculateBounds()),this._anchor=new Bs(T.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:e,anchor:s,color:i,opacity:n,visible:o,graphics:a,offset:h,copyGraphics:l,onPreDraw:c,onPostDraw:u,onPreTransformDraw:d,onPostTransformDraw:f}=t;for(const[p,_]of Object.entries(a))_ instanceof Pt?this._graphics[p]=_:(this._graphics[p]=_.graphic,this._options[p]=_.options);this.offset=h??this.offset,this.opacity=n??this.opacity,this.anchor=s??this.anchor,this.color=i??this.color,this.copyGraphics=l??this.copyGraphics,this.onPreDraw=c??this.onPreDraw,this.onPostDraw=u??this.onPostDraw,this.onPreDraw=d??this.onPreTransformDraw,this.onPostTransformDraw=f??this.onPostTransformDraw,this.isVisible=!!o,this._current=e??this._current,e&&this._graphics[e]&&this.use(e)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,e,s){let i="default",n=null,o;if(typeof t=="string"&&e instanceof Pt&&(i=t,n=e,o=s),t instanceof Pt&&!(e instanceof Pt)&&(n=t,o=e),!n)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[i]=this.copyGraphics?n.clone():n,this._options[i]=this.copyGraphics?{...o}:o,i==="default"&&this.use("default"),n}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,e){var s;if(t instanceof Pt){let i=t;this.copyGraphics&&(i=t.clone()),this._current="default",this._graphics[this._current]=i,this._options[this._current]=e}else this._current=t,this._options[this._current]=e,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(s=this.owner)===null||s===void 0?void 0:s.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new z;const e=this._graphics[this._current],s=this._options[this._current];if(!e){this._localBounds=t;return}let i=this.anchor,n=this.offset;s!=null&&s.anchor&&(i=s.anchor),s!=null&&s.offset&&(n=s.offset);const o=e.localBounds,a=-o.width*i.x+n.x,h=-o.height*i.y+n.y;e instanceof Bi&&!e.useAnchor?t=e==null?void 0:e.localBounds.combine(t):t=e==null?void 0:e.localBounds.translate(E(a,h)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const e=this.owner.get(N);e&&(t=t.transform(e.get().matrix))}return t}update(t,e=0){const s=this.current;s&&ma(s)&&s.tick(t,e)}clone(){const t=new It;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var vr;(function(r){r.Kill="kill",r.PreKill="prekill",r.PostKill="postkill",r.PreDraw="predraw",r.PostDraw="postdraw",r.PreDebugDraw="predebugdraw",r.PostDebugDraw="postdebugdraw",r.PreUpdate="preupdate",r.PostUpdate="postupdate",r.PreFrame="preframe",r.PostFrame="postframe",r.PreCollision="precollision",r.CollisionStart="collisionstart",r.CollisionEnd="collisionend",r.PostCollision="postcollision",r.Initialize="initialize",r.Activate="activate",r.Deactivate="deactivate",r.ExitViewport="exitviewport",r.EnterViewport="enterviewport",r.ExitTrigger="exit",r.EnterTrigger="enter",r.Connect="connect",r.Disconnect="disconnect",r.Button="button",r.Axis="axis",r.Visible="visible",r.Hidden="hidden",r.Start="start",r.Stop="stop",r.PointerUp="pointerup",r.PointerDown="pointerdown",r.PointerMove="pointermove",r.PointerEnter="pointerenter",r.PointerLeave="pointerleave",r.PointerCancel="pointercancel",r.PointerWheel="pointerwheel",r.Up="up",r.Down="down",r.Move="move",r.Enter="enter",r.Leave="leave",r.Cancel="cancel",r.Wheel="wheel",r.Press="press",r.Release="release",r.Hold="hold",r.PointerDragStart="pointerdragstart",r.PointerDragEnd="pointerdragend",r.PointerDragEnter="pointerdragenter",r.PointerDragLeave="pointerdragleave",r.PointerDragMove="pointerdragmove",r.ActionStart="actionstart",r.ActionComplete="actioncomplete",r.Add="add",r.Remove="remove"})(vr||(vr={}));class J{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class Vr extends J{constructor(t){super(),this.self=t,this.target=t}}class va extends J{constructor(t){super(),this.self=t,this.target=t}}class wa extends J{constructor(t){super(),this.self=t,this.target=t}}class xa extends J{constructor(t){super(),this.self=t,this.target=t}}class ya extends J{constructor(t){super(),this.self=t,this.target=t}}class Ji extends J{constructor(t,e,s){super(),this.ctx=t,this.elapsed=e,this.self=s,this.target=s}}class Ki extends J{constructor(t,e,s){super(),this.ctx=t,this.elapsed=e,this.self=s,this.target=s}}class ba extends J{constructor(t,e,s){super(),this.ctx=t,this.elapsed=e,this.self=s,this.target=s}}class Ca extends J{constructor(t,e,s){super(),this.ctx=t,this.elapsed=e,this.self=s,this.target=s}}class Ta extends J{constructor(t,e){super(),this.ctx=t,this.self=e,this.target=e}}class Aa extends J{constructor(t,e){super(),this.ctx=t,this.self=e,this.target=e}}class Gs extends J{constructor(t,e,s){super(),this.engine=t,this.elapsed=e,this.self=s,this.target=s}}class Xs extends J{constructor(t,e,s){super(),this.engine=t,this.elapsed=e,this.self=s,this.target=s}}class Sa extends J{constructor(t,e){super(),this.engine=t,this.prevStats=e,this.target=t}}class Ea extends J{constructor(t,e){super(),this.engine=t,this.stats=e,this.target=t}}class Pa extends J{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class Ia extends J{constructor(t,e){super(),this.index=t,this.gamepad=e,this.target=e}}class Ma extends J{constructor(t,e,s,i){super(),this.button=t,this.index=e,this.value=s,this.self=i,this.target=i}}class Ra extends J{constructor(t,e,s){super(),this.axis=t,this.value=e,this.self=s,this.target=s}}class Da extends J{constructor(t){super(),this.self=t,this.target=t}}class ka extends J{constructor(t){super(),this.self=t,this.target=t}}class ui extends J{constructor(t,e,s,i,n){super(),this.self=t,this.other=e,this.side=s,this.intersection=i,this.contact=n,this.target=t}}class di extends J{constructor(t,e,s,i,n){super(),this.self=t,this.other=e,this.side=s,this.intersection=i,this.contact=n,this.target=t}}class wr{constructor(t,e,s,i){this.self=t,this.other=e,this.side=s,this.contact=i}}class xr{constructor(t,e,s,i){this.self=t,this.other=e,this.side=s,this.lastContact=i}}class yr{constructor(t,e,s,i,n){this.self=t,this.other=e,this.side=s,this.intersection=i,this.contact=n}}class br{constructor(t,e,s,i,n){this.self=t,this.other=e,this.side=s,this.intersection=i,this.contact=n}}class _n extends J{constructor(t,e,s,i){super(),this.self=t,this.other=e,this.side=s,this.contact=i,this.target=t}}class gn extends J{constructor(t,e,s,i){super(),this.self=t,this.other=e,this.side=s,this.lastContact=i,this.target=t}}class tn extends J{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class Fa extends J{constructor(t,e){super(),this.context=t,this.self=e,this.target=e}}class Ba extends J{constructor(t,e){super(),this.context=t,this.self=e,this.target=e}}class Oa extends J{constructor(t){super(),this.self=t,this.target=t}}class Na extends J{constructor(t){super(),this.self=t,this.target=t}}class La extends J{constructor(t,e){super(),this.self=t,this.entity=e,this.target=t}}class Ua extends J{constructor(t,e){super(),this.self=t,this.entity=e,this.target=t}}class za extends J{constructor(t,e){super(),this.action=t,this.self=e,this.target=e}}class Va extends J{constructor(t,e){super(),this.action=t,this.self=e,this.target=e}}class Wa extends J{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class Ha extends J{constructor(t,e){super(),this.engine=t,this.self=e,this.target=e}}class ff{constructor(t){this.data=t,this.type="Component Added"}}function pf(r){return!!r&&r.type==="Component Added"}class _f{constructor(t){this.data=t,this.type="Component Removed"}}function gf(r){return!!r&&r.type==="Component Removed"}const mf={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class oe{constructor(t,e){this.id=oe._ID++,this.name=`Entity#${this.id}`,this.events=new yt,this._tags=new Set,this.componentAdded$=new ue,this.componentRemoved$=new ue,this.tagAdded$=new ue,this.tagRemoved$=new ue,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new ue,this.childrenRemoved$=new ue,this._children=[],this._isInitialized=!1,this._isAdded=!1;let s,i;if(Array.isArray(t))s=t,i=e;else if(t&&typeof t=="object"){const{components:n,name:o,silenceWarnings:a}=t;s=n??[],i=o}if(i&&(this.name=i),s)for(const n of s)this.addComponent(n)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Vr(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let e=0;e<t.length;e++)if(!this.components.has(t[e]))return!1;return!0}hasAllTags(t){for(let e=0;e<t.length;e++)if(!this.tags.has(t[e]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&($i(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let e=this.parent;for(;e;)t.push(e),e=e.parent;return t.reverse()}getDescendants(){let t=[this],e=[this];for(;e.length>0;){const s=e.pop();s&&(e=e.concat(s.children),t=t.concat(s.children))}return t}clone(){const t=new oe;for(const e of this.types){const s=this.get(e);s&&t.addComponent(s.clone())}for(const e of this.children)t.addChild(e.clone());return t}addTemplate(t,e=!1){for(const s of t.getComponents())this.addComponent(s.clone(),e);for(const s of t.children)this.addChild(s.clone().addTemplate(s));return this}_getClassHierarchyRoot(t){var e,s;let i=t,n=(e=Object.getPrototypeOf(i.prototype))===null||e===void 0?void 0:e.constructor;for(;n&&n!==Object&&n!==Ue;)i=n,n=(s=Object.getPrototypeOf(i.prototype))===null||s===void 0?void 0:s.constructor;return i}addComponent(t,e=!1){if(this.has(t.constructor))if(e)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const i of t.dependencies)this.addComponent(new i);t.owner=this;const s=this._getClassHierarchyRoot(t.constructor);return this.components.set(s,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,e=!1){let s;if(Ul(t)?s=t:s=t.constructor,e){const i=this.components.get(s);if(i){this.componentRemoved$.notifyAll(i),i.owner=void 0,i.onRemove&&i.onRemove(this);const o=this.componentValues.indexOf(i);o>-1&&this.componentValues.splice(o,1)}const n=this._getClassHierarchyRoot(s);this.components.delete(n),this.components.delete(s)}else this._componentsToRemove.push(s);return this}clearComponents(){const t=this.types;for(const e of t)this.removeComponent(e)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new tn(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new Wa(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Ha(t,this)),this._isAdded=!1)}_preupdate(t,e){this.events.emit("preupdate",new Gs(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new Xs(t,e,this)),this.onPostUpdate(t,e)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}update(t,e){this._initialize(t),this._add(t),this._preupdate(t,e);for(const s of this.children)s.update(t,e);this._postupdate(t,e),this._remove(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){e?this.events.off(t,e):this.events.off(t)}}oe._ID=0;class at extends Ue{constructor(){super(...arguments),this.vel=T.Zero,this.acc=T.Zero,this.scaleFactor=T.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class ce{static integrate(t,e,s,i){const n=i/1e3;e.vel.addEqual(s.scale(n,ce._ACC)),t.pos.add(e.vel.scale(n,ce._VEL),ce._POS).addEqual(s.scale(.5*n*n,ce._VEL_ACC)),e.angularVelocity+=e.torque*(1/e.inertia)*n;const o=t.rotation+e.angularVelocity*n;t.scale.add(e.scaleFactor.scale(n,this._SCALE_FACTOR),ce._SCALE),t.get().setTransform(ce._POS,o,ce._SCALE)}}ce._POS=new T(0,0);ce._SCALE=new T(1,1);ce._ACC=new T(0,0);ce._VEL=new T(0,0);ce._VEL_ACC=new T(0,0);ce._SCALE_FACTOR=new T(0,0);class Wr extends oe{constructor(t){super({silenceWarnings:!0}),this.beginColor=k.White,this.endColor=k.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=k.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Qe.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new N),this.addComponent(this.motion=new at),this.addComponent(this.graphics=new It),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Qe.Global){const e=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(e),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var e,s,i,n,o,a,h,l,c,u,d,f,p,_;this.particleTransform=(e=t.transform)!==null&&e!==void 0?e:this.particleTransform,this.life=(s=t.life)!==null&&s!==void 0?s:this.life,this.fade=(i=t.fade)!==null&&i!==void 0?i:this.fade,this.size=(n=t.size)!==null&&n!==void 0?n:this.size,this.endColor=(o=t.endColor)!==null&&o!==void 0?o:this.endColor.clone(),this.beginColor=(a=t.beginColor)!==null&&a!==void 0?a:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(h=t.opacity)!==null&&h!==void 0?h:this.graphics.opacity,this.transform.pos=(l=t.pos)!==null&&l!==void 0?l:this.transform.pos,this.transform.rotation=(c=t.rotation)!==null&&c!==void 0?c:0,this.transform.scale=E(1,1),this.motion.vel=(u=t.vel)!==null&&u!==void 0?u:this.motion.vel,this.motion.angularVelocity=(d=t.angularVelocity)!==null&&d!==void 0?d:0,this.motion.acc=(f=t.acc)!==null&&f!==void 0?f:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(p=t.startSize)!==null&&p!==void 0?p:0,this.endSize=(_=t.endSize)!==null&&_!==void 0?_:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=z.fromDimension(this.size,this.size,T.Half),this.graphics.onPostDraw=v=>{v.save(),v.debug.drawPoint(E(0,0),{color:this._currentColor,size:this.size}),v.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,e){this.life=this.life-e,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=tt(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=tt(this.sizeRate*e+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=tt(this._currentColor.r+this._rRate*e,0,255),this._currentColor.g=tt(this._currentColor.g+this._gRate*e,0,255),this._currentColor.b=tt(this._currentColor.b+this._bRate*e,0,255),this._currentColor.a=this.graphics.opacity;let s=this.motion.acc;this.focus&&(s=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(e/1e3)),ce.integrate(this.transform,this.motion,s,e)}}Wr.DefaultConfig={beginColor:k.White,endColor:k.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Qe;(function(r){r.Global="global",r.Local="local"})(Qe||(Qe={}));class zl{constructor(){this.type="ex.particle",this.priority=0}initialize(t,e){this._gl=t,this._context=e,this._shader=new ye({gl:t,vertexSource:of,fragmentSource:af,onPreLink:s=>{t.transformFeedbackVaryings(s,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const e=t.getAttribute(ot.Filtering),s=e?Zi(e):void 0,i=Ze(t.getAttribute(ot.WrappingX)),n=Ze(t.getAttribute(ot.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:s,wrapping:{x:i,y:n}},o);return t.removeAttribute("forceUpload"),a}draw(t,e){var s,i,n,o,a,h,l,c,u;const d=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const f=t.particle.transform===Qe.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",f),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(s=t.particle.life)!==null&&s!==void 0?s:2e3),this._shader.setUniformFloat("deltaMs",e),this._shader.setUniformFloatVector("gravity",(i=t.particle.acc)!==null&&i!==void 0?i:E(0,0)),this._shader.setUniformFloatColor("beginColor",(n=t.particle.beginColor)!==null&&n!==void 0?n:k.Transparent),this._shader.setUniformFloatColor("endColor",(o=t.particle.endColor)!==null&&o!==void 0?o:k.Transparent);let p=(a=t.particle.startSize)!==null&&a!==void 0?a:0,_=(h=t.particle.endSize)!==null&&h!==void 0?h:0;const v=(l=t.particle.size)!==null&&l!==void 0?l:0;if(v>0&&(p=v,_=v),this._shader.setUniformFloat("startSize",p??10),this._shader.setUniformFloat("endSize",_??10),this._shader.setUniformFloat("startOpacity",(c=t.particle.opacity)!==null&&c!==void 0?c:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(u=t.particle.focusAccel)!==null&&u!==void 0?u:0)),t.particle.graphic){const g=t.particle.graphic,w=this._getTexture(g.image.image);d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,w),this._shader.setUniformInt("graphic",0)}t.draw(d)}hasPendingDraws(){return!1}flush(){}dispose(){}}const vf=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,wf=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class xf{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=k.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,e){this._gl=t,this._context=e;const s=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),i=ga(t,s);this._maxTextures=Math.min(s,i);const n=this._transformFragmentSource(vf,this._maxTextures);this._shader=new ye({gl:t,fragmentSource:n,vertexSource:wf}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",e.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((u,d)=>d)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const o=this._components;this._transformData=new ls({gl:t,size:o*this._maxImages,type:"dynamic"}),this._transformData.bind();let a=0,h=2;const l=4,c=o*4;t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(2),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(3),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(4),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(5),a+=2*l,t.vertexAttribPointer(h++,1,t.FLOAT,!1,c,a),t.enableVertexAttribArray(6),a+=1*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(7),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(8),a+=2*l,t.vertexAttribPointer(h++,1,t.FLOAT,!1,c,a),t.enableVertexAttribArray(9),a+=1*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(10),a+=2*l,t.vertexAttribPointer(h++,2,t.FLOAT,!1,c,a),t.enableVertexAttribArray(11),a+=2*l,t.vertexAttribPointer(h++,4,t.FLOAT,!1,c,a),t.enableVertexAttribArray(12),a+=4*l,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const e=this._components;this._transformData.bind(),this._transformData.upload(e*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,e){let s=t.replace("%%count%%",e.toString()),i="";for(let n=0;n<e;n++)n===0?i+=`if (v_texture_index <= ${n}.5) {
`:i+=`   else if (v_texture_index <= ${n}.5) {
`,i+=`      color = texture(u_textures[${n}], uv);
`,i+=`   }
`;return s=s.replace("%%texture_picker%%",i),s}_addImageAsTexture(t){if(this._images.has(t))return;const e=t.getAttribute(ot.Filtering),s=e?Zi(e):void 0,i=Ze(t.getAttribute(ot.WrappingX)),n=Ze(t.getAttribute(ot.WrappingY)),o=t.getAttribute("forceUpload")==="true",a=this._context.textureLoader.load(t,{filtering:s,wrapping:{x:i,y:n}},o);t.removeAttribute("forceUpload"),this._textures.indexOf(a)===-1&&(this._textures.push(a),this._textureToIndex.set(a,this._textureIndex++),this._images.add(t))}_bindTextures(t){const e=Math.min(this._textureIndex,this._maxTextures);for(let s=0;s<e;s++)t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(t){var e;if(t){const s=this._context.textureLoader.get(t);return(e=this._textureToIndex.get(s))!==null&&e!==void 0?e:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}draw(t,e,s,i,n,o,a,h,l){var c,u,d,f;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const p=this._getImageWidth(t),_=this._getImageHeight(t);let v=p||i||0,g=_||n||0;this._view[0]=0,this._view[1]=0,this._view[2]=(c=i??p)!==null&&c!==void 0?c:0,this._view[3]=(u=n??_)!==null&&u!==void 0?u:0,this._dest[0]=e??1,this._dest[1]=s??1,o!==void 0&&a!==void 0&&h!==void 0&&l!==void 0&&(this._view[0]=e??1,this._view[1]=s??1,this._view[2]=(d=i??p)!==null&&d!==void 0?d:0,this._view[3]=(f=n??_)!==null&&f!==void 0?f:0,this._dest[0]=o,this._dest[1]=a,v=h,g=l),e=this._view[0],s=this._view[1];const w=this._view[2],C=this._view[3],b=this._context.getTransform(),x=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+$),this._dest[1]=~~(this._dest[1]+$));const y=this._context.tint||this._defaultTint,S=this._getTextureIdForImage(t),I=p||v,R=_||g,D=(e+this.uvPadding)/I,M=(s+this.uvPadding)/R,B=(e+w-this.uvPadding)/I,F=(s+C-this.uvPadding)/R,L=p,O=_,P=this._transformData.bufferData;P[this._vertexIndex++]=this._dest[0],P[this._vertexIndex++]=this._dest[1],P[this._vertexIndex++]=b.data[0],P[this._vertexIndex++]=b.data[1],P[this._vertexIndex++]=b.data[2],P[this._vertexIndex++]=b.data[3],P[this._vertexIndex++]=b.data[4],P[this._vertexIndex++]=b.data[5],P[this._vertexIndex++]=x,P[this._vertexIndex++]=v,P[this._vertexIndex++]=g,P[this._vertexIndex++]=L,P[this._vertexIndex++]=O,P[this._vertexIndex++]=S,P[this._vertexIndex++]=D,P[this._vertexIndex++]=M,P[this._vertexIndex++]=B,P[this._vertexIndex++]=F,P[this._vertexIndex++]=y.r/255,P[this._vertexIndex++]=y.g/255,P[this._vertexIndex++]=y.b/255,P[this._vertexIndex++]=y.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),wt.DrawnImagesCount+=this._imageCount,wt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const $=1e-4;class yf{constructor(t){this._webglCtx=t,this._debugText=new _a}drawRect(t,e,s,i,n={color:k.Black}){this.drawLine(E(t,e),E(t+s,e),{...n}),this.drawLine(E(t+s,e),E(t+s,e+i),{...n}),this.drawLine(E(t+s,e+i),E(t,e+i),{...n}),this.drawLine(E(t,e+i),E(t,e),{...n})}drawLine(t,e,s){var i;this._webglCtx.draw("ex.line",t,e,(i=s==null?void 0:s.color)!==null&&i!==void 0?i:k.Black)}drawPoint(t,e={color:k.Black,size:5}){this._webglCtx.draw("ex.point",t,e.color,e.size)}drawText(t,e){this._debugText.write(this._webglCtx,t,e)}}class xs{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let e=!0;return(t.width>4096||t.height>4096)&&(e=!1),e}constructor(t){this._logger=V.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Jt.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new zr(()=>new nf,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new kd,this._state=new Dl,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=k.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new yf(this),this._totalPostProcessorTime=0;const{canvasElement:e,context:s,enableTransparency:i,antialiasing:n,uvPadding:o,multiSampleAntialiasing:a,pixelArtSampler:h,powerPreference:l,snapToPixel:c,backgroundColor:u,useDrawSorting:d,garbageCollector:f,handleContextLost:p,handleContextRestored:_}=t;if(this.__gl=s??e.getContext("webgl2",{antialias:n??this.smoothing,premultipliedAlpha:!1,alpha:i??this.transparency,depth:!1,powerPreference:l??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");p&&this.__gl.canvas.addEventListener("webglcontextlost",p,!1),_&&this.__gl.canvas.addEventListener("webglcontextrestored",_,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new At(this.__gl,f),this.snapToPixel=c??this.snapToPixel,this.smoothing=n??this.smoothing,this.transparency=i??this.transparency,this.pixelArtSampler=h??this.pixelArtSampler,this.uvPadding=o??this.uvPadding,this.multiSampleAntialiasing=typeof a=="boolean"?a:this.multiSampleAntialiasing,this.samples=typeof a=="object"?a.samples:void 0,this.backgroundColor=u??this.backgroundColor,this.useDrawSorting=d??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=Ce.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new Zd({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Jh),this.register(new Kd),this.register(new sf),this.register(new qd),this.register(new Vd),this.lazyRegister("ex.particle",()=>new zl),this.register(new xf({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new jd(t),this._renderTarget=new Jn({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new Jn({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new Jn({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new Jn({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,e){this._lazyRenderersFactory.set(t,e)}get(t){let e=this._renderers.get(t);if(!e){const s=this._lazyRenderersFactory.get(t);s&&(this._logger.debug("lazy init renderer:",t),e=s(),this.register(e))}return e}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...e){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const s=this.get(t);if(s)if(this.useDrawSorting){const i=this._drawCallPool.get();i.z=this._state.current.z,i.priority=s.priority,i.renderer=t,this.getTransform().clone(i.transform),i.state.z=this._state.current.z,i.state.opacity=this._state.current.opacity,i.state.tint=this._state.current.tint,i.state.material=this._state.current.material,i.args[0]=e[0],i.args[1]=e[1],i.args[2]=e[2],i.args[3]=e[3],i.args[4]=e[4],i.args[5]=e[5],i.args[6]=e[6],i.args[7]=e[7],i.args[8]=e[8],i.args[9]=e[9],this._drawCalls[this._drawCallIndex++]=i}else this._currentRenderer||(this._currentRenderer=s),this._isCurrentRenderer(s)||this._currentRenderer.flush(),s.draw(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]),this._currentRenderer=s;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const e=this.__gl;this._ortho=this._ortho=Ce.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(e.canvas.width,e.canvas.height),this._msaaTarget.setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[0].setResolution(e.canvas.width,e.canvas.height),this._postProcessTargets[1].setResolution(e.canvas.width,e.canvas.height)}_getImageWidth(t){let e=this._imageToWidth.get(t);return e===void 0&&(e=t.width,this._imageToWidth.set(t,e)),e}_getImageHeight(t){let e=this._imageToHeight.get(t);return e===void 0&&(e=t.height,this._imageToHeight.set(t,e)),e}drawImage(t,e,s,i,n,o,a,h,l){if(!(i===0||n===0)){{if(h===0||l===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){V.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,e,s,i,n,o,a,h,l):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,e,s,i,n,o,a,h,l):this.draw(this.imageRenderer,t,e,s,i,n,o,a,h,l)}}drawLine(t,e,s,i=1){this.draw("ex.rectangle",t,e,s,i)}drawRectangle(t,e,s,i,n,o){this.draw("ex.rectangle",t,e,s,i,n,o)}drawCircle(t,e,s,i,n){this.draw("ex.circle",t,e,s,i,n)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,e){this._transform.translate(this.snapToPixel?~~(t+$):t,this.snapToPixel?~~(e+$):e)}rotate(t){this._transform.rotate(t)}scale(t,e){this._transform.scale(t,e)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const e=this._postprocessors.indexOf(t);e!==-1&&this._postprocessors.splice(e,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const e of this._postprocessors){const s=e.getShader();s.use();const i=s.getUniforms();this._totalPostProcessorTime+=t,i.find(n=>n.name==="u_time_ms")&&s.setUniformFloat("u_time_ms",this._totalPostProcessorTime),i.find(n=>n.name==="u_elapsed_ms")&&s.setUniformFloat("u_elapsed_ms",t),i.find(n=>n.name==="u_resolution")&&s.setUniformFloatVector("u_resolution",E(this.width,this.height)),e.onUpdate&&e.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Ll({...t,graphicsContext:this})}createShader(t){const e=this.__gl,{vertexSource:s,fragmentSource:i}=t,n=new ye({gl:e,vertexSource:s,fragmentSource:i});return n.compile(),n}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let e=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(e.use(),this.useDrawSorting){for(let o=this._drawCallIndex;o<this._drawCalls.length;o++)this._drawCalls[o]=null;const s=new Map;for(const[o]of this._renderers){let a=0;for(a=0;a<this._drawCallIndex&&this._drawCalls[a].renderer!==o;a++);s.set(o,a)}this._drawCalls.sort((o,a)=>{if(o===null||a===null)return 0;const h=o.z-a.z,l=s.get(o.renderer)-s.get(a.renderer),c=o.priority-a.priority;return h===0?c===0?l:c:h});const i=this._transform.current,n=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let o=this._drawCalls[0].renderer,a=this.get(o);for(let h=0;h<this._drawCallIndex;h++)this._transform.current=this._drawCalls[h].transform,this._state.current=this._drawCalls[h].state,this._drawCalls[h].renderer!==o&&(a.flush(),o=this._drawCalls[h].renderer,a=this.get(o)),a instanceof Jh&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(e.copyToTexture(this.materialScreenTexture),e.use()),a.draw(...this._drawCalls[h].args);a.hasPendingDraws()&&a.flush()}this._transform.current=i,this._state.current=n,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const s of this._renderers.values())s.hasPendingDraws()&&s.flush();e.disable(),this._postprocessors.length>0&&e.toRenderSource().use();for(let s=0;s<this._postprocessors.length;s++)e=this._postProcessTargets[s%2],this._postProcessTargets[s%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[s]),this._postProcessTargets[s%2].toRenderSource().use();e.blitToScreen()}}const Rt=1e-4;class bf{constructor(t){this._ex=t,this._debugText=new _a}drawRect(t,e,s,i){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+Rt):t,this._ex.snapToPixel?~~(e+Rt):e,this._ex.snapToPixel?~~(s+Rt):s,this._ex.snapToPixel?~~(i+Rt):i),this._ex.__ctx.restore()}drawLine(t,e,s={color:k.Black}){var i,n;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(n=(i=s.color)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+Rt):t.x,this._ex.snapToPixel?~~(t.y+Rt):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(e.x+Rt):e.x,this._ex.snapToPixel?~~(e.y+Rt):e.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,e={color:k.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=e.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+Rt):t.x,this._ex.snapToPixel?~~(t.y+Rt):t.y,e.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,e){this._debugText.write(this._ex,t,e)}}class Cr{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=k.ExcaliburBlue,this._state=new Dl,this.snapToPixel=!1,this.debug=new bf(this);const{canvasElement:e,context:s,enableTransparency:i,snapToPixel:n,antialiasing:o,backgroundColor:a}=t;if(this.__ctx=s??e.getContext("2d",{alpha:i??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=a??this.backgroundColor,this.snapToPixel=n??this.snapToPixel,this.smoothing=o??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,e,s,i,n,o,a,h,l){if(i===0||n===0)return;if(h===0||l===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const c=[t,e,s,i,n,o,a,h,l].filter(u=>u!==void 0).map(u=>typeof u=="number"&&this.snapToPixel?~~u:u);this.__ctx.drawImage.apply(this.__ctx,c),wt.DrawCallCount++,wt.DrawnImagesCount=1}drawLine(t,e,s,i=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=s.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+Rt):t.x,this.snapToPixel?~~(t.y+Rt):t.y),this.__ctx.lineTo(this.snapToPixel?~~(e.x+Rt):e.x,this.snapToPixel?~~(e.y+Rt):e.y),this.__ctx.lineWidth=i,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,e,s,i){this.__ctx.save(),this.__ctx.fillStyle=i.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+Rt):t.x,this.snapToPixel?~~(t.y+Rt):t.y,this.snapToPixel?~~(e+Rt):e,this.snapToPixel?~~(s+Rt):s),this.__ctx.restore()}drawCircle(t,e,s,i,n){this.__ctx.save(),this.__ctx.beginPath(),i&&(this.__ctx.strokeStyle=i.toString()),n&&(this.__ctx.lineWidth=n),this.__ctx.fillStyle=s.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+Rt):t.x,this.snapToPixel?~~(t.y+Rt):t.y,e,0,Math.PI*2),this.__ctx.fill(),i&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,e){this.__ctx.translate(this.snapToPixel?~~(t+Rt):t,this.snapToPixel?~~(e+Rt):e)}rotate(t){this.__ctx.rotate(t)}scale(t,e){this.__ctx.scale(t,e)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),wt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Xt;(function(r){r.Fixed="Fixed",r.FitContainerAndFill="FitContainerAndFill",r.FitScreenAndFill="FitScreenAndFill",r.FitContainerAndZoom="FitContainerAndZoom",r.FitScreenAndZoom="FitScreenAndZoom",r.FitScreen="FitScreen",r.FillScreen="FillScreen",r.FitContainer="FitContainer",r.FillContainer="FillContainer"})(Xt||(Xt={}));class Oo{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Cf={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class No{constructor(t){var e,s,i,n;this.events=new yt,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=V.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const o=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(o),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new z,this._unsafeArea=new z,this.viewport=t.viewport,this.resolution=(e=t.resolution)!==null&&e!==void 0?e:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(s=t.displayMode)!==null&&s!==void 0?s:Xt.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(i=t.antialiasing)!==null&&i!==void 0?i:this._antialiasing,this._canvasImageRendering=(n=t.canvasImageRendering)!==null&&n!==void 0?n:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(T.Zero);return this.worldToPageCoordinates(E(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Xt.FillContainer:case Xt.FitContainer:case Xt.FitContainerAndFill:case Xt.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof xs&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let i=Math.max(1,this.pixelRatio-.5),n=!1;for(;i>1&&!n;){i=Math.max(1,i-.5);const o=this._resolution.width*i,a=this._resolution.height*i;n=this.graphicsContext.checkIfResolutionSupported({width:o,height:a})}this.pixelRatioOverride=i,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",e=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+e,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Cr&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var e,s,i,n,o,a;if(t){const h=document.getElementById(t);if(h!=null&&h.requestFullscreen||h!=null&&h.webkitRequestFullscreen){if(h.getAttribute("ex-fullscreen-listener")||(h.setAttribute("ex-fullscreen-listener","true"),h.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),h.requestFullscreen)return(e=h.requestFullscreen())!==null&&e!==void 0?e:Promise.resolve();if(h.webkitRequestFullscreen)return(s=h.webkitRequestFullscreen())!==null&&s!==void 0?s:Promise.resolve()}}return!((i=this._canvas)===null||i===void 0)&&i.requestFullscreen?(o=(n=this._canvas)===null||n===void 0?void 0:n.requestFullscreen())!==null&&o!==void 0?o:Promise.resolve():this._canvas.webkitRequestFullscreen?(a=this._canvas.webkitRequestFullscreen())!==null&&a!==void 0?a:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let e=t.x,s=t.y;this._isFullscreen||(e-=cn(this._canvas).x,s-=cn(this._canvas).y);const i=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const n=window.innerWidth/this.aspectRatio,o=(window.innerHeight-n)/2;s=(s-o)/n*i.height,e=e/window.innerWidth*i.width}else{const n=window.innerHeight*this.aspectRatio,o=(window.innerWidth-n)/2;e=(e-o)/n*i.width,s=s/window.innerHeight*i.height}return e=e/i.width*this.resolution.width,s=s/i.height*this.resolution.height,e=e-this.contentArea.left,s=s-this.contentArea.top,new T(e,s)}screenToPageCoordinates(t){let e=t.x,s=t.y;const i=this._viewportToPixels(this.viewport);if(e=e/this.resolution.width*i.width,s=s/this.resolution.height*i.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const n=window.innerWidth/this.aspectRatio,o=(window.innerHeight-n)/2;s=s/i.height*n+o,e=e/i.width*window.innerWidth}else{const n=window.innerHeight*this.aspectRatio,o=(window.innerWidth-n)/2;e=e/i.width*n+o,s=s/i.height*window.innerHeight}return this._isFullscreen||(e+=cn(this._canvas).x,s+=cn(this._canvas).y),new T(e,s)}screenToWorldCoordinates(t){return t=t.add(E(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(E(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(E(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const e=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(e)}worldToPageCoordinates(t){const e=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(e)}getWorldBounds(){return z.fromDimension(this.resolution.width,this.resolution.height,T.Half).scale(E(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return z.fromDimension(this.resolution.width,this.resolution.height,T.Zero,T.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return E(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let e=0,s=0;window.innerWidth/t<window.innerHeight?(e=window.innerWidth,s=window.innerWidth/t):(e=window.innerHeight*t,s=window.innerHeight),this.viewport={width:e,height:s},this._contentArea=z.fromDimension(this.resolution.width,this.resolution.height,T.Zero),this._unsafeArea=z.fromDimension(this.resolution.width,this.resolution.height,T.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,e=window.innerHeight;this._computeFitAndFill(t,e),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,e,s){if(this.viewport=s??{width:t,height:e},t/e<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*e/t};const i=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new z({top:i,left:0,right:this._contentResolution.width,bottom:this.resolution.height-i}),this._unsafeArea=new z({top:-i,left:0,right:this._contentResolution.width,bottom:this.resolution.height+i})}else{this.resolution={width:e*this._contentResolution.height/e*t/e,height:e*this._contentResolution.height/e};const i=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new z({top:0,left:i,right:this.resolution.width-i,bottom:this._contentResolution.height}),this._unsafeArea=new z({top:0,left:-i,right:this.resolution.width+i,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,e=window.innerHeight;this._computeFitAndZoom(t,e),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:e,offsetHeight:s}=this.canvas;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,e){const s=this.aspectRatio;let i=0,n=0;t/s<e?(i=t,n=t/s):(i=e*s,n=e);const o=t/i,a=e/n,h=Math.max(o,a),l=i*h,c=n*h;l>t?this.canvas.style.left=-(l-t)/2+"px":this.canvas.style.left="",c>e?this.canvas.style.top=-(c-e)/2+"px":this.canvas.style.top="",this.viewport={width:l,height:c};const u=z.fromDimension(this.viewport.width,this.viewport.height,T.Zero);if(this.viewport.width>t){const d=(this.viewport.width-t)/this.viewport.width*this.resolution.width;u.top=0,u.left=d/2,u.right=this.resolution.width-d/2,u.bottom=this.resolution.height}if(this.viewport.height>e){const d=(this.viewport.height-e)/this.viewport.height*this.resolution.height;u.top=d/2,u.left=0,u.bottom=this.resolution.height-d/2,u.right=this.resolution.width}this._contentArea=u}_computeFitContainer(){const t=this.aspectRatio;let e=0,s=0,i="pixel",n="pixel";const o=this.canvas.parentElement;o.clientWidth/t<o.clientHeight?(this.canvas.style.width="100%",e=100,i="percent",s=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",s=100,n="percent",e=this.canvas.offsetHeight*t),this.viewport={width:e,widthUnit:i,height:s,heightUnit:n},this._contentArea=z.fromDimension(this.resolution.width,this.resolution.height,T.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===Xt.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Xt.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=z.fromDimension(this.resolution.width,this.resolution.height,T.Zero),this.displayMode===Xt.FitScreen&&this._computeFit(),this.displayMode===Xt.FitContainer&&this._computeFitContainer(),this.displayMode===Xt.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Xt.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Xt.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Xt.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class mn{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Tf(r){return!!r.playbackState}class ii{static unlock(){return new Promise((e,s)=>{if(ii._UNLOCKED||!mn.create())return e(!0);const i=setTimeout(()=>{V.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),e(!1)},200),n=mn.create();n.resume().then(()=>{const o=n.createBuffer(1,1,22050),a=n.createBufferSource();let h=!1;a.buffer=o,a.connect(n.destination),a.onended=()=>h=!0,a.start(0),setTimeout(()=>{Tf(a)?(a.playbackState===a.PLAYING_STATE||a.playbackState===a.FINISHED_STATE)&&(ii._UNLOCKED=!0):(n.currentTime>0||h)&&(ii._UNLOCKED=!0)},0),clearTimeout(i),e(!0)},()=>{s()})})}static isUnlocked(){return this._UNLOCKED}}ii._UNLOCKED=!1;class Hr extends Qi{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Hr({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var e,s;!((e=this._options)===null||e===void 0)&&e.draw&&((s=this._options)===null||s===void 0||s.draw(t)),this._options.cache||this.flagDirty()}}class qa{}qa.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class qr{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,e){const s=new qr;s.data=e;for(const i in t.states)s.states.set(i,{name:i,...t.states[i]});for(const i of s.states.values())for(const n of i.transitions)if(n!=="*"&&!s.states.has(n))throw Error(`Invalid state machine, state [${i.name}] has a transition to another state that doesn't exist [${n}]`);return s.currentState=s.startState=s.states.get(t.start),s}in(t){return this.currentState.name===t}go(t,e){var s,i;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const n=this.states.get(t);return this.currentState.onExit&&((s=this.currentState)===null||s===void 0?void 0:s.onExit({to:n.name,data:this.data}))===!1||n!=null&&n.onEnter&&(n==null?void 0:n.onEnter({from:this.currentState.name,eventData:e,data:this.data}))===!1?!1:(this.currentState=n,!((i=this.currentState)===null||i===void 0)&&i.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const e=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(e.currentState),this.data=e.data}}class Vl{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=tt(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=mn.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new De,this._stateMachine=qr.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:e})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,e.pausedAt*this._playbackRate):this._instance.start(0,e.pausedAt*this._playbackRate,this.duration),e.startedAt=this._audioContext.currentTime-e.pausedAt,e.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:e})=>{e==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:e,data:s})=>{s.pausedAt=(e??0)/this._playbackRate,s.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:e})=>{e.pausedAt=0,e.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:e})=>{e.pausedAt=this._audioContext.currentTime-e.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:e}=this._stateMachine.data;return t?t*this._playbackRate:e?(this._audioContext.currentTime-e)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class Ga extends J{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,e="MediaEvent"){super(),this.target=t,this._name=e}stopPropagation(){}action(){}propagate(){}layPath(t){}}class Ks extends Ga{constructor(t,e){super(t,"NativeSoundEvent"),this.track=e}}class Wl extends Ga{constructor(t,e){super(t,"NativeSoundProcessedEvent"),this._processedData=e,this.data=this._processedData}}function Af(r){try{const t=new Audio,e=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,s=r.match(e)[1];return!!t.canPlayType("audio/"+s)}catch(t){return V.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const Sf={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Hl{set loop(t){this._loop=t;for(const e of this._tracks)e.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const e of this._tracks)e.volume=this._volume;this.events.emit("volumechange",new Ks(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new yt,this.logger=V.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=mn.create(),this._resource=new Rn("",qa.type.arraybuffer);for(const e of t)if(Af(e)){this.path=e;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,e;if(this.data)return this.data;const s=await this._resource.load(),i=await this.decodeAudio(s.slice(0));return this._duration=(e=(t=this._duration)!==null&&t!==void 0?t:i==null?void 0:i.duration)!==null&&e!==void 0?e:void 0,this.events.emit("processed",new Wl(this,i)),this.data=i}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new Ks(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new Ks(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(e=>{e.playbackRate=this._playbackRate})}seek(t,e=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[e].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const e of this._tracks)t.push(e.play().then(()=>(this._tracks.splice(this.getTrackId(e),1),!0)));this.events.emit("resume",new Ks(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),e=await t.play(()=>{this.events.emit("playbackstart",new Ks(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new Ks(this,t));const s=this.getTrackId(t);return s!==-1&&this._tracks.splice(s,1),e}_getTrackInstance(t){var e;const s=new Vl(t);return s.loop=this.loop,s.volume=this.volume,s.duration=(e=this.duration)!==null&&e!==void 0?e:0,s.playbackRate=this._playbackRate,this._tracks.push(s),s}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}const Ef={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Lo(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class vn{get resources(){return this._resources}constructor(t){var e;this.events=new yt,this.canvas=new Hr({filtering:Lt.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new De,t&&(!((e=t.loadables)===null||e===void 0)&&e.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await ur(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let e=0;const s=t.length;for(e;e<s;e++)this.addResource(t[e])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?tt(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,e){this._totalTimeMs+=e}onDraw(t){const e=this._totalTimeMs/1e3;t.fillStyle=k.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const s=e*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,s,s+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const i=(this.progress*100).toFixed(0)+"%",n=t.measureText(i),o=Math.abs(n.actualBoundingBoxLeft)+Math.abs(n.actualBoundingBoxRight),a=Math.abs(n.actualBoundingBoxAscent)+Math.abs(n.actualBoundingBoxDescent);t.fillText(i,-o/2,a/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof Hl&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await ii.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}const Pf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var If=Zt(851);class fi extends vn{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const e=Array.isArray(t)?{loadables:t}:t;super(e),this._logger=V.getInstance(),this._originalOptions={loadables:[]},this.events=new yt,this._playButtonShown=!1,this.logo=Pf,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=k.White,this.backgroundColor="#176BAA",this._imageLoaded=new De,this.suppressPlayButton=!1,this._playButtonStyles=If.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let s=document.getElementById("excalibur-play");return s||(s=document.createElement("button")),s.id="excalibur-play",s.textContent=this.playButtonText,s.style.display="none",s},this._originalOptions={...fi._DEFAULT_LOADER_OPTIONS,...e}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,e;if(this.suppressPlayButton)this.hidePlayButton(),await ur(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const s=()=>{try{this._positionPlayButton()}catch{}};return!((e=this.engine)===null||e===void 0)&&e.browser&&this.engine.browser.window.on("resize",s),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",n=>{n.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(n=>{const o=a=>{var h;if(a.stopPropagation(),this.hidePlayButton(),!((h=this.engine)===null||h===void 0)&&h.browser&&this.engine.browser.window.off("resize",s),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(l){this._logger.error("could not go fullscreen",l)}n()};this._playButton.addEventListener("click",o),this._playButton.addEventListener("touchend",o),this._playButton.addEventListener("pointerup",o),this.engine&&this.engine.input.gamepads.once("button",()=>o(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await ur(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await(t==null?void 0:t.decode())}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:e,width:s,height:i}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const n=this._playButton.clientWidth,o=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+s/2-n/2}px`,this._playButtonRootElement.style.top=`${e+i/2-o/2+100}px`)}}}onDraw(t){const e=this.engine.canvasHeight/this.engine.pixelRatio,s=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,s,e);let i=e/2;const n=Math.min(this.logoWidth,s*.75);let o=s/2-n/2;this.logoPosition&&(o=this.logoPosition.x,i=this.logoPosition.y);const a=Math.floor(n*(this.logoHeight/this.logoWidth)),h=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,o,i,n,a):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,o,i-a-20,n,a),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=h;return}let l=o,c=i;this.loadingBarPosition&&(l=this.loadingBarPosition.x,c=this.loadingBarPosition.y),t.lineWidth=2,Bo(t,l,c,n,20,10,this.loadingBarColor);const u=n*this.progress,d=5,f=u-d*2,p=20-d*2;Bo(t,l+d,c+d,f>10?f:10,p,5,null,this.loadingBarColor),this.engine.screen.antialiasing=h}}fi._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Kh={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class ql{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const e=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],s=this.getBrowserFeatures();for(const i of Object.keys(Kh))s[i]?(t+="(%c%c)",e.push("font-weight: bold; color: green"),e.push("font-weight: normal; color: inherit")):(t+="(%c%c)",e.push("font-weight: bold; color: red"),e.push("font-weight: normal; color: inherit")),t+=" "+Kh[i]+`
`;e.unshift(t),console.log.apply(console,e)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const e in this._criticalTests)this._criticalTests[e].call(this)||(this.failedTests.push(e),V.getInstance().error("Critical browser feature missing, Excalibur requires:",e),t=!0);if(t)return!1;for(const e in this._warningTest)this._warningTest[e]()||V.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",e);return!0}}var X;(function(r){r.PreventCollision="PreventCollision",r.Passive="Passive",r.Active="Active",r.Fixed="Fixed"})(X||(X={}));class os{static create(t,e){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const i=this._GROUPS.get(t);if(i.mask===e)return i;throw new Error(`Collision group ${t} already exists with a different mask!`)}const s=new Ts(t,this._CURRENT_BIT,e!==void 0?e:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,s),s}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}os._STARTING_BIT=1;os._MAX_GROUPS=32;os._CURRENT_GROUP=1;os._CURRENT_BIT=os._STARTING_BIT;os._GROUPS=new Map;class Ts{constructor(t,e,s){this._name=t,this._category=e,this._mask=s}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const e=this.category&t.mask,s=this.mask&t.category;return e!==0&&s!==0}invert(){const t=os.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const e=t.map(n=>n.name).join("+"),i=~t.reduce((n,o)=>o.category|n,0);return os.create(e,i)}static collidesWith(t){const e=`collidesWith(${t.map(i=>i.name).join("+")})`,s=t.reduce((i,n)=>n.category|i,0);return os.create(e,s)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}Ts.All=new Ts("Collide with all groups",-1,-1);class de{constructor(t,e){this.colliderA=t,this.colliderB=e,this.id=null,this.id=de.calculatePairHash(t.id,e.id)}static canCollide(t,e){var s,i;if(t.id===e.id||t.owner&&e.owner&&t.owner.id===e.owner.id||t.localBounds.hasZeroDimensions()||e.localBounds.hasZeroDimensions())return!1;const n=(s=t==null?void 0:t.owner)===null||s===void 0?void 0:s.get(it),o=(i=e==null?void 0:e.owner)===null||i===void 0?void 0:i.get(it);return!(!n||!o||!n.group.canCollide(o.group)||n.collisionType===X.Fixed&&o.collisionType===X.Fixed||o.collisionType===X.PreventCollision||n.collisionType===X.PreventCollision||!n.isActive||!o.isActive)}get canCollide(){const t=this.colliderA,e=this.colliderB;return de.canCollide(t,e)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,e){return t.value<e.value?`#${t.value}+${e.value}`:`#${e.value}+${t.value}`}}class Bn{constructor(t,e){this.min=t,this.max=e}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class Uo{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new z,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Xa{constructor(t,e=new z(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=e,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const e=t.bounds;let s=this.root;for(;!s.isLeaf();){const a=s.left,h=s.right,l=s.bounds.getPerimeter(),u=s.bounds.combine(e).getPerimeter(),d=2*u,f=2*(u-l);let p=0;const _=e.combine(a.bounds);let v,g;a.isLeaf()?p=_.getPerimeter()+f:(g=a.bounds.getPerimeter(),v=_.getPerimeter(),p=v-g+f);let w=0;const C=e.combine(h.bounds);if(h.isLeaf()?w=C.getPerimeter()+f:(g=h.bounds.getPerimeter(),v=C.getPerimeter(),w=v-g+f),d<p&&d<w)break;p<w?s=a:s=h}const i=s.parent,n=new Uo(i);n.bounds=e.combine(s.bounds),n.height=s.height+1,i!==null?(i.left===s?i.left=n:i.right=n,n.left=s,n.right=t,s.parent=n,t.parent=n):(n.left=s,n.right=t,s.parent=n,t.parent=n,this.root=n);let o=t.parent;for(;o;){if(o=this._balance(o),!o.left)throw new Error("Parent of current leaf cannot have a null left child"+o);if(!o.right)throw new Error("Parent of current leaf cannot have a null right child"+o);o.height=1+Math.max(o.left.height,o.right.height),o.bounds=o.left.bounds.combine(o.right.bounds),o=o.parent}}_remove(t){if(t===this.root){this.root=null;return}const e=t.parent,s=e.parent;let i;if(e.left===t?i=e.right:i=e.left,s){s.left===e?s.left=i:s.right=i,i.parent=s;let n=s;for(;n;)n=this._balance(n),n.bounds=n.left.bounds.combine(n.right.bounds),n.height=1+Math.max(n.left.height,n.right.height),n=n.parent}else this.root=i,i.parent=null}trackCollider(t){const e=new Uo;e.data=t,e.bounds=t.bounds,e.bounds.left-=2,e.bounds.top-=2,e.bounds.right+=2,e.bounds.bottom+=2,this.nodes[t.id.value]=e,this._insert(e)}updateCollider(t){var e;const s=this.nodes[t.id.value];if(!s)return!1;const i=t.bounds;if(!this.worldBounds.contains(i))return V.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(s.bounds.contains(i))return!1;if(this._remove(s),i.left-=this._config.boundsPadding,i.top-=this._config.boundsPadding,i.right+=this._config.boundsPadding,i.bottom+=this._config.boundsPadding,t.owner){const n=(e=t.owner)===null||e===void 0?void 0:e.get(it);if(n){const o=n.vel.x*32/1e3*this._config.velocityMultiplier,a=n.vel.y*32/1e3*this._config.velocityMultiplier;o<0?i.left+=o:i.right+=o,a<0?i.top+=a:i.bottom+=a}}return s.bounds=i,this._insert(s),!0}untrackCollider(t){const e=this.nodes[t.id.value];e&&(this._remove(e),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const e=t.left,s=t.right,i=t,n=e,o=s,a=e.left,h=e.right,l=s.left,c=s.right,u=o.height-n.height;if(u>1)return o.left=i,o.parent=i.parent,i.parent=o,o.parent?o.parent.left===i?o.parent.left=o:o.parent.right=o:this.root=o,l.height>c.height?(o.right=l,i.right=c,c.parent=i,i.bounds=n.bounds.combine(c.bounds),o.bounds=i.bounds.combine(l.bounds),i.height=1+Math.max(n.height,c.height),o.height=1+Math.max(i.height,l.height)):(o.right=c,i.right=l,l.parent=i,i.bounds=n.bounds.combine(l.bounds),o.bounds=i.bounds.combine(c.bounds),i.height=1+Math.max(n.height,l.height),o.height=1+Math.max(i.height,c.height)),o;if(u<-1){if(n.left=i,n.parent=i.parent,i.parent=n,n.parent)if(n.parent.left===i)n.parent.left=n;else{if(n.parent.right!==i)throw"Error rotating Dynamic Tree";n.parent.right=n}else this.root=n;return a.height>h.height?(n.right=a,i.left=h,h.parent=i,i.bounds=o.bounds.combine(h.bounds),n.bounds=i.bounds.combine(a.bounds),i.height=1+Math.max(o.height,h.height),n.height=1+Math.max(i.height,a.height)):(n.right=h,i.left=a,a.parent=i,i.bounds=o.bounds.combine(a.bounds),n.bounds=i.bounds.combine(h.bounds),i.height=1+Math.max(o.height,a.height),n.height=1+Math.max(i.height,h.height)),n}return t}getHeight(){return this.root===null?0:this.root.height}query(t,e){const s=t.bounds,i=n=>{if(n&&n.bounds.overlaps(s))if(n.isLeaf()&&n.data!==t){if(e.call(t,n.data))return!0}else return i(n.left)||i(n.right);return!1};i(this.root)}rayCastQuery(t,e=1/0,s){const i=n=>{if(n&&n.bounds.rayCast(t,e))if(n.isLeaf()){if(s.call(t,n.data))return!0}else return i(n.left)||i(n.right);return!1};i(this.root)}getNodes(){const t=e=>e?[e].concat(t(e.left),t(e.right)):[];return t(this.root)}debug(t){const e=s=>{s&&(s.isLeaf()?s.bounds.draw(t,k.Green):s.bounds.draw(t,k.White),s.left&&e(s.left),s.right&&e(s.right))};e(this.root)}}class ei{constructor(t,e){this.pos=t,this.dir=e.normalize()}intersect(t){const e=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&e.cross(this.dir)!==0)return-1;const s=this.dir.cross(t.getSlope());if(s===0)return-1;const i=e.cross(t.getSlope())/s;if(i>=0){const n=e.cross(this.dir)/s/t.getLength();if(n>=0&&n<=1)return i}return-1}intersectPoint(t){const e=this.intersect(t);return e<0?null:this.getPoint(e)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class Tr{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Xa(t.dynamicTree)}getColliders(){return this._colliders}query(t){const e=[];return t instanceof z?this._dynamicCollisionTree.query({id:hi("collider",-1),owner:null,bounds:t},s=>(e.push(s),!1)):this._dynamicCollisionTree.query({id:hi("collider",-1),owner:null,bounds:new z(t.x,t.y,t.x,t.y)},s=>(e.push(s),!1)),e}rayCast(t,e){var s,i,n;const o=[],a=(s=e==null?void 0:e.maxDistance)!==null&&s!==void 0?s:1/0,h=e==null?void 0:e.collisionGroup,l=h?h.category:(i=e==null?void 0:e.collisionMask)!==null&&i!==void 0?i:Ts.All.category,c=(n=e==null?void 0:e.searchAllColliders)!==null&&n!==void 0?n:!1;return this._dynamicCollisionTree.rayCastQuery(t,a,u=>{const f=u.owner.get(it);if(e!=null&&e.ignoreCollisionGroupAll&&f.group===Ts.All)return!1;const p=(l&f.group.category)!==0;if(f!=null&&f.group&&!p)return!1;const _=u.rayCast(t,a);if(_){if(e!=null&&e.filter){if(e.filter(_)&&(o.push(_),!c))return!0}else if(o.push(_),!c)return!0}return!1}),o}track(t){if(!t){V.getInstance().warn("Cannot track null collider");return}if(t instanceof $t){const e=t.getColliders();for(const s of e)s.owner=t.owner,this._colliders.push(s),this._dynamicCollisionTree.trackCollider(s)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){V.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof $t){const e=t.getColliders();for(const s of e){const i=this._colliders.indexOf(s);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(s)}}else{const e=this._colliders.indexOf(t);e!==-1&&this._colliders.splice(e,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,e){const s=de.calculatePairHash(t.id,e.id);return this._pairs.has(s)}broadphase(t,e,s){const i=e/1e3,n=t.filter(a=>{var h,l;const c=(h=a.owner)===null||h===void 0?void 0:h.get(it);return((l=a.owner)===null||l===void 0?void 0:l.isActive)&&c.collisionType!==X.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let o;for(let a=0,h=n.length;a<h;a++)o=n[a],this._dynamicCollisionTree.query(o,l=>{if(!this._pairExists(o,l)&&de.canCollide(o,l)){const c=new de(o,l);this._pairs.add(c.id),this._collisionPairCache.push(c)}return!1});if(s&&(s.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const a of n){const h=a.owner.get(it);if(h.collisionType!==X.Active)continue;const l=h.vel.magnitude*i+h.acc.magnitude*.5*i*i,c=Math.min(a.bounds.height,a.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||l>c/2){s&&s.physics.fastBodies++;const u=h.globalPos.sub(h.oldPos),d=a.center,f=a.getFurthestPoint(h.vel),p=f.sub(u),_=new ei(p,h.vel);_.pos=_.pos.add(_.dir.scale(-2*this._config.continuous.surfaceEpsilon));let v,g=new T(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(_,l+this._config.continuous.surfaceEpsilon*2,w=>{if(!this._pairExists(a,w)&&de.canCollide(a,w)){const C=w.rayCast(_,l+this._config.continuous.surfaceEpsilon*10);if(C){const b=C.point.sub(p);b.magnitude<g.magnitude&&(g=b,v=w)}}return!1}),v&&T.isValid(g)){const w=new de(a,v);this._pairs.has(w.id)||(this._pairs.add(w.id),this._collisionPairCache.push(w));const C=d.sub(f);h.globalPos=p.add(C).add(g).add(_.dir.scale(10*this._config.continuous.surfaceEpsilon)),a.update(h.transform.get()),s&&s.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,e){let s=[];for(let i=0;i<t.length;i++){const n=t[i].collide();if(s=s.concat(n),e&&n.length>0)for(const o of n)e.physics.contacts.set(o.id,o)}return e&&(e.physics.collisions+=s.length),s}update(t){let e=0;const s=t.length;for(let i=0;i<s;i++)this._dynamicCollisionTree.updateCollider(t[i])&&e++;return e}debug(t){this._dynamicCollisionTree.debug(t)}}class js{constructor(){this.id=hi("collider",js._ID++),this.composite=null,this.events=new yt,this.offset=T.Zero}touching(t){return!!this.collide(t)}}js._ID=0;var wn;(function(r){r.Arcade="arcade",r.Realistic="realistic"})(wn||(wn={}));var As;(function(r){r.None="none",r.VerticalFirst="vertical-first",r.HorizontalFirst="horizontal-first"})(As||(As={}));const ja={vertical:1,horizontal:2},Ya={horizontal:1,vertical:2},$a={horizontal:0,vertical:0};var Oi;(function(r){r.DynamicTree="dynamic-tree",r.SparseHashGrid="sparse-hash-grid"})(Oi||(Oi={}));const ys=()=>({enabled:!0,gravity:E(0,0).clone(),solver:wn.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Oi.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:As.None},realistic:{contactSolveBias:As.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class $t extends js{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new Tr({...ys()}),this._dynamicAABBTree=new Xa({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const e of t)this.addCollider(e)}clearColliders(){this._colliders=[]}addCollider(t){let e;t instanceof $t?(e=t.getColliders(),e.forEach(s=>s.offset.addEqual(t.offset))):e=[t];for(const s of e)s.events.pipe(this.events),s.composite=this,this._colliders.push(s),this._collisionProcessor.track(s),this._dynamicAABBTree.trackCollider(s)}removeCollider(t){t.events.pipe(this.events),t.composite=null,$i(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,e;return((e=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&e!==void 0?e:T.Zero).add(this.offset)}get center(){var t,e;return((e=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&e!==void 0?e:T.Zero).add(this.offset)}get bounds(){var t,e;const s=this.getColliders();return s.reduce((n,o)=>n.combine(o.bounds),(e=(t=s[0])===null||t===void 0?void 0:t.bounds)!==null&&e!==void 0?e:new z().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,e;const s=this.getColliders();return s.reduce((n,o)=>n.combine(o.localBounds),(e=(t=s[0])===null||t===void 0?void 0:t.localBounds)!==null&&e!==void 0?e:new z)}get axes(){const t=this.getColliders();let e=[];for(const s of t)e=e.concat(s.axes);return e}getFurthestPoint(t){const e=this.getColliders(),s=[];for(const o of e)s.push(o.getFurthestPoint(t));let i=s[0],n=-Number.MAX_VALUE;for(const o of s){const a=o.dot(t);a>n&&(i=o,n=a)}return i}getInertia(t){const e=this.getColliders();let s=0;for(const i of e)s+=i.getInertia(t);return s}collide(t){let e=[t];t instanceof $t&&(e=t.getColliders());const s=[];for(const n of e)this._dynamicAABBTree.query(n,o=>(s.push(new de(n,o)),!1));let i=[];for(const n of s)i=i.concat(n.collide());return i}getClosestLineBetween(t){const e=this.getColliders(),s=[];if(t instanceof $t){const i=t.getColliders();for(const n of e)for(const o of i){const a=n.getClosestLineBetween(o);a&&s.push(a)}}else for(const i of e){const n=t.getClosestLineBetween(i);n&&s.push(n)}if(s.length){let i=s[0].getLength(),n=s[0];for(const o of s){const a=o.getLength();a<i&&(i=a,n=o)}return n}return null}contains(t){const e=this.getColliders();for(const s of e)if(s.contains(t))return!0;return!1}rayCast(t,e){const s=this.getColliders(),i=[];for(const n of s){const o=n.rayCast(t,e);o&&i.push(o)}if(i.length){let n=i[0],o=n.point.dot(t.dir);for(const a of i){const h=t.dir.dot(a.point);h<o&&(n=a,o=h)}return n}return null}project(t){const e=this.getColliders(),s=[];for(const i of e){const n=i.project(t);n&&s.push(n)}if(s.length){const i=new Bn(s[0].min,s[0].max);for(const n of s)i.min=Math.min(n.min,i.min),i.max=Math.max(n.max,i.max);return i}return null}update(t){if(t){const e=this.getColliders();for(const s of e)s.owner=this.owner,s.update(t)}}debug(t,e,s){const i=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const n of i)n.debug(t,e,s);t.restore()}clone(){const t=new $t(this._colliders.map(e=>e.clone()));return t.offset=this.offset.clone(),t}}class kt{constructor(t,e){this.begin=t,this.end=e}clone(t){const e=t||new kt(this.begin.clone(),this.end.clone());return e.begin=this.begin.clone(e.begin),e.end=this.end.clone(e.end),e}transform(t,e){const s=e||new kt(T.Zero,T.Zero);return s.begin=t.multiply(this.begin,s.begin),s.end=t.multiply(this.end,s.end),s}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,e=this.end,s=t.distance(e);return this._slope=e.sub(t).scale(1/s)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,e=this.end;return t.distance(e)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new kt(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,e,s=!0){let i=t;s&&(i=i.normalize());const n=i.dot(this.begin)-e,o=i.dot(this.end)-e,a=[];if(n<=0&&a.push(this.begin),o<=0&&a.push(this.end),n*o<0){const h=n/(n-o);a.push(this.begin.add(this.end.sub(this.begin).scale(h)))}return a.length!==2?null:new kt(a[0],a[1])}distanceToPoint(t,e=!1){const s=t.x,i=t.y,n=this.getLength(),o=this.end.y-this.begin.y,a=this.end.x-this.begin.x,h=(o*s-a*i+this.end.x*this.begin.y-this.end.y*this.begin.x)/n;return e?h:Math.abs(h)}findVectorToPoint(t){const e=this.begin.sub(t),s=this.getSlope();return e.sub(s.scale(e.dot(s)))}findPoint(t=null,e=null){const s=this.slope,i=this.intercept;if(t!==null)return new T(t,s*t+i);if(e!==null)return new T((e-i)/s,e);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,e=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new T(arguments[0],arguments[1]),e=arguments[2]||0;else if(arguments[0]instanceof T)t=arguments[0],e=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const s=t.x-this.begin.x,i=t.y-this.begin.y,n=this.end.x-this.begin.x,o=this.end.y-this.begin.y,a=s*o-i*n;return Math.abs(a)>e?!1:Math.abs(n)>=Math.abs(o)?n>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:o>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function So(r,t){const s=r.dir(),i=t.dir(),n=s.dot(s),o=i.dot(i);if(n<1e-9&&o<1e-9)return new kt(r.begin,t.begin);if(n<1e-9){const v=tt(i.dot(r.begin.sub(t.begin))/o,0,1),g=t.begin.add(i.scale(v));return new kt(r.begin,g)}if(o<1e-9){const v=tt(s.dot(t.begin.sub(r.begin))/n,0,1),g=r.begin.add(s.scale(v));return new kt(g,t.begin)}const a=r.begin.sub(t.begin),h=n,l=o,c=i.dot(a),u=h*l-Math.pow(s.dot(i),2);let d=0,f=0;Math.abs(u)>1e-9?d=tt((s.dot(i)*c-l*s.dot(a))/u,0,1):d=tt(s.dot(a)/h,0,1),Math.abs(l)>1e-9?f=tt((s.dot(i)*d+c)/l,0,1):f=0;const p=r.begin.add(s.scale(d)),_=t.begin.add(i.scale(f));return new kt(p,_)}const as={PolygonPolygonClosestLine(r,t){const e=r.getSides(),s=t.getSides();let i=Number.MAX_VALUE,n=null;for(let o=0;o<e.length;o++)for(let a=0;a<s.length;a++){const h=So(e[o],s[a]),l=h.getLength();l<i&&(i=l,n=h)}return n},PolygonEdgeClosestLine(r,t){const s=t.worldPos.sub(r.worldPos),i=new ei(r.worldPos,s),n=r.rayCast(i).point.add(i.dir.scale(.1)),o=r.getClosestFace(n),a=t.asLine();return So(o.face,a)},PolygonCircleClosestLine(r,t){const e=t.worldPos,s=e.sub(r.worldPos),i=new ei(r.worldPos,s.normalize()),n=r.rayCast(i).point.add(i.dir.scale(.1)),o=r.getClosestFace(n),a=o.face.begin,h=o.face.getEdge();let l=(h.x*(e.x-a.x)+h.y*(e.y-a.y))/(h.x*h.x+h.y*h.y);l>1?l=1:l<0&&(l=0);const c=Math.sqrt(Math.pow(a.x+h.x*l-e.x,2)+Math.pow(a.y+h.y*l-e.y,2))-t.radius,u=(a.x+h.x*l-e.x)*t.radius/(t.radius+c),d=(a.y+h.y*l-e.y)*t.radius/(t.radius+c);return new kt(h.scale(l).add(a),new T(e.x+u,e.y+d))},CircleCircleClosestLine(r,t){const s=t.worldPos.sub(r.worldPos),n=r.worldPos.sub(t.worldPos),o=new ei(r.worldPos,s),a=new ei(t.worldPos,n),h=r.rayCast(o),l=t.rayCast(a);return new kt(h.point,l.point)},CircleEdgeClosestLine(r,t){const e=r.worldPos,s=t.asLine(),i=s.begin,n=s.getEdge(),o=i,a=n;let h=(a.x*(e.x-o.x)+a.y*(e.y-o.y))/(a.x*a.x+a.y*a.y);h>1?h=1:h<0&&(h=0);const l=Math.sqrt(Math.pow(o.x+a.x*h-e.x,2)+Math.pow(o.y+a.y*h-e.y,2))-r.radius,c=(o.x+a.x*h-e.x)*r.radius/(r.radius+l),u=(o.y+a.y*h-e.y)*r.radius/(r.radius+l);return new kt(a.scale(h).add(o),new T(e.x+c,e.y+u))},EdgeEdgeClosestLine(r,t){const e=r.asLine(),s=t.asLine();return So(e,s)}};class ne extends js{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const e=this._transform,s=(t=e==null?void 0:e.globalScale)!==null&&t!==void 0?t:T.One;return this._radius=this._naturalRadius*Math.min(s.x,s.y)}set radius(t){var e;const s=this._transform,i=(e=s==null?void 0:s.globalScale)!==null&&e!==void 0?e:T.One;this._naturalRadius=t/Math.min(i.x,i.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=T.Zero,this._globalMatrix=Ot.identity(),this._localBoundsDirty=!0,this.offset=t.offset||T.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new ne({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:this.offset).distance(t)<=this.radius}rayCast(t,e=1/0){var s,i;const n=this.center,o=t.dir,a=t.pos,h=n.sub(a),l=o.scale(h.dot(o)),u=h.sub(l).magnitude;if(u>this.radius)return null;{let d=0;if(Sl(u,this.radius,1e-4)){if(d=-o.dot(a.sub(n)),d>0&&d<e){const f=t.getPoint(d);return{point:f,normal:f.sub(n).normalize(),collider:this,body:(s=this.owner)===null||s===void 0?void 0:s.get(it),distance:d}}return null}else{const f=Math.sqrt(Math.pow(o.dot(a.sub(n)),2)-Math.pow(a.sub(n).distance(),2)+Math.pow(this.radius,2)),p=-o.dot(a.sub(n))+f,_=-o.dot(a.sub(n))-f,v=[];p>=0&&v.push(p),_>=0&&v.push(_);const g=Math.min(...v);if(g<=e){const w=t.getPoint(g);return{point:w,normal:w.sub(n).normalize(),collider:this,body:(i=this.owner)===null||i===void 0?void 0:i.get(it),distance:g}}return null}}}getClosestLineBetween(t){if(t instanceof ne)return as.CircleCircleClosestLine(this,t);if(t instanceof Kt)return as.PolygonCircleClosestLine(t,this).flip();if(t instanceof Te)return as.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof ne)return Ye.CollideCircleCircle(this,t);if(t instanceof Kt)return Ye.CollideCirclePolygon(this,t);if(t instanceof Te)return Ye.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new z(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var e;this._transform=t,((e=t.matrix)!==null&&e!==void 0?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const e=[],i=this.center.dot(t);return e.push(i),e.push(i+this.radius),e.push(i-this.radius),new Bn(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e,s){var i,n,o,a;const{lineWidth:h}={lineWidth:1,...s},l=this._transform,c=(i=l==null?void 0:l.globalScale)!==null&&i!==void 0?i:T.One,u=(n=l==null?void 0:l.globalRotation)!==null&&n!==void 0?n:0,d=(o=l==null?void 0:l.globalPos)!==null&&o!==void 0?o:T.Zero;t.save(),t.translate(d.x,d.y),t.rotate(u),t.scale(c.x,c.y),t.drawCircle((a=this.offset)!==null&&a!==void 0?a:T.Zero,this._naturalRadius,k.Transparent,e,h),t.restore()}}class ti{constructor(t,e,s,i,n,o,a,h){var l,c,u,d,f,p;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=e,this.mtv=s,this.normal=i,this.tangent=n,this.points=o,this.localPoints=a,this.info=h,this.id=de.calculatePairHash(t.id,e.id),t.composite||e.composite){const _=((l=t.composite)===null||l===void 0?void 0:l.compositeStrategy)==="separate"?t.id:(u=(c=t.composite)===null||c===void 0?void 0:c.id)!==null&&u!==void 0?u:t.id,v=((d=e.composite)===null||d===void 0?void 0:d.compositeStrategy)==="separate"?e.id:(p=(f=e.composite)===null||f===void 0?void 0:f.id)!==null&&p!==void 0?p:e.id;this.id+="|"+de.calculatePairHash(_,v)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(it)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(it))}matchAwake(){const t=this.bodyA,e=this.bodyB;t&&e&&t.isSleeping!==e.isSleeping&&(t.isSleeping&&t.collisionType!==X.Fixed&&e.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),e.isSleeping&&e.collisionType!==X.Fixed&&t.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const e=this.colliderA,s=this.colliderB;return this.colliderB=e,this.colliderA=s,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Gl{constructor(){this.axis=E(0,0),this.localAxis=E(0,0),this.side=new kt(E(0,0),E(0,0)),this.localSide=new kt(E(0,0),E(0,0)),this.point=E(0,0),this.localPoint=E(0,0)}}class Bt{static findPolygonPolygonSeparation(t,e){if(e.transform.matrix.determinant()===0)return Bt.findPolygonPolygonSeparationDegenerate(t,e);let s=-Number.MAX_VALUE,i=-1,n;const o=e.transform.inverse.multiply(t.transform.matrix,Bt._SCRATCH_MATRIX),a=o.getRotation(),h=t.normals,l=t.points,c=e.points;for(let f=0;f<l.length;f++){const p=h[f].rotate(a,Bt._ZERO,Bt._SCRATCH_NORMAL),_=o.multiply(l[f],Bt._SCRATCH_POINT);let v=Number.MAX_VALUE,g;for(let w=0;w<c.length;w++){const C=p.dot(c[w].sub(_,Bt._SCRATCH_SUB_POINT));C<v&&(v=C,g=c[w])}v>s&&(s=v,i=f,n=g)}const u=(i+1)%l.length,d=Bt.SeparationPool.get();return d.collider=t,d.separation=s,s>0||(h[i].clone(d.localAxis),h[i].rotate(t.transform.rotation,Bt._ZERO,d.axis),t.transform.matrix.multiply(l[i],d.side.begin),t.transform.matrix.multiply(l[u],d.side.end),e.transform.matrix.multiply(n,d.point),d.sideId=i,n.clone(d.localPoint),l[i].clone(d.localSide.begin),l[u].clone(d.localSide.end)),d}static findCirclePolygonSeparation(t,e){const s=e.axes,n=e.center.sub(t.worldPos),o=e.getFurthestPoint(n.negate());s.push(o.sub(t.worldPos).normalize());let a=Number.MAX_VALUE,h=null,l=-1;for(let c=0;c<s.length;c++){const u=e.project(s[c]),d=t.project(s[c]),f=u.getOverlap(d);if(f<=0)return null;f<a&&(a=f,h=s[c],l=c)}return l<0?null:h.normalize().scale(a)}static findPolygonPolygonSeparationDegenerate(t,e){let s=-Number.MAX_VALUE,i=null,n=null,o=-1,a=null;const h=t.getSides(),l=t.getLocalSides();for(let c=0;c<h.length;c++){const u=h[c],d=u.normal(),f=e.getFurthestPoint(d.negate()),p=u.distanceToPoint(f,!0);p>s&&(s=p,i=u,n=d,o=c,a=f)}return{collider:t,separation:n?s:99,axis:n,side:i,localSide:l[o],sideId:o,point:a,localPoint:n?e.getFurthestLocalPoint(n.negate()):null}}}Bt.SeparationPool=new zr(()=>new Gl,r=>r,500);Bt._ZERO=E(0,0);Bt._SCRATCH_POINT=E(0,0);Bt._SCRATCH_SUB_POINT=E(0,0);Bt._SCRATCH_NORMAL=E(0,0);Bt._SCRATCH_MATRIX=Ot.identity();Bt.SeparationPool.disableWarnings=!0;const Mf=T.Zero,Rf=T.Zero,Df=Ot.identity(),Ye={CollideCircleCircle(r,t){const e=r.worldPos,s=t.worldPos,i=r.radius+t.radius,n=e.distance(s);if(n>i)return[];const o=i-n,a=s.sub(e).normalize(),h=a.perpendicular(),l=a.scale(o),c=r.getFurthestPoint(a),u=r.getFurthestLocalPoint(a),d={collider:r,separation:o,axis:a,point:c};return[new ti(r,t,l,a,h,[c],[u],d)]},CollideCirclePolygon(r,t){var e,s;let i=Bt.findCirclePolygonSeparation(r,t);if(!i)return[];i=i.dot(t.center.sub(r.center))<0?i.negate():i;const o=r.getFurthestPoint(i),h=((s=(e=r.owner)===null||e===void 0?void 0:e.get(N))!==null&&s!==void 0?s:new N).applyInverse(o),l=i.normalize(),c={collider:r,separation:-i.magnitude,axis:l,point:o,localPoint:h,side:t.findSide(l.negate()),localSide:t.findLocalSide(l.negate())};return[new ti(r,t,i,l,l.perpendicular(),[o],[h],c)]},CollideCircleEdge(r,t){const e=r.center,s=t.asLine(),i=s.end.sub(s.begin),n=i.dot(s.end.sub(e)),o=i.dot(e.sub(s.begin)),a=t.asLine(),h=t.asLocalLine();if(o<=0){const g=s.begin.sub(e),w=g.dot(g);if(w>r.radius*r.radius)return[];const C=g.normalize(),b=r.radius-Math.sqrt(w),x={collider:r,separation:b,axis:C,point:a.begin,side:a,localSide:h};return[new ti(r,t,C.scale(b),C,C.perpendicular(),[a.begin],[h.begin],x)]}if(n<=0){const g=s.end.sub(e),w=g.dot(g);if(w>r.radius*r.radius)return[];const C=g.normalize(),b=r.radius-Math.sqrt(w),x={collider:r,separation:b,axis:C,point:a.end,side:a,localSide:h};return[new ti(r,t,C.scale(b),C,C.perpendicular(),[a.end],[h.end],x)]}const l=i.dot(i),c=s.begin.scale(n).add(s.end.scale(o)).scale(1/l),u=e.sub(c),d=u.dot(u);if(d>r.radius*r.radius)return[];let f=i.perpendicular();f.dot(e.sub(s.begin))<0&&(f.x=-f.x,f.y=-f.y),f=f.normalize();const p=r.radius-Math.sqrt(d),_=f.scale(p),v={collider:r,separation:p,axis:f,point:c,side:a,localSide:h};return[new ti(r,t,_,f.negate(),f.negate().perpendicular(),[c],[c.sub(t.worldPos)],v)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(r,t){var e;const s=r.center,n=t.center.sub(s).normalize(),o=new Kt({points:[t.begin,t.end,t.end.add(n.scale(100)),t.begin.add(n.scale(100))],offset:t.offset});o.owner=t.owner,((e=t.owner)===null||e===void 0?void 0:e.get(N))&&o.update(t.owner.get(N).get());const h=this.CollidePolygonPolygon(r,o);return h.length&&(h[0].colliderB=t,h[0].id=de.calculatePairHash(r.id,t.id)),h},CollidePolygonPolygon(r,t){const e=Bt.findPolygonPolygonSeparation(r,t);if(e.separation>0)return[];const s=Bt.findPolygonPolygonSeparation(t,r);if(s.separation>0)return[];const i=e.separation>s.separation?e:s,n=i.collider===r?t:r,o=i.collider===r?r:t,a=n.transform.inverse.multiply(o.transform.matrix,Df),h=a.getRotation(),l=o.normals[i.sideId].rotate(h,Mf,Rf);let c=Number.MAX_VALUE,u=0;for(let g=0;g<n.normals.length;g++){const w=l.dot(n.normals[g]);w<c&&(c=w,u=g)}if(!i.localSide||!i.localAxis||!i.axis)return[];const d=i.localSide.transform(a),f=i.localAxis.perpendicular().negate().rotate(h),_=new kt(n.points[u],n.points[(u+1)%n.points.length]).clip(f.negate(),-f.dot(d.begin),!1);let v=null;if(_&&(v=_.clip(f,f.dot(d.end),!1)),v){const g=[],w=[],C=v.getPoints();for(let A=0;A<C.length;A++){const y=C[A];d.below(y)&&(g.push(y),w.push(n.transform.apply(y)))}let b=i.axis,x=b.perpendicular();return t.center.sub(r.center).dot(b)<0&&(b=b.negate(),x=b.perpendicular()),[new ti(r,t,b.scale(-i.separation),b,x,w,g,i)]}return[]},FindContactSeparation(r,t){var e,s,i,n;const o=r.colliderA,a=(s=(e=r.bodyA)===null||e===void 0?void 0:e.transform)!==null&&s!==void 0?s:new N,h=r.colliderB,l=(n=(i=r.bodyB)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new N;if(o instanceof ne&&h instanceof ne){const c=o.radius+h.radius,u=a.pos.distance(l.pos);return-(c-u)}if(o instanceof Kt&&h instanceof Kt&&r.info.localSide){let c,u;return r.info.collider===o?(c=new kt(a.apply(r.info.localSide.begin).add(o.offset),a.apply(r.info.localSide.end).add(o.offset)),u=l.apply(t).add(h.offset)):(c=new kt(l.apply(r.info.localSide.begin).add(h.offset),l.apply(r.info.localSide.end).add(h.offset)),u=a.apply(t).add(o.offset)),c.distanceToPoint(u,!0)}if(o instanceof Kt&&h instanceof ne||h instanceof Kt&&o instanceof ne){const c=a.apply(t);if(r.info.side)return r.info.side.distanceToPoint(c,!0)}if(o instanceof Te&&h instanceof Kt||h instanceof Te&&o instanceof Kt){let c;if(r.info.collider===o?c=l.apply(t):c=a.apply(t),r.info.side)return r.info.side.distanceToPoint(c,!0)}if(o instanceof ne&&h instanceof Te||h instanceof ne&&o instanceof Te){const c=l.apply(t);let u;o instanceof ne&&(u=o.getFurthestPoint(r.normal));const d=c.distance(u);if(r.info.side)return d>0?-d:0}return 0}};class Te extends js{constructor(t){var e;super(),this._globalMatrix=Ot.identity(),this.begin=t.begin||T.Zero,this.end=t.end||T.Zero,this.offset=(e=t.offset)!==null&&e!==void 0?e:T.Zero}clone(){return new Te({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const e=this._transform;return(t=e==null?void 0:e.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.average(e)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),e=this._getTransformedEnd(),s=t.distance(e);return e.sub(t).scale(1/s)}getLength(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return t.distance(e)}contains(){return!1}rayCast(t,e=1/0){var s;const i=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&i.cross(t.dir)!==0)return null;const n=t.dir.cross(this.getSlope());if(n===0)return null;const o=i.cross(this.getSlope())/n;if(o>=0&&o<=e){const a=i.cross(t.dir)/n/this.getLength();if(a>=0&&a<=1)return{distance:o,normal:this.asLine().normal(),collider:this,body:(s=this.owner)===null||s===void 0?void 0:s.get(it),point:t.getPoint(o)}}return null}getClosestLineBetween(t){if(t instanceof ne)return as.CircleEdgeClosestLine(t,this);if(t instanceof Kt)return as.PolygonEdgeClosestLine(t,this).flip();if(t instanceof Te)return as.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof ne)return Ye.CollideCircleEdge(t,this);if(t instanceof Kt)return Ye.CollidePolygonEdge(t,this);if(t instanceof Te)return Ye.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return t.dot(e)>0?e:s}_boundsFromBeginEnd(t,e,s=10){return new z(Math.min(t.x,e.x)-s,Math.min(t.y,e.y)-s,Math.max(t.x,e.x)+s,Math.max(t.y,e.y)+s)}get bounds(){const t=this._getTransformedBegin(),e=this._getTransformedEnd();return this._boundsFromBeginEnd(t,e)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new kt(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new kt(this.begin,this.end)}get axes(){const e=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),s=[];return s.push(e),s.push(e.negate()),s.push(e.normal()),s.push(e.normal().negate()),s}getInertia(t){const e=this.end.sub(this.begin).distance()/2;return t*e*e}update(t){var e;this._transform=t,((e=t.matrix)!==null&&e!==void 0?e:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const e=[],s=[this._getTransformedBegin(),this._getTransformedEnd()],i=s.length;for(let n=0;n<i;n++)e.push(s[n].dot(t));return new Bn(Math.min.apply(Math,e),Math.max.apply(Math,e))}debug(t,e){const s=this._getTransformedBegin(),i=this._getTransformedEnd();t.drawLine(s,i,e,2),t.drawCircle(s,2,e),t.drawCircle(i,2,e)}}class jt{static registerGraphicsContext(t){jt._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,e){jt.draw(s=>{s.debug.drawPoint(t,e)})}static drawLine(t,e,s){jt.draw(i=>{i.debug.drawLine(t,e,s)})}static drawLines(t,e){t.length>1&&jt.draw(s=>{for(let i=0;i<t.length-1;i++)s.debug.drawLine(t[i],t[i+1],e)})}static drawText(t,e){jt.draw(s=>{s.debug.drawText(t,e)})}static drawPolygon(t,e){t.length>1&&jt.draw(s=>{const i=t[0],n=[...t,i];for(let o=0;o<n.length-1;o++)s.debug.drawLine(n[o],n[o+1],e)})}static drawCircle(t,e,s){const{color:i,strokeColor:n,width:o}={color:k.Black,strokeColor:void 0,width:void 0,...s};jt.draw(a=>{a.drawCircle(t,e,i,n,o)})}static drawBounds(t,e){jt.draw(s=>{s.debug.drawRect(t.left,t.top,t.width,t.height,e)})}static drawRay(t,e){const{distance:s,color:i}={color:k.Blue,distance:10,...e};jt.draw(n=>{const o=t.pos,a=t.pos.add(t.dir.scale(s));n.debug.drawLine(o,a,{color:i})})}static flush(t){t.save(),t.z=jt.z;for(const e of jt._drawCalls)e(t);t.restore(),jt.clear()}static clear(){jt._drawCalls.length=0}}jt._drawCalls=[];jt.z=1/0;class Kt extends js{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let e=0;e<this._points.length;e++)t.push(this._points[(e+1)%this._points.length].sub(this._points[e]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var e;super(),this._logger=V.getInstance(),this._transform=new Cs,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(e=t.offset)!==null&&e!==void 0?e:T.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let e=0;for(let s=0;s<t.length;s++)e+=(t[(s+1)%t.length].x-t[s].x)*(t[(s+1)%t.length].y+t[s].y);return e<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],e=this.points[this.points.length-1],s=Math.atan2(e.y-t.y,e.x-t.x),i=0,n=0,o=0;for(const[a,h]of this.points.entries()){if(t=e,i=s,e=h,s=Math.atan2(e.y-t.y,e.x-t.x),t.equals(e))return!1;let l=s-i;if(l<=-Math.PI?l+=Math.PI*2:l>Math.PI&&(l-=Math.PI*2),a===0){if(l===0)return!1;n=l>0?1:-1}else if(n*l<=0)return!1;o+=l}return Math.abs(Math.round(o/(Math.PI*2)))===1}tessellate(){const t=[];for(let e=1;e<this.points.length-2;e++)t.push([this.points[0],this.points[e+1],this.points[e+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new $t(t.map(e=>re.Polygon(e)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],e=[...this.points].reverse();let s=e.length;function i(u){return u===0?s-1:u-1}function n(u){return u===s-1?0:u+1}function o(u){const d=i(u),f=n(u),p=e[d],_=e[u],v=e[f],g=p.sub(_),w=v.sub(_);return!(g.cross(w)<0)}const a=e.map((u,d)=>o(d));function h(u,d,f,p){const _=f.sub(d),v=p.sub(f),g=d.sub(p),w=u.sub(d),C=u.sub(f),b=u.sub(p),x=_.cross(w),A=v.cross(C),y=g.cross(b);return!(x>0||A>0||y>0)}function l(){for(let u=0;u<s;u++)if(a[u]){const d=i(u),f=n(u),p=e[d],_=e[u],v=e[f];let g=!0;for(let w=0;w<s;w++){if(w===u||w===d||w===f)continue;const C=e[w];if(h(C,p,_,v)){g=!1;break}}if(g)return u}for(let u=0;u<s;u++)if(a[u])return u;return 0}function c(u){const d=i(u),f=n(u),p=e[d],_=e[u],v=e[f];t.push([p,_,v]),e.splice(u,1),a.splice(u,1),s--}for(;s>3;){const u=l();c(u);for(let d=0;d<s;d++)a[d]=o(d)}return t.push([e[0],e[1],e[2]]),new $t(t.map(u=>re.Polygon(u,T.Zero,!0)))}clone(){return new Kt({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,e=t.length;this._transformedPoints.length=0;for(let s=0;s<e;s++)this._transformedPoints[s]=this._transform.apply(t[s].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],e=this.getTransformedPoints(),s=e.length;for(let i=0;i<s;i++)t.push(new kt(e[i],e[(i+1)%s]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],e=this.points,s=e.length;for(let i=0;i<s;i++)t.push(new kt(e[i],e[(i+1)%s]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const e=this.getSides();let s=e[0],i=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=e[n],h=o.normal().dot(t);h>i&&(s=o,i=h)}return s}findLocalSide(t){const e=this.getLocalSides();let s=e[0],i=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=e[n],h=o.normal().dot(t);h>i&&(s=o,i=h)}return s}get axes(){const t=[],e=this.getSides();for(let s=0;s<e.length;s++)t.push(e[s].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(e=>E(e.x*_t(this._transform.scale.x),e.y*_t(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const e=this._transform.applyInverse(t),s=new ei(e,new T(1,0));let i=0;const n=this.getLocalSides();for(let o=0;o<n.length;o++){const a=n[o];s.intersect(a)>=0&&i++}return i%2!==0}getClosestLineBetween(t){if(t instanceof ne)return as.PolygonCircleClosestLine(this,t);if(t instanceof Kt)return as.PolygonPolygonClosestLine(this,t);if(t instanceof Te)return as.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof ne)return Ye.CollideCirclePolygon(t,this);if(t instanceof Kt)return Ye.CollidePolygonPolygon(this,t);if(t instanceof Te)return Ye.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const e=this.getTransformedPoints();let s=null,i=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=t.dot(e[n]);o>i&&(i=o,s=e[n])}return s}getFurthestLocalPoint(t){const e=this.points;let s=e[0],i=-Number.MAX_VALUE;for(let n=0;n<e.length;n++){const o=t.dot(e[n]);o>i&&(i=o,s=e[n])}return s}getClosestFace(t){const e=this.getSides();let s=Number.POSITIVE_INFINITY,i=-1,n=-1;for(let o=0;o<e.length;o++){const a=e[o].distanceToPoint(t);a<s&&(s=a,i=o,n=a)}return i!==-1?{distance:e[i].normal().scale(n),face:e[i]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=z.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let e=0,s=0;const i=this.points;for(let n=0;n<i.length;n++){const o=(n+1)%i.length,a=i[o].cross(i[n]);e+=a*(i[n].dot(i[n])+i[n].dot(i[o])+i[o].dot(i[o])),s+=a}return this._cachedMass=t,this._cachedInertia=t/6*(e/s)}rayCast(t,e=1/0){var s;const i=this.getSides(),n=i.length;let o=Number.MAX_VALUE,a,h=-1;for(let l=0;l<n;l++){const c=t.intersect(i[l]);c>=0&&c<o&&c<=e&&(o=c,a=i[l],h=l)}return h>=0?{collider:this,distance:o,body:(s=this.owner)===null||s===void 0?void 0:s.get(it),point:t.getPoint(o),normal:a.normal()}:null}project(t){const e=this.getTransformedPoints(),s=e.length;let i=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let o=0;o<s;o++){const a=e[o].dot(t);i=Math.min(i,a),n=Math.max(n,a)}return new Bn(i,n)}debug(t,e,s){const i=this.getTransformedPoints();jt.drawPolygon(i,{color:e})}}class re{static Box(t,e,s=T.Half,i=T.Zero){return new Kt({points:new z(-t*s.x,-e*s.y,t-t*s.x,e-e*s.y).getPoints(),offset:i})}static Polygon(t,e=T.Zero,s=!1){return new Kt({points:t,offset:e,suppressConvexWarning:s})}static Circle(t,e=T.Zero){return new ne({radius:t,offset:e})}static Edge(t,e){return new Te({begin:t,end:e})}static Capsule(t,e,s=T.Zero){const i=V.getInstance();return t===e&&i.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),e>=t?new $t([re.Circle(t/2,E(0,-e/2+t/2).add(s)),re.Box(t,e-t,T.Half,s),re.Circle(t/2,E(0,e/2-t/2).add(s))]):new $t([re.Circle(e/2,E(-t/2+e/2,0).add(s)),re.Box(t-e,e,T.Half,s),re.Circle(e/2,E(t/2-e/2,0).add(s))])}}class Nt extends Ue{constructor(t){super(),this.events=new yt,this.$colliderAdded=new ue,this.$colliderRemoved=new ue,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new Nt(this._collider.clone())}get bounds(){var t,e;return(e=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&e!==void 0?e:new z}get localBounds(){var t,e;return(e=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&e!==void 0?e:new z}update(){var t;const e=(t=this.owner)===null||t===void 0?void 0:t.get(N);this._collider&&(this._collider.owner=this.owner,e&&this._collider.update(e.get()))}collide(t){let e=this._collider,s=t._collider;if(!e||!s)return[];let i=!1;if(s instanceof $t&&(e=s,s=this._collider,i=!0),this._collider){const n=e.collide(s);return n?(i&&n.forEach(o=>{o.mtv=o.mtv.negate(),o.normal=o.normal.negate(),o.tangent=o.normal.perpendicular(),o.colliderA=this._collider,o.colliderB=t._collider}),n):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",e=>{const s=e;t.events.emit("precollision",new ui(s.self,s.other,s.side,s.intersection,s.contact)),t instanceof fe&&t.onPreCollisionResolve(s.self,s.other,s.side,s.contact)}),this.events.on("postcollision",e=>{const s=e;t.events.emit("postcollision",new di(s.self,s.other,s.side,s.intersection,s.contact)),t instanceof fe&&t.onPostCollisionResolve(s.self,s.other,s.side,s.contact)}),this.events.on("collisionstart",e=>{const s=e;t.events.emit("collisionstart",new _n(s.self,s.other,s.side,s.contact)),t instanceof fe&&t.onCollisionStart(s.self,s.other,s.side,s.contact)}),this.events.on("collisionend",e=>{const s=e;t.events.emit("collisionend",new gn(s.self,s.other,s.side,s.lastContact)),t instanceof fe&&t.onCollisionEnd(s.self,s.other,s.side,s.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,e,s=T.Half,i=T.Zero){const n=re.Box(t,e,s,i);return this.set(n)}usePolygonCollider(t,e=T.Zero){const s=re.Polygon(t,e);return this.set(s)}useCircleCollider(t,e=T.Zero){const s=re.Circle(t,e);return this.set(s)}useEdgeCollider(t,e){const s=re.Edge(t,e);return this.set(s)}useCompositeCollider(t){return this.set(new $t(t))}}var me;(function(r){r.Rotation="rotation",r.X="x",r.Y="y"})(me||(me={}));class it extends Ue{constructor(t){var e,s,i;super(),this.dependencies=[N,at],this.id=hi("body",it._ID++),this.events=new yt,this.oldTransform=new Cs,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=X.PreventCollision,this.group=Ts.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=T.Zero,this.oldVel=new T(0,0),this.oldAcc=T.Zero,this._impulseScratch=E(0,0),this._distanceFromCenterScratch=E(0,0),t?(this.collisionType=(e=t.type)!==null&&e!==void 0?e:this.collisionType,this.group=(s=t.group)!==null&&s!==void 0?s:this.group,this.useGravity=(i=t.useGravity)!==null&&i!==void 0?i:this.useGravity,this._bodyConfig={...ys().bodies,...t.config}):this._bodyConfig={...ys().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=it._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...ys().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){it._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===X.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=T.Zero,this.acc=T.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),e=this._bodyConfig.sleepBias;this.sleepMotion=e*this.sleepMotion+(1-e)*t,this.sleepMotion=tt(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(Nt);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const e=t.get();if(e)return this._cachedInertia=e.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===X.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var e,s;this.transform=(e=this.owner)===null||e===void 0?void 0:e.get(N),this.motion=(s=this.owner)===null||s===void 0?void 0:s.get(at)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,e){if(this.collisionType!==X.Active)return;const s=e.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(me.X)>-1&&(s.x=0),this.limitDegreeOfFreedom.indexOf(me.Y)>-1&&(s.y=0),this.vel.addEqual(s),!this.limitDegreeOfFreedom.includes(me.Rotation)){const i=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*i.cross(e)}}applyLinearImpulse(t){if(this.collisionType!==X.Active)return;const e=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(me.X)&&(e.x=0),this.limitDegreeOfFreedom.includes(me.Y)&&(e.y=0),this.vel=this.vel.add(e)}applyAngularImpulse(t,e){if(this.collisionType===X.Active&&!this.limitDegreeOfFreedom.includes(me.Rotation)){const s=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*s.cross(e)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}it._ID=0;it._DEFAULT_CONFIG={...ys().bodies};class On extends Qi{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new On({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Gr extends Qi{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var e,s,i;super(t),this._radius=0;const n=(e=t.lineWidth)!==null&&e!==void 0?e:t.strokeColor?1:0;this.padding=(s=t.padding)!==null&&s!==void 0?s:2+n/2,this.radius=t.radius,this.filtering=(i=t.filtering)!==null&&i!==void 0?i:Lt.Blended,this.rasterize()}clone(){return new Gr({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class Ws extends Ue{constructor(t){var e,s;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(e=t==null?void 0:t.useColliderShape)!==null&&e!==void 0?e:this.useColliderShape,this.useGraphicsBounds=(s=t==null?void 0:t.useGraphicsBounds)!==null&&s!==void 0?s:this.useGraphicsBounds,this.localBounds=t==null?void 0:t.localBounds}}class ut{static CreateReversibleEasingFunction(t){return(e,s,i,n)=>i<s?s-(t(e,i,s,n)-i):t(e,s,i,n)}static CreateVectorEasingFunction(t){return(e,s,i,n)=>new T(t(e,s.x,i.x,n),t(e,s.y,i.y,n))}}ut.Linear=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,e*r/s+t));ut.EaseInQuad=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s,e*r*r+t));ut.EaseOutQuad=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s,-e*r*(r-2)+t));ut.EaseInOutQuad=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s/2,r<1?e/2*r*r+t:(r--,-e/2*(r*(r-2)-1)+t)));ut.EaseInCubic=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s,e*r*r*r+t));ut.EaseOutCubic=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s,r--,e*(r*r*r+1)+t));ut.EaseInOutCubic=ut.CreateReversibleEasingFunction((r,t,e,s)=>(e=e-t,r/=s/2,r<1?e/2*r*r*r+t:(r-=2,e/2*(r*r*r+2)+t)));class Xl{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const e=this._actions.indexOf(t);this._actions.splice(e,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let e=0;e<t;e++)this._actions[e].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new za(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Va(this._currentAction,this._entity));const e=this._actions.shift();e&&this._completedActions.push(e)}}}let kf=0;function ct(){return kf++}class jl{constructor(t,e,s){this.id=ct(),this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new Un(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=s,this._originalRepeat=s,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Yl{constructor(t,e){this.id=ct(),this._stopped=!1,this._repeatBuilder=e,this._repeatContext=new Un(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function $l(r,t,e){return(1-e)*r+t*e}function Za(r,t,e,s){const i=(r-t+Ht)%Ht>=Math.PI,n=Math.abs(t-r),o=Ht-n;let a=0,h=0;n>o?(a=o,h=n):(a=n,h=o);let l=0,c=1;switch(e){case Et.ShortestPath:l=a,c=i?1:-1;break;case Et.LongestPath:l=h,c=i?-1:1;break;case Et.Clockwise:c=1,l=i?a:h;break;case Et.CounterClockwise:c=-1,l=i?h:a;break}return r+c*(l*s)}function Nn(r,t,e){return r.scale(1-e).add(t.scale(e))}function Zl(r,t,e){return(e-r)/(t-r)}function Ql(r,t,e){const s=e.sub(r),i=t.sub(r),n=s.x/i.x,o=s.y/i.y;return Math.min(n,o)}function cs(r,t,e,s,i){const n=Zl(r,t,i);return $l(e,s,n)}function Ff(r,t,e,s,i){const n=Ql(r,t,i);return Nn(e,s,n)}function Jl(r){return r.offset instanceof T&&typeof r.duration=="number"}class Kl{constructor(t,e){var s;if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._easing=ut.Linear,this._offset=e.offset,this._easing=(s=e.easing)!==null&&s!==void 0?s:this._easing,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=this._tx.pos,i=this._easing(e,this._start.x,this._end.x,1),n=this._easing(e,this._start.y,this._end.y,1),o=(i-s.x)/(t/1e3),a=(n-s.y)/(t/1e3);this._motion.vel.x=o,this._motion.vel.y=a,this.isComplete(this.entity)&&(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=E(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class zo{constructor(t,e,s,i){if(this.id=ct(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(N),this._motion=t.get(at),this._speed=i,this._offset=new T(e,s),i<=0)throw V.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+i),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new T(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const e=t.get(N);return this._stopped||e.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=E(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function tc(r){return r.pos instanceof T&&typeof r.duration=="number"}class ec{constructor(t,e){var s;if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._easing=ut.Linear,this._end=e.pos,this._easing=(s=e.easing)!==null&&s!==void 0?s:this._easing,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=this._tx.pos,i=this._easing(e,this._start.x,this._end.x,1),n=this._easing(e,this._start.y,this._end.y,1),o=(i-s.x)/(t/1e3),a=(n-s.y)/(t/1e3);this._motion.vel.x=o,this._motion.vel.y=a,this.isComplete(this.entity)&&(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=E(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Vo{constructor(t,e,s,i){this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._end=new T(e,s),this._speed=i}update(t){this._started||(this._started=!0,this._start=new T(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const e=this._dir.scale(this._speed);this._motion.vel=E(e.x,e.y),this.isComplete(this.entity)&&(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0))}isComplete(t){const e=t.get(N);return this._stopped||new T(e.pos.x,e.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=E(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Bf(r){return typeof r.angle=="number"&&typeof r.duration=="number"}class sc{constructor(t,e){var s;if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=e.angle,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._rotationType=(s=e.rotationType)!==null&&s!==void 0?s:Et.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=Za(this._startAngle,this._endAngle,this._rotationType,e),i=this._tx.rotation,n=(s-i)/(t/1e3);this._motion.angularVelocity=n,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ic{constructor(t,e,s,i){this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._end=e,this._speed=s,this._rotationType=i||Et.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const e=Math.abs(this._end-this._start),s=Ht-e;switch(e>s?(this._shortDistance=s,this._longDistance=e):(this._shortDistance=e,this._longDistance=s),this._shortestPathIsPositive=(this._start-this._end+Ht)%Ht>=Math.PI,this._rotationType){case Et.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case Et.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case Et.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case Et.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Of(r){return typeof r.angleRadiansOffset=="number"&&typeof r.duration=="number"}class nc{constructor(t,e){var s;if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=e.angleRadiansOffset,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._rotationType=(s=e.rotationType)!==null&&s!==void 0?s:Et.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=ws(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=Za(this._startAngle,this._endAngle,this._rotationType,e),i=this._tx.rotation,n=(s-i)/(t/1e3);this._motion.angularVelocity=n,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class rc{constructor(t,e,s,i){this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._speed=s,this._offset=e,this._rotationType=i||Et.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const e=Math.abs(this._end-this._start),s=Ht-e;switch(e>s?(this._shortDistance=s,this._longDistance=e):(this._shortDistance=e,this._longDistance=s),this._shortestPathIsPositive=(this._start-this._end+Ht)%Ht>=Math.PI,this._rotationType){case Et.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case Et.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case Et.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case Et.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function oc(r){return typeof r.scale=="object"&&typeof r.duration=="number"}class ac{constructor(t,e){if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._endScale=E(1,1),this._startScale=E(1,1),this._endScale=e.scale,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=Nn(this._startScale,this._endScale,e),i=this._tx.scale,n=s.sub(i).scale(1/(t/1e3));this._motion.scaleFactor=n,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=T.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class hc{constructor(t,e,s,i,n){this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._endX=e,this._endY=s,this._speedX=i,this._speedY=n}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const e=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*e}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const e=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*e}this.isComplete()&&(this._tx.scale=E(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function lc(r){return typeof r.scaleOffset=="object"&&typeof r.duration=="number"}class cc{constructor(t,e){if(this.entity=t,this.id=ct(),this._started=!1,this._stopped=!1,this._endScale=E(1,1),this._scaleOffset=E(0,0),this._startScale=E(1,1),this._scaleOffset=e.scaleOffset,this._tx=t.get(N),this._motion=t.get(at),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=e.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),s=Nn(this._startScale,this._endScale,e),i=this._tx.scale,n=s.sub(i).scale(1/(t/1e3));this._motion.scaleFactor=n,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=T.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class uc{constructor(t,e,s,i){this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._offset=new T(e,s),this._speedX=this._speedY=i}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class tl{constructor(t){this.id=ct(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class dc{constructor(t,e,s,i,n){this.easingFcn=n,this.id=ct(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new T(0,0),this._lerpEnd=new T(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._lerpDuration=i,this._lerpEnd=new T(e,s)}_initialize(){this._lerpStart=new T(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,s=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?e=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):e=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?s=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):s=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=E((e-this._tx.pos.x)/(t/1e3),(s-this._tx.pos.y)/(t/1e3))):(this._tx.pos=E(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=T.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=E(0,0),this._stopped=!0}}class fc{constructor(t,e,s,i,n){this.easingFcn=n,this.id=ct(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new T(0,0),this._lerpEnd=new T(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._lerpDuration=i,this._offset=new T(e,s)}_initialize(){this._lerpStart=new T(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let e=this._tx.pos.x,s=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?e=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):e=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?s=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):s=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=E((e-this._tx.pos.x)/(t/1e3),(s-this._tx.pos.y)/(t/1e3))):(this._tx.pos=E(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=T.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=E(0,0),this._stopped=!0}}class pc{constructor(t,e,s,i=1){this.id=ct(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(It),this._timeVisible=e,this._timeNotVisible=s,this._duration=(e+s)*i}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class _c{constructor(t,e,s){this.id=ct(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(It),this._endOpacity=e,this._remainingTime=this._originalTime=s}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),V.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class gc{constructor(t){this.id=ct(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class mc{constructor(t){this.id=ct(),this._stopped=!1,this._entity=t}update(t){this._entity.get(Ri).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Wo{constructor(t,e,s){this.id=ct(),this._started=!1,this._stopped=!1,this._tx=t.get(N),this._motion=t.get(at),this._followTx=e.get(N),this._followMotion=e.get(at),this._current=new T(this._tx.pos.x,this._tx.pos.y),this._end=new T(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=s!==void 0?s:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const e=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(e!==0&&(this._speed=e),this._current=E(this._tx.pos.x,this._tx.pos.y),this._end=E(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const s=this._dir.scale(this._speed);this._motion.vel=E(s.x,s.y)}else this._motion.vel=E(0,0);this.isComplete()&&(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0))}stop(){this._motion.vel=E(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Ho{constructor(t,e,s){this.id=ct(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(N),this._motion=t.get(at),this._meetTx=e.get(N),this._meetMotion=e.get(at),this._current=new T(this._tx.pos.x,this._tx.pos.y),this._end=new T(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=s||0,s!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const e=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));e!==0&&!this._speedWasSpecified&&(this._speed=e),this._current=E(this._tx.pos.x,this._tx.pos.y),this._end=E(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const s=this._dir.scale(this._speed);this._motion.vel=E(s.x,s.y),this.isComplete()&&(this._tx.pos=E(this._end.x,this._end.y),this._motion.vel=E(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=E(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class vc{constructor(t,e,s=1e3){var i;this.id=ct(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(It),this._duration=s,this._entity=t,this._material=(i=t.scene)===null||i===void 0?void 0:i.engine.graphicsContext.createMaterial({name:"flash-material",color:e,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=s}update(t){var e;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((e=this._material)===null||e===void 0||e.update(s=>{s.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Ln{constructor(t){var e;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(e=t.quality)!==null&&e!==void 0?e:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,e){this._controlPoints[t]=e,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let e=this.controlPoints[0];const s=this.controlPoints.length*this.quality;for(let i=0;i<s;i++){const n=i/(s-1),o=this.getPoint(n),a=e.distance(o);t+=a,this._distLookup.push(t),e=o}this._arcLength=t}_getTimeGivenDistance(t){const e=this._distLookup.length,s=this.arcLength;if(t>=0&&t<s){for(let i=0;i<e-1;i++)if(this._distLookup[i]<=t&&t<this._distLookup[i+1])return cs(this._distLookup[i],this._distLookup[i+1],i/(e-1),(i+1)/(e-1),t)}return t/s}getPoint(t){const e=[...this.controlPoints];for(let s=1;s<e.length;s++)for(let i=0;i<e.length-s;i++)e[i]=Nn(e[i],e[i+1],t);return e[0]}getTangent(t){const e=t*t,s=this.controlPoints[0],i=this.controlPoints[1],n=this.controlPoints[2],o=this.controlPoints[3];return s.scale(-3*e+6*t-3).add(i.scale(9*e-12*t+3).add(n.scale(-9*e+6*t).add(o.scale(3*e)))).normalize()}getUniformTangent(t){const e=t*this.arcLength,s=this._getTimeGivenDistance(e);return this.getTangent(s)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const e=t*this.arcLength,s=this._getTimeGivenDistance(e);return this.getPoint(s)}clone(){return new Ln({controlPoints:[...this.controlPoints],quality:this.quality})}}class wc{constructor(t,e){var s;if(this.id=ct(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(N),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Ln({controlPoints:[E(0,0),...e.controlPoints],quality:e.quality}),this._durationMs=e.duration,this._mode=(s=e.mode)!==null&&s!==void 0?s:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(e):this._tx.pos=this._curve.getUniformPoint(e),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class xc{constructor(t,e){var s;if(this.id=ct(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(N),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Ln({controlPoints:[E(0,0),...e.controlPoints],quality:e.quality}),this._durationMs=e.duration,this._mode=(s=e.mode)!==null&&s!==void 0?s:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const e=tt(cs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(e):this._tx.pos=this._curve.getUniformPoint(e),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Un{constructor(t){this._entity=t,this._queue=new Xl(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new xc(this._entity,t)),this}curveTo(t){return this._queue.add(new wc(this._entity,t)),this}easeTo(...t){var e,s;let i=0,n=0,o=0,a=ut.Linear;return t[0]instanceof T?(i=t[0].x,n=t[0].y,o=t[1],a=(e=t[2])!==null&&e!==void 0?e:a):(i=t[0],n=t[1],o=t[2],a=(s=t[3])!==null&&s!==void 0?s:a),this._queue.add(new dc(this._entity,i,n,o,a)),this}easeBy(...t){var e,s;let i=0,n=0,o=0,a=ut.Linear;return t[0]instanceof T?(i=t[0].x,n=t[0].y,o=t[1],a=(e=t[2])!==null&&e!==void 0?e:a):(i=t[0],n=t[1],o=t[2],a=(s=t[3])!==null&&s!==void 0?s:a),this._queue.add(new fc(this._entity,i,n,o,a)),this}moveTo(t,e,s){let i=0,n=0,o=0;return t instanceof T?(i=t.x,n=t.y,o=+(e??0),this._queue.add(new Vo(this._entity,i,n,o))):typeof t=="number"&&typeof e=="number"&&typeof s=="number"?(i=t,n=e,o=s,this._queue.add(new Vo(this._entity,i,n,o))):tc(t)&&this._queue.add(new ec(this._entity,t)),this}moveBy(t,e,s){let i=0,n=0,o=0;return t instanceof T&&typeof e=="number"?(i=t.x,n=t.y,o=e,this._queue.add(new zo(this._entity,i,n,o))):typeof t=="number"&&typeof e=="number"&&typeof s=="number"?(i=t,n=e,o=s,this._queue.add(new zo(this._entity,i,n,o))):Jl(t)&&this._queue.add(new Kl(this._entity,t)),this}rotateTo(t,e,s){return typeof t=="number"&&typeof e=="number"?this._queue.add(new ic(this._entity,t,e,s)):typeof t=="object"&&this._queue.add(new sc(this._entity,t)),this}rotateBy(t,e,s){return typeof t=="object"?this._queue.add(new nc(this._entity,t)):this._queue.add(new rc(this._entity,t,e,s)),this}scaleTo(t,e,s,i){let n=1,o=1,a=0,h=0;return oc(t)?(this._queue.add(new ac(this._entity,t)),this):(t instanceof T&&e instanceof T&&(n=t.x,o=t.y,a=e.x,h=e.y),typeof t=="number"&&typeof e=="number"&&(n=t,o=e,a=s,h=i),this._queue.add(new hc(this._entity,n,o,a,h)),this)}scaleBy(t,e,s){if(lc(t))return this._queue.add(new cc(this._entity,t)),this;let i=1,n=1;return t instanceof T&&(i=t.x,n=t.y,s=e),typeof t=="number"&&typeof e=="number"&&(i=t,n=e),this._queue.add(new uc(this._entity,i,n,s)),this}blink(t,e,s=1){return this._queue.add(new pc(this._entity,t,e,s)),this}fade(t,e){return this._queue.add(new _c(this._entity,t,e)),this}flash(t,e=1e3){return this._queue.add(new vc(this._entity,t,e)),this}delay(t){return this._queue.add(new gc(t)),this}die(){return this._queue.add(new mc(this._entity)),this}callMethod(t){return this._queue.add(new tl(t)),this}repeat(t,e){return e?(this._queue.add(new jl(this._entity,t,e)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new Yl(this._entity,t)),this}follow(t,e){return e===void 0?this._queue.add(new Wo(this._entity,t)):this._queue.add(new Wo(this._entity,t,e)),this}meet(t,e){return e===void 0?this._queue.add(new Ho(this._entity,t)):this._queue.add(new Ho(this._entity,t,e)),this}toPromise(){return new Promise(e=>{this._queue.add(new tl(()=>{e()}))})}}class Ri extends Ue{constructor(){super(...arguments),this.dependencies=[N,at],this._ctx=null}onAdd(t){this._ctx=new Un(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var e;return(e=this._ctx)===null||e===void 0?void 0:e.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,e,s){return this._getCtx().moveTo.apply(this._ctx,[t,e,s])}moveBy(t,e,s){return this._getCtx().moveBy.apply(this._ctx,[t,e,s])}rotateTo(t,e,s){return this._getCtx().rotateTo.apply(this._ctx,[t,e,s])}rotateBy(t,e,s){return this._getCtx().rotateBy.apply(this._ctx,[t,e,s])}scaleTo(t,e,s,i){return this._getCtx().scaleTo.apply(this._ctx,[t,e,s,i])}scaleBy(t,e,s){return this._getCtx().scaleBy.apply(this._ctx,[t,e,s])}blink(t,e,s){return this._getCtx().blink(t,e,s)}fade(t,e){return this._getCtx().fade(t,e)}flash(t,e=1e3){return this._getCtx().flash(t,e)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,e){return this._getCtx().repeat(t,e)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,e){return this._getCtx().follow(t,e)}meet(t,e){return this._getCtx().meet(t,e)}toPromise(){return this._getCtx().toPromise()}}function Nf(r){return r instanceof fe}const Lf={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class fe extends oe{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(N).scale}set scale(t){this.get(N).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=qe(t,e=>this._handleAnchorChange(e)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=qe(t,e=>this._handleOffsetChange(e)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new yt,this._anchor=qe(T.Half,I=>this._handleAnchorChange(I)),this._offset=qe(T.Zero,I=>this._handleOffsetChange(I)),this.logger=V.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=I=>{this._dragging&&(this.pos=I.worldPos)},this._pointerDragLeaveHandler=I=>{this._dragging&&(this.pos=I.worldPos)};const{name:e,x:s,y:i,pos:n,coordPlane:o,scale:a,width:h,height:l,radius:c,collider:u,vel:d,acc:f,rotation:p,angularVelocity:_,z:v,color:g,visible:w,opacity:C,anchor:b,offset:x,collisionType:A,collisionGroup:y,silenceWarnings:S}={...t};this.name=e??this.name,this.anchor=b??fe.defaults.anchor.clone(),this.offset=x??T.Zero,this.transform=new N,this.addComponent(this.transform),this.pos=n??E(s??0,i??0),this.rotation=p??0,this.scale=a??E(1,1),this.z=v??0,this.transform.coordPlane=o??te.World,this._silenceWarnings=S??!1,this.pointer=new Ws,this.addComponent(this.pointer),this.graphics=new It({anchor:this.anchor,offset:this.offset,opacity:C}),this.addComponent(this.graphics),this.motion=new at,this.addComponent(this.motion),this.vel=d??T.Zero,this.acc=f??T.Zero,this.angularVelocity=_??0,this.actions=new Ri,this.addComponent(this.actions),this.body=new it,this.addComponent(this.body),this.body.collisionType=A??X.Passive,y&&(this.body.group=y),g&&(this.color=g),u?(this.collider=new Nt(u),this.addComponent(this.collider)):c?(this.collider=new Nt(re.Circle(c)),this.addComponent(this.collider),g&&this.graphics.add(new Gr({color:g,radius:c}))):h>0&&l>0?(this.collider=new Nt(re.Box(h,l,this.anchor)),this.addComponent(this.collider),g&&h&&l&&this.graphics.add(new On({color:g,width:h,height:l}))):(this.collider=new Nt,this.addComponent(this.collider)),this.graphics.isVisible=w??!0}clone(){const t=new fe({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const e=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],s=this.getComponents();for(const i of s)e.includes(i)||t.addComponent(i.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const e of this.children)e._initialize(t)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}_prekill(t){this.events.emit("prekill",new va(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new wa(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Vr(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(N).z}set z(t){this.get(N).z=t}get center(){const t=this.getGlobalPos();return new T(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new T(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(N).globalRotation}get globalRotation(){return this.get(N).globalRotation}getGlobalPos(){return this.get(N).globalPos}get globalPos(){return this.get(N).globalPos}getGlobalScale(){return this.get(N).globalScale}get globalScale(){return this.get(N).globalScale}get globalZ(){return this.get(N).globalZ}contains(t,e,s=!1){const i=E(t,e),n=this.get(Nt);n.update();const o=n.get();if(!o)return!1;const a=o.contains(i);return s?a||this.children.some(h=>h.contains(t,e,!0)):a}within(t,e){const s=this.get(Nt),i=t.get(Nt),n=s.get(),o=i.get();return n&&o?n.getClosestLineBetween(o).getLength()<=e:!1}update(t,e){this._initialize(t),this._add(t),this._preupdate(t,e),this._postupdate(t,e),this._remove(t)}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreCollisionResolve(t,e,s,i){}onPostCollisionResolve(t,e,s,i){}onCollisionStart(t,e,s,i){}onCollisionEnd(t,e,s,i){}_preupdate(t,e){this.events.emit("preupdate",new Gs(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.events.emit("postupdate",new Xs(t,e,this)),this.onPostUpdate(t,e)}}fe.defaults={anchor:T.Half};function yc(r){return r instanceof Qa}class Qa extends fe{constructor(t){var e,s;super({...t}),this.get(N).coordPlane=te.Screen,this.anchor=(e=t==null?void 0:t.anchor)!==null&&e!==void 0?e:E(0,0),this.body.collisionType=(s=t==null?void 0:t.collisionType)!==null&&s!==void 0?s:X.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(t!=null&&t.collider)&&(t==null?void 0:t.width)>0&&(t==null?void 0:t.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,e,s=!0){if(s)return super.contains(t,e);const i=this._engine.worldToScreenCoordinates(new T(t,e));return super.contains(i.x,i.y)}}class ni{get complete(){return this._complete}constructor(t){var e;this._logger=V.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const s=(e=t.action)!==null&&e!==void 0?e:t.fcn,i=t.interval,n=t.repeats,o=t.numberOfRepeats,a=t.randomRange,h=t.random;if(o&&o>=0&&(this.maxNumberOfRepeats=o,!n))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=ni._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=i,a){if(a[0]>a[1])throw new Error("min value must be lower than max value for range");this.random=h??new Yi,this.randomRange=a,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=n||this.repeats,s&&this.on(s)}on(t){this._callbacks.push(t)}off(t){const e=this._callbacks.indexOf(t);this._callbacks.splice(e,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(e=>{e.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,e){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=e,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}ni._MAX_ID=0;class Xr extends Ue{constructor(t){super(),this.parallaxFactor=E(1,1),this.parallaxFactor=t??this.parallaxFactor}}class jr extends Ue{constructor(t,e=!0){super(),this.draw=t,this.useTransform=e}}function el(r){return r&&r._dispatchPointerEvents&&r._processPointerToObject}class Uf{get events(){return this.object.events}init(t,e,s){this.object=t,this.contains=e,this.active=s}}class Ja{constructor(){this._proxyPool=new Mn(()=>new Uf,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,e,s){const i=this._proxyPool.rent(!1);i.init(t,e,s),this._proxies.push(i),this._objectToProxy.set(t,i)}_getProxy(t){const e=this._objectToProxy.get(t);if(e)return e;throw new Error("No PointerTargetProxy for object")}removeObject(t){const e=this._objectToProxy.get(t);if(e){const s=this._proxies.indexOf(e);s>-1&&this._proxies.splice(s,1),this._proxyPool.return(e)}}_objectCurrentlyUnderPointer(t,e){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(e))}_objectWasUnderPointer(t,e){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(e))}_entered(t,e){return this._objectCurrentlyUnderPointer(t,e)&&!this._lastFrameObjectToPointers.has(t)}_left(t,e){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,e)}addPointerToObject(t,e){const s=this._objectToProxy.get(t);s&&this._addPointerToProxy(s,e)}_addPointerToProxy(t,e){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[e]);return}const s=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,s.concat(e))}dispatchEvents(t,e){const s=new Set(this._lastFrameObjectToPointers.keys()),i=new Set(this._currentFrameObjectToPointers.keys());let n,o,a;for(let h=0;h<e.length;h++){const l=e[h],c=this._getProxy(l);if(el(l)&&l._dispatchPointerEvents(t),s.has(c)||i.has(c)){a=this._processDownAndEmit(t,c),o=this._processUpAndEmit(t,c),n=this._processMoveAndEmit(t,c);const u=[...n.values(),...a.values(),...o.values()];this._processEnterLeaveAndEmit(t,c,u),this._processCancelAndEmit(t,c),this._processWheelAndEmit(t,c)}}}processPointerToObject(t,e){for(let s=0;s<e.length;s++){const i=e[s],n=this._getProxy(i);el(i)&&i._processPointerToObject(t);for(const[o,a]of t.currentFramePointerCoords.entries())n.contains(a)&&this._addPointerToProxy(n,o)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,e){const s=new Map;for(const i of t.currentFrameDown)i.active&&this._objectCurrentlyUnderPointer(e,i.pointerId)&&(e.events.emit("pointerdown",i),t.isDragStart(i.pointerId)&&e.events.emit("pointerdragstart",i)),s.set(i.pointerId,i);return s}_processUpAndEmit(t,e){const s=new Map;for(const i of t.currentFrameUp)i.active&&this._objectCurrentlyUnderPointer(e,i.pointerId)&&(e.events.emit("pointerup",i),t.isDragEnd(i.pointerId)&&e.events.emit("pointerdragend",i)),s.set(i.pointerId,i);return s}_processMoveAndEmit(t,e){const s=new Map;for(const i of t.currentFrameMove)i.active&&e.active()&&this._objectCurrentlyUnderPointer(e,i.pointerId)&&(e.events.emit("pointermove",i),t.isDragging(i.pointerId)&&e.events.emit("pointerdragmove",i)),s.set(i.pointerId,i);return s}_processEnterLeaveAndEmit(t,e,s){for(const i of s){if(i.active&&e.active()&&this._entered(e,i.pointerId)){e.events.emit("pointerenter",i),t.isDragging(i.pointerId)&&e.events.emit("pointerdragenter",i);break}if(i.active&&e.active()&&(this._left(e,i.pointerId)||this._objectCurrentlyUnderPointer(e,i.pointerId)&&i.type==="up")){e.events.emit("pointerleave",i),t.isDragging(i.pointerId)&&e.events.emit("pointerdragleave",i);break}}}_processCancelAndEmit(t,e){for(const s of t.currentFrameCancel)s.active&&e.active()&&this._objectCurrentlyUnderPointer(e,s.pointerId)&&e.events.emit("pointercancel",s)}_processWheelAndEmit(t,e){for(const s of t.currentFrameWheel)s.active&&e.active()&&this._objectCurrentlyUnderPointer(e,0)&&e.events.emit("pointerwheel",s)}}const zf={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class bc extends oe{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var e;!((e=this.transform)===null||e===void 0)&&e.pos&&(this.get(N).pos=E(t,this.y))}get y(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&e!==void 0?e:0}set y(t){var e;!((e=this.transform)===null||e===void 0)&&e.pos&&(this.transform.pos=E(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&e!==void 0?e:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,e;return(e=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&e!==void 0?e:T.One}set scale(t){var e;!((e=this.transform)===null||e===void 0)&&e.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,s,i;super([],t.name),this.events=new yt,this._token=0,this.logger=V.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(e=t.meshingLookBehind)!==null&&e!==void 0?e:this.meshingLookBehind,this.addComponent(new N),this.addComponent(new at),this.addComponent(new it({type:X.Fixed})),this.addComponent(new It({onPostDraw:(o,a)=>this.draw(o,a)})),this.addComponent(new jr((o,a)=>this.debug(o,a),!1)),this.addComponent(new Nt),this.addComponent(new Ws),this.pointer=this.get(Ws),this._graphics=this.get(It),this.transform=this.get(N),this._motion=this.get(at),this.collider=this.get(Nt),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(s=t.pos)!==null&&s!==void 0?s:T.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(i=t.renderFromTopOfGraphic)!==null&&i!==void 0?i:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new Ja,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let n=[];for(let o=0;o<this.columns;o++){for(let a=0;a<this.rows;a++){const h=new Cc({x:o,y:a,map:this});h.map=this,this.tiles[o+a*this.columns]=h,this._pointerEventDispatcher.addObject(h,l=>h.bounds.contains(l.worldPos),()=>!0),n.push(h),this._rows[a]||(this._rows[a]=[]),this._rows[a].push(h)}this._cols[o]=n,n=[]}this._graphics.localBounds=new z({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var e;if(this._originalOffsets.has(t))return(e=this._originalOffsets.get(t))!==null&&e!==void 0?e:T.Zero;{const s=t.offset;return this._originalOffsets.set(t,s),s}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let e=null;const s=(n,o)=>n&&o?n.top===o.top&&n.bottom===o.bottom&&n.right===o.left:!1,i=(n,o,a=this.meshingLookBehind)=>{if(!n)return!1;for(let h=o.length-1;h>=0;h--){if(a--<0)return!1;const l=o[h];if(s(l,n))return o[h]=l.combine(n),!0}return!1};for(let n=0;n<this.columns;n++){for(let o=0;o<this.rows;o++){const a=this.tiles[n+o*this.columns];if(a.solid)if(a.getColliders().length>0){for(const h of a.getColliders()){const l=this._getOrSetColliderOriginalOffset(h);h.offset=E(a.x*this.tileWidth*this.scale.x,a.y*this.tileHeight*this.scale.y).add(l),h.owner=this,this._composite.addCollider(h)}e&&!i(e,t)&&t.push(e),e=null}else e?e=e.combine(a.defaultGeometry):e=a.defaultGeometry;else e&&!i(e,t)&&t.push(e),e=null}e&&!i(e,t)&&t.push(e),e=null}for(const n of t){const o=re.Box(n.width,n.height,T.Zero,E(n.left-this.pos.x,n.top-this.pos.y));o.owner=this,this._composite.addCollider(o)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var e;return(e=this.tiles[t])!==null&&e!==void 0?e:null}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){const{x:e,y:s}=this._getTileCoordinates(t),i=this.getTile(e,s);return e>=0&&s>=0&&e<this.columns&&s<this.rows&&i?i:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const e=Math.floor(t.x/this.tileWidth),s=Math.floor(t.y/this.tileHeight);return{x:e,y:s}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const e=this.get(Xr);if(e&&this.isInitialized){let f=this.pos;const p=T.One.sub(e.parallaxFactor),_=this._engine.currentScene.camera.pos.scale(p);f=f.sub(_),t=t.translate(f)}const s=this.transform.coordPlane===te.Screen?this._engine.screen.getScreenBounds():t,i=this._getTileCoordinates(s.topLeft),n=this._getTileCoordinates(s.topRight),o=this._getTileCoordinates(s.bottomRight),a=this._getTileCoordinates(s.bottomLeft),h=Math.min(tt(i.x,0,this.columns-1),tt(n.x,0,this.columns-1)),l=Math.min(tt(i.y,0,this.rows-1),tt(n.y,0,this.rows-1)),c=Math.max(tt(o.x,0,this.columns-1),tt(a.x,0,this.columns-1)),u=Math.max(tt(o.y,0,this.rows-1),tt(a.y,0,this.rows-1)),d=[];for(let f=h;f<=c;f++)for(let p=l;p<=u;p++)d.push(this.getTile(f,p));return d}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,e){this._initialize(t),this.onPreUpdate(t,e),this.emit("preupdate",new Gs(t,e,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,e),this.emit("postupdate",new Xs(t,e,this))}draw(t,e){if(!this.isInitialized)return;this.emit("predraw",new Ji(t,e,this));let s,i,n;const o=this.getOnScreenTiles();for(let a=0;a<o.length;a++){const h=o[a],l=h.getGraphicsOffsets();for(s=h.getGraphics(),i=0,n=s.length;i<n;i++){const c=s[i],u=l[i];if(c){ma(c)&&(c==null||c.tick(e,this._token));const d=this.renderFromTopOfGraphic?0:c.height-this.tileHeight;c.draw(t,h.x*this.tileWidth+u.x,h.y*this.tileHeight-d+u.y)}}}this.emit("postdraw",new Ki(t,e,this))}debug(t,e){const{showAll:s,showGrid:i,gridColor:n,gridWidth:o,showSolidBounds:a,solidBoundsColor:h,showColliderGeometry:l}=e.tilemap,{geometryColor:c,geometryLineWidth:u,geometryPointSize:d}=e.collider,f=this.tileWidth*this.columns*this.scale.x,p=this.tileHeight*this.rows*this.scale.y,_=this.pos;if(i||s){for(let v=0;v<this.rows+1;v++){const g=E(0,v*this.tileHeight*this.scale.y);t.drawLine(_.add(g),_.add(E(f,g.y)),n,o)}for(let v=0;v<this.columns+1;v++){const g=E(v*this.tileWidth*this.scale.x,0);t.drawLine(_.add(g),_.add(E(g.x,p)),n,o)}}if(s||a||l){const v=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const g of v){const w=g.localBounds,C=g.worldPos.sub(this.pos);a&&t.drawRectangle(C,w.width,w.height,h)}if(t.restore(),l)for(const g of v)g.debug(t,c,{lineWidth:u,pointSize:d})}if(s||a){if(t.save(),t.z=999,a)for(let v=0;v<this.tiles.length;v++)this.tiles[v].bounds.draw(t);t.restore()}}}class Cc{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var e;(e=this.map)===null||e===void 0||e.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,e){this._graphics.push(t),e!=null&&e.offset?this._offsets.push(e.offset):this._offsets.push(T.Zero)}removeGraphic(t){const e=this._graphics.indexOf(t);e>-1&&(this._graphics.splice(e,1),this._offsets.splice(e,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var e,s;this._posDirty=!1,this.events=new yt,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(e=t.solid)!==null&&e!==void 0?e:this.solid,this._graphics=(s=t.graphics)!==null&&s!==void 0?s:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(E(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new z(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(E(this.x*this._width,this.y*this._height)),this._bounds=new z(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new T(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){e?this.events.off(t,e):this.events.off(t)}}class Tc{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new Ac(t))}lockToActorAxis(t,e){this.camera.addStrategy(new Sc(t,e))}elasticToActor(t,e,s){this.camera.addStrategy(new Ec(t,e,s))}radiusAroundActor(t,e){this.camera.addStrategy(new Pc(t,e))}limitCameraBounds(t){this.camera.addStrategy(new Ic(t))}}var Ar;(function(r){r[r.X=0]="X",r[r.Y=1]="Y"})(Ar||(Ar={}));class Ac{constructor(t){this.target=t,this.action=(e,s,i,n)=>e.center}}class Sc{constructor(t,e){this.target=t,this.axis=e,this.action=(s,i,n,o)=>{const a=s.center,h=i.getFocus();return this.axis===Ar.X?new T(a.x,h.y):new T(h.x,a.y)}}}class Ec{constructor(t,e,s){this.target=t,this.cameraElasticity=e,this.cameraFriction=s,this.action=(i,n,o,a)=>{const h=i.center;let l=n.getFocus(),c=n.vel.clone();const u=h.sub(l).scale(this.cameraElasticity);c=c.add(u);const d=c.scale(-1).scale(this.cameraFriction);return c=c.add(d),l=l.add(c),l}}}class Pc{constructor(t,e){this.target=t,this.radius=e,this.action=(s,i,n,o)=>{const a=s.center,h=i.getFocus(),l=a.sub(h),c=l.magnitude;if(c>=this.radius){const u=c-this.radius;return h.add(l.normalize().scale(u))}return h}}}class Ic{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(e,s,i,n)=>{const o=s.getFocus();this.boundSizeChecked||((e.bottom-e.top<i.drawHeight||e.right-e.left<i.drawWidth)&&V.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let a=o.x,h=o.y;return o.x<e.left+i.halfDrawWidth?a=e.left+i.halfDrawWidth:o.x>e.right-i.halfDrawWidth&&(a=e.right-i.halfDrawWidth),o.y<e.top+i.halfDrawHeight?h=e.top+i.halfDrawHeight:o.y>e.bottom-i.halfDrawHeight&&(h=e.bottom-i.halfDrawHeight),E(a,h)}}}const Vf={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Mc{constructor(){this.events=new yt,this.transform=Ot.identity(),this.inverse=Ot.identity(),this._cameraStrategies=[],this.strategy=new Tc(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Bs(T.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=T.Zero,this.acc=T.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=ut.EaseInOutCubic,this._easing=ut.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=E(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Bs(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=E(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=E(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=E(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=E(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=E(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=E(this.acc.x,t)}getFocus(){return this.pos}move(t,e,s=ut.EaseInOutCubic){if(typeof s!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(i=>{this._lerpResolve=i}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=e,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=s,this._lerpPromise)}shake(t,e,s){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=e,this._shakeDuration=s}zoomOverTime(t,e=0,s=ut.EaseInOutCubic){if(this._zoomPromise=new Promise(i=>{this._zoomResolve=i}),e)this._isZooming=!0,this._zoomEasing=s,this._currentZoomTime=0,this._zoomDuration=e,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new z(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){$i(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,e){this.events.emit("preupdate",new Gs(t,e,this)),this.onPreUpdate(t,e)}onPreUpdate(t,e){}_postupdate(t,e){this.events.emit("postupdate",new Xs(t,e,this)),this.onPostUpdate(t,e)}onPostUpdate(t,e){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const e=this._screen.contentArea;let s=E(e.width/2,e.height/2);if(!this._engine.loadingComplete){const i=this._screen.peekResolution();i&&(s=E(i.width/2,i.height/2))}this._halfWidth=s.x,this._halfHeight=s.y,this._posChanged||(this.pos=s),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new tn(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}runStrategies(t,e){for(const s of this._cameraStrategies)this.pos=s.action.call(s,s.target,this,t,e)}updateViewport(){this._viewport=new z(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,e){if(this._initialize(t),this._preupdate(t,e),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(e/1e3)),this.zoom+=this.dz*e/1e3,this.vel=this.vel.add(this.acc.scale(e/1e3)),this.dz+=this.az*e/1e3,this.rotation+=this.angularVelocity*e/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const s=this._zoomEasing,i=s(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=i,this._currentZoomTime+=e}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const i=ut.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=i,this._currentLerpTime+=e}else{this.pos=this._lerpEnd;const s=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(s)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=e,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,e),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,e),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const e=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,s=this.pos.scale(e).add(this._oldPos.scale(1-e));s.clone(this.drawPos),this.updateTransform(s)}if(t.snapToPixel){const e=this.drawPos.clone(this._snapPos);e.x=~~(e.x+$*_t(e.x)),e.y=~~(e.y+$*_t(e.y)),e.clone(this.drawPos),this.updateTransform(e)}t.multiply(this.transform)}updateTransform(t){const e=this._screen.resolution.width/this.zoom,s=this._screen.resolution.height/this.zoom,i=E(-t.x+e/2+this._xShake,-t.y+s/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(e/2,s/2),this.transform.rotate(this.rotation),this.transform.translate(-e/2,-s/2),this.transform.translate(i.x,i.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Wf={ExitTrigger:"exit",EnterTrigger:"enter"};class Rc extends fe{constructor(t){var e,s,i,n;super({...t}),this.events=new yt,this.filter=(e=t.filter)!==null&&e!==void 0?e:()=>!0,this.repeat=(s=t.repeat)!==null&&s!==void 0?s:-1,this.action=(i=t.action)!==null&&i!==void 0?i:()=>{},this.target=t.target,this.graphics.isVisible=(n=t.visible)!==null&&n!==void 0?n:!1,this.body.collisionType=X.Passive,this.events.on("collisionstart",({other:o})=>{this._matchesTarget(o.owner)&&(this.events.emit("enter",new La(this,o.owner)),this._dispatchAction(o.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:o})=>{this._matchesTarget(o.owner)&&this.events.emit("exit",new Ua(this,o.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const us={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var Ee;(function(r){r.Update="update",r.Draw="draw"})(Ee||(Ee={}));class ke{}ke.priority=us.Average;class Dc{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>e=>{this.addEntity(e)},this._createChildRemovedHandler=()=>e=>{this.removeEntity(e,!1)},this._entitiesToRemove=[]}updateEntities(t,e){for(let s=0;s<this.entities.length;s++){const i=this.entities[s];i.update(t.engine,e),i.isActive||this.removeEntity(i)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const e=this.entities[t];e.isActive||this.removeEntity(e)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(i=>{i.scene=t.scene,this.addEntity(i)});const e=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,e);const s=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,s),t.childrenAdded$.subscribe(e),t.childrenRemoved$.subscribe(s)}}removeEntity(t,e=!0){var s,i;let n=0;t instanceof oe?n=t.id:n=t;const o=this._entityIndex[n];if(o&&o.isActive&&(o.isActive=!1),o&&e){this._entitiesToRemove.push(o);return}if(delete this._entityIndex[n],o){o.scene=null,$i(o,this.entities),this._world.queryManager.removeEntity(o),o.children.forEach(l=>{l.scene=null,this.removeEntity(l,e)});const a=this._childAddedHandlerMap.get(o);a&&o.childrenAdded$.unsubscribe(a);const h=this._childRemovedHandlerMap.get(o);h&&o.childrenRemoved$.unsubscribe(h),!((i=(s=this._world)===null||s===void 0?void 0:s.scene)===null||i===void 0)&&i.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const e=this._entitiesToRemove[t];e.isActive||this.removeEntity(e,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(e=>e.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class xn{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new ue,this.entityRemoved$=new ue,t.length===0)throw new Error("Cannot create query without components");for(const e of t)this.components.add(e);this.id=xn.createId(t)}static createId(t){return t.slice().map(e=>e.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&(this.entities.splice(e,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class yn{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new ue,this.entityRemoved$=new ue,t.length===0)throw new Error("Cannot create tag query without tags");for(const e of t)this.tags.add(e);this.id=yn.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&(this.entities.splice(e,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class kc{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=e=>s=>{this.addComponent(e,s)},this._createRemoveComponentHandler=e=>s=>{this.removeComponent(e,s)},this._createAddTagHandler=e=>s=>{this.addTag(e,s)},this._createRemoveTagHandler=e=>s=>{this.removeTag(e,s)}}createQuery(t){const e=xn.createId(t);if(this._queries.has(e))return this._queries.get(e);const s=new xn(t);this._queries.set(s.id,s);for(const i of t){const n=this._componentToQueriesIndex.get(i);n?n.push(s):this._componentToQueriesIndex.set(i,[s])}for(const i of this._world.entities)this.addEntity(i);return s}createTagQuery(t){const e=yn.createId(t);if(this._tagQueries.has(e))return this._tagQueries.get(e);const s=new yn(t);this._tagQueries.set(s.id,s);for(const i of t){const n=this._tagToQueriesIndex.get(i);n?n.push(s):this._tagToQueriesIndex.set(i,[s])}for(const i of this._world.entities)this.addEntity(i);return s}addEntity(t){const e=this._addComponentHandlers.get(t),s=this._removeComponentHandlers.get(t),i=e??this._createAddComponentHandler(t),n=s??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,i),this._removeComponentHandlers.set(t,n);const o=this._addTagHandlers.get(t),a=this._removeTagHandlers.get(t),h=o??this._createAddTagHandler(t),l=a??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,h),this._removeTagHandlers.set(t,l);for(const c of this._queries.values())c.checkAndAdd(t);for(const c of this._tagQueries.values())c.checkAndAdd(t);t.componentAdded$.subscribe(i),t.componentRemoved$.subscribe(n),t.tagAdded$.subscribe(h),t.tagRemoved$.subscribe(l)}removeEntity(t){const e=this._addComponentHandlers.get(t),s=this._removeComponentHandlers.get(t);for(const o of this._queries.values())o.removeEntity(t);e&&t.componentAdded$.unsubscribe(e),s&&t.componentRemoved$.unsubscribe(s);const i=this._addTagHandlers.get(t),n=this._removeTagHandlers.get(t);for(const o of this._tagQueries.values())o.removeEntity(t);i&&t.tagAdded$.unsubscribe(i),n&&t.tagRemoved$.unsubscribe(n)}addComponent(t,e){var s;const i=(s=this._componentToQueriesIndex.get(e.constructor))!==null&&s!==void 0?s:[];for(const n of i)n.checkAndAdd(t)}removeComponent(t,e){var s;const i=(s=this._componentToQueriesIndex.get(e.constructor))!==null&&s!==void 0?s:[];for(const n of i)n.removeEntity(t)}addTag(t,e){var s;const i=(s=this._tagToQueriesIndex.get(e))!==null&&s!==void 0?s:[];for(const n of i)n.checkAndAdd(t)}removeTag(t,e){var s;const i=(s=this._tagToQueriesIndex.get(e))!==null&&s!==void 0?s:[];for(const n of i)n.removeEntity(t)}}function Fc(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class Bc{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(e=>e instanceof t)}addSystem(t){let e;t instanceof ke?e=t:e=new t(this._world),this.systems.push(e),this.systems.sort((s,i)=>s.constructor.priority-i.constructor.priority),this.initialized&&e.initialize&&e.initialize(this._world,this._world.scene)}removeSystem(t){$i(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,e,s){const i=this.systems.filter(n=>n.systemType===t);for(const n of i)n.preupdate&&n.preupdate(e,s);for(const n of i)n.update(s);for(const n of i)n.postupdate&&n.postupdate(e,s)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class Oc{constructor(t){this.scene=t,this._logger=V.getInstance(),this.queryManager=new kc(this),this.entityManager=new Dc(this),this.systemManager=new Bc(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,e){t===Ee.Update&&this.entityManager.updateEntities(this.scene,e),this.systemManager.updateSystems(t,this.scene,e),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof oe){this.entityManager.addEntity(t);return}if(t instanceof ke||Fc(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,e=!0){if(t instanceof oe){this.entityManager.removeEntity(t,e);return}if(t instanceof ke){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class Yr extends ke{constructor(t,e){super(),this.world=t,this.physics=e,this.systemType=Ee.Update,this._physicsConfigDirty=!1,e.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([N,at])}update(t){let e,s;const i=this.query.entities,n=this.physics.config.substep;for(let o=0;o<i.length;o++){e=i[o].get(N),s=i[o].get(at);const a=i[o].get(it);if(this._physicsConfigDirty&&a&&a.updatePhysicsConfig(this.physics.config.bodies),a!=null&&a.isSleeping)continue;const h=s.acc.clone();(a==null?void 0:a.collisionType)===X.Active&&(a!=null&&a.useGravity)&&h.addEqual(this.physics.config.gravity),i[o].parent||this.captureOldTransformWithChildren(i[o]),ce.integrate(e,s,h,t/n)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var e;(e=t.get(it))===null||e===void 0||e.captureOldTransform();for(let s=0;s<t.children.length;s++)this.captureOldTransformWithChildren(t.children[s])}}Yr.priority=us.Higher;class qo{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(s=>!s.isCanceled());let e;switch(this.config.contactSolveBias){case As.HorizontalFirst:{e=Ya;break}case As.VerticalFirst:{e=ja;break}default:e=$a}t.sort((s,i)=>{const n=this.directionMap.get(s.id),o=this.directionMap.get(i.id),a=this.distanceMap.get(s.id),h=this.distanceMap.get(i.id);return e[n]-e[o]||a-h});for(const s of t)this.solvePosition(s),this.solveVelocity(s);return this.postSolve(t),t}preSolve(t){for(let s=0;s<t.length;s++){const i=t[s];if(Math.abs(i.mtv.x)<1e-4&&Math.abs(i.mtv.y)<1e-4){i.cancel();continue}const n=lt.fromDirection(i.mtv),o=i.mtv.negate(),a=Math.abs(i.info.separation);this.distanceMap.set(i.id,a),this.directionMap.set(i.id,n===lt.Left||n===lt.Right?"horizontal":"vertical"),i.colliderA.events.emit("precollision",new ui(i.colliderA,i.colliderB,n,o,i)),i.colliderB.events.emit("precollision",new ui(i.colliderB,i.colliderA,lt.getOpposite(n),o.negate(),i))}}postSolve(t){var e,s;for(let i=0;i<t.length;i++){const n=t[i];if(n.isCanceled())continue;const o=n.colliderA,a=n.colliderB,h=(e=o.owner)===null||e===void 0?void 0:e.get(it),l=(s=a.owner)===null||s===void 0?void 0:s.get(it);if(h&&l&&(h.collisionType===X.Passive||l.collisionType===X.Passive))continue;const c=lt.fromDirection(n.mtv),u=n.mtv.negate();n.colliderA.events.emit("postcollision",new di(n.colliderA,n.colliderB,c,u,n)),n.colliderB.events.emit("postcollision",new di(n.colliderB,n.colliderA,lt.getOpposite(c),u.negate(),n))}}solvePosition(t){var e,s;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let n=t.mtv;const o=t.colliderA,a=t.colliderB,h=(e=o.owner)===null||e===void 0?void 0:e.get(it),l=(s=a.owner)===null||s===void 0?void 0:s.get(it);if(h&&l){if(h.collisionType===X.Passive||l.collisionType===X.Passive)return;h.collisionType===X.Active&&l.collisionType===X.Active&&(n=n.scale(.5)),h.collisionType===X.Active&&(h.globalPos.x-=n.x,h.globalPos.y-=n.y,o.update(h.transform.get())),l.collisionType===X.Active&&(l.globalPos.x+=n.x,l.globalPos.y+=n.y,a.update(l.transform.get()))}}solveVelocity(t){var e,s;if(t.isCanceled())return;const i=t.colliderA,n=t.colliderB,o=(e=i.owner)===null||e===void 0?void 0:e.get(it),a=(s=n.owner)===null||s===void 0?void 0:s.get(it);if(o&&a){if(o.collisionType===X.Passive||a.collisionType===X.Passive)return;const h=t.normal,l=h.negate();if(o.collisionType===X.Active&&o.vel.normalize().dot(l)<0){const c=h.scale(h.dot(o.vel.negate()));o.vel=o.vel.add(c)}if(a.collisionType===X.Active&&a.vel.normalize().dot(h)<0){const c=l.scale(l.dot(a.vel.negate()));a.vel=a.vel.add(c)}}}}class Nc{constructor(t,e,s){this.point=t,this.local=e,this.contact=s,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new T(0,0),this.bToContact=new T(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,e=this.contact.colliderA,s=this.contact.bodyB,i=this.contact.colliderB;if(t&&s){const n=this.contact.normal,o=this.contact.tangent;this.aToContact=this.point.sub(e.center),this.bToContact=this.point.sub(i.center);const a=this.aToContact.cross(n),h=this.bToContact.cross(n);this.normalMass=t.inverseMass+s.inverseMass+t.inverseInertia*a*a+s.inverseInertia*h*h;const l=this.aToContact.cross(o),c=this.bToContact.cross(o);this.tangentMass=t.inverseMass+s.inverseMass+t.inverseInertia*l*l+s.inverseInertia*c*c}return this}getRelativeVelocity(){const t=this.contact.bodyA,e=this.contact.bodyB;if(t&&e){const s=t.vel.add(T.cross(t.angularVelocity,this.aToContact));return e.vel.add(T.cross(e.angularVelocity,this.bToContact)).sub(s)}return T.Zero}}class Go{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var e;return(e=this.idToContactConstraint.get(t))!==null&&e!==void 0?e:[]}solve(t){this.preSolve(t),t=t.filter(s=>!s.isCanceled());let e;switch(this.config.contactSolveBias){case As.HorizontalFirst:{e=Ya;break}case As.VerticalFirst:{e=ja;break}default:e=$a}return t.sort((s,i)=>{const n=this.directionMap.get(s.id),o=this.directionMap.get(i.id),a=this.distanceMap.get(s.id),h=this.distanceMap.get(i.id);return e[n]-e[o]||a-h}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var e,s,i,n;for(let h=0;h<t.length;h++){const l=t[h];if(Math.abs(l.mtv.x)<1e-4&&Math.abs(l.mtv.y)<1e-4){l.cancel();continue}const c=lt.fromDirection(l.mtv),u=Math.abs(((e=l==null?void 0:l.info)===null||e===void 0?void 0:e.separation)||0);this.distanceMap.set(l.id,u),this.directionMap.set(l.id,c===lt.Left||c===lt.Right?"horizontal":"vertical"),l.colliderA.events.emit("precollision",new ui(l.colliderA,l.colliderB,c,l.mtv,l)),l.colliderA.events.emit("beforecollisionresolve",new yr(l.colliderA,l.colliderB,c,l.mtv,l)),l.colliderB.events.emit("precollision",new ui(l.colliderB,l.colliderA,lt.getOpposite(c),l.mtv.negate(),l)),l.colliderB.events.emit("beforecollisionresolve",new yr(l.colliderB,l.colliderA,lt.getOpposite(c),l.mtv.negate(),l)),l.matchAwake()}const a=Array.from(this.idToContactConstraint.keys());for(let h=0;h<t.length;h++){const l=t[h],c=a.indexOf(l.id);c>-1&&a.splice(c,1);const u=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];let d=0;const f=l.bodyA,p=l.colliderA,_=l.bodyB,v=l.colliderB;if(f&&_)for(let g=0;g<l.points.length;g++){const w=l.points[g],C=l.normal,b=l.tangent,x=w.sub(p.center),A=w.sub(v.center),y=x.cross(C),S=A.cross(C),I=f.inverseMass+_.inverseMass+f.inverseInertia*y*y+_.inverseInertia*S*S,R=x.cross(b),D=A.cross(b),M=f.inverseMass+_.inverseMass+f.inverseInertia*R*R+_.inverseInertia*D*D;u[d]&&((n=(i=u[d])===null||i===void 0?void 0:i.point)===null||n===void 0?void 0:n.squareDistance(w))<4?(u[d].point=w,u[d].local=l.localPoints[d]):u[d]=new Nc(w,l.localPoints[d],l),u[d].aToContact=x,u[d].bToContact=A,u[d].normalMass=1/I,u[d].tangentMass=1/M;const B=f.bounciness>_.bounciness?f.bounciness:_.bounciness,F=l.normal.dot(u[d].getRelativeVelocity());u[d].originalVelocityAndRestitution=0,F<-.1&&(u[d].originalVelocityAndRestitution=-B*F),d++}this.idToContactConstraint.set(l.id,u)}for(const h of a)this.idToContactConstraint.delete(h);if(this.config.warmStart)this.warmStart(t);else for(let h=0;h<t.length;h++){const l=t[h],c=this.getContactConstraints(l.id);for(const u of c)u.normalImpulse=0,u.tangentImpulse=0}}postSolve(t){for(let e=0;e<t.length;e++){const s=t[e],i=s.bodyA,n=s.bodyB;if(i&&n){if(i.collisionType===X.Passive||n.collisionType===X.Passive)continue;i.updateMotion(),n.updateMotion()}const o=lt.fromDirection(s.mtv);s.colliderA.events.emit("postcollision",new di(s.colliderA,s.colliderB,o,s.mtv,s)),s.colliderA.events.emit("aftercollisionresolve",new br(s.colliderA,s.colliderB,o,s.mtv,s)),s.colliderB.events.emit("postcollision",new di(s.colliderB,s.colliderA,lt.getOpposite(o),s.mtv.negate(),s)),s.colliderB.events.emit("aftercollisionresolve",new br(s.colliderB,s.colliderA,lt.getOpposite(o),s.mtv.negate(),s))}this.lastFrameContacts.clear();for(let e=0;e<t.length;e++){const s=t[e];this.lastFrameContacts.set(s.id,s)}}warmStart(t){var e;for(let s=0;s<t.length;s++){const i=t[s],n=i.bodyA,o=i.bodyB;if(n&&o){const a=(e=this.idToContactConstraint.get(i.id))!==null&&e!==void 0?e:[];for(const h of a)if(this.config.warmStart){const l=i.normal.scale(h.normalImpulse),c=i.tangent.scale(h.tangentImpulse),u=l.add(c);n.applyImpulse(h.point,u.negate()),o.applyImpulse(h.point,u)}else h.normalImpulse=0,h.tangentImpulse=0}}}solvePosition(t){var e;for(let s=0;s<this.config.positionIterations;s++)for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,a=n.bodyB;if(o&&a){if(o.collisionType===X.Passive||a.collisionType===X.Passive)continue;const h=(e=this.idToContactConstraint.get(n.id))!==null&&e!==void 0?e:[];for(const l of h){const c=n.normal,u=Ye.FindContactSeparation(n,l.local),d=this.config.steeringFactor,f=-5,p=this.config.slop,_=tt(d*(u+p),f,0),v=c.scale(-_*l.normalMass);if(o.collisionType===X.Active){const g=v.negate().scale(o.inverseMass);o.limitDegreeOfFreedom.includes(me.X)&&(g.x=0),o.limitDegreeOfFreedom.includes(me.Y)&&(g.y=0),o.globalPos=o.globalPos.add(g),o.limitDegreeOfFreedom.includes(me.Rotation)||(o.rotation-=l.aToContact.cross(v)*o.inverseInertia)}if(a.collisionType===X.Active){const g=v.scale(a.inverseMass);a.limitDegreeOfFreedom.includes(me.X)&&(g.x=0),a.limitDegreeOfFreedom.includes(me.Y)&&(g.y=0),a.globalPos=a.globalPos.add(g),a.limitDegreeOfFreedom.includes(me.Rotation)||(a.rotation+=l.bToContact.cross(v)*a.inverseInertia)}}}}}solveVelocity(t){var e;for(let s=0;s<this.config.velocityIterations;s++)for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,a=n.bodyB;if(o&&a){if(o.collisionType===X.Passive||a.collisionType===X.Passive)continue;const h=Math.min(o.friction,a.friction),l=(e=this.idToContactConstraint.get(n.id))!==null&&e!==void 0?e:[];for(const c of l){let f=-c.getRelativeVelocity().dot(n.tangent)*c.tangentMass;const p=h*c.normalImpulse,_=tt(c.tangentImpulse+f,-p,p);f=_-c.tangentImpulse,c.tangentImpulse=_;const v=n.tangent.scale(f);o.applyImpulse(c.point,v.negate()),a.applyImpulse(c.point,v)}for(const c of l){const d=c.getRelativeVelocity().dot(n.normal);let f=-c.normalMass*(d-c.originalVelocityAndRestitution);const p=Math.max(c.normalImpulse+f,0);f=p-c.normalImpulse,c.normalImpulse=p;const _=n.normal.scale(f);o.applyImpulse(c.point,_.negate()),a.applyImpulse(c.point,_)}}}}}class $r extends ke{get _processor(){return this._physics.collisionProcessor}constructor(t,e){super(),this._physics=e,this.systemType=Ee.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new qo(e.config.arcade),this._realisticSolver=new Go(e.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=s=>this._processor.track(s),this._untrackCollider=s=>this._processor.untrack(s),this.query=t.query([N,at,Nt]),this.query.entityAdded$.subscribe(s=>{const i=s.get(Nt);i.$colliderAdded.subscribe(this._trackCollider),i.$colliderRemoved.subscribe(this._untrackCollider);const n=i.get();n&&this._processor.track(n)}),this.query.entityRemoved$.subscribe(s=>{const i=s.get(Nt),n=i.get();i&&n&&this._processor.untrack(n)}),this._motionSystem=t.get(Yr)}initialize(t,e){this._engine=e.engine}update(t){var e,s,i,n;if(!this._physics.config.enabled)return;let o=[];for(let u=0;u<this.query.entities.length;u++){const f=this.query.entities[u].get(Nt),p=f==null?void 0:f.get();if(f&&(!((e=f.owner)===null||e===void 0)&&e.isActive)&&p)if(f.update(),p instanceof $t){const _=p.getColliders();p.compositeStrategy||(p.compositeStrategy=this._physics.config.colliders.compositeStrategy),o=o.concat(_)}else o.push(p)}this._processor.update(o,t);let a=this._processor.broadphase(o,t);this._currentFrameContacts.clear();let h=[];const l=this.getSolver(),c=this._physics.config.substep;for(let u=0;u<c;u++)if(u>0&&this._motionSystem.update(t),h.length&&(a=h.map(d=>new de(d.colliderA,d.colliderB))),a.length){h=this._processor.narrowphase(a,(n=(i=(s=this._engine)===null||s===void 0?void 0:s.debug)===null||i===void 0?void 0:i.stats)===null||n===void 0?void 0:n.currFrame),h=l.solve(h);for(const d of h){if(d.isCanceled())continue;const f=d.id.indexOf("|");if(f>0){const p=d.id.substring(f+1);this._currentFrameContacts.set(p,d)}else this._currentFrameContacts.set(d.id,d)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const u of this.query.entities){const d=u.get(Nt);d&&d.processColliderRemoval()}}postupdate(){Bt.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new qo(this._physics.config.arcade),this._realisticSolver=new Go(this._physics.config.realistic)),this._physics.config.solver===wn.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,e]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const s=e.colliderA,i=e.colliderB,n=lt.fromDirection(e.mtv),o=lt.getOpposite(n);s.events.emit("collisionstart",new _n(s,i,n,e)),s.events.emit("contactstart",new wr(s,i,n,e)),i.events.emit("collisionstart",new _n(i,s,o,e)),i.events.emit("contactstart",new wr(i,s,o,e))}for(const[t,e]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const s=e.colliderA,i=e.colliderB,n=lt.fromDirection(e.mtv),o=lt.getOpposite(n);s.events.emit("collisionend",new gn(s,i,n,e)),s.events.emit("contactend",new xr(s,i,n,e)),i.events.emit("collisionend",new gn(i,s,o,e)),i.events.emit("contactend",new xr(i,s,o,e))}}}$r.priority=us.Higher;function Hf(r,t,e,s){if(r.parent!==t.parent){const c=r.clone(),u=r.globalPos.clone(),d=r.globalScale.clone(),f=r.globalRotation;c.parent=t.parent,c.globalPos=u,c.globalScale=d,c.globalRotation=f,r=c}let i=t.pos,n=t.scale,o=t.rotation;i=t.pos.scale(e).add(r.pos.scale(1-e)),n=t.scale.scale(e).add(r.scale.scale(1-e));const a=(1-e)*Math.cos(r.rotation)+e*Math.cos(t.rotation),h=(1-e)*Math.sin(r.rotation)+e*Math.sin(t.rotation);o=Math.atan2(h,a);const l=s??new Cs;return l.setTransform(i,o,n),l}class Ka extends ke{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=Ee.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Cs,this.query=this.world.query([N,It]),this.query.entityAdded$.subscribe(e=>{const s=e.get(N);this._sortedTransforms.push(s),s.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(e=>{const s=e.get(N);s.zIndexChanged$.unsubscribe(this._zIndexUpdate);const i=this._sortedTransforms.indexOf(s);i>-1&&this._sortedTransforms.splice(i,1)})}initialize(t,e){this._camera=e.camera,this._engine=e.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>t.globalZ-e.globalZ),this._zHasChanged=!1)}update(t){this._token++;let e;ht.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let s=0;s<this._sortedTransforms.length;s++){const i=this._sortedTransforms[s],n=i.owner;if(n.hasTag("ex.offscreen")||(e=n.get(It),!e.isVisible))continue;e.onPreTransformDraw&&e.onPreTransformDraw(this._graphicsContext,t),n.events.emit("pretransformdraw",new ba(this._graphicsContext,t,n)),i.coordPlane===te.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),i.coordPlane===te.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),e.update(t,this._token);const o=n.get(Xr);if(o){const a=T.One.sub(o.parallaxFactor),h=this._camera.drawPos.scale(a);this._graphicsContext.translate(h.x,h.y)}this._applyTransform(n),e.material&&(this._graphicsContext.material=e.material),e.onPreDraw&&e.onPreDraw(this._graphicsContext,t),n.events.emit("predraw",new Ji(this._graphicsContext,t,n)),this._applyOpacity(n),this._drawGraphicsComponent(e,i),e.onPostDraw&&e.onPostDraw(this._graphicsContext,t),n.events.emit("postdraw",new Ki(this._graphicsContext,t,n)),this._graphicsContext.restore(),i.coordPlane===te.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),e.onPostTransformDraw&&e.onPostTransformDraw(this._graphicsContext,t),n.events.emit("posttransformdraw",new Ca(this._graphicsContext,t,n))}this._graphicsContext.restore()}_drawGraphicsComponent(t,e){var s,i;if(t.isVisible){const n=t.flipHorizontal,o=t.flipVertical,a=t.current,h=(s=t.currentOptions)!==null&&s!==void 0?s:{};if(a){let l=t.anchor,c=t.offset,u=1,d=1;h!=null&&h.anchor&&(l=h.anchor),h!=null&&h.offset&&(c=h.offset);const f=e.globalScale;u*=a.scale.x*f.x,d*=a.scale.y*f.y;const p=-a.width*l.x+c.x*u,_=-a.height*l.y+c.y*d,v=a.flipHorizontal,g=a.flipVertical;if((n||o)&&(a.flipHorizontal=n?!v:v,a.flipVertical=o?!g:g),a==null||a.draw(this._graphicsContext,p,_),(n||o)&&(a.flipHorizontal=v,a.flipVertical=g),!((i=this._engine)===null||i===void 0)&&i.isDebug&&this._engine.debug.graphics.showBounds){const w=E(p,_);if(a instanceof Bi)for(const C of a.members){let b,x=T.Zero;C instanceof Pt?b=C:(b=C.graphic,x=C.offset),a.useAnchor?b==null||b.localBounds.translate(w.add(x)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):b==null||b.localBounds.translate(x).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else a==null||a.localBounds.translate(w).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const e=t.getAncestors();for(let s=0;s<e.length;s++){const i=e[s],n=i==null?void 0:i.get(N),o=i==null?void 0:i.get(it);if(n){let a=n.get();if(o&&this._engine.fixedUpdateTimestep&&o.__oldTransformCaptured&&o.enableFixedUpdateInterpolate){const h=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;a=Hf(o.oldTransform,n.get(),h,this._targetInterpolationTransform)}this._graphicsContext.z=n.globalZ,this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation)}}}_applyOpacity(t){var e;const s=t.getAncestors();for(let i=0;i<s.length;i++){const n=s[i],o=n==null?void 0:n.get(It);this._graphicsContext.opacity*=(e=o==null?void 0:o.opacity)!==null&&e!==void 0?e:1}}}Ka.priority=us.Average;class th extends ke{constructor(t){super(),this.world=t,this.systemType=Ee.Draw,this.query=this.world.query([N])}initialize(t,e){this._graphicsContext=e.engine.graphicsContext,this._camera=e.camera,this._engine=e.engine,this._collisionSystem=t.systemManager.get($r)}update(){var t;if(!this._engine.isDebug)return;const e=this._engine.debug.filter;let s,i;const n=this._engine.debug.entity;let o;const a=this._engine.debug.transform;let h;const l=this._engine.debug.motion;let c;const u=this._engine.debug.collider,d=this._engine.debug.physics;let f;const p=this._engine.debug.graphics;let _,v;const g=this._engine.debug.body,w=this._engine.debug.camera;for(let C=0;C<this.query.entities.length;C++){const b=this.query.entities[C];if(b.hasTag("offscreen")||b instanceof Wr||e.useFilter&&(!(e.ids.length===0||e.ids.includes(b.id))||!(e.nameQuery===""||b.name.includes(e.nameQuery))))continue;let x=T.Zero;const A=E(0,16);if(s=b.id,i=b.name,o=b.get(N),this._pushCameraTransform(o),this._graphicsContext.save(),o.coordPlane===te.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=a.debugZIndex,this._applyTransform(b),o&&((a.showAll||a.showPosition)&&this._graphicsContext.debug.drawPoint(T.Zero,{size:4,color:a.positionColor}),(a.showAll||a.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${o.pos.toString(2)}`,x),x=x.add(A)),(a.showAll||a.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${o.z.toFixed(1)})`,x),x=x.add(A)),(n.showAll||n.showId)&&(this._graphicsContext.debug.drawText(`id(${s}) ${b.parent?"child of id("+((t=b.parent)===null||t===void 0?void 0:t.id)+")":""}`,x),x=x.add(A)),(n.showAll||n.showName)&&(this._graphicsContext.debug.drawText(`name(${i})`,x),x=x.add(A)),(a.showAll||a.showRotation)&&(this._graphicsContext.drawLine(T.Zero,T.fromAngle(o.rotation).scale(50).add(T.Zero),a.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${El(o.rotation).toFixed(2)})`,x),x=x.add(A)),(a.showAll||a.showScale)&&this._graphicsContext.drawLine(T.Zero,o.scale.add(T.Zero),a.scaleColor,2)),f=b.get(It),f&&(p.showAll||p.showBounds)&&f.localBounds.draw(this._graphicsContext,p.boundsColor),_=b.get(jr),_&&(_.useTransform||this._graphicsContext.restore(),_.draw(this._graphicsContext,this._engine.debug),_.useTransform||(this._graphicsContext.save(),this._applyTransform(b))),v=b.get(it),v&&((g.showAll||g.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${v.group.name})`,x),x=x.add(A)),(g.showAll||g.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${v.collisionType})`,x),x=x.add(A)),(g.showAll||g.showMass)&&(this._graphicsContext.debug.drawText(`mass(${v.mass})`,x),x=x.add(A)),(g.showAll||g.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${v.sleepMotion})`,x),x=x.add(A)),(g.showAll||g.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${v.canSleep?v.isSleeping:"cant sleep"})`,x),x=x.add(A))),this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===te.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=a.debugZIndex,h=b.get(at),h&&((l.showAll||l.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${h.vel.toString(2)}`,x.add(o.globalPos)),this._graphicsContext.drawLine(o.globalPos,o.globalPos.add(h.vel),l.velocityColor,2),x=x.add(A)),(l.showAll||l.showAcceleration)&&this._graphicsContext.drawLine(o.globalPos,o.globalPos.add(h.acc),l.accelerationColor,2)),c=b.get(Nt),c){const y=c.get();if((u.showAll||u.showGeometry)&&y&&y.debug(this._graphicsContext,u.geometryColor,{lineWidth:u.geometryLineWidth,pointSize:u.geometryPointSize}),u.showAll||u.showBounds){if(y instanceof $t){const S=y.getColliders();for(const I of S){const R=I.bounds,D=E(R.left,R.top);this._graphicsContext.debug.drawRect(D.x,D.y,R.width,R.height,{color:u.boundsColor}),(u.showAll||u.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${I.owner.id})`,D)}c.bounds.draw(this._graphicsContext,u.boundsColor)}else if(y){const S=c.bounds,I=E(S.left,S.top);this._graphicsContext.debug.drawRect(I.x,I.y,S.width,S.height,{color:u.boundsColor}),(u.showAll||u.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${c.owner.id})`,I)}}}this._graphicsContext.restore(),this._popCameraTransform(o)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(d.showAll||d.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),d.showAll||d.showCollisionContacts||d.showCollisionNormals)for(const[C,b]of this._engine.debug.stats.currFrame.physics.contacts){if(d.showAll||d.showCollisionContacts)for(const x of b.points)this._graphicsContext.debug.drawPoint(x,{size:d.contactSize,color:d.collisionContactColor});if(d.showAll||d.showCollisionNormals)for(const x of b.points)this._graphicsContext.debug.drawLine(x,b.normal.scale(30).add(x),{color:d.collisionNormalColor})}this._graphicsContext.restore(),w&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(w.showAll||w.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,w.focusColor),(w.showAll||w.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,e){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),jt.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const e=t.getAncestors();for(const s of e){const i=s==null?void 0:s.get(N);i&&(this._graphicsContext.translate(i.pos.x,i.pos.y),this._graphicsContext.scale(i.scale.x,i.scale.y),this._graphicsContext.rotate(i.rotation))}}_pushCameraTransform(t){t.coordPlane===te.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===te.World&&this._graphicsContext.restore()}}th.priority=us.Lowest;class eh{constructor(t,e){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=e,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,e=Math.floor(t.left/this.gridSize),s=Math.floor(t.right/this.gridSize),i=Math.floor(t.bottom/this.gridSize),n=Math.floor(t.top/this.gridSize);return this.leftX!==e||this.rightX!==s||this.bottomY!==i||this.topY!==n}clear(){for(const t of this.cells){const e=t.proxies.indexOf(this);e>-1&&t.proxies.splice(e,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class ns{constructor(){this.proxies=[]}configure(t,e){this.x=t,this.y=e,this.key=ns.calculateHashKey(t,e)}static calculateHashKey(t,e){return`${t}+${e}`}}class sh{constructor(t){this.bounds=new z,this._hashGridCellPool=new Mn(()=>new ns,e=>(e.configure(0,0),e.proxies.length=0,e),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=e=>t.proxyFactory(e,this.gridSize):this._buildProxy=e=>new eh(e,this.gridSize)}query(t){const e=new Set;if(t instanceof z){const s=t,i=Math.floor(s.left/this.gridSize),n=Math.floor(s.right/this.gridSize),o=Math.floor(s.bottom/this.gridSize),a=Math.floor(s.top/this.gridSize);for(let h=i;h<=n;h++)for(let l=a;l<=o;l++){const c=ns.calculateHashKey(h,l),u=this.sparseHashGrid.get(c);if(u)for(let d=0;d<u.proxies.length;d++)u.proxies[d].updateBounds(),u.proxies[d].bounds.intersect(s)&&e.add(u.proxies[d].object)}}else{const s=t,i=ns.calculateHashKey(Math.floor(s.x/this.gridSize),Math.floor(s.y/this.gridSize)),n=this.sparseHashGrid.get(i);if(n)for(let o=0;o<n.proxies.length;o++)n.proxies[o].updateBounds(),n.proxies[o].bounds.contains(s)&&e.add(n.proxies[o].object)}return Array.from(e)}get(t,e){const s=ns.calculateHashKey(t,e);return this.sparseHashGrid.get(s)}_insert(t,e,s){const i=ns.calculateHashKey(t,e);let n=this.sparseHashGrid.get(i);n||(n=this._hashGridCellPool.rent(),n.configure(t,e),this.sparseHashGrid.set(n.key,n)),n.proxies.push(s),s.cells.push(n),this.bounds.combine(s.bounds,this.bounds)}_remove(t,e,s){const i=ns.calculateHashKey(t,e),n=this.sparseHashGrid.get(i);if(n){const o=n.proxies.indexOf(s);o>-1&&n.proxies.splice(o,1);const a=s.cells.indexOf(n);a>-1&&s.cells.splice(a,1),n.proxies.length===0&&(this._hashGridCellPool.return(n),this.sparseHashGrid.delete(i))}}track(t){const e=this._buildProxy(t);this.objectToProxy.set(t,e);for(let s=e.leftX;s<=e.rightX;s++)for(let i=e.topY;i<=e.bottomY;i++)this._insert(s,i,e)}untrack(t){const e=this.objectToProxy.get(t);e&&(e.clear(),this.objectToProxy.delete(t))}update(t){let e=0;for(const s of t){const i=this.objectToProxy.get(s);if(i&&i.hasChanged()){for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._remove(n,o,i);i.update();for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i);e++}}return e}debug(t,e){const s=k.Transparent,i=k.White;for(const n of this.sparseHashGrid.values())t.drawRectangle(E(n.x*this.gridSize,n.y*this.gridSize),this.gridSize,this.gridSize,s,i,2)}}class Zr extends ke{constructor(t){super(),this.world=t,this.systemType=Ee.Update,this._graphicsHashGrid=new sh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new Ja,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([N,Ws]),this.query.entityAdded$.subscribe(e=>{const s=e.get(N),i=e.get(Ws);this._pointerEventDispatcher.addObject(e,o=>i&&i.localBounds?i.localBounds.transform(s.get().matrix).contains(s.coordPlane===te.World?o.worldPos:o.screenPos):!1,()=>e.isActive),this._entityToPointer.set(e,i);const n=e.get(It);n&&(this._graphics.push(n),this._graphicsHashGrid.track(n)),this._sortedTransforms.push(s),this._sortedEntities.push(s.owner),s.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(e=>{this._pointerEventDispatcher.removeObject(e);const s=e.get(N);this._entityToPointer.delete(e);const i=e.get(It);if(i){const o=this._graphics.indexOf(i);o>-1&&this._graphics.splice(o,1),this._graphicsHashGrid.untrack(i)}s.zIndexChanged$.unsubscribe(this._zIndexUpdate);const n=this._sortedTransforms.indexOf(s);n>-1&&(this._sortedTransforms.splice(n,1),this._sortedEntities.splice(n,1))})}initialize(t,e){this._engine=e.engine,this._scene=e}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,e)=>e.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,e]of this._engineReceiver.currentFramePointerCoords.entries()){const s=this._scene.physics.query(e.worldPos);for(let n=0;n<s.length;n++){const o=s[n],a=this._entityToPointer.get(o.owner);a&&(a.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(o.owner,t)}const i=this._graphicsHashGrid.query(e.worldPos);for(let n=0;n<i.length;n++){const o=i[n],a=this._entityToPointer.get(o.owner);a&&(a.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(o.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}Zr.priority=us.Higher;class ih extends ke{constructor(t){super(),this.world=t,this.systemType=Ee.Update,this._actions=[],this.query=this.world.query([Ri]),this.query.entityAdded$.subscribe(e=>this._actions.push(e.get(Ri))),this.query.entityRemoved$.subscribe(e=>{const s=e.get(Ri),i=this._actions.indexOf(s);i>-1&&this._actions.splice(i,1)})}update(t){for(let e=0;e<this._actions.length;e++)this._actions[e].update(t)}}ih.priority=us.Higher;class bn extends Ue{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class nh extends ke{constructor(t){super(),this.world=t,this.systemType=Ee.Update,this.query=this.world.query([N,bn])}update(){let t,e;for(let s=0;s<this.query.entities.length;s++){const i=this.query.entities[s];t=i.get(N),e=i.get(bn);const o=Math.max(e.columns*e.tileWidth,e.rows*e.tileHeight)*e.elevation+t.pos.y;t.z=o}}}nh.priority=us.Lower;class rh extends ke{constructor(t){super(),this.world=t,this.systemType=Ee.Draw,this.query=this.world.query([N,It])}initialize(t,e){this._camera=e.camera,this._screen=e.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,e,s;for(let i=0;i<this.query.entities.length;i++){const n=this.query.entities[i];e=n.get(It),t=n.get(N),s=n.get(Xr);let o;if(s){const h=T.One.sub(s.parallaxFactor);o=this._camera.pos.scale(h)}const a=this._isOffscreen(t,e,o);a&&!n.hasTag("ex.offscreen")&&(n.events.emit("exitviewport",new Oa(n)),n.addTag("ex.offscreen")),!a&&n.hasTag("ex.offscreen")&&(n.events.emit("enterviewport",new Na(n)),n.removeTag("ex.offscreen"))}}_isOffscreen(t,e,s){if(e.forceOnScreen)return!1;if(t.coordPlane===te.World){let i=e.localBounds;s&&(i=i.translate(s));const n=i.transform(t.get().matrix);return!this._worldBounds.overlaps(n)}else return!1}}rh.priority=us.Higher;class Lc extends eh{constructor(t,e){var s,i;super(t,e),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=e;const n=t.bounds;this.hasZeroBounds=n.hasZeroDimensions(),this.leftX=Math.floor(n.left/this.gridSize),this.rightX=Math.floor(n.right/this.gridSize),this.bottomY=Math.floor(n.bottom/this.gridSize),this.topY=Math.floor(n.top/this.gridSize),this.owner=t.owner,this.body=(s=this.owner)===null||s===void 0?void 0:s.get(it),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:X.PreventCollision}update(){var t,e;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(it),this.collisionType=(e=this.body.collisionType)!==null&&e!==void 0?e:X.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Xo{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new zr(()=>new de({id:hi("collider",0)},{id:hi("collider",0)}),e=>(e.colliderA=null,e.colliderB=null,e),200),this.gridSize=t.size,this.hashGrid=new sh({size:this.gridSize,proxyFactory:(e,s)=>new Lc(e,s)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,e){var s,i,n;const o=[],a=(s=e==null?void 0:e.maxDistance)!==null&&s!==void 0?s:1/0,h=e==null?void 0:e.collisionGroup,l=h?h.category:(i=e==null?void 0:e.collisionMask)!==null&&i!==void 0?i:Ts.All.category,c=(n=e==null?void 0:e.searchAllColliders)!==null&&n!==void 0?n:!1,u=t.dir.normalize(),d=u.y/u.x,f=u.x/u.y,p=Math.sqrt(1+d*d)*this.gridSize,_=Math.sqrt(1+f*f)*this.gridSize,v=t.pos.x/this.gridSize,g=t.pos.y/this.gridSize,w=E(1,1);let C=~~v,b=~~g,x=0,A=0;u.x<0?(w.x=-1,x=(v-C)*p):(w.x=1,x=(C+1-v)*p),u.y<0?(w.y=-1,A=(g-b)*_):(w.y=1,A=(b+1-g)*_);const y=new Set;let S=!1,I=9999;for(;!S&&I>0&&(I--,!!this.hashGrid.bounds.contains(E(C*this.gridSize,b*this.gridSize)));){const R=ns.calculateHashKey(C,b),D=this.hashGrid.sparseHashGrid.get(R);if(D){const M=[];for(let B=0;B<D.proxies.length;B++){const F=D.proxies[B];if(!y.has(F.collider.id.value)){if(y.add(F.collider.id.value),e!=null&&e.ignoreCollisionGroupAll&&F.body.group===Ts.All)continue;const L=(l&F.body.group.category)!==0;if(F.body.group&&!L)continue;const O=F.collider.rayCast(t,a);O&&M.push(O)}}M.sort((B,F)=>B.distance-F.distance);for(let B=0;B<M.length;B++){const F=M[B];if(e!=null&&e.filter){if(e.filter(F)&&(o.push(F),!c)){S=!0;break}}else if(o.push(F),!c){S=!0;break}}}x<A?(C+=w.x,x+=p):(b+=w.y,A+=_)}return o.sort((R,D)=>R.distance-D.distance),!c&&o.length?[o[0]]:o}track(t){let e=[t];if(t instanceof $t){const s=t.getColliders();for(const i of s)i.owner=t.owner;e=s}for(const s of e)this.hashGrid.track(s)}untrack(t){let e=[t];t instanceof $t&&(e=t.getColliders());for(const s of e)this.hashGrid.untrack(s)}_canCollide(t,e){return!(t.collider.id===e.collider.id||t.owner&&e.owner&&t.owner.id===e.owner.id||t.hasZeroBounds||e.hasZeroBounds||!t.body.group.canCollide(e.body.group)||t.collisionType===X.Fixed&&e.collisionType===X.Fixed||t.collisionType===X.PreventCollision||e.collisionType===X.PreventCollision||!t.owner.isActive||!e.owner.isActive)}broadphase(t,e){const s=[];this._pairs.clear(),this._nonPairs.clear();let i=0;for(const n of this.hashGrid.objectToProxy.values())if(n.id=i++,!(!n.owner.isActive||n.collisionType===X.PreventCollision))for(let o=0;o<n.cells.length;o++){const a=n.cells[o];for(let h=0;h<a.proxies.length;h++){const l=a.proxies[h];if(l.id===n.id)continue;const c=de.calculatePairHash(n.collider.id,l.collider.id);if(!this._nonPairs.has(c))if(!this._pairs.has(c)&&this._canCollide(n,l)&&n.object.bounds.overlaps(l.object.bounds)){const u=this._pairPool.get();u.colliderA=n.collider,u.colliderB=l.collider,u.id=c,this._pairs.add(c),s.push(u)}else this._nonPairs.add(c)}}return s}narrowphase(t,e){const s=[];for(let i=0;i<t.length;i++){const n=t[i].collide();for(let o=0;o<n.length;o++){const a=n[o];s.push(a),e&&e.physics.contacts.set(a.id,a)}}return this._pairPool.done(),e&&(e.physics.collisions+=s.length),s}update(t,e){return this.hashGrid.update(t)}debug(t,e){this.hashGrid.debug(t,e)}}class Uc{get config(){return Od(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===Oi.SparseHashGrid?this._collisionProcessor=new Xo(this._config.sparseHashGrid):this._collisionProcessor=new Tr(this._config);for(const e of t)this._collisionProcessor.track(e)}return this._collisionProcessor}constructor(t){this.$configUpdate=new ue,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(e=>{this._configDirty=!0,it.updateDefaultPhysicsConfig(e.bodies)}),this._config.spatialPartition===Oi.SparseHashGrid?this._collisionProcessor=new Xo(this._config.sparseHashGrid):this._collisionProcessor=new Tr(this._config)}rayCast(t,e){return this.collisionProcessor.rayCast(t,e)}query(t){return this._collisionProcessor.query(t)}}class Qr{constructor(){this.events=new yt,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const e=t.axes.filter(i=>typeof i!==void 0).length,s=t.buttons.filter(i=>typeof i!==void 0).length;return e>=this._minimumConfiguration.axis&&s>=this._minimumConfiguration.buttons&&t.connected}emit(t,e){this.events.emit(t,e)}on(t,e){return this._enableAndUpdate(),this.events.on(t,e)}once(t,e){return this._enableAndUpdate(),this.events.once(t,e)}off(t,e){this._enableAndUpdate(),this.events.off(t,e)}update(){var t,e;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const s=this._navigator.getGamepads();for(let i=0;i<s.length;i++){if(s[i]){const o=this.at(i);!this.at(i).connected&&this._isGamepadValid(s[i])&&(o.events.pipe(this.events),this.events.emit("connect",new Pa(i,this.at(i)))),this.at(i).connected=!0}else{const o=this.at(i);o.connected&&(this.events.emit("disconnect",new Ia(i,o)),o.events.unpipe(this.events)),o.connected=!1;continue}if(this.at(i).update(),s[i].timestamp&&s[i].timestamp===this._gamePadTimeStamps[i])continue;this._gamePadTimeStamps[i]=s[i].timestamp,this.at(i).navigatorGamepad=s[i];const n=s[i];if(n){for(let o=0;o<n.buttons.length;o++){const a=n.buttons[o],h=a==null?void 0:a.value;h!==((t=this._oldPads[i])===null||t===void 0?void 0:t.getButton(o))&&(a!=null&&a.pressed?(this.at(i).updateButton(o,h),this.at(i).events.emit("button",new Ma(o in Cn?o:Cn.Unknown,o,h,this.at(i)))):this.at(i).updateButton(o,0))}for(let o=0;o<n.axes.length;o++){const a=n.axes[o];a!==((e=this._oldPads[i])===null||e===void 0?void 0:e.getAxes(o))&&(this.at(i).updateAxes(o,a),this.at(i).events.emit("axis",new Ra(o,a,this.at(i))))}}this._oldPads[i]=this._clonePad(s[i])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let e=this._pads.length-1,s=t;e<s;e++)this._pads.push(new or),this._oldPads.push(new or);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let e=0;e<this._pads.length;e++)this._isGamepadValid(this.at(e).navigatorGamepad)&&this.at(e).connected&&t.push(this.at(e));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const e=[];for(let s=0,i=t.length;s<i;s++)e.push(this._clonePad(t[s]));return e}_clonePad(t){let e,s;const i=new or;if(!t)return i;for(e=0,s=t.buttons.length;e<s;e++)t.buttons[e]&&i.updateButton(e,t.buttons[e].value);for(e=0,s=t.axes.length;e<s;e++)i.updateAxes(e,t.axes[e]);return i}}Qr.MinAxisMoveThreshold=.05;class or{constructor(){this.events=new yt,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,e=1){return this._buttons[t]>=e}isButtonHeld(t,e=1){return this._buttons[t]>=e}wasButtonPressed(t,e=1){return this._buttonsDown[t]>=e}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const e=this._axes[t];return Math.abs(e)<Qr.MinAxisMoveThreshold?0:e}updateButton(t,e){e===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=e,this._buttons[t]=e}updateAxes(t,e){this._axes[t]=e}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}}var Cn;(function(r){r[r.Unknown=-1]="Unknown",r[r.Face1=0]="Face1",r[r.Face2=1]="Face2",r[r.Face3=2]="Face3",r[r.Face4=3]="Face4",r[r.LeftBumper=4]="LeftBumper",r[r.RightBumper=5]="RightBumper",r[r.LeftTrigger=6]="LeftTrigger",r[r.RightTrigger=7]="RightTrigger",r[r.Select=8]="Select",r[r.Start=9]="Start",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",r[r.DpadUp=12]="DpadUp",r[r.DpadDown=13]="DpadDown",r[r.DpadLeft=14]="DpadLeft",r[r.DpadRight=15]="DpadRight",r[r.CenterButton=16]="CenterButton",r[r.MiscButton1=17]="MiscButton1"})(Cn||(Cn={}));var jo;(function(r){r[r.LeftStickX=0]="LeftStickX",r[r.LeftStickY=1]="LeftStickY",r[r.RightStickX=2]="RightStickX",r[r.RightStickY=3]="RightStickY"})(jo||(jo={}));class zc{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,e]of this._handlers.entries()){const s=t(this.inputs);s&&e(s)}}on(t,e){this._handlers.set(t,e)}}function Vc(){try{const r=()=>{};window.top.addEventListener("blur",r),window.top.removeEventListener("blur",r)}catch{return!0}return!1}var Tn;(function(r){r.Backquote="Backquote",r.Backslash="Backslash",r.BracketLeft="BracketLeft",r.BracketRight="BracketRight",r.Comma="Comma",r.Key0="Digit0",r.Key1="Digit1",r.Key2="Digit2",r.Key3="Digit3",r.Key4="Digit4",r.Key5="Digit5",r.Key6="Digit6",r.Key7="Digit7",r.Key8="Digit8",r.Key9="Digit9",r.Digit0="Digit0",r.Digit1="Digit1",r.Digit2="Digit2",r.Digit3="Digit3",r.Digit4="Digit4",r.Digit5="Digit5",r.Digit6="Digit6",r.Digit7="Digit7",r.Digit8="Digit8",r.Digit9="Digit9",r.Equal="Equal",r.IntlBackslash="IntlBackslash",r.IntlRo="IntlRo",r.IntlYen="IntlYen",r.A="KeyA",r.B="KeyB",r.C="KeyC",r.D="KeyD",r.E="KeyE",r.F="KeyF",r.G="KeyG",r.H="KeyH",r.I="KeyI",r.J="KeyJ",r.K="KeyK",r.L="KeyL",r.M="KeyM",r.N="KeyN",r.O="KeyO",r.P="KeyP",r.Q="KeyQ",r.R="KeyR",r.S="KeyS",r.T="KeyT",r.U="KeyU",r.V="KeyV",r.W="KeyW",r.X="KeyX",r.Y="KeyY",r.Z="KeyZ",r.KeyA="KeyA",r.KeyB="KeyB",r.KeyC="KeyC",r.KeyD="KeyD",r.KeyE="KeyE",r.KeyF="KeyF",r.KeyG="KeyG",r.KeyH="KeyH",r.KeyI="KeyI",r.KeyJ="KeyJ",r.KeyK="KeyK",r.KeyL="KeyL",r.KeyM="KeyM",r.KeyN="KeyN",r.KeyO="KeyO",r.KeyP="KeyP",r.KeyQ="KeyQ",r.KeyR="KeyR",r.KeyS="KeyS",r.KeyT="KeyT",r.KeyU="KeyU",r.KeyV="KeyV",r.KeyW="KeyW",r.KeyX="KeyX",r.KeyY="KeyY",r.KeyZ="KeyZ",r.Minus="Minus",r.Period="Period",r.Quote="Quote",r.Semicolon="Semicolon",r.Slash="Slash",r.AltLeft="AltLeft",r.AltRight="AltRight",r.Alt="Alt",r.AltGraph="AltGraph",r.Backspace="Backspace",r.CapsLock="CapsLock",r.ContextMenu="ContextMenu",r.ControlLeft="ControlLeft",r.ControlRight="ControlRight",r.Enter="Enter",r.MetaLeft="MetaLeft",r.MetaRight="MetaRight",r.ShiftLeft="ShiftLeft",r.ShiftRight="ShiftRight",r.Space="Space",r.Tab="Tab",r.Convert="Convert",r.KanaMode="KanaMode",r.NonConvert="NonConvert",r.Delete="Delete",r.End="End",r.Help="Help",r.Home="Home",r.Insert="Insert",r.PageDown="PageDown",r.PageUp="PageUp",r.Up="ArrowUp",r.Down="ArrowDown",r.Left="ArrowLeft",r.Right="ArrowRight",r.ArrowUp="ArrowUp",r.ArrowDown="ArrowDown",r.ArrowLeft="ArrowLeft",r.ArrowRight="ArrowRight",r.NumLock="NumLock",r.Numpad0="Numpad0",r.Numpad1="Numpad1",r.Numpad2="Numpad2",r.Numpad3="Numpad3",r.Numpad4="Numpad4",r.Numpad5="Numpad5",r.Numpad6="Numpad6",r.Numpad7="Numpad7",r.Numpad8="Numpad8",r.Numpad9="Numpad9",r.Num0="Numpad0",r.Num1="Numpad1",r.Num2="Numpad2",r.Num3="Numpad3",r.Num4="Numpad4",r.Num5="Numpad5",r.Num6="Numpad6",r.Num7="Numpad7",r.Num8="Numpad8",r.Num9="Numpad9",r.NumAdd="NumpadAdd",r.NumpadAdd="NumpadAdd",r.NumDecimal="NumpadDecimal",r.NumpadDecimal="NumpadDecimal",r.NumDivide="NumpadDivide",r.NumpadDivide="NumpadDivide",r.NumEnter="NumpadEnter",r.NumpadEnter="NumpadEnter",r.NumMultiply="NumpadMultiply",r.NumpadMultiply="NumpadMultiply",r.NumSubtract="NumpadSubtract",r.NumpadSubtract="NumpadSubtract",r.Esc="Escape",r.Escape="Escape",r.F1="F1",r.F2="F2",r.F3="F3",r.F4="F4",r.F5="F5",r.F6="F6",r.F7="F7",r.F8="F8",r.F9="F9",r.F10="F10",r.F11="F11",r.F12="F12",r.F13="F13",r.F14="F14",r.F15="F15",r.F16="F16",r.F17="F17",r.F18="F18",r.F19="F19",r.F20="F20",r.PrintScreen="PrintScreen",r.ScrollLock="ScrollLock",r.Pause="Pause",r.Unidentified="Unidentified"})(Tn||(Tn={}));class un extends J{constructor(t,e,s){super(),this.key=t,this.value=e,this.originalEvent=s}}class Wc{constructor(){this.events=new yt,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const e of this._keys){const s=new un(e,t.key,t);this.events.emit("up",s),this.events.emit("release",s)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(Tn.MetaLeft)||this._keys.includes(Tn.MetaRight))&&this._releaseAllKeys(t);const e=t.code;if(this._keys.indexOf(e)===-1){this._keys.push(e),this._keysDown.push(e);const s=new un(e,t.key,t);this.events.emit("down",s),this.events.emit("press",s)}},this._handleKeyUp=t=>{if(!this._enabled)return;const e=t.code,s=this._keys.indexOf(e);this._keys.splice(s,1),this._keysUp.push(e);const i=new un(e,t.key,t);this.events.emit("up",i),this.events.emit("release",i),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}init(t){let{global:e}=t;const{grabWindowFocus:s}=t;e||(Vc()?(e=window,s&&window.focus(),V.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):e=window.top),e.addEventListener("blur",()=>{this._keys.length=0}),e.addEventListener("keyup",this._handleKeyUp),e.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new un(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,e,s){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:e,key:s??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:e,key:s??null}))}}class Ni{static fromPagePosition(t,e,s){let i,n,o,a;arguments.length===3?(i=t,n=e,o=new T(i,n),a=s):(o=t,i=o.x,n=o.y,a=e);const h=a.screen.pageToScreenCoordinates(o),l=a.screen.screenToWorldCoordinates(h);return new Ni(l,o,h)}constructor(t,e,s){this.worldPos=t,this.pagePos=e,this.screenPos=s}}class dn{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,e,s,i,n,o){this.type=t,this.pointerId=e,this.button=s,this.pointerType=i,this.coordinates=n,this.nativeEvent=o,this.active=!0}}class Hc{cancel(){this.active=!1}constructor(t,e,s,i,n,o,a,h,l,c,u,d){this.x=t,this.y=e,this.pageX=s,this.pageY=i,this.screenX=n,this.screenY=o,this.index=a,this.deltaX=h,this.deltaY=l,this.deltaZ=c,this.deltaMode=u,this.ev=d,this.active=!0}}class Yo{constructor(){this.events=new yt,this.lastPagePos=T.Zero,this.lastScreenPos=T.Zero,this.lastWorldPos=T.Zero,this._onPointerMove=t=>{this.lastPagePos=new T(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new T(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new T(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new T(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new T(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new T(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}_updateWorldPosition(t){const e=Ni.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=e.screenPos,this.lastWorldPos=e.worldPos}}var Di;(function(r){r.Pixel="Pixel",r.Line="Line",r.Page="Page"})(Di||(Di={}));var Fs;(function(r){r[r.NoButton=-1]="NoButton",r[r.Left=0]="Left",r[r.Middle=1]="Middle",r[r.Right=2]="Right",r[r.Unknown=3]="Unknown"})(Fs||(Fs={}));var gs;(function(r){r.Left="Left",r.Middle="Middle",r.Right="Right",r.Unknown="Unknown",r.NoButton="NoButton"})(gs||(gs={}));var ms;(function(r){r.Touch="Touch",r.Mouse="Mouse",r.Pen="Pen",r.Unknown="Unknown"})(ms||(ms={}));function qf(r){return globalThis.TouchEvent&&r instanceof globalThis.TouchEvent}function Gf(r){return globalThis.PointerEvent&&r instanceof globalThis.PointerEvent}class Jr{constructor(t,e){this.target=t,this.engine=e,this.events=new yt,this.primary=new Yo,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,e){const s=new Jr(t,e);return s.primary=this.primary,s._pointers=this._pointers,s}at(t){if(t>=this._pointers.length)for(let e=this._pointers.length-1,s=t;e<s;e++)this._pointers.push(new Yo);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var e;return this._enabled&&(e=this.currentFramePointerDown.get(t))!==null&&e!==void 0?e:!1}wasDown(t){var e;return this._enabled&&(e=this.lastFramePointerDown.get(t))!==null&&e!==void 0?e:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const e=this._activeNativePointerIdsToNormalized.entries();for(const[s,i]of e)i===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(s)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var e;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const s={passive:!(this.engine.pageScrollPreventionMode===Os.All||this.engine.pageScrollPreventionMode===Os.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,s):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,s):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,s),((e=t==null?void 0:t.grabWindowFocus)!==null&&e!==void 0?e:!0)&&Vc()){const n=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",n):(this.target.addEventListener("touchstart",n),this.target.addEventListener("mousedown",n))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const s=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((i,n)=>i-n).findIndex(i=>i===t);return this._activeNativePointerIdsToNormalized.set(t,s),s}_handle(t){if(!this._enabled)return;t.preventDefault();const e=new Map;let s,i;if(qf(t)){s=gs.Unknown,i=ms.Touch;for(let n=0;n<t.changedTouches.length;n++){const o=t.changedTouches[n],a=Ni.fromPagePosition(o.pageX,o.pageY,this.engine),h=n+1,l=this._normalizePointerId(h);this.currentFramePointerCoords.set(l,a),e.set(l,a)}}else{s=this._nativeButtonToPointerButton(t.button),i=ms.Mouse;const n=Ni.fromPagePosition(t.pageX,t.pageY,this.engine);let o=1;Gf(t)&&(o=t.pointerId,i=this._stringToPointerType(t.pointerType));const a=this._normalizePointerId(o);this.currentFramePointerCoords.set(a,n),e.set(a,n)}for(const[n,o]of e.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new dn("down",n,s,i,o,t)),this.currentFramePointerDown.set(n,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new dn("up",n,s,i,o,t)),this.currentFramePointerDown.set(n,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new dn("move",n,s,i,o,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new dn("cancel",n,s,i,o,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Os.All||this.engine.pageScrollPreventionMode===Os.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const e=this.engine.screen.pageToScreenCoordinates(E(t.pageX,t.pageY)),s=this.engine.screen.screenToWorldCoordinates(e),i=-1/40,n=t.deltaX||t.wheelDeltaX*i||0,o=t.deltaY||t.wheelDeltaY*i||t.wheelDelta*i||t.detail||0,a=t.deltaZ||0;let h=Di.Pixel;t.deltaMode&&(t.deltaMode===1?h=Di.Line:t.deltaMode===2&&(h=Di.Page));const l=new Hc(s.x,s.y,t.pageX,t.pageY,e.x,e.y,0,n,o,a,h,t);this.currentFrameWheel.push(l)}triggerEvent(t,e){const s=this.engine.screen.worldToPageCoordinates(e);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:s.x,clientY:s.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:s.x,clientY:s.y}));const i=this.engine.currentScene.world.get(Zr);i.preupdate(this.engine.currentScene,1),i.update(1)}_nativeButtonToPointerButton(t){switch(t){case Fs.NoButton:return gs.NoButton;case Fs.Left:return gs.Left;case Fs.Middle:return gs.Middle;case Fs.Right:return gs.Right;case Fs.Unknown:return gs.Unknown;default:return Ml(t)}}_stringToPointerType(t){switch(t){case"touch":return ms.Touch;case"mouse":return ms.Mouse;case"pen":return ms.Pen;default:return ms.Unknown}}}class oh{constructor(t){this._enabled=!0;const{pointerTarget:e,grabWindowFocus:s,engine:i}=t;this.keyboard=new Wc,this.pointers=new Jr(e,i),this.gamepads=new Qr,this.keyboard.init({grabWindowFocus:s}),this.pointers.init({grabWindowFocus:s}),this.gamepads.init(),this.inputMapper=new zc({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Xf{}const jf={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function ss(r){var t,e;return!!(r!=null&&r.prototype)&&!!(!((e=(t=r==null?void 0:r.prototype)===null||t===void 0?void 0:t.constructor)===null||e===void 0)&&e.name)}class Ie{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof fe)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof Rc)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof bc)}get timers(){return this._timers}constructor(){this._logger=V.getInstance(),this.events=new yt,this.camera=new Mc,this.world=new Oc(this),this.physics=new Uc(ys()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(ih),this.world.add(new Yr(this.world,this.physics)),this.world.add(new $r(this.world,this.physics)),this.world.add(Zr),this.world.add(nh),this.world.add(rh),this.world.add(Ka),this.world.add(th)}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,e){}onPostUpdate(t,e){}onPreDraw(t,e){}onPostDraw(t,e){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var e;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new oh({pointerTarget:t.pointerScope===li.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new tn(t,this))}catch(s){throw this._logger.error(`Error during scene initialization for scene ${(e=t.director)===null||e===void 0?void 0:e.getSceneName(this)}!`),s}this._isInitialized=!0}}async _activate(t){var e,s;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(i){throw this._logger.error(`Error during scene activation for scene ${(s=(e=this.engine)===null||e===void 0?void 0:e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),i}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,e){this.emit("preupdate",new Gs(t,e,this)),this.onPreUpdate(t,e)}_postupdate(t,e){this.emit("postupdate",new Xs(t,e,this)),this.onPostUpdate(t,e)}_predraw(t,e){this.emit("predraw",new Ji(t,e,this)),this.onPreDraw(t,e)}_postdraw(t,e){this.emit("postdraw",new Ki(t,e,this)),this.onPostDraw(t,e)}update(t,e){var s;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(s=t.director)===null||s===void 0?void 0:s.getSceneName(this)}!`);return}this._preupdate(t,e);let i,n;for(i=0,n=this._cancelQueue.length;i<n;i++)this.removeTimer(this._cancelQueue[i]);this._cancelQueue.length=0;for(const o of this._timers)o.update(e);this.world.update(Ee.Update,e),this.camera&&this.camera.update(t,e),this._collectActorStats(t),this._postupdate(t,e),this.input.update()}draw(t,e){var s;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,e),this.world.update(Ee.Draw,e),!((s=this.engine)===null||s===void 0)&&s.isDebug&&this.debugDraw(t),this._postdraw(t,e)}debugDraw(t){this.emit("predebugdraw",new Ta(t,this)),this.emit("postdebugdraw",new Aa(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof ni){Il(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let e;t instanceof oe&&t.scene&&t.scene!==this&&(e=t.scene,t.scene.world.remove(t,!1)),t instanceof ni&&t.scene&&(e=t.scene,t.scene.removeTimer(t)),e==null||e.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof oe&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof ni&&this.removeTimer(t)}clear(t=!0){for(let e=this.entities.length-1;e>=0;e--)this.world.remove(this.entities[e],t);for(let e=this.timers.length-1;e>=0;e--)this.removeTimer(this.timers[e])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const e=this._timers.indexOf(t);return e!==-1&&this._timers.splice(e,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const e=this.actors;for(let s=0;s<e.length;s++){const i=e[s];i instanceof Qa&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let n=0;n<i.children.length;n++){const o=i.children[n];yc(o)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var ri;(function(r){r.Protanope="Protanope",r.Deuteranope="Deuteranope",r.Tritanope="Tritanope"})(ri||(ri={}));const Yf=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class qc{constructor(t,e){this._shader=new ye({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:e}),this._shader.compile(),this._buffer=new ls({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Es({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Gc{constructor(t,e=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=e}initialize(t){this._shader=new qc(t,Yf),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const e=this._shader.getShader();e.use(),this._colorBlindnessMode===ri.Protanope?e.setUniformInt("u_type",0):this._colorBlindnessMode===ri.Deuteranope?e.setUniformInt("u_type",1):this._colorBlindnessMode===ri.Tritanope&&e.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const e=this._shader.getShader();e.use(),e.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class Xc{constructor(t){this._engine=t,this._colorBlindPostProcessor=new Gc(ri.Protanope)}correct(t){this._engine.graphicsContext instanceof xs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof xs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class jc{constructor(t){this.stats={currFrame:new An,prevFrame:new An},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:k.Yellow,showZIndex:!1,showScale:!1,scaleColor:k.Green,showRotation:!1,rotationColor:k.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:k.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:k.Blue,showOwner:!1,showGeometry:!0,geometryColor:k.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:k.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:k.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:k.Yellow,showAcceleration:!1,accelerationColor:k.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:k.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:k.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:k.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:k.Yellow,positionSize:1,showGrid:!1,gridColor:k.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new Xc(this._engine)}useTestClock(){const t=this._engine.clock,e=t.isRunning();t.stop();const s=t.toTestClock();return e&&s.start(),this._engine.clock=s,s}useStandardClock(){const t=this._engine.clock,e=t.isRunning();t.stop();const s=t.toStandardClock();return e&&s.start(),this._engine.clock=s,s}}class An{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Kr,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new An;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Kr{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new Kr;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class $o{on(t,e){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(e),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,e){e||(e=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,e),this._nativeHandlers[t]=null}_decorate(t){return e=>{this._paused||t(e)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class Yc{constructor(t,e){this._windowGlobal=t,this._documentGlobal=e,this._windowComponent=new $o(this._windowGlobal),this._documentComponent=new $o(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const $c={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:Lt.Blended,canvasImageRendering:"auto"},Zc={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:Lt.Blended,canvasImageRendering:"auto"};class Qc{constructor(t){var e;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(e=t.samplePeriod)!==null&&e!==void 0?e:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}let ah=class{constructor(t){var e,s,i;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(e=this.now())!==null&&e!==void 0?e:0,this._maxFps=(s=t.maxFps)!==null&&s!==void 0?s:this._maxFps,this._onFatalException=(i=t.onFatalException)!==null&&i!==void 0?i:this._onFatalException,this.fpsSampler=new Qc({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new Jc({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new hh({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,e=0,s="preframe"){const i=this._totalElapsed+e;this._scheduledCbs.push([t,i,s])}__runScheduledCbs(t="preframe"){for(let e=this._scheduledCbs.length-1;e>-1;e--)t===this._scheduledCbs[e][2]&&this._scheduledCbs[e][1]<=this._totalElapsed&&(this._scheduledCbs[e][0](this._elapsed),this._scheduledCbs.splice(e,1))}update(t){try{this.fpsSampler.start();const e=this.now();let s=e-this._lastTime||1;const i=1e3/this._maxFps;if(s>=i){let n=0;i!==0&&(n=s%i,s=s-n),s>200&&(s=1),this._elapsed=t||s,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||s),this.__runScheduledCbs("postframe"),i!==0?this._lastTime=e-n:this._lastTime=e,this.fpsSampler.end()}}catch(e){this._onFatalException(e),this.stop()}}};class hh extends ah{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(e){throw window.cancelAnimationFrame(this._requestId),e}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class Jc extends ah{constructor(t){super({...t}),this._logger=V.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const e=t??this._updateMs;this._running?(this.update(e),this._currentTime+=e):this._logger.warn("The clock is not running, no step will be performed")}run(t,e){for(let s=0;s<t;s++)this.step(e??this._updateMs)}}var $f=Zt(296);class Kc{constructor(){this._toasterCss=$f.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const e=document.createElement("span");return e.innerText=t,e}toast(t,e,s){this._initialize();const i=document.createElement("div");i.className="ex-toast-message";const n=t.split("[LINK]").map(c=>this._createFragment(c));if(e){const c=document.createElement("a");c.href=e,s?c.innerText=s:c.innerText=e,n.splice(1,0,c)}const o=document.createElement("div");n.forEach(c=>{o.appendChild(c)}),i.appendChild(o);const a=document.createElement("button");a.innerText="x",a.addEventListener("click",()=>{this._container.removeChild(i)}),i.appendChild(a);const h=c=>{if(c.key==="Escape")try{this._container.removeChild(i)}catch{}document.removeEventListener("keydown",h)};document.addEventListener("keydown",h);const l=this._container.firstChild;this._container.insertBefore(i,l)}}const Zf={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class tu{get isTransitioning(){return this._isTransitioning}constructor(t,e){this._engine=t,this.events=new yt,this._logger=V.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new Ie,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const s in e){const i=e[s];this.add(s,i),s==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const e=this._deferredTransition;this._deferredTransition=void 0;const s=this.getSceneInstance(t);s&&e&&e._addToTargetScene(this._engine,s),await this.swapScene(t),s&&e&&await this.playTransition(e,s)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,e){const s=e==null?void 0:e.loader;s instanceof vn?this.mainLoader=s:Lo(s)?this.mainLoader=new s:this.mainLoader=new fi;let i;if(e!=null&&e.inTransition){const{inTransition:n}=e;i=n}if(this.startScene=t,i){const n=this.getSceneInstance(this.startScene);n&&(i._addToTargetScene(this._engine,n),this.swapScene(this.startScene).then(()=>this.playTransition(i,n)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var e;const s=this.scenes[t];if(!(s instanceof Ie||ss(s)))return(e=s==null?void 0:s.transitions)===null||e===void 0?void 0:e.in}_getOutTransition(t){var e;const s=this.scenes[t];if(!(s instanceof Ie||ss(s)))return(e=s==null?void 0:s.transitions)===null||e===void 0?void 0:e.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const e=this.scenes[t];if(e instanceof Ie||ss(e))return e;if(e)return e.scene}getSceneName(t){for(const[e,s]of Object.entries(this.scenes))if(s instanceof Ie){if(t===s)return e}else if(!ss(s)&&t===s.scene)return e;for(const[e,s]of Object.entries(this.scenes))if(ss(s)){if(t.constructor===s)return e}else if(!(s instanceof Ie)&&t.constructor===s.scene)return e;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,e){if(!(e instanceof Ie)&&!ss(e)){const{loader:s,transitions:i}=e,{in:n,out:o}=i??{};this._sceneToTransition.set(t,{in:n,out:o}),Lo(s)?this._sceneToLoader.set(t,new s):s&&this._sceneToLoader.set(t,s)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=e,this.assertAdded(t)}remove(t){if(t instanceof Ie||ss(t)){const e=t;for(const s in this.scenes)if(this.scenes.hasOwnProperty(s)){const i=this.scenes[s];let n;if(i instanceof Ie||ss(i)?n=i:n=i.scene,n===e){if(s===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${s}`);this._sceneToInstance.delete(s),this._sceneToTransition.delete(s),this._sceneToLoader.delete(s),delete this.scenes[s]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,e){var s,i,n,o,a,h;const l=this.getSceneInstance(t);if(!l){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const c=this.currentScene,u=this.currentSceneName,d=(i=(s=this._engine.input)===null||s===void 0?void 0:s.enabled)!==null&&i!==void 0?i:!0;this._isTransitioning=!0;const f=(n=this.getSceneInstance(u))===null||n===void 0?void 0:n.onTransition("out"),p=l==null?void 0:l.onTransition("in");e={sourceOut:(o=this._getOutTransition(this.currentSceneName))!==null&&o!==void 0?o:f,destinationIn:(a=this._getInTransition(t))!==null&&a!==void 0?a:p,...e};const{sourceOut:_,destinationIn:v,sceneActivationData:g}=e,w=_??this._getOutTransition(this.currentSceneName),C=v??this._getInTransition(t),b=(w==null?void 0:w.hideLoader)||(C==null?void 0:C.hideLoader);b&&this.maybeLoadScene(t,b),this._emitEvent("navigationstart",u,t),w&&await this.playTransition(w,c),await this.maybeLoadScene(t,b),C&&await C.onPreviousSceneDeactivate(this.currentScene),C&&C._addToTargetScene(this._engine,l),await this.swapScene(t,g),this._emitEvent("navigation",u,t),C&&await this.playTransition(C,l),this._emitEvent("navigationend",u,t),(h=this._engine.input)===null||h===void 0||h.toggleEnabled(d),this._isTransitioning=!1}getSceneInstance(t){const e=this.getSceneDefinition(t);if(!e)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(e instanceof Ie)return this._sceneToInstance.set(t,e),e;const s=new e;return this._sceneToInstance.set(t,s),s}async maybeLoadScene(t,e=!1){var s;const i=(s=this._getLoader(t))!==null&&s!==void 0?s:new vn,n=this.getSceneDefinition(t),o=this.getSceneInstance(t);n&&o&&!this._loadedScenes.has(o)&&(o.onPreLoad(i),o.events.emit("preload",{loader:i}),e?this._engine.load(i,e):await this._engine.load(i),this._loadedScenes.add(o))}async playTransition(t,e){var s,i,n,o,a,h,l;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const c=(i=(s=e.input)===null||s===void 0?void 0:s.enabled)!==null&&i!==void 0?i:!0;(n=e.input)===null||n===void 0||n.toggleEnabled(!t.blockInput),(o=this._engine.input)===null||o===void 0||o.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,e),await this.currentTransition._play(),(a=e.input)===null||a===void 0||a.toggleEnabled(c)}(h=this.currentTransition)===null||h===void 0||h.kill(),(l=this.currentTransition)===null||l===void 0||l.reset(),this.currentTransition=void 0}async swapScene(t,e){const s=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const i=this.getSceneInstance(t);if(i){const n=this.currentScene,o=i;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const l={engine:s,previousScene:n,nextScene:o};await this.currentScene._deactivate(l),this.currentScene.events.emit("deactivate",new Ba(l,this.currentScene)),this.currentScene.input.clear()}const a=this._sceneToLoader.get(t);await(a==null?void 0:a.areResourcesLoaded()),this.currentScene=o,this.currentSceneName=t,s.screen.setCurrentCamera(o.camera),await this.currentScene._initialize(s);const h={engine:s,previousScene:n,nextScene:o,data:e};await this.currentScene._activate(h),this.currentScene.events.emit("activate",new Fa(h,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,e,s){const i=this.getSceneDefinition(e),n=this.getSceneDefinition(s);this.events.emit(t,{sourceScene:i,sourceName:e,destinationScene:n,destinationName:s})}}function eu(){const r={scope:(t,e)=>{const s=r.value;r.value=t;try{return e()}catch(i){throw i}finally{r.value=s}},value:void 0};return r}function su(r){return r.value}const Zo={textureCollectInterval:6e4};class iu{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=e=>{if(this._running){for(const[s,[i,n]]of this._collectors.entries()){const o=this.options.getTimestamp();for(const[a,[h,l]]of this._collectionMap.entries()){if(s!==h||l+n>=o)continue;i(a)&&this._collectionMap.delete(a)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,e,s){this._collectors.set(t,[s,e])}addCollectableResource(t,e){this._collectionMap.set(e,[t,this.options.getTimestamp()])}touch(t){const e=this._collectionMap.get(t);e&&this._collectionMap.set(t,[e[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[e]]of this._collectors.entries())for(const[s]of this._collectionMap.entries())e(s)&&this._collectionMap.delete(s)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Al();const Qf={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Os;(function(r){r[r.None=0]="None",r[r.Canvas=1]="Canvas",r[r.All=2]="All"})(Os||(Os={}));class ge{static useEngine(){const t=su(ge.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,e){this.events.emit(t,e)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}constructor(t){var e,s,i,n,o,a,h,l,c;this.scope=b=>ge.Context.scope(this,b),this.version=Qo,this.events=new yt,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=b=>{V.getInstance().fatal(b,b.stack)},this._toaster=new Kc,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=b=>{var x;b.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",b);const A=document.createElement("div");A.id="ex-webgl-graphics-context-lost",A.style.position="absolute",A.style.zIndex="99",A.style.left="50%",A.style.top="50%",A.style.display="flex",A.style.flexDirection="column",A.style.transform="translate(-50%, -50%)",A.style.backgroundColor="white",A.style.padding="10px",A.style.borderStyle="solid 1px";const y=document.createElement("div");if(y.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,A.appendChild(y),!((x=this.canvas)===null||x===void 0)&&x.parentElement){this.canvas.parentElement.appendChild(A);const S=y.querySelector("#ex-webgl-graphics-reload");S==null||S.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new De,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...ge._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Jt.freeze(),this.browser=new Yc(window,document);const u=new ql;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=u.test())){const b=document.createElement("div");if(b.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(b),u.failedTests.forEach(function(x){const A=document.createElement("div");A.innerText="Browser feature missing "+x,document.body.appendChild(A)}),t.canvasElementId){const x=document.getElementById(t.canvasElementId);x&&x.parentElement.removeChild(x)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Qo})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=V.getInstance(),this._logger.defaultLevel===Vt.Debug&&u.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...Zo}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Zo,...t.garbageCollection},this._garbageCollector=new iu({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",b=>{b.preventDefault()});let d=(e=t.displayMode)!==null&&e!==void 0?e:Xt.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(d=Xt.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),d=Xt.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=d;let f,p,_,v,g,w;typeof t.antialiasing=="object"?{pixelArtSampler:f,nativeContextAntialiasing:_,multiSampleAntialiasing:w,filtering:g,canvasImageRendering:v}={...t.pixelArt?Zc:$c,...t.antialiasing}:(f=!!t.pixelArt,_=!1,w=t.antialiasing,v=t.antialiasing?"auto":"pixelated",g=t.antialiasing?Lt.Blended:Lt.Pixel),_&&w&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(p=.25),(!t.antialiasing||g===Lt.Pixel)&&(p=0),p=(i=(s=t.uvPadding)!==null&&s!==void 0?s:p)!==null&&i!==void 0?i:.01;let C=Jt.isEnabled("use-canvas-context");if(!C)try{this.graphicsContext=new xs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:f,antialiasing:_,multiSampleAntialiasing:w,uvPadding:p,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(n=t.handleContextLost)!==null&&n!==void 0?n:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(b){this._logger.warn(`Excalibur could not load webgl for some reason (${b.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),C=!0}C&&(this.graphicsContext=new Cr({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:_,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new No({canvas:this.canvas,context:this.graphicsContext,antialiasing:_,canvasImageRendering:v,browser:this.browser,viewport:(o=t.viewport)!==null&&o!==void 0?o:t.width&&t.height?{width:t.width,height:t.height}:Oo.SVGA,resolution:t.resolution,displayMode:d,pixelRatio:t.suppressHiDPIScaling?1:(a=t.pixelRatio)!==null&&a!==void 0?a:null}),At.filtering=g,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(h=t.maxFps)!==null&&h!==void 0?h:this.maxFps,this.fixedUpdateTimestep=(l=t.fixedUpdateTimestep)!==null&&l!==void 0?l:this.fixedUpdateTimestep,this.fixedUpdateFps=(c=t.fixedUpdateFps)!==null&&c!==void 0?c:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new hh({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:b=>this.onFatalException(b)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...ys(),enabled:t.physics}:(this.physics={...ys()},dr(this.physics,t.physics)),this.debug=new jc(this),this.director=new tu(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,ge.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:e,showPlayerMessage:s}=this._originalOptions.configurePerformanceCanvas2DFallback;if(e===void 0&&(e=ge._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),s===void 0&&(s=ge._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Jt.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===e.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let i=0;for(let o=0;o<this._fpsSamples.length;o++)i+=this._fpsSamples[o];const n=i/this._fpsSamples.length;this._fpsSamples.length===e.numberOfFrames&&n<=e.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),s&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,e,s;const i=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(i,this.canvas),this.canvas=i;const n={...this._originalOptions,antialiasing:this.screen.antialiasing},o=this._originalDisplayMode;this.graphicsContext=new Cr({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:n.antialiasing,backgroundColor:n.backgroundColor,snapToPixel:n.snapToPixel,useDrawSorting:n.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new No({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=n.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(e=n.viewport)!==null&&e!==void 0?e:n.width&&n.height?{width:n.width,height:n.height}:Oo.SVGA,resolution:n.resolution,displayMode:o,pixelRatio:n.suppressHiDPIScaling?1:(s=n.pixelRatio)!==null&&s!==void 0?s:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const a=n&&n.pointerScope===li.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(a,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,ge.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){V.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,e){return this.director.add(t,e),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const e=this.director.getDeferredScene();e instanceof Ie?e.add(t):this.currentScene.add(t)}remove(t){t instanceof oe&&this.currentScene.remove(t),(t instanceof Ie||ss(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,e){await this.scope(async()=>{await this.director.goToScene(t,e)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var e,s;this.pageScrollPreventionMode=t.scrollPreventionMode;const i=t&&t.pointerScope===li.Document?document:this.canvas,n=(s=(e=this._originalOptions)===null||e===void 0?void 0:e.grabWindowFocus)!==null&&s!==void 0?s:!0;this.input=new oh({pointerTarget:i,grabWindowFocus:n,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new ka(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Da(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new tn(t,this)),this._isInitialized=!0)}_update(t){var e;if(this._isLoading){(e=this._loader)===null||e===void 0||e.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new Gs(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,e){}_postupdate(t){this.emit("postupdate",new Xs(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,e){}_draw(t){var e,s;if(this.graphicsContext.backgroundColor=(e=this.currentScene.backgroundColor)!==null&&e!==void 0?e:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((s=this._loader)===null||s===void 0||s.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,e){this.emit("predraw",new Ji(t,e,this)),this.onPreDraw(t,e)}onPreDraw(t,e){}_postdraw(t,e){this.emit("postdraw",new Ki(t,e,this)),this.onPostDraw(t,e)}onPostDraw(t,e){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,e){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let s;return t instanceof vn?s=t:typeof t=="string"&&(this.director.configureStart(t,e),s=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(s??new fi),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new xa(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new Sa(this,this.stats.prevFrame));const e=t*this.timescale;this.currentFrameElapsedMs=e;const s=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=s,this.stats.currFrame.elapsedMs=e,this.stats.currFrame.fps=this.clock.fpsSampler.fps,wt.clear();const i=this.clock.now(),n=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=e;this._lagMs>=n;)this._update(n),this._lagMs-=n;else this._update(e);const o=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(e);const a=this.clock.now();this.stats.currFrame.duration.update=o-i,this.stats.currFrame.duration.draw=a-o,this.stats.currFrame.graphics.drawnImages=wt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=wt.DrawCallCount,this.emit("postframe",new Ea(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new ya(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(s=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:s})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const e=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,s=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,i=document.createElement("canvas");i.width=e,i.height=s;const n=i.getContext("2d");n.imageSmoothingEnabled=this.screen.antialiasing,n.drawImage(this.canvas,0,0,e,s);const o=new Image,a=i.toDataURL("image/png");o.onload=()=>{t.resolve(o)},o.src=a}this._screenShotRequests.length=0}async load(t,e=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=e,t instanceof fi&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(s){this._logger.error("Error loading resources, things may not behave properly",s),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}ge.Context=eu();ge.InstanceCount=0;ge._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:li.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Os.Canvas,backgroundColor:k.fromHex("#2185d0")};class Jf extends fe{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new ci,this._text=new Fn({text:"",font:this._font});const{text:e,pos:s,x:i,y:n,spriteFont:o,font:a,color:h,maxWidth:l}={text:"",...t};this.pos=s??(i&&n?E(i,n):this.pos),this.text=e??this.text,this.font=a??this.font,this.maxWidth=l??this.maxWidth,this.spriteFont=o??this.spriteFont,this._text.color=h??this.color;const c=this.get(It);c.anchor=T.Zero,c.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Ns;(function(r){r.Circle="circle",r.Rectangle="rectangle"})(Ns||(Ns={}));class Kf extends fe{constructor(t){var e,s;super({width:(e=t.width)!==null&&e!==void 0?e:0,height:(s=t.height)!==null&&s!==void 0?s:0}),this._particlesToEmit=0,this._particlePool=new Mn(()=>new Wr({}),p=>p,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Ns.Rectangle,this.radius=0,this.particle={life:2e3,transform:Qe.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:i,x:n,y:o,z:a,pos:h,isEmitting:l,emitRate:c,emitterType:u,radius:d,random:f}={...t};this.particle={...this.particle,...i},this.pos=h??E(n??0,o??0),this.z=a??0,this.isEmitting=l??this.isEmitting,this.emitRate=c??this.emitRate,this.emitterType=u??this.emitterType,this.radius=d??this.radius,this.body.collisionType=X.PreventCollision,this.random=f??new Yi}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var e;if(!(t<=0)){t=t|0;for(let s=0;s<t;s++){const i=this._createParticle();!((e=this===null||this===void 0?void 0:this.scene)===null||e===void 0)&&e.world&&(this.particle.transform===Qe.Global?this.scene.world.add(i):this.addChild(i)),this._activeParticles.push(i)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,e=0;const s=is(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),i=is(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),n=this.particle.startSize||is(this.particle.minSize||5,this.particle.maxSize||5,this.random),o=i*Math.cos(s),a=i*Math.sin(s);if(this.emitterType===Ns.Rectangle)t=is(0,this.width,this.random),e=is(0,this.height,this.random);else if(this.emitterType===Ns.Circle){const l=is(0,this.radius,this.random);t=l*Math.cos(s),e=l*Math.sin(s)}const h=this._particlePool.rent();return h.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:E(t,e),vel:E(o,a),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:n,graphic:this.particle.graphic,fade:this.particle.fade}),h.registerEmitter(this),this.particle.randomRotation&&(h.transform.rotation=is(0,Math.PI*2,this.random)),this.particle.focus&&(h.focus=this.particle.focus.add(E(this.pos.x,this.pos.y)),h.focusAccel=this.particle.focusAccel),h}update(t,e){var s;super.update(t,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let i=0;i<this.deadParticles.length;i++){!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.scene.world.remove(this.deadParticles[i],!1),this._particlePool.return(this.deadParticles[i]));const n=this._activeParticles.indexOf(this.deadParticles[i]);n>-1&&this._activeParticles.splice(n,1)}this.deadParticles.length=0}}function tp(r,t){}class Sr{constructor(t,e,s){var i;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=s,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=e,this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,e){if(this._initialized)return;const s=this.emitter.maxParticles,i=this._numInputFloats,n=this._particleData,o=4,a=t.createBuffer(),h=t.createVertexArray();t.bindVertexArray(h),t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,s*i*o,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,n);let l=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,i*o,0),l+=o*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,i*o,l),l+=o*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,i*o,l),l+=o*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,i*o,l),l+=o*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,i*o,l),l+=o*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(h),this._buffers.push(a),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const c=t.createBuffer(),u=t.createVertexArray();t.bindVertexArray(u),t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,s*i*o,t.DYNAMIC_DRAW),l=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,i*o,0),l+=o*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,i*o,l),l+=o*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,i*o,l),l+=o*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,i*o,l),l+=o*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,i*o,l),l+=o*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(u),this._buffers.push(c),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const e=this._particleIndex,s=this.maxParticles*this._numInputFloats,i=t*this._numInputFloats+e;for(let n=e;n<i;n+=this._numInputFloats){const o=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||Ht),a=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),h=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),l=a*Math.cos(o),c=h*Math.sin(o);let u=0,d=0;if(this.emitter.emitterType===Ns.Rectangle)u=this._random.floating(-.5,.5)*this.emitter.width,d=this._random.floating(-.5,.5)*this.emitter.height;else{const _=this._random.floating(0,this.emitter.radius);u=_*Math.cos(o),d=_*Math.sin(o)}const f=this.emitter.transform.apply(E(u,d)),p=[this.particle.transform===Qe.Local?u:f.x,this.particle.transform===Qe.Local?d:f.y,l,c,this.particle.randomRotation?is(0,Ht,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(p,n%this._particleData.length)}i>=s?(this._wrappedParticles+=(i-s)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=i%s,this._emitted.push([this._particleLife,e])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var e;if(this._particleLife=(e=this.particle.life)!==null&&e!==void 0?e:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let s=this._emitted.length-1;s>=0;s--){const i=this._emitted[s];i[0]-=t,i[0]<=0&&this._emitted.splice(s,1)}this._emitted.sort((s,i)=>s[0]-i[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const e=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-e)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,e,this.maxParticles-e),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,e),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Sr.GPU_MAX_PARTICLES=1e5;class ep extends fe{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Qe.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new It,this.isEmitting=!1,this.emitRate=1,this.emitterType=Ns.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:e,maxParticles:s,x:i,y:n,z:o,pos:a,isEmitting:h,emitRate:l,emitterType:c,radius:u,random:d}={...t};this.maxParticles=tt(s??this.maxParticles,0,Sr.GPU_MAX_PARTICLES),this.pos=a??E(i??0,n??0),this.z=o??0,this.isEmitting=h??this.isEmitting,this.emitRate=l??this.emitRate,this.emitterType=c??this.emitterType,this.radius=u??this.radius,this.particle={...this.particle,...e},this.random=d??new Yi,this.renderer=new Sr(this,this.random,this.particle)}_initialize(t){super._initialize(t);const e=t.graphicsContext;this.renderer.initialize(e.__gl,e)}update(t,e){super.update(t,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(e)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,e){t.draw("ex.particle",this.renderer,e)}}class nu extends oe{getGraphics(){return this._graphics}addGraphic(t,e){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,e!=null&&e.offset&&(this._gfx.offset=e.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const e of this._graphics){const s=E(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:e.height-this.map.tileHeight));t=t.combine(e.localBounds.translate(s))}return t}removeGraphic(t){const e=this._graphics.indexOf(t);e>-1&&this._graphics.splice(e,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const e=this._colliders.indexOf(t);e>-1&&this._colliders.splice(e,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(E(this.x,this.y))}get center(){return this.pos.add(E(0,this.map.tileHeight/2))}constructor(t,e,s,i){super([new N,new It({offset:s??T.Zero,onPostDraw:(d,f)=>this.draw(d,f)}),new bn(i)]),this.solid=!1,this.events=new yt,this._tileBounds=new z,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=e,this.map=i,this._transform=this.get(N),this._isometricEntityComponent=this.get(bn);const n=this.map.tileWidth/2,o=this.map.tileHeight/2,a=(this.x-this.y)*n,h=(this.x+this.y)*o;this._transform.pos=E(a,h),this._isometricEntityComponent.elevation=i.elevation,this._gfx=this.get(It),this._gfx.isVisible=!1;const l=this.map.tileWidth,c=this.map.tileHeight,u=E(0,this.map.renderFromTopOfGraphic?c:0);this._gfx.localBounds=this._tileBounds=new z({left:-l/2,top:-c,right:l/2,bottom:c}).translate(u)}draw(t,e){const s=this.map.tileWidth/2;t.save(),t.translate(-s,0);for(const i of this._graphics)i.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t.restore()}}class sp extends oe{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new N,new it({type:X.Fixed}),new Nt,new Ws,new jr((c,u)=>this.debug(c,u),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=E(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:e,tileWidth:s,tileHeight:i,columns:n,rows:o,renderFromTopOfGraphic:a,graphicsOffset:h,elevation:l}=t;this.transform=this.get(N),e&&(this.transform.pos=e),this.collider=this.get(Nt),this.collider&&this.collider.set(this._composite=new $t([])),this.pointer=this.get(Ws),this.renderFromTopOfGraphic=a??this.renderFromTopOfGraphic,this.graphicsOffset=h??this.graphicsOffset,this.elevation=l??this.elevation,this.tileWidth=s,this.tileHeight=i,this.columns=n,this.rows=o,this._pointerEventDispatcher=new Ja,this.tiles=new Array(n*o);for(let c=0;c<o;c++)for(let u=0;u<n;u++){const d=new nu(u,c,this.graphicsOffset,this);this.tiles[u+c*n]=d,this.addChild(d),this._pointerEventDispatcher.addObject(d,f=>this.getTileByPoint(f.worldPos)===d,()=>!0)}this.pointer.localBounds=z.fromDimension(s*n*this.transform.scale.x,i*o*this.transform.scale.y,E(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var e;if(this._originalOffsets.has(t))return(e=this._originalOffsets.get(t))!==null&&e!==void 0?e:T.Zero;{const s=t.offset;return this._originalOffsets.set(t,s),s}}updateColliders(){this._composite.clearColliders();const t=this.get(N).pos;for(const e of this.tiles)if(e.solid)for(const s of e.getColliders()){const i=this._getOrSetColliderOriginalOffset(s);s.offset=this.tileToWorld(E(e.x,e.y)).sub(t).add(i).sub(E(this.tileWidth/2,this.tileHeight)),s.owner=this,this._composite.addCollider(s)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const e=this.tileWidth/2,s=this.tileHeight/2;return E(~~((t.x/e+t.y/s)/2),~~((t.y/s-t.x/e)/2))}tileToWorld(t){const e=this.tileWidth/2,s=this.tileHeight/2,i=(t.x-t.y)*e,n=(t.x+t.y)*s;return E(i,n).add(this.transform.pos)}getTile(t,e){return t<0||e<0||t>=this.columns||e>=this.rows?null:this.tiles[t+e*this.columns]}getTileByPoint(t){const e=this.worldToTile(t);return this.getTile(e.x,e.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const e of this.tiles){const s=e.get(N).z;s>t&&(t=s)}return t}debug(t,e){const{showAll:s,showPosition:i,positionColor:n,positionSize:o,showGrid:a,gridColor:h,gridWidth:l,showColliderGeometry:c}=e.isometric,{geometryColor:u,geometryLineWidth:d,geometryPointSize:f}=e.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,s||a){for(let p=0;p<this.rows+1;p++){const _=this.tileToWorld(E(0,p)),v=this.tileToWorld(E(this.columns,p));t.drawLine(_,v,h,l)}for(let p=0;p<this.columns+1;p++){const _=this.tileToWorld(E(p,0)),v=this.tileToWorld(E(p,this.rows));t.drawLine(_,v,h,l)}}if(s||i)for(const p of this.tiles)t.drawCircle(this.tileToWorld(E(p.x,p.y)),o,n);if(s||c){for(const p of this.tiles)if(p.solid)for(const _ of p.getColliders())_.debug(t,u,{lineWidth:d,pointSize:f})}t.restore()}}class lh{constructor(t,e){this.id=ct(),this._stopped=!1,this._sequenceBuilder=e,this._sequenceContext=new Un(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new lh(t,this._sequenceBuilder)}}class ip{constructor(t){this.id=ct(),this._actions=t}update(t){for(let e=0;e<this._actions.length;e++)this._actions[e].update(t)}isComplete(t){return this._actions.every(e=>e.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class Ti{constructor(t,e){this.bounds=t,this.options=e,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...e},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Ti(new z({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new Ti(new z({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new Ti(new z({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new Ti(new z({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var e,s,i,n;!((e=this.topLeft)===null||e===void 0)&&e.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((s=this.topRight)===null||s===void 0)&&s.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((i=this.bottomLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((n=this.bottomRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const e of this.items)this._insertIntoSubNodes(e);this.items.length=0}}remove(t){var e,s,i,n;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const o=this.items.indexOf(t);o>-1&&this.items.splice(o,1);return}!((e=this.topLeft)===null||e===void 0)&&e.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((s=this.topRight)===null||s===void 0)&&s.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((i=this.bottomLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((n=this.bottomRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let e=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(e=e.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(e=e.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(e=e.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(e=e.concat(this.bottomRight.query(t)))),e=e.filter((s,i)=>e.indexOf(s)>=i),e}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((e,s)=>t.indexOf(e)>=s),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,k.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,k.Yellow),this.topRight.bounds.draw(t,k.Yellow),this.bottomLeft.bounds.draw(t,k.Yellow),this.bottomRight.bounds.draw(t,k.Yellow))}}function np(r){return!!r._initialize}function rp(r){return!!r.onAdd}function op(r){return!!r.onRemove}function ap(r){return!!r.onInitialize}function hp(r){return!!r._preupdate}function lp(r){return!!r.onPreUpdate}function cp(r){return!!r.onPostUpdate}function up(r){return!!r.onPostUpdate}function dp(r){return!!r.onAdd}function fp(r){return!!r.onRemove}function pp(r){return!!r.onPreDraw}function _p(r){return!!r.onPostDraw}class gp{constructor(t,e=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Rn(t,"arraybuffer",e)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new ru(t),this._gif=new ou(this._stream);const e=this._gif.images.map(s=>new rs(s.src,!1));return await Promise.all(e.map(s=>s.load())),this.data=this._images=e,this._sprites=this._images.map(s=>s.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var e;return(e=this._sprites[t])!==null&&e!==void 0?e:null}toSpriteSheet(){const t=this._sprites;return t.length?new si({sprites:t}):null}toAnimation(t){var e;const s=(e=this._gif)===null||e===void 0?void 0:e.images;if(s!=null&&s.length){const i=s.map((n,o)=>{var a;return{graphic:this._sprites[o],duration:((a=this._gif)===null||a===void 0?void 0:a.frames[o].delayMs)||void 0}});return this._animation=new He({frames:i,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,e;return(e=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&e!==void 0?e:[]}}const Kn=r=>r.reduce(function(t,e){return t*2+e},0),Eo=r=>{const t=[];for(let e=7;e>=0;e--)t.push(!!(r&1<<e));return t};class ru{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=e=>{const s=[];for(let i=0;i<e;i++)s.push(this.readByte());return s},this.read=e=>{let s="";for(let i=0;i<e;i++)s+=String.fromCharCode(this.readByte());return s},this.readUnsigned=()=>{const e=this.readBytes(2);return(e[1]<<8)+e[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const mp=function(r,t){let e=0;const s=function(d){let f=0;for(let p=0;p<d;p++)t.charCodeAt(e>>3)&1<<(e&7)&&(f|=1<<p),e++;return f},i=[],n=1<<r,o=n+1;let a=r+1,h=[];const l=function(){h=[],a=r+1;for(let d=0;d<n;d++)h[d]=[d];h[n]=[],h[o]=null};let c=0,u=0;for(;;){if(u=c,c=s(a),c===n){l();continue}if(c===o)break;if(c<h.length)u!==n&&h.push(h[u].concat(h[c][0]));else{if(c!==h.length)throw new Error("Invalid LZW code.");h.push(h[u].concat(h[u][0]))}i.push.apply(i,h[c]),h.length===1<<a&&a<12&&a++}return i};class ou{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=e=>{const s=[];for(let i=0;i<e;i++){const n=this._st.readBytes(3);s.push(n)}return s},this.readSubBlocks=()=>{let e,s;s="";do e=this._st.readByte(),s+=this._st.read(e);while(e!==0);return s},this.parseHeader=()=>{const e={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(e.sig=this._st.read(3),e.ver=this._st.read(3),e.sig!=="GIF")throw new Error("Not a GIF file.");e.width=this._st.readUnsigned(),e.height=this._st.readUnsigned(),this._currentFrameCanvas.width=e.width,this._currentFrameCanvas.height=e.height;const s=Eo(this._st.readByte());e.gctFlag=s.shift(),e.colorResolution=Kn(s.splice(0,3)),e.sortedFlag=s.shift(),e.globalColorTableSize=Kn(s.splice(0,3)),e.backgroundColorIndex=this._st.readByte(),e.pixelAspectRatio=this._st.readByte(),e.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<e.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(e)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=e=>{const s=h=>{this.checkBytes.push(this._st.readByte());const l=Eo(this._st.readByte());return h.reserved=l.splice(0,3),h.disposalMethod=Kn(l.splice(0,3)),h.userInputFlag=l.shift(),h.transparentColorFlag=l.shift(),h.delayTime=this._st.readUnsigned(),h.transparentColorIndex=this._st.readByte(),h.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(h)&&this.checkBytes.push(this._handler.gce),h},i=h=>{h.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(h)&&this.checkBytes.push(this._handler.com)},n=h=>{this.checkBytes.push(this._st.readByte()),h.ptHeader=this._st.readBytes(12),h.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(h)&&this.checkBytes.push(this._handler.pte)},o=h=>{const l=u=>{this.checkBytes.push(this._st.readByte()),u.unknown=this._st.readByte(),u.iterations=this._st.readUnsigned(),u.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(u)&&this.checkBytes.push(this._handler.app)},c=u=>{u.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[u.identifier]&&this._handler.app[u.identifier](u)&&this.checkBytes.push(this._handler.app[u.identifier])};switch(this.checkBytes.push(this._st.readByte()),h.identifier=this._st.read(8),h.authCode=this._st.read(3),h.identifier){case"NETSCAPE":l(h);break;default:c(h);break}},a=h=>{h.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(h)&&this.checkBytes.push(this._handler.unknown)};switch(e.label=this._st.readByte(),e.label){case 249:e.extType="gce",this._gce=s(e);break;case 254:e.extType="com",i(e);break;case 1:e.extType="pte",n(e);break;case 255:e.extType="app",o(e);break;default:e.extType="unknown",a(e);break}},this.parseImg=e=>{var s;const i=(a,h)=>{const l=new Array(a.length),c=a.length/h,u=(_,v)=>{const g=a.slice(v*h,(v+1)*h);l.splice.apply(l,[_*h,h].concat(g))},d=[0,4,2,1],f=[8,8,4,2];let p=0;for(let _=0;_<4;_++)for(let v=d[_];v<c;v+=f[_])u(v,p),p++;return l};e.leftPos=this._st.readUnsigned(),e.topPos=this._st.readUnsigned(),e.width=this._st.readUnsigned(),e.height=this._st.readUnsigned();const n=Eo(this._st.readByte());e.lctFlag=n.shift(),e.interlaced=n.shift(),e.sorted=n.shift(),e.reserved=n.splice(0,2),e.lctSize=Kn(n.splice(0,3)),e.lctFlag&&(e.lctBytes=this.parseColorTableBytes(1<<e.lctSize+1)),e.lzwMinCodeSize=this._st.readByte();const o=this.readSubBlocks();e.pixels=mp(e.lzwMinCodeSize,o),e.interlaced&&(e.pixels=i(e.pixels,e.width)),!((s=this._gce)===null||s===void 0)&&s.delayTime&&(e.delayMs=this._gce.delayTime*10),this.frames.push(e),this.arrayToImage(e,e.lctFlag?e.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(e)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const e={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(e.sentinel)){case"!":e.type="ext",this.parseExt(e);break;case",":e.type="img",this.parseImg(e);break;case";":e.type="eof",this._handler.eof&&this._handler.eof(e)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}e.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(e,s)=>{var i,n,o,a;const h=document.createElement("canvas");h.width=e.width,h.height=e.height;const l=h.getContext("2d"),c=l.getImageData(0,0,h.width,h.height);let u=-1;!((i=this._gce)===null||i===void 0)&&i.transparentColorFlag&&(u=this._gce.transparentColorIndex);for(let f=0;f<e.pixels.length;f++){const p=e.pixels[f],_=s[p];p===u?c.data.set([0,0,0,0],f*4):c.data.set([..._,255],f*4)}if(l.putImageData(c,0,0),((n=this._gce)===null||n===void 0?void 0:n.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((o=this._gce)===null||o===void 0?void 0:o.disposalMethod)===2&&(!((a=this._hdr)===null||a===void 0)&&a.gctFlag)){const f=s[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${f[0]}, ${f[1]}, ${f[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(h,e.leftPos,e.topPos,e.width,e.height);const d=new Image;d.src=this._currentFrameCanvas.toDataURL(),this.images.push(d)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class vp{constructor(t,e,{bustCache:s,...i}={}){this.path=t,this.family=e,this._isLoaded=!1,this._resource=new Rn(t,"blob",s),this._options=i}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),e=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${e})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new ci({family:this.family,...this._options,...t})}}const sl=eu(),wp=/^\s*(?:function)?\*/;function il(r){return typeof r!="function"?!1:wp.test(Function.prototype.toString.call(r))?!0:Object.getPrototypeOf?Object.getPrototypeOf(r)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function au(...r){var t;const e=V.getInstance();let s,i,n,o;il(r[0])&&(i=globalThis,s=r[0],n=r[1]),il(r[1])&&(i=r[0],s=r[1],n=r[2]),r[1]instanceof ge&&(i=r[0],o=r[1],s=r[2],n=r[3]),r[0]instanceof ge&&(i=globalThis,o=r[0],s=r[1],n=r[2]);const a=su(sl),h=n==null?void 0:n.timing,l=a?!1:(t=n==null?void 0:n.autostart)!==null&&t!==void 0?t:!0;let c;try{c=o??ge.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let u=!1,d=!1,f=!1;const p=s.bind(i),_=p();let v;const g=new Promise((C,b)=>{v=x=>{try{if(f){d=!0,C();return}const{done:A,value:y}=sl.scope(!0,()=>_.next(x));if(A||f){d=!0,C();return}y instanceof Promise?y.then(()=>{c.clock.schedule(v,0,h)}):y===void 0||y===void 0?c.clock.schedule(v,0,h):c.clock.schedule(v,y||0,h)}catch(A){b(A);return}},l&&(u=!0,v(c.clock.elapsed()))}),w={isRunning:()=>u&&!f&&!d,isComplete:()=>d,cancel:()=>{f=!0},start:()=>(u?e.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(p)):(u=!0,v(c.clock.elapsed())),w),generator:_,done:g,then:g.then.bind(g),[Symbol.iterator]:()=>_};return w}class to extends oe{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var e,s,i,n;super(),this._logger=V.getInstance(),this.transform=new N,this.graphics=new It,this._completeFuture=new De,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(e=t.easing)!==null&&e!==void 0?e:ut.Linear,this.direction=(s=t.direction)!==null&&s!==void 0?s:"out",this.hideLoader=(i=t.hideLoader)!==null&&i!==void 0?i:!1,this.blockInput=(n=t.blockInput)!==null&&n!==void 0?n:!1,this.transform.coordPlane=te.Screen,this.transform.pos=T.Zero,this.transform.z=1/0,this.graphics.anchor=T.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,e){this.complete||(this._currentDistance+=tt(e/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=tt(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=tt(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new De,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,e){const s=e;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),s.world.entityManager.getById(this.id))return this._co;this._engine=t,s.add(this);const i=this;return this._co=au(t,function*(){for(;!i.complete;){const n=yield;i.updateTransition(i._engine,n),i._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class xp extends to{constructor(t){var e,s;super({...t,duration:(e=t.duration)!==null&&e!==void 0?e:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(s=t.color)!==null&&s!==void 0?s:k.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new On({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class yp extends to{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=rs.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=E(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class bp extends to{constructor(t){var e;super({direction:"in",...t}),this._easing=ut.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=te.World,this.graphics.forceOnScreen=!0,this._easing=(e=t.easingFunction)!==null&&e!==void 0?e:this._easing,this._vectorEasing=ut.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=rs.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=E(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=E(0,t.screen.resolution.height);break}case"left":{this._directionOffset=E(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=E(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=E(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class ch extends Pt{constructor(t){super(),this.color=k.Black,this.thickness=1;const{start:e,end:s,color:i,thickness:n}=t;this.start=e,this.end=s,this.color=i??this.color,this.thickness=n??this.thickness,this._localBounds=this._calculateBounds();const{width:o,height:a}=this._localBounds;this.width=o,this.height=a}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),e=this.thickness/2,s=[this.start.add(t.scale(e)),this.end.add(t.scale(e)),this.end.add(t.scale(-e)),this.start.add(t.scale(-e))];return z.fromPoints(s)}_drawImage(t,e,s){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new ch({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class uh extends Qi{get points(){return this._points}set points(t){this._points=t;const e=this.minPoint;this.width=this._points.reduce((s,i)=>Math.max(i.x,s),0)-e.x,this.height=this._points.reduce((s,i)=>Math.max(i.y,s),0)-e.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((s,i)=>Math.min(i.x,s),1/0),e=this._points.reduce((s,i)=>Math.min(i.y,s),1/0);return E(t,e)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=Lt.Blended,this.rasterize()}clone(){return new uh({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const e=this.minPoint.negate(),s=this.points[0].add(e);t.moveTo(s.x,s.y),this.points.forEach(i=>{t.lineTo(i.x+e.x,i.y+e.y)}),t.lineTo(s.x,s.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var vs;(function(r){r.Stretch="stretch",r.Tile="tile",r.TileFit="tile-fit"})(vs||(vs={}));class dh extends Pt{constructor(t){super(t),this._logger=V.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,e=!1){this._config.width=t,e&&this._initialize()}setTargetHeight(t,e=!1){this._config.height=t,e&&this._initialize()}setMargins(t,e,s,i,n=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=e,this._config.sourceConfig.rightMargin=s,this._config.sourceConfig.bottomMargin=i,n&&this._initialize()}setStretch(t,e,s=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=e:t==="vertical"?this._config.destinationConfig.verticalStretch=e:(this._config.destinationConfig.horizontalStretch=e,this._config.destinationConfig.verticalStretch=e),s&&this._initialize()}getConfig(){return this._config}_drawTile(t,e,s,i,n,o,a){const h=o||0,l=a||0;let c,u,d,f;const p=this._getNumberOfTiles(e.width,s.x,i),_=this._getNumberOfTiles(e.height,s.y,n);for(let v=0;v<p;v++)for(let g=0;g<_;g++){let{tempSize:w,tempPosition:C}=this._calculateParams(v,p,e.width,s.x,this._config.destinationConfig.horizontalStretch);c=w,u=C,{tempSize:w,tempPosition:C}=this._calculateParams(g,_,e.height,s.y,this._config.destinationConfig.verticalStretch),d=w,f=C,t.drawImage(e,0,0,e.width,e.height,h+u,l+f,c,d)}}_drawImage(t,e,s){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new T(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new T(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new T(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new T(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new T(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new T(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new T(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new T(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new T(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t==null||t.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const e=this._canvasB.getContext("2d");e==null||e.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const s=this._canvasC.getContext("2d");s==null||s.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const i=this._canvasD.getContext("2d");i==null||i.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const n=this._canvasE.getContext("2d");n==null||n.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasF.getContext("2d");o==null||o.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const a=this._canvasG.getContext("2d");a==null||a.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const h=this._canvasH.getContext("2d");h==null||h.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const l=this._canvasI.getContext("2d");l==null||l.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new dh(this._config)}_getNumberOfTiles(t,e,s){switch(s){case vs.Stretch:return 1;case vs.Tile:return Math.ceil(e/t);case vs.TileFit:return Math.ceil(e/t)}}_calculateParams(t,e,s,i,n){switch(n){case vs.Stretch:return{tempPosition:0,tempSize:i};case vs.Tile:return t===e-1?{tempPosition:t*s,tempSize:s-(e*s-i)}:{tempPosition:t*s,tempSize:s};case vs.TileFit:const o=i/e;return{tempPosition:t*o,tempSize:o}}}}class fh extends He{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new De,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const e=[];for(let s=0;s<this.frames.length;s++){const i=this.frames[s].graphic;if(i&&i instanceof je){const n=new Dn({image:i.image,width:t.width,height:t.height,sourceView:{...i.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[s].graphic=n,n.ready.then(()=>{n.sourceView={...n.sourceView,...this._sourceView}}),e.push(n.ready)}}Promise.all(e).then(()=>this._ready.resolve())}static fromAnimation(t,e){return new fh({width:t.width,height:t.height,...e,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const e=this.frames[t].graphic;e&&e instanceof je&&(e.sourceView={...e.sourceView,...this._sourceView})}}get sourceView(){return qe(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=qe(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const e=this.frames[t].graphic;e&&e instanceof je&&(e.sourceView.height=this._tiledHeight||e.height,e.destSize.height=this._tiledHeight||e.height,e.sourceView.width=this._tiledWidth||e.width,e.destSize.width=this._tiledWidth||e.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const hu=5,Li={},Cp=()=>{for(const r in Li)Li[r]=0},tr=(r,t)=>{const e=Jt.isEnabled("suppress-obsolete-message");Li[r]<hu&&!e&&(V.getInstance().warn(r),console.trace&&t.showStackTrace&&console.trace()),Li[r]++};function Tp(r){return r={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...r},function(t,e,s){if(s&&!(typeof s.value=="function"||typeof s.get=="function"||typeof s.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const n=`${`${t.name||""}${t.name&&e?".":""}${e||""}`} is marked obsolete: ${r.message}`+(r.alternateMethod?` Use ${r.alternateMethod} instead`:"");Li[n]||(Li[n]=0);const o=s?{...s}:t;if(!s){class a extends o{constructor(...l){tr(n,r),super(...l)}}return a}return s&&s.value?(o.value=function(){return tr(n,r),s.value.apply(this,arguments)},o):(s&&s.get&&(o.get=function(){return tr(n,r),s.get.apply(this,arguments)}),s&&s.set&&(o.set=function(){return tr(n,r),s.set.apply(this,arguments)}),o)}}class Ap{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new De;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class Sp{constructor(t){this._count=t,this._waitQueue=new Ap}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const Qo="0.30.3";Al();m.eKr;m.yVm;m.a7j;m.U_w;m.JF2;m.htg;m.HXL;m.mcg;var eo=m.Agj;m.J3_;m.Wgv;m.u6S;m.x7M;var Ep=m.X55;m.m3M;m.aE5;var Pp=m.YJU;m.eZi;m.GNv;m.Y56;m._0v;m.vhs;m.vrQ;m.Z8b;m.Yfw;m.IcQ;m.kgJ;m.GTT;m.ypY;m.i7d;m.fQ3;m.HlI;m.jlt;m.VQc;m.zD7;m.AUF;m.JoF;m.MlA;m.PZh;m.qA;m.CrD;m.dQK;m.D3r;m.Qpo;m.D9n;m.b6v;m.mvh;var Sn=m.Bpo,we=m.Q1f;m.IKv;m.fcV;m.Glf;m.uAl;m.ElT;m.Z8r;m.QSL;m.sPV;m.nAn;m.zCU;m.QrV;m.fF9;m.Jqv;m.d_u;m.xI8;m.yar;m.SP7;m.oRy;m.f5X;m.V1c;m.Mlx;m.ZiM;m.ZCo;m.J5p;var Ip=m.mL_;m.Guw;m.N5j;m.pgY;m.OP3;m.rl5;m.eod;var Mp=m.q5Z;m.YUC;m.saR;m.hvr;m.Qol;m.Wf4;m.JCs;m.gJV;m.fWD;m.Va_;var Rp=m.N$8;m._jQ;m.rxj;m.rhv;m.wCu;m.HAp;m.Zy1;m.bkB;m.wfL;m.sVA;m.$Gs;m.CJ0;m.NWh;m.tWi;m.xAj;m.zWh;m.i_4;m.iIx;m.Hxo;m.c9e;m.KQV;m.weH;var Dp=m.jXp;m.zzY;var Ls=m.yRQ;m.MtE;m.rPj;m.KLc;var lu=m.Fir;m.V5f;m.Xj7;m.Wud;m.FVg;m.g5Y;m.YQB;m.KPb;m.nHK;m.Jrb;m.TX_;m.Olt;m.r3n;m.Fvk;m.gpR;m.vYh;m.hnk;m.D2R;m.n1o;m.h9O;m.X5j;m.p3P;m.RLG;m.fBU;m.Adb;var Po=m.bEs;m.wCy;m.CbD;m.x_C;m.pGf;m.ibQ;m.shR;m.Yjk;m._u1;m.OBI;m.klh;m.s3S;var bi=m.D$R;m.xth;var Us=m.JU7;m.h9x;m.N1A;m.e_k;var kp=m.aHM;m.tlv;m.Vi9;m.ieR;m.$bb;m.VyI;m.imn;m.uqu;m.QnL;m.vnc;m.wk_;m.GH0;m._1r;m.l0X;m.bT;m.HHX;m.jtW;m.tjk;m.rWe;m.j9l;m.l0$;m.sGJ;m.NVp;m.cPK;m.XoL;m.RmF;m.DXI;m.tCD;m.J3D;m.vCJ;m.e6k;m.f9l;m.v9m;m.yRJ;m.EU6;m.m3O;m.Ryz;m.OxP;m.LEs;m.Ec;m.Pi5;m.gmH;m.tS;m.XxX;m.bCz;m.nYS;m.yiT;m.NHl;m.mO8;m.PXI;m.bn5;m.Ywr;m.cMd;m.Bs6;m.G0k;m.pyn;m.QeM;m.aPX;m.ITP;m.BY0;m.MFw;m.sBn;m.S3L;m.XKQ;m.ESI;m.uxz;m.o8N;m.u_r;m.RlV;m.gVA;var so=m.M_G;m.BpG;m.GRB;m.kM6;m.dO8;m.jgM;m.FWq;m.s3j;m.hlw;m.L0q;m.B7e;m.PGN;m.H_X;m.S_d;m._Tq;m.U7E;m.IOH;var Fp=m.Z58;m.yh2;m.ff$;m.cWi;var io=m.NBt;m.oNz;m.QlU;m.Xey;m.jft;m._r8;m.bTC;m.Mtr;var cu=m.ypk;m.mnM;m.q7S;var Bp=m.bAZ,Op=m.ABN;m.VK6;m.Hj2;m.Df8;m.oOx;var Np=m.kxk;m.DT1;var Lp=m.FLG;m.qN_;m.Z37;m.FtL;m.Z6X;m.iQT;m.ziO;m.OEF;m.uuE;m.tiv;m.T$Y;m.EYj;var oi=m.nOB;m.Tap;m.FAs;m.B_P;m.aA5;m.J3s;m.Y0Q;var ar=m.M4G;m.l$l;m.dLy;m.WZP;m.eB6;m.nFK;m.l9z;m.YOF;m.yhB;m.J0N;var Yt=m.Miz;m.Bj4;m.Rcs;m.vJ4;m.TqC;m.nM0;m.X1u;m.SpZ;m.DX8;m.Yx$;m.HK4;m.yt5;m.vAR;m.SE$;var Up=m.qE8;m.Pz7;m.sX_;m.JuI;m.pxT;m.Nl$;m.zDr;m.OwT;m.P$G;m.mHV;m.kEA;m.Fx_;m.WFC;m.vKu;m.aDq;m.jIg;m.UH3;m.AJO;m.U4;m.xAc;m._3Y;m.K6X;m.C1Y;m.Aw1;m.tm8;m.LBV;m.A8$;m.F5e;m.ran;m.c8L;m.o6M;m.hsx;m.l9E;m.aSf;m.CcK;m.nU8;m.td6;m.Zex;m.bkJ;m.mXP;m.vt$;m.hCA;m.pjR;m.U43;m.pSZ;m.y17;m.Ew7;m.hG1;m.jVr;m._SZ;m.xWn;m.ehJ;var Jo=m.t6s;m.Eyn;const Ui=Object.freeze({EFFECT_ON:"EFFECT_ON",EFFECT_OFF:"EFFECT_OFF",MUSIC_ON:"MUSIC_ON",MUSIC_OFF:"MUSIC_OFF"});class zp extends lu{constructor(t){super(),this.gameSound=t}}class Io extends Op{constructor(){super(...arguments);bt(this,"isEffectOn",!1)}play(e){this.isEffectOn&&super.play(e)}wireEngine(e){console.log(e),e.events.on("gameSoundChange",s=>{s.gameSound===Ui.EFFECT_ON&&(this.isEffectOn=!0,console.log("effects on")),s.gameSound===Ui.EFFECT_OFF&&(this.isEffectOn=!1,console.log("effects off"),this.stop())})}}const Ae={Fish:new Po("images/fish.png"),Cars:new Po("images/cars.png"),Explosion:new Po("images/explosionanimation.png"),PixelFont:new Dp("fonts/PressStart2P-Regular.ttf","PressStart"),Explosion1:new Io("sounds/explosion-312361.mp3"),Crash1:new Io("sounds/clank-car-crash-collision-6206.mp3"),Jump:new Io("sounds/funny-spring-jump-140378.mp3")},uu={dumptruck:{x:1,y:131,width:54,height:123,class:5},tow_truck:{x:1,y:59,width:33,height:70,class:4},tow_truck2:{x:57,y:184,width:33,height:70,class:4},tow_truck3:{x:92,y:185,width:33,height:69,class:4},truck2:{x:127,y:188,width:33,height:66,class:4},truck3:{x:162,y:188,width:33,height:66,class:4},landcruiser:{x:1,y:1,width:29,height:56,class:3},landcruiser2:{x:197,y:198,width:29,height:56,class:3},landcruiser3:{x:228,y:198,width:29,height:56,class:3},van:{x:259,y:198,width:29,height:56,class:3},raptor:{x:290,y:199,width:28,height:55,class:3},raptor2:{x:320,y:199,width:28,height:55,class:3},pickup:{x:57,y:131,width:28,height:51,class:3},pickup2:{x:36,y:78,width:28,height:51,class:3},pickup3:{x:350,y:203,width:28,height:51,class:3},suv:{x:380,y:204,width:28,height:50,class:3},suv2:{x:410,y:204,width:28,height:50,class:3},van2:{x:440,y:204,width:27,height:50,class:3},van3:{x:469,y:204,width:27,height:50,class:3},mustang2:{x:66,y:80,width:26,height:49,class:3},camaro:{x:87,y:134,width:26,height:48,class:3},camaro2:{x:94,y:84,width:26,height:48,class:3},challenger2:{x:115,y:135,width:28,height:48,class:3},challenger3:{x:145,y:138,width:28,height:48,class:3},lexus:{x:122,y:85,width:26,height:48,class:3},lexus2:{x:175,y:138,width:26,height:48,class:3},gwagon:{x:150,y:89,width:27,height:47,class:3},bmw:{x:179,y:89,width:25,height:47,class:2},gwagon2:{x:203,y:149,width:27,height:47,class:3},patrol:{x:232,y:149,width:27,height:47,class:3},patrol2:{x:261,y:149,width:27,height:47,class:3},lexus3:{x:290,y:149,width:26,height:48,class:3},taxi:{x:318,y:149,width:26,height:48,class:3},taxi2:{x:206,y:99,width:26,height:48,class:3},lambo:{x:234,y:101,width:27,height:46,class:2},lambo2:{x:263,y:101,width:27,height:46,class:2},lancer:{x:292,y:100,width:26,height:47,class:2},bmw2:{x:320,y:100,width:25,height:47,class:2},bmw3:{x:32,y:10,width:25,height:47,class:2},lancer2:{x:346,y:150,width:26,height:47,class:2},mustang3:{x:347,y:101,width:26,height:47,class:2},wrangler:{x:374,y:155,width:24,height:46,class:2},sunny:{x:400,y:157,width:25,height:45,class:2},wrangler2:{x:427,y:156,width:24,height:46,class:2},wrangler3:{x:453,y:156,width:24,height:46,class:2},wrangler4:{x:375,y:107,width:24,height:46,class:2},tida:{x:401,y:112,width:24,height:43,class:2},mini:{x:427,y:112,width:24,height:42,class:2},tida2:{x:453,y:111,width:24,height:43,class:2},tida3:{x:479,y:159,width:24,height:43,class:2},convertible:{x:479,y:116,width:24,height:41,class:2},figo:{x:206,y:56,width:24,height:41,class:2},figo2:{x:232,y:56,width:24,height:41,class:2},porsche:{x:258,y:58,width:24,height:41,class:2},bike2:{x:284,y:63,width:16,height:35,class:1},bike:{x:302,y:65,width:16,height:33,class:1}},hr={};for(const[r,t]of Object.entries(uu))hr[r]=new Np({image:Ae.Cars,sourceView:{x:t.x,y:t.y,width:t.width,height:t.height}});const du=new kp;for(let r of Object.values(Ae))du.addResource(r);const zs=Object.freeze({INIT:"INIT",MENU:"MENU",PLAYING:"PLAYING",GAMEOVER:"GAMEOVER"});class Vp extends lu{constructor(t,e=!1){super(),this.gameState=t,this.levelCompleted=e}}class fu extends eo{constructor(e,s,i,n,o){const a=new Yt(e,s);super({pos:a,width:i,height:n,color:new we(0,150,0),collisionType:Sn.Fixed,anchor:new Yt(0,1)});bt(this,"row");this.row=o}onInitialize(e){this.collider.set(cu.Box(this.width,this.height,new Yt(0,1))),this.on("exitviewport",()=>{const i=this.scene.camera.pos.y+this.scene.engine.screen.resolution.height/2;this.pos.y>i&&(this.kill(),this.scene.obstacleLeftScreen(this.row))}),this.body.friction=0}}class pu extends eo{constructor(t,e,s,i,n){super({collisionType:Sn.Active}),this.carType=t,this.pos=e,this.vel=s,this.minSpeed=i,this.maxSpeed=n,this.gameOver=!1}onInitialize(t){this.graphics.use(hr[this.carType]);const e=hr[this.carType].width,s=hr[this.carType].height;this.collider.set(cu.Box(e,s)),this.on("collisionstart",i=>{i.other.owner instanceof fu&&(this.gameOver=!0,this.handleObstacleCollision())}),this.body.bounciness=1,this.body.friction=0,this.body.limitDegreeOfFreedom.push(Ip.Rotation),super.onInitialize(t)}steerLeft(){this.body.applyLinearImpulse(Jo(-25*this.body.mass,0))}steerRight(){this.body.applyLinearImpulse(Jo(25*this.body.mass,0))}useThrottle(){this.vel.y-=5}useBreak(){this.vel.y+=50}update(t,e){this.vel.y+=.005*-this.vel.y,this.vel.y=Up(this.vel.y,-this.maxSpeed,-this.minSpeed),Math.abs(this.vel.x)<10?this.vel.x=0:this.vel.x=this.vel.x-Math.sign(this.vel.x)*10,this.gameOver&&(this.vel.x=0,this.vel.y=0),this.rotation=this.vel.x/2e3,super.update(t,e)}handleObstacleCollision(t){}}let Wp=class extends pu{constructor(e,s,i,n,o){super(e,s,i,n,o);bt(this,"jumping");bt(this,"jumpTime");bt(this,"gameOver",!1);bt(this,"levelEnd",-13500)}onInitialize(e){this.jumping=!1,this.body.mass=1e3,e.input.keyboard.on("press",s=>{s.key===bi.Space&&(this.body.collisionType=Sn.PreventCollision,this.jumpTime=this.scene.engine.clock.now(),this.jumping=!0,Ae.Jump.play(.5))}),this.z=10,e.events.on("gameStateChange",s=>{s.gameState===zs.GAMEOVER&&(this.gameOver=!0)}),super.onInitialize(e)}onPreUpdate(e,s){if(this.pos.y<this.levelEnd&&!this.gameOver&&e.setGameState(zs.GAMEOVER,!0),this.gameOver||(e.input.keyboard.isHeld(bi.ArrowUp)&&this.useThrottle(),e.input.keyboard.isHeld(bi.ArrowDown)&&this.useBreak(),e.input.keyboard.isHeld(bi.ArrowLeft)&&(this.jumping?this.vel.x=-150:this.steerLeft()),e.input.keyboard.isHeld(bi.ArrowRight)&&(this.jumping?this.vel.x=150:this.steerRight())),this.jumping){const i=(e.clock.now()-this.jumpTime)*4e-4*Math.PI;i>=Math.PI&&(this.body.collisionType=Sn.Active,this.jumping=!1);const n=1+Math.sin(i);this.scale=new Yt(n,n)}}handleObstacleCollision(){this.kill(),this.scene.addExplosion(this.pos,0),this.scene.engine.setGameState(zs.GAMEOVER,!1)}};class Hp extends io{constructor(e){super({x:10,y:450,z:100});bt(this,"speedLabel");this.car=e}onInitialize(e){this.graphics.use(new so({width:200,height:40,color:we.Black}));const s=new Us({text:"0",pos:new Yt(180,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Yellow,textAlign:oi.Right})});this.addChild(s),this.speedLabel=s}onPreUpdate(e,s){this.speedLabel.text=`${Math.round(this.car.vel.y*-1)} km/u`}}class qp extends io{constructor(e){super({x:10,y:10,z:100});bt(this,"scoreLabel");bt(this,"highscoreLabel");bt(this,"score",BigInt(0));bt(this,"highscore",BigInt(123456789));bt(this,"highscorePlayer","BAS");bt(this,"multiplierValue",BigInt(1));bt(this,"isPlaying",!0);this.car=e}onInitialize(e){this.graphics.use(new so({width:780,height:40,color:we.Black}));const s=new Us({text:"0",pos:new Yt(10,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Red,textAlign:oi.Left})});this.addChild(s),this.multiplier=s;const i=new Us({text:"0",pos:new Yt(770,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Yellow,textAlign:oi.Right})});this.addChild(i),this.scoreLabel=i;const n=new Us({text:"0",pos:new Yt(770,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Yellow,textAlign:oi.Right}),opacity:.25});this.addChild(n),this.highscoreLabel=n,e.events.on("gameStateChange",o=>{o.gameState===zs.GAMEOVER&&(this.isPlaying=!1)})}onPreUpdate(e,s){this.isPlaying&&(this.score+=BigInt(Math.round(this.car.vel.y*-1))*this.multiplierValue*BigInt(Math.round(s/16))),this.score>this.highscore&&(this.highscore=this.score,this.highscorePlayer="JIJ",this.highscoreLabel.opacity=1),this.scoreLabel.text=`${this.score}`,this.highscoreLabel.text=`${this.highscorePlayer} ${this.highscore}`,this.multiplier.text=`x ${this.multiplierValue}`}}class Gp extends io{constructor(){super({x:750,y:450,z:40});bt(this,"effectSymbol");bt(this,"bar")}onInitialize(e){this.rectangleGraphic=new so({width:40,height:40,color:we.Black,opacity:0}),this.graphics.use(this.rectangleGraphic);const s=new Us({text:"",pos:new Yt(10,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Yellow,textAlign:oi.Left})}),i=new Us({text:"\\",pos:new Yt(10,10),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Yellow,textAlign:oi.Left})});this.effectSymbol=s,this.bar=i,e.isEffectOn||this.showEffectsOff(),e.events.on("gameSoundChange",n=>{n.gameSound===Ui.EFFECT_ON&&this.showEffectsOn(),n.gameSound===Ui.EFFECT_OFF&&this.showEffectsOff()})}showEffectsOn(){this.rectangleGraphic.opacity=0,this.removeChild(this.effectSymbol),this.removeChild(this.bar)}showEffectsOff(){this.rectangleGraphic.opacity=1,this.addChild(this.effectSymbol),this.addChild(this.bar)}onPreUpdate(e,s){}}class Xp extends eo{constructor(t){super({pos:t,width:10,height:50,color:we.White,collisionType:Sn.PreventCollision}),this.z=-1}onInitialize(t){this.events.on("exitviewport",()=>{this.pos.y-=t.drawHeight+this.height})}}class jp extends eo{constructor(e=1e3,s){super(s);bt(this,"points");this.points=e}onInitialize(e){const s=Lp.fromImageSource({image:Ae.Explosion,grid:{rows:1,columns:11,spriteWidth:64,spriteHeight:64}}),i=Ep.fromSpriteSheet(s,Array.from({length:11},(n,o)=>o),25,Pp.End);this.endExplosion(),this.graphics.use(i),Ae.Explosion1.play(Math.random()*.5+.25)}endExplosion(){if(this.points===0)return;const e=new Us({text:`${this.points}`,pos:new Yt(0,0),font:Ae.PixelFont.toFont({unit:Ls.Px,size:20,color:we.Red})});this.addChild(e),e.actions.fade(0,1e3),e.vel.y=-200;const s=new ar({interval:1e3,repeats:!1,action:()=>{this.kill()}});this.scene.add(s)}}class Yp extends io{onInitialize(t){this.pos=new Yt(0,0),t.events.on("gameStateChange",e=>{if(e.gameState===zs.GAMEOVER){this.graphics.use(new so({width:800,height:500,color:we.Black,z:1e3,opacity:.5}));const s=new Us({text:e.levelCompleted?"LEVEL COMPLETE":"GAME OVER",pos:new Yt(400,200),font:Ae.PixelFont.toFont({unit:Ls.Px,size:40,color:we.Yellow,textAlign:oi.Center})});this.addChild(s)}})}}const _u="15.0.4",nl=(r,t,e)=>({endTime:t,insertTime:e,type:"exponentialRampToValue",value:r}),rl=(r,t,e)=>({endTime:t,insertTime:e,type:"linearRampToValue",value:r}),Ko=(r,t)=>({startTime:t,type:"setValue",value:r}),gu=(r,t,e)=>({duration:e,startTime:t,type:"setValueCurve",values:r}),mu=(r,t,{startTime:e,target:s,timeConstant:i})=>s+(t-s)*Math.exp((e-r)/i),Ai=r=>r.type==="exponentialRampToValue",Er=r=>r.type==="linearRampToValue",ks=r=>Ai(r)||Er(r),ph=r=>r.type==="setValue",_s=r=>r.type==="setValueCurve",Pr=(r,t,e,s)=>{const i=r[t];return i===void 0?s:ks(i)||ph(i)?i.value:_s(i)?i.values[i.values.length-1]:mu(e,Pr(r,t-1,i.startTime,s),i)},ol=(r,t,e,s,i)=>e===void 0?[s.insertTime,i]:ks(e)?[e.endTime,e.value]:ph(e)?[e.startTime,e.value]:_s(e)?[e.startTime+e.duration,e.values[e.values.length-1]]:[e.startTime,Pr(r,t-1,e.startTime,i)],ta=r=>r.type==="cancelAndHold",ea=r=>r.type==="cancelScheduledValues",Ds=r=>ta(r)||ea(r)?r.cancelTime:Ai(r)||Er(r)?r.endTime:r.startTime,al=(r,t,e,{endTime:s,value:i})=>e===i?i:0<e&&0<i||e<0&&i<0?e*(i/e)**((r-t)/(s-t)):0,hl=(r,t,e,{endTime:s,value:i})=>e+(r-t)/(s-t)*(i-e),$p=(r,t)=>{const e=Math.floor(t),s=Math.ceil(t);return e===s?r[e]:(1-(t-e))*r[e]+(1-(s-t))*r[s]},Zp=(r,{duration:t,startTime:e,values:s})=>{const i=(r-e)/t*(s.length-1);return $p(s,i)},er=r=>r.type==="setTarget";class Qp{constructor(t){this._automationEvents=[],this._currenTime=0,this._defaultValue=t}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(t){const e=Ds(t);if(ta(t)||ea(t)){const s=this._automationEvents.findIndex(n=>ea(t)&&_s(n)?n.startTime+n.duration>=e:Ds(n)>=e),i=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),ta(t)){const n=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&ks(i)){if(n!==void 0&&er(n))throw new Error("The internal list is malformed.");const o=n===void 0?i.insertTime:_s(n)?n.startTime+n.duration:Ds(n),a=n===void 0?this._defaultValue:_s(n)?n.values[n.values.length-1]:n.value,h=Ai(i)?al(e,o,a,i):hl(e,o,a,i),l=Ai(i)?nl(h,e,this._currenTime):rl(h,e,this._currenTime);this._automationEvents.push(l)}if(n!==void 0&&er(n)&&this._automationEvents.push(Ko(this.getValue(e),e)),n!==void 0&&_s(n)&&n.startTime+n.duration>e){const o=e-n.startTime,a=(n.values.length-1)/n.duration,h=Math.max(2,1+Math.ceil(o*a)),l=o/(h-1)*a,c=n.values.slice(0,h);if(l<1)for(let u=1;u<h;u+=1){const d=l*u%1;c[u]=n.values[u-1]*(1-d)+n.values[u]*d}this._automationEvents[this._automationEvents.length-1]=gu(c,n.startTime,o)}}}else{const s=this._automationEvents.findIndex(o=>Ds(o)>e),i=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(i!==void 0&&_s(i)&&Ds(i)+i.duration>e)return!1;const n=Ai(t)?nl(t.value,t.endTime,this._currenTime):Er(t)?rl(t.value,e,this._currenTime):t;if(s===-1)this._automationEvents.push(n);else{if(_s(t)&&e+t.duration>Ds(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,n)}}return!0}flush(t){const e=this._automationEvents.findIndex(s=>Ds(s)>t);if(e>1){const s=this._automationEvents.slice(e-1),i=s[0];er(i)&&s.unshift(Ko(Pr(this._automationEvents,e-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=s}}getValue(t){if(this._automationEvents.length===0)return this._defaultValue;const e=this._automationEvents.findIndex(o=>Ds(o)>t),s=this._automationEvents[e],i=(e===-1?this._automationEvents.length:e)-1,n=this._automationEvents[i];if(n!==void 0&&er(n)&&(s===void 0||!ks(s)||s.insertTime>t))return mu(t,Pr(this._automationEvents,i-1,n.startTime,this._defaultValue),n);if(n!==void 0&&ph(n)&&(s===void 0||!ks(s)))return n.value;if(n!==void 0&&_s(n)&&(s===void 0||!ks(s)||n.startTime+n.duration>t))return t<n.startTime+n.duration?Zp(t,n):n.values[n.values.length-1];if(n!==void 0&&ks(n)&&(s===void 0||!ks(s)))return n.value;if(s!==void 0&&Ai(s)){const[o,a]=ol(this._automationEvents,i,n,s,this._defaultValue);return al(t,o,a,s)}if(s!==void 0&&Er(s)){const[o,a]=ol(this._automationEvents,i,n,s,this._defaultValue);return hl(t,o,a,s)}return this._defaultValue}}const Jp=r=>({cancelTime:r,type:"cancelAndHold"}),Kp=r=>({cancelTime:r,type:"cancelScheduledValues"}),t_=(r,t)=>({endTime:t,type:"exponentialRampToValue",value:r}),e_=(r,t)=>({endTime:t,type:"linearRampToValue",value:r}),s_=(r,t,e)=>({startTime:t,target:r,timeConstant:e,type:"setTarget"}),i_=()=>new DOMException("","AbortError"),n_=r=>(t,e,[s,i,n],o)=>{r(t[i],[e,s,n],a=>a[0]===e&&a[1]===s,o)},r_=r=>(t,e,s)=>{const i=[];for(let n=0;n<s.numberOfInputs;n+=1)i.push(new Set);r.set(t,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:e})},o_=r=>(t,e)=>{r.set(t,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:e})},zi=new WeakSet,vu=new WeakMap,_h=new WeakMap,wu=new WeakMap,gh=new WeakMap,no=new WeakMap,xu=new WeakMap,sa=new WeakMap,ia=new WeakMap,na=new WeakMap,yu={construct(){return yu}},a_=r=>{try{const t=new Proxy(r,yu);new t}catch{return!1}return!0},ll=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,cl=(r,t)=>{const e=[];let s=r.replace(/^[\s]+/,""),i=s.match(ll);for(;i!==null;){const n=i[1].slice(1,-1),o=i[0].replace(/([\s]+)?;?$/,"").replace(n,new URL(n,t).toString());e.push(o),s=s.slice(i[0].length).replace(/^[\s]+/,""),i=s.match(ll)}return[e.join(";"),s]},ul=r=>{if(r!==void 0&&!Array.isArray(r))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},dl=r=>{if(!a_(r))throw new TypeError("The given value for processorCtor should be a constructor.");if(r.prototype===null||typeof r.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},h_=(r,t,e,s,i,n,o,a,h,l,c,u,d)=>{let f=0;return(p,_,v={credentials:"omit"})=>{const g=c.get(p);if(g!==void 0&&g.has(_))return Promise.resolve();const w=l.get(p);if(w!==void 0){const x=w.get(_);if(x!==void 0)return x}const C=n(p),b=C.audioWorklet===void 0?i(_).then(([x,A])=>{const[y,S]=cl(x,A),I=`${y};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${S}
})})(window,'_AWGS')`;return e(I)}).then(()=>{const x=d._AWGS.pop();if(x===void 0)throw new SyntaxError;s(C.currentTime,C.sampleRate,()=>x(class{},void 0,(A,y)=>{if(A.trim()==="")throw t();const S=ia.get(C);if(S!==void 0){if(S.has(A))throw t();dl(y),ul(y.parameterDescriptors),S.set(A,y)}else dl(y),ul(y.parameterDescriptors),ia.set(C,new Map([[A,y]]))},C.sampleRate,void 0,void 0))}):Promise.all([i(_),Promise.resolve(r(u,u))]).then(([[x,A],y])=>{const S=f+1;f=S;const[I,R]=cl(x,A),F=`${I};((AudioWorkletProcessor,registerProcessor)=>{${R}
})(${y?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${y?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${y?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${S}',class extends AudioWorkletProcessor{process(){return !1}})`,L=new Blob([F],{type:"application/javascript; charset=utf-8"}),O=URL.createObjectURL(L);return C.audioWorklet.addModule(O,v).then(()=>{if(a(C))return C;const P=o(C);return P.audioWorklet.addModule(O,v).then(()=>P)}).then(P=>{if(h===null)throw new SyntaxError;try{new h(P,`__sac${S}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(O))});return w===void 0?l.set(p,new Map([[_,b]])):w.set(_,b),b.then(()=>{const x=c.get(p);x===void 0?c.set(p,new Set([_])):x.add(_)}).finally(()=>{const x=l.get(p);x!==void 0&&x.delete(_)}),b}},Je=(r,t)=>{const e=r.get(t);if(e===void 0)throw new Error("A value with the given key could not be found.");return e},ro=(r,t)=>{const e=Array.from(r).filter(t);if(e.length>1)throw Error("More than one element was found.");if(e.length===0)throw Error("No element was found.");const[s]=e;return r.delete(s),s},bu=(r,t,e,s)=>{const i=Je(r,t),n=ro(i,o=>o[0]===e&&o[1]===s);return i.size===0&&r.delete(t),n},zn=r=>Je(xu,r),Vi=r=>{if(zi.has(r))throw new Error("The AudioNode is already stored.");zi.add(r),zn(r).forEach(t=>t(!0))},Cu=r=>"port"in r,Vn=r=>{if(!zi.has(r))throw new Error("The AudioNode is not stored.");zi.delete(r),zn(r).forEach(t=>t(!1))},ra=(r,t)=>{!Cu(r)&&t.every(e=>e.size===0)&&Vn(r)},l_=(r,t,e,s,i,n,o,a,h,l,c,u,d)=>{const f=new WeakMap;return(p,_,v,g,w)=>{const{activeInputs:C,passiveInputs:b}=n(_),{outputs:x}=n(p),A=a(p),y=S=>{const I=h(_),R=h(p);if(S){const D=bu(b,p,v,g);r(C,p,D,!1),!w&&!u(p)&&e(R,I,v,g),d(_)&&Vi(_)}else{const D=s(C,p,v,g);t(b,g,D,!1),!w&&!u(p)&&i(R,I,v,g);const M=o(_);if(M===0)c(_)&&ra(_,C);else{const B=f.get(_);B!==void 0&&clearTimeout(B),f.set(_,setTimeout(()=>{c(_)&&ra(_,C)},M*1e3))}}};return l(x,[_,v,g],S=>S[0]===_&&S[1]===v&&S[2]===g,!0)?(A.add(y),c(p)?r(C,p,[v,g,y],!0):t(b,g,[p,v,y],!0),!0):!1}},c_=r=>(t,e,[s,i,n],o)=>{const a=t.get(s);a===void 0?t.set(s,new Set([[i,e,n]])):r(a,[i,e,n],h=>h[0]===i&&h[1]===e,o)},u_=r=>(t,e)=>{const s=r(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});e.connect(s).connect(t.destination);const i=()=>{e.removeEventListener("ended",i),e.disconnect(s),s.disconnect()};e.addEventListener("ended",i)},d_=r=>(t,e)=>{r(t).add(e)},f_={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},p_=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=i(a),c={...f_,...h},u=s(l,c),d=n(l)?t():null;super(a,!1,u,d),this._nativeAnalyserNode=u}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(a){this._nativeAnalyserNode.fftSize=a}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(a){const h=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=a,!(a>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=h,e()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(a){const h=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=a,!(this._nativeAnalyserNode.maxDecibels>a))throw this._nativeAnalyserNode.minDecibels=h,e()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(a){this._nativeAnalyserNode.smoothingTimeConstant=a}getByteFrequencyData(a){this._nativeAnalyserNode.getByteFrequencyData(a)}getByteTimeDomainData(a){this._nativeAnalyserNode.getByteTimeDomainData(a)}getFloatFrequencyData(a){this._nativeAnalyserNode.getFloatFrequencyData(a)}getFloatTimeDomainData(a){this._nativeAnalyserNode.getFloatTimeDomainData(a)}},_e=(r,t)=>r.context===t,__=(r,t,e)=>()=>{const s=new WeakMap,i=async(n,o)=>{let a=t(n);if(!_e(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,fftSize:a.fftSize,maxDecibels:a.maxDecibels,minDecibels:a.minDecibels,smoothingTimeConstant:a.smoothingTimeConstant};a=r(o,l)}return s.set(o,a),await e(n,o,a),a};return{render(n,o){const a=s.get(o);return a!==void 0?Promise.resolve(a):i(n,o)}}},Ir=r=>{try{r.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},ds=()=>new DOMException("","IndexSizeError"),mh=r=>{r.getChannelData=(t=>e=>{try{return t.call(r,e)}catch(s){throw s.code===12?ds():s}})(r.getChannelData)},g_={numberOfChannels:1},m_=(r,t,e,s,i,n,o,a)=>{let h=null;return class Tu{constructor(c){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:u,numberOfChannels:d,sampleRate:f}={...g_,...c};h===null&&(h=new i(1,1,44100));const p=s!==null&&t(n,n)?new s({length:u,numberOfChannels:d,sampleRate:f}):h.createBuffer(d,u,f);if(p.numberOfChannels===0)throw e();return typeof p.copyFromChannel!="function"?(o(p),mh(p)):t(Ir,()=>Ir(p))||a(p),r.add(p),p}static[Symbol.hasInstance](c){return c!==null&&typeof c=="object"&&Object.getPrototypeOf(c)===Tu.prototype||r.has(c)}}},Me=-34028234663852886e22,ve=34028234663852886e22,bs=r=>zi.has(r),v_={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},w_=(r,t,e,s,i,n,o,a)=>class extends r{constructor(l,c){const u=n(l),d={...v_,...c},f=i(u,d),p=o(u),_=p?t():null;super(l,!1,f,_),this._audioBufferSourceNodeRenderer=_,this._isBufferNullified=!1,this._isBufferSet=d.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=e(this,p,f.playbackRate,ve,Me)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(l){if(this._nativeAudioBufferSourceNode.buffer=l,l!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(l){this._nativeAudioBufferSourceNode.loop=l}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(l){this._nativeAudioBufferSourceNode.loopEnd=l}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(l){this._nativeAudioBufferSourceNode.loopStart=l}get onended(){return this._onended}set onended(l){const c=typeof l=="function"?a(this,l):null;this._nativeAudioBufferSourceNode.onended=c;const u=this._nativeAudioBufferSourceNode.onended;this._onended=u!==null&&u===c?l:u}get playbackRate(){return this._playbackRate}start(l=0,c=0,u){if(this._nativeAudioBufferSourceNode.start(l,c,u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=u===void 0?[l,c]:[l,c,u]),this.context.state!=="closed"){Vi(this);const d=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",d),bs(this)&&Vn(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",d)}}stop(l=0){this._nativeAudioBufferSourceNode.stop(l),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=l)}},x_=(r,t,e,s,i)=>()=>{const n=new WeakMap;let o=null,a=null;const h=async(l,c)=>{let u=e(l);const d=_e(u,c);if(!d){const f={buffer:u.buffer,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,loop:u.loop,loopEnd:u.loopEnd,loopStart:u.loopStart,playbackRate:u.playbackRate.value};u=t(c,f),o!==null&&u.start(...o),a!==null&&u.stop(a)}return n.set(c,u),d?await r(c,l.playbackRate,u.playbackRate):await s(c,l.playbackRate,u.playbackRate),await i(l,c,u),u};return{set start(l){o=l},set stop(l){a=l},render(l,c){const u=n.get(c);return u!==void 0?Promise.resolve(u):h(l,c)}}},y_=r=>"playbackRate"in r,b_=r=>"frequency"in r&&"gain"in r,C_=r=>"offset"in r,T_=r=>!("frequency"in r)&&"gain"in r,A_=r=>"detune"in r&&"frequency"in r&&!("gain"in r),S_=r=>"pan"in r,xe=r=>Je(vu,r),Wn=r=>Je(wu,r),oa=(r,t)=>{const{activeInputs:e}=xe(r);e.forEach(i=>i.forEach(([n])=>{t.includes(r)||oa(n,[...t,r])}));const s=y_(r)?[r.playbackRate]:Cu(r)?Array.from(r.parameters.values()):b_(r)?[r.Q,r.detune,r.frequency,r.gain]:C_(r)?[r.offset]:T_(r)?[r.gain]:A_(r)?[r.detune,r.frequency]:S_(r)?[r.pan]:[];for(const i of s){const n=Wn(i);n!==void 0&&n.activeInputs.forEach(([o])=>oa(o,t))}bs(r)&&Vn(r)},Au=r=>{oa(r.destination,[])},E_=r=>r===void 0||typeof r=="number"||typeof r=="string"&&(r==="balanced"||r==="interactive"||r==="playback"),P_=(r,t,e,s,i,n,o,a,h)=>class extends r{constructor(c={}){if(h===null)throw new Error("Missing the native AudioContext constructor.");let u;try{u=new h(c)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?e():p}if(u===null)throw s();if(!E_(c.latencyHint))throw new TypeError(`The provided value '${c.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(c.sampleRate!==void 0&&u.sampleRate!==c.sampleRate)throw e();super(u,2);const{latencyHint:d}=c,{sampleRate:f}=u;if(this._baseLatency=typeof u.baseLatency=="number"?u.baseLatency:d==="balanced"?512/f:d==="interactive"||d===void 0?256/f:d==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(d*f/128)))*128/f,this._nativeAudioContext=u,h.name==="webkitAudioContext"?(this._nativeGainNode=u.createGain(),this._nativeOscillatorNode=u.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(u.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,u.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),u.removeEventListener("statechange",p)};u.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),Au(this)}))}createMediaElementSource(c){return new i(this,{mediaElement:c})}createMediaStreamDestination(){return new n(this)}createMediaStreamSource(c){return new o(this,{mediaStream:c})}createMediaStreamTrackSource(c){return new a(this,{mediaStreamTrack:c})}resume(){return this._state==="suspended"?new Promise((c,u)=>{const d=()=>{this._nativeAudioContext.removeEventListener("statechange",d),this._nativeAudioContext.state==="running"?c():this.resume().then(c,u)};this._nativeAudioContext.addEventListener("statechange",d)}):this._nativeAudioContext.resume().catch(c=>{throw c===void 0||c.code===15?t():c})}suspend(){return this._nativeAudioContext.suspend().catch(c=>{throw c===void 0?t():c})}},I_=(r,t,e,s,i,n,o,a)=>class extends r{constructor(l,c){const u=n(l),d=o(u),f=i(u,c,d),p=d?t(a):null;super(l,!1,f,p),this._isNodeOfNativeOfflineAudioContext=d,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(l){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(l>this._nativeAudioDestinationNode.maxChannelCount)throw e();this._nativeAudioDestinationNode.channelCount=l}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(l){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=l}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},M_=r=>{const t=new WeakMap,e=async(s,i)=>{const n=i.destination;return t.set(i,n),await r(s,i,n),n};return{render(s,i){const n=t.get(i);return n!==void 0?Promise.resolve(n):e(s,i)}}},R_=(r,t,e,s,i,n,o,a)=>(h,l)=>{const c=l.listener,u=()=>{const x=new Float32Array(1),A=t(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),y=o(l);let S=!1,I=[0,0,-1,0,1,0],R=[0,0,0];const D=()=>{if(S)return;S=!0;const L=s(l,256,9,0);L.onaudioprocess=({inputBuffer:O})=>{const P=[n(O,x,0),n(O,x,1),n(O,x,2),n(O,x,3),n(O,x,4),n(O,x,5)];P.some((W,q)=>W!==I[q])&&(c.setOrientation(...P),I=P);const Y=[n(O,x,6),n(O,x,7),n(O,x,8)];Y.some((W,q)=>W!==R[q])&&(c.setPosition(...Y),R=Y)},A.connect(L)},M=L=>O=>{O!==I[L]&&(I[L]=O,c.setOrientation(...I))},B=L=>O=>{O!==R[L]&&(R[L]=O,c.setPosition(...R))},F=(L,O,P)=>{const Y=e(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:O});Y.connect(A,0,L),Y.start(),Object.defineProperty(Y.offset,"defaultValue",{get(){return O}});const W=r({context:h},y,Y.offset,ve,Me);return a(W,"value",q=>()=>q.call(W),q=>G=>{try{q.call(W,G)}catch(nt){if(nt.code!==9)throw nt}D(),y&&P(G)}),W.cancelAndHoldAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.cancelAndHoldAtTime),W.cancelScheduledValues=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.cancelScheduledValues),W.exponentialRampToValueAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.exponentialRampToValueAtTime),W.linearRampToValueAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.linearRampToValueAtTime),W.setTargetAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.setTargetAtTime),W.setValueAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.setValueAtTime),W.setValueCurveAtTime=(q=>y?()=>{throw i()}:(...G)=>{const nt=q.apply(W,G);return D(),nt})(W.setValueCurveAtTime),W};return{forwardX:F(0,0,M(0)),forwardY:F(1,0,M(1)),forwardZ:F(2,-1,M(2)),positionX:F(6,0,B(0)),positionY:F(7,0,B(1)),positionZ:F(8,0,B(2)),upX:F(3,0,M(3)),upY:F(4,1,M(4)),upZ:F(5,0,M(5))}},{forwardX:d,forwardY:f,forwardZ:p,positionX:_,positionY:v,positionZ:g,upX:w,upY:C,upZ:b}=c.forwardX===void 0?u():c;return{get forwardX(){return d},get forwardY(){return f},get forwardZ(){return p},get positionX(){return _},get positionY(){return v},get positionZ(){return g},get upX(){return w},get upY(){return C},get upZ(){return b}}},Mr=r=>"context"in r,Hn=r=>Mr(r[0]),mi=(r,t,e,s)=>{for(const i of r)if(e(i)){if(s)return!1;throw Error("The set contains at least one similar element.")}return r.add(t),!0},fl=(r,t,[e,s],i)=>{mi(r,[t,e,s],n=>n[0]===t&&n[1]===e,i)},pl=(r,[t,e,s],i)=>{const n=r.get(t);n===void 0?r.set(t,new Set([[e,s]])):mi(n,[e,s],o=>o[0]===e,i)},en=r=>"inputs"in r,Rr=(r,t,e,s)=>{if(en(t)){const i=t.inputs[s];return r.connect(i,e,0),[i,e,0]}return r.connect(t,e,s),[t,e,s]},Su=(r,t,e)=>{for(const s of r)if(s[0]===t&&s[1]===e)return r.delete(s),s;return null},D_=(r,t,e)=>ro(r,s=>s[0]===t&&s[1]===e),Eu=(r,t)=>{if(!zn(r).delete(t))throw new Error("Missing the expected event listener.")},Pu=(r,t,e)=>{const s=Je(r,t),i=ro(s,n=>n[0]===e);return s.size===0&&r.delete(t),i},Dr=(r,t,e,s)=>{en(t)?r.disconnect(t.inputs[s],e,0):r.disconnect(t,e,s)},xt=r=>Je(_h,r),En=r=>Je(gh,r),pi=r=>sa.has(r),lr=r=>!zi.has(r),_l=(r,t)=>new Promise(e=>{if(t!==null)e(!0);else{const s=r.createScriptProcessor(256,1,1),i=r.createGain(),n=r.createBuffer(1,2,44100),o=n.getChannelData(0);o[0]=1,o[1]=1;const a=r.createBufferSource();a.buffer=n,a.loop=!0,a.connect(s).connect(r.destination),a.connect(i),a.disconnect(i),s.onaudioprocess=h=>{const l=h.inputBuffer.getChannelData(0);Array.prototype.some.call(l,c=>c===1)?e(!0):e(!1),a.stop(),s.onaudioprocess=null,a.disconnect(s),s.disconnect(r.destination)},a.start()}}),Mo=(r,t)=>{const e=new Map;for(const s of r)for(const i of s){const n=e.get(i);e.set(i,n===void 0?1:n+1)}e.forEach((s,i)=>t(i,s))},kr=r=>"context"in r,k_=r=>{const t=new Map;r.connect=(e=>(s,i=0,n=0)=>{const o=kr(s)?e(s,i,n):e(s,i),a=t.get(s);return a===void 0?t.set(s,[{input:n,output:i}]):a.every(h=>h.input!==n||h.output!==i)&&a.push({input:n,output:i}),o})(r.connect.bind(r)),r.disconnect=(e=>(s,i,n)=>{if(e.apply(r),s===void 0)t.clear();else if(typeof s=="number")for(const[o,a]of t){const h=a.filter(l=>l.output!==s);h.length===0?t.delete(o):t.set(o,h)}else if(t.has(s))if(i===void 0)t.delete(s);else{const o=t.get(s);if(o!==void 0){const a=o.filter(h=>h.output!==i&&(h.input!==n||n===void 0));a.length===0?t.delete(s):t.set(s,a)}}for(const[o,a]of t)a.forEach(h=>{kr(o)?r.connect(o,h.output,h.input):r.connect(o,h.output)})})(r.disconnect)},F_=(r,t,e,s)=>{const{activeInputs:i,passiveInputs:n}=Wn(t),{outputs:o}=xe(r),a=zn(r),h=l=>{const c=xt(r),u=En(t);if(l){const d=Pu(n,r,e);fl(i,r,d,!1),!s&&!pi(r)&&c.connect(u,e)}else{const d=D_(i,r,e);pl(n,d,!1),!s&&!pi(r)&&c.disconnect(u,e)}};return mi(o,[t,e],l=>l[0]===t&&l[1]===e,!0)?(a.add(h),bs(r)?fl(i,r,[e,h],!0):pl(n,[r,e,h],!0),!0):!1},B_=(r,t,e,s)=>{const{activeInputs:i,passiveInputs:n}=xe(t),o=Su(i[s],r,e);return o===null?[bu(n,r,e,s)[2],!1]:[o[2],!0]},O_=(r,t,e)=>{const{activeInputs:s,passiveInputs:i}=Wn(t),n=Su(s,r,e);return n===null?[Pu(i,r,e)[1],!1]:[n[2],!0]},vh=(r,t,e,s,i)=>{const[n,o]=B_(r,e,s,i);if(n!==null&&(Eu(r,n),o&&!t&&!pi(r)&&Dr(xt(r),xt(e),s,i)),bs(e)){const{activeInputs:a}=xe(e);ra(e,a)}},wh=(r,t,e,s)=>{const[i,n]=O_(r,e,s);i!==null&&(Eu(r,i),n&&!t&&!pi(r)&&xt(r).disconnect(En(e),s))},N_=(r,t)=>{const e=xe(r),s=[];for(const i of e.outputs)Hn(i)?vh(r,t,...i):wh(r,t,...i),s.push(i[0]);return e.outputs.clear(),s},L_=(r,t,e)=>{const s=xe(r),i=[];for(const n of s.outputs)n[1]===e&&(Hn(n)?vh(r,t,...n):wh(r,t,...n),i.push(n[0]),s.outputs.delete(n));return i},U_=(r,t,e,s,i)=>{const n=xe(r);return Array.from(n.outputs).filter(o=>o[0]===e&&(s===void 0||o[1]===s)&&(i===void 0||o[2]===i)).map(o=>(Hn(o)?vh(r,t,...o):wh(r,t,...o),n.outputs.delete(o),o[0]))},z_=(r,t,e,s,i,n,o,a,h,l,c,u,d,f,p,_)=>class extends l{constructor(g,w,C,b){super(C),this._context=g,this._nativeAudioNode=C;const x=c(g);u(x)&&e(_l,()=>_l(x,_))!==!0&&k_(C),_h.set(this,C),xu.set(this,new Set),g.state!=="closed"&&w&&Vi(this),r(this,b,C)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(g){this._nativeAudioNode.channelCount=g}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(g){this._nativeAudioNode.channelCountMode=g}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(g){this._nativeAudioNode.channelInterpretation=g}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(g,w=0,C=0){if(w<0||w>=this._nativeAudioNode.numberOfOutputs)throw i();const b=c(this._context),x=p(b);if(d(g)||f(g))throw n();if(Mr(g)){const S=xt(g);try{const R=Rr(this._nativeAudioNode,S,w,C),D=lr(this);(x||D)&&this._nativeAudioNode.disconnect(...R),this.context.state!=="closed"&&!D&&lr(g)&&Vi(g)}catch(R){throw R.code===12?n():R}if(t(this,g,w,C,x)){const R=h([this],g);Mo(R,s(x))}return g}const A=En(g);if(A.name==="playbackRate"&&A.maxValue===1024)throw o();try{this._nativeAudioNode.connect(A,w),(x||lr(this))&&this._nativeAudioNode.disconnect(A,w)}catch(S){throw S.code===12?n():S}if(F_(this,g,w,x)){const S=h([this],g);Mo(S,s(x))}}disconnect(g,w,C){let b;const x=c(this._context),A=p(x);if(g===void 0)b=N_(this,A);else if(typeof g=="number"){if(g<0||g>=this.numberOfOutputs)throw i();b=L_(this,A,g)}else{if(w!==void 0&&(w<0||w>=this.numberOfOutputs)||Mr(g)&&C!==void 0&&(C<0||C>=g.numberOfInputs))throw i();if(b=U_(this,A,g,w,C),b.length===0)throw n()}for(const y of b){const S=h([this],y);Mo(S,a)}}},V_=(r,t,e,s,i,n,o,a,h,l,c,u,d)=>(f,p,_,v=null,g=null)=>{const w=_.value,C=new Qp(w),b=p?s(C):null,x={get defaultValue(){return w},get maxValue(){return v===null?_.maxValue:v},get minValue(){return g===null?_.minValue:g},get value(){return _.value},set value(A){_.value=A,x.setValueAtTime(A,f.context.currentTime)},cancelAndHoldAtTime(A){if(typeof _.cancelAndHoldAtTime=="function")b===null&&C.flush(f.context.currentTime),C.add(i(A)),_.cancelAndHoldAtTime(A);else{const y=Array.from(C).pop();b===null&&C.flush(f.context.currentTime),C.add(i(A));const S=Array.from(C).pop();_.cancelScheduledValues(A),y!==S&&S!==void 0&&(S.type==="exponentialRampToValue"?_.exponentialRampToValueAtTime(S.value,S.endTime):S.type==="linearRampToValue"?_.linearRampToValueAtTime(S.value,S.endTime):S.type==="setValue"?_.setValueAtTime(S.value,S.startTime):S.type==="setValueCurve"&&_.setValueCurveAtTime(S.values,S.startTime,S.duration))}return x},cancelScheduledValues(A){return b===null&&C.flush(f.context.currentTime),C.add(n(A)),_.cancelScheduledValues(A),x},exponentialRampToValueAtTime(A,y){if(A===0)throw new RangeError;if(!Number.isFinite(y)||y<0)throw new RangeError;const S=f.context.currentTime;return b===null&&C.flush(S),Array.from(C).length===0&&(C.add(l(w,S)),_.setValueAtTime(w,S)),C.add(o(A,y)),_.exponentialRampToValueAtTime(A,y),x},linearRampToValueAtTime(A,y){const S=f.context.currentTime;return b===null&&C.flush(S),Array.from(C).length===0&&(C.add(l(w,S)),_.setValueAtTime(w,S)),C.add(a(A,y)),_.linearRampToValueAtTime(A,y),x},setTargetAtTime(A,y,S){return b===null&&C.flush(f.context.currentTime),C.add(h(A,y,S)),_.setTargetAtTime(A,y,S),x},setValueAtTime(A,y){return b===null&&C.flush(f.context.currentTime),C.add(l(A,y)),_.setValueAtTime(A,y),x},setValueCurveAtTime(A,y,S){const I=A instanceof Float32Array?A:new Float32Array(A);if(u!==null&&u.name==="webkitAudioContext"){const R=y+S,D=f.context.sampleRate,M=Math.ceil(y*D),B=Math.floor(R*D),F=B-M,L=new Float32Array(F);for(let P=0;P<F;P+=1){const Y=(I.length-1)/S*((M+P)/D-y),W=Math.floor(Y),q=Math.ceil(Y);L[P]=W===q?I[W]:(1-(Y-W))*I[W]+(1-(q-Y))*I[q]}b===null&&C.flush(f.context.currentTime),C.add(c(L,y,S)),_.setValueCurveAtTime(L,y,S);const O=B/D;O<R&&d(x,L[L.length-1],O),d(x,I[I.length-1],R)}else b===null&&C.flush(f.context.currentTime),C.add(c(I,y,S)),_.setValueCurveAtTime(I,y,S);return x}};return e.set(x,_),t.set(x,f),r(x,b),x},W_=r=>({replay(t){for(const e of r)if(e.type==="exponentialRampToValue"){const{endTime:s,value:i}=e;t.exponentialRampToValueAtTime(i,s)}else if(e.type==="linearRampToValue"){const{endTime:s,value:i}=e;t.linearRampToValueAtTime(i,s)}else if(e.type==="setTarget"){const{startTime:s,target:i,timeConstant:n}=e;t.setTargetAtTime(i,s,n)}else if(e.type==="setValue"){const{startTime:s,value:i}=e;t.setValueAtTime(i,s)}else if(e.type==="setValueCurve"){const{duration:s,startTime:i,values:n}=e;t.setValueCurveAtTime(n,i,s)}else throw new Error("Can't apply an unknown automation.")}});class Iu{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,e=null){return this._map.forEach((s,i)=>t.call(e,s,i,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const H_={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},q_=(r,t,e,s,i,n,o,a,h,l,c,u,d,f)=>class extends t{constructor(_,v,g){var w;const C=a(_),b=h(C),x=c({...H_,...g});d(x);const A=ia.get(C),y=A==null?void 0:A.get(v),S=b||C.state!=="closed"?C:(w=o(C))!==null&&w!==void 0?w:C,I=i(S,b?null:_.baseLatency,l,v,y,x),R=b?s(v,x,y):null;super(_,!0,I,R);const D=[];I.parameters.forEach((B,F)=>{const L=e(this,b,B);D.push([F,L])}),this._nativeAudioWorkletNode=I,this._onprocessorerror=null,this._parameters=new Iu(D),b&&r(C,this);const{activeInputs:M}=n(this);u(I,M)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(_){const v=typeof _=="function"?f(this,_):null;this._nativeAudioWorkletNode.onprocessorerror=v;const g=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=g!==null&&g===v?_:g}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function Fr(r,t,e,s,i){if(typeof r.copyFromChannel=="function")t[e].byteLength===0&&(t[e]=new Float32Array(128)),r.copyFromChannel(t[e],s,i);else{const n=r.getChannelData(s);if(t[e].byteLength===0)t[e]=n.slice(i,i+128);else{const o=new Float32Array(n.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);t[e].set(o)}}}const Mu=(r,t,e,s,i)=>{typeof r.copyToChannel=="function"?t[e].byteLength!==0&&r.copyToChannel(t[e],s,i):t[e].byteLength!==0&&r.getChannelData(s).set(t[e],i)},Br=(r,t)=>{const e=[];for(let s=0;s<r;s+=1){const i=[],n=typeof t=="number"?t:t[s];for(let o=0;o<n;o+=1)i.push(new Float32Array(128));e.push(i)}return e},G_=(r,t)=>{const e=Je(na,r),s=xt(t);return Je(e,s)},X_=async(r,t,e,s,i,n,o)=>{const a=t===null?Math.ceil(r.context.length/128)*128:t.length,h=s.channelCount*s.numberOfInputs,l=i.reduce((v,g)=>v+g,0),c=l===0?null:e.createBuffer(l,a,e.sampleRate);if(n===void 0)throw new Error("Missing the processor constructor.");const u=xe(r),d=await G_(e,r),f=Br(s.numberOfInputs,s.channelCount),p=Br(s.numberOfOutputs,i),_=Array.from(r.parameters.keys()).reduce((v,g)=>({...v,[g]:new Float32Array(128)}),{});for(let v=0;v<a;v+=128){if(s.numberOfInputs>0&&t!==null)for(let g=0;g<s.numberOfInputs;g+=1)for(let w=0;w<s.channelCount;w+=1)Fr(t,f[g],w,w,v);n.parameterDescriptors!==void 0&&t!==null&&n.parameterDescriptors.forEach(({name:g},w)=>{Fr(t,_,g,h+w,v)});for(let g=0;g<s.numberOfInputs;g+=1)for(let w=0;w<i[g];w+=1)p[g][w].byteLength===0&&(p[g][w]=new Float32Array(128));try{const g=f.map((C,b)=>u.activeInputs[b].size===0?[]:C),w=o(v/e.sampleRate,e.sampleRate,()=>d.process(g,p,_));if(c!==null)for(let C=0,b=0;C<s.numberOfOutputs;C+=1){for(let x=0;x<i[C];x+=1)Mu(c,p[C],x,b+x,v);b+=i[C]}if(!w)break}catch(g){r.dispatchEvent(new ErrorEvent("processorerror",{colno:g.colno,filename:g.filename,lineno:g.lineno,message:g.message}));break}}return c},j_=(r,t,e,s,i,n,o,a,h,l,c,u,d,f,p,_)=>(v,g,w)=>{const C=new WeakMap;let b=null;const x=async(A,y)=>{let S=c(A),I=null;const R=_e(S,y),D=Array.isArray(g.outputChannelCount)?g.outputChannelCount:Array.from(g.outputChannelCount);if(u===null){const M=D.reduce((O,P)=>O+P,0),B=i(y,{channelCount:Math.max(1,M),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,M)}),F=[];for(let O=0;O<A.numberOfOutputs;O+=1)F.push(s(y,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:D[O]}));const L=o(y,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1});L.connect=t.bind(null,F),L.disconnect=h.bind(null,F),I=[B,F,L]}else R||(S=new u(y,v));if(C.set(y,I===null?S:I[2]),I!==null){if(b===null){if(w===void 0)throw new Error("Missing the processor constructor.");if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const P=A.channelCount*A.numberOfInputs,Y=w.parameterDescriptors===void 0?0:w.parameterDescriptors.length,W=P+Y;b=X_(A,W===0?null:await(async()=>{const G=new d(W,Math.ceil(A.context.length/128)*128,y.sampleRate),nt=[],he=[];for(let pt=0;pt<g.numberOfInputs;pt+=1)nt.push(o(G,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1})),he.push(i(G,{channelCount:g.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:g.channelCount}));const le=await Promise.all(Array.from(A.parameters.values()).map(async pt=>{const ie=n(G,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:pt.value});return await f(G,pt,ie.offset),ie})),K=s(G,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,P+Y)});for(let pt=0;pt<g.numberOfInputs;pt+=1){nt[pt].connect(he[pt]);for(let ie=0;ie<g.channelCount;ie+=1)he[pt].connect(K,ie,pt*g.channelCount+ie)}for(const[pt,ie]of le.entries())ie.connect(K,0,P+pt),ie.start(0);return K.connect(G.destination),await Promise.all(nt.map(pt=>p(A,G,pt))),_(G)})(),y,g,D,w,l)}const M=await b,B=e(y,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[F,L,O]=I;M!==null&&(B.buffer=M,B.start(0)),B.connect(F);for(let P=0,Y=0;P<A.numberOfOutputs;P+=1){const W=L[P];for(let q=0;q<D[P];q+=1)F.connect(W,Y+q,q);Y+=D[P]}return O}if(R)for(const[M,B]of A.parameters.entries())await r(y,B,S.parameters.get(M));else for(const[M,B]of A.parameters.entries())await f(y,B,S.parameters.get(M));return await p(A,y,S),S};return{render(A,y){a(y,A);const S=C.get(y);return S!==void 0?Promise.resolve(S):x(A,y)}}},Y_=(r,t,e,s,i,n,o,a,h,l,c,u,d,f,p,_,v,g,w,C)=>class extends p{constructor(x,A){super(x,A),this._nativeContext=x,this._audioWorklet=r===void 0?void 0:{addModule:(y,S)=>r(this,y,S)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new i(this)}createBuffer(x,A,y){return new e({length:A,numberOfChannels:x,sampleRate:y})}createBufferSource(){return new s(this)}createChannelMerger(x=6){return new n(this,{numberOfInputs:x})}createChannelSplitter(x=6){return new o(this,{numberOfOutputs:x})}createConstantSource(){return new a(this)}createConvolver(){return new h(this)}createDelay(x=1){return new c(this,{maxDelayTime:x})}createDynamicsCompressor(){return new u(this)}createGain(){return new d(this)}createIIRFilter(x,A){return new f(this,{feedback:A,feedforward:x})}createOscillator(){return new _(this)}createPanner(){return new v(this)}createPeriodicWave(x,A,y={disableNormalization:!1}){return new g(this,{...y,imag:A,real:x})}createStereoPanner(){return new w(this)}createWaveShaper(){return new C(this)}decodeAudioData(x,A,y){return l(this._nativeContext,x).then(S=>(typeof A=="function"&&A(S),S),S=>{throw typeof y=="function"&&y(S),S})}},$_={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Z_=(r,t,e,s,i,n,o,a)=>class extends r{constructor(l,c){const u=n(l),d={...$_,...c},f=i(u,d),p=o(u),_=p?e():null;super(l,!1,f,_),this._Q=t(this,p,f.Q,ve,Me),this._detune=t(this,p,f.detune,1200*Math.log2(ve),-1200*Math.log2(ve)),this._frequency=t(this,p,f.frequency,l.sampleRate/2,0),this._gain=t(this,p,f.gain,40*Math.log10(ve),Me),this._nativeBiquadFilterNode=f,a(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(l){this._nativeBiquadFilterNode.type=l}getFrequencyResponse(l,c,u){try{this._nativeBiquadFilterNode.getFrequencyResponse(l,c,u)}catch(d){throw d.code===11?s():d}if(l.length!==c.length||c.length!==u.length)throw s()}},Q_=(r,t,e,s,i)=>()=>{const n=new WeakMap,o=async(a,h)=>{let l=e(a);const c=_e(l,h);if(!c){const u={Q:l.Q.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,detune:l.detune.value,frequency:l.frequency.value,gain:l.gain.value,type:l.type};l=t(h,u)}return n.set(h,l),c?(await r(h,a.Q,l.Q),await r(h,a.detune,l.detune),await r(h,a.frequency,l.frequency),await r(h,a.gain,l.gain)):(await s(h,a.Q,l.Q),await s(h,a.detune,l.detune),await s(h,a.frequency,l.frequency),await s(h,a.gain,l.gain)),await i(a,h,l),l};return{render(a,h){const l=n.get(h);return l!==void 0?Promise.resolve(l):o(a,h)}}},J_=(r,t)=>(e,s)=>{const i=t.get(e);if(i!==void 0)return i;const n=r.get(e);if(n!==void 0)return n;try{const o=s();return o instanceof Promise?(r.set(e,o),o.catch(()=>!1).then(a=>(r.delete(e),t.set(e,a),a))):(t.set(e,o),o)}catch{return t.set(e,!1),!1}},K_={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},tg=(r,t,e,s,i)=>class extends r{constructor(o,a){const h=s(o),l={...K_,...a},c=e(h,l),u=i(h)?t():null;super(o,!1,c,u)}},eg=(r,t,e)=>()=>{const s=new WeakMap,i=async(n,o)=>{let a=t(n);if(!_e(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfInputs:a.numberOfInputs};a=r(o,l)}return s.set(o,a),await e(n,o,a),a};return{render(n,o){const a=s.get(o);return a!==void 0?Promise.resolve(a):i(n,o)}}},sg={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},ig=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=s(a),c=n({...sg,...h}),u=e(l,c),d=i(l)?t():null;super(a,!1,u,d)}},ng=(r,t,e)=>()=>{const s=new WeakMap,i=async(n,o)=>{let a=t(n);if(!_e(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfOutputs:a.numberOfOutputs};a=r(o,l)}return s.set(o,a),await e(n,o,a),a};return{render(n,o){const a=s.get(o);return a!==void 0?Promise.resolve(a):i(n,o)}}},rg=r=>(t,e,s)=>r(e,t,s),og=r=>(t,e,s=0,i=0)=>{const n=t[s];if(n===void 0)throw r();return kr(e)?n.connect(e,0,i):n.connect(e,0)},ag=r=>(t,e)=>{const s=r(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=t.createBuffer(1,2,44100);return s.buffer=i,s.loop=!0,s.connect(e),s.start(),()=>{s.stop(),s.disconnect(e)}},hg={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},lg=(r,t,e,s,i,n,o)=>class extends r{constructor(h,l){const c=i(h),u={...hg,...l},d=s(c,u),f=n(c),p=f?e():null;super(h,!1,d,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=d,this._offset=t(this,f,d.offset,ve,Me),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(h){const l=typeof h=="function"?o(this,h):null;this._nativeConstantSourceNode.onended=l;const c=this._nativeConstantSourceNode.onended;this._onended=c!==null&&c===l?h:c}start(h=0){if(this._nativeConstantSourceNode.start(h),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=h),this.context.state!=="closed"){Vi(this);const l=()=>{this._nativeConstantSourceNode.removeEventListener("ended",l),bs(this)&&Vn(this)};this._nativeConstantSourceNode.addEventListener("ended",l)}}stop(h=0){this._nativeConstantSourceNode.stop(h),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=h)}},cg=(r,t,e,s,i)=>()=>{const n=new WeakMap;let o=null,a=null;const h=async(l,c)=>{let u=e(l);const d=_e(u,c);if(!d){const f={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,offset:u.offset.value};u=t(c,f),o!==null&&u.start(o),a!==null&&u.stop(a)}return n.set(c,u),d?await r(c,l.offset,u.offset):await s(c,l.offset,u.offset),await i(l,c,u),u};return{set start(l){o=l},set stop(l){a=l},render(l,c){const u=n.get(c);return u!==void 0?Promise.resolve(u):h(l,c)}}},ug=r=>t=>(r[0]=t,r[0]),dg={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},fg=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=s(a),c={...dg,...h},u=e(l,c),f=i(l)?t():null;super(a,!1,u,f),this._isBufferNullified=!1,this._nativeConvolverNode=u,c.buffer!==null&&n(this,c.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(a){if(this._nativeConvolverNode.buffer=a,a===null&&this._nativeConvolverNode.buffer!==null){const h=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=h.createBuffer(1,1,h.sampleRate),this._isBufferNullified=!0,n(this,0)}else this._isBufferNullified=!1,n(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(a){this._nativeConvolverNode.normalize=a}},pg=(r,t,e)=>()=>{const s=new WeakMap,i=async(n,o)=>{let a=t(n);if(!_e(a,o)){const l={buffer:a.buffer,channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,disableNormalization:!a.normalize};a=r(o,l)}return s.set(o,a),en(a)?await e(n,o,a.inputs[0]):await e(n,o,a),a};return{render(n,o){const a=s.get(o);return a!==void 0?Promise.resolve(a):i(n,o)}}},_g=(r,t)=>(e,s,i)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(e,s,i)}catch(n){throw n.name==="SyntaxError"?r():n}},gg=()=>new DOMException("","DataCloneError"),gl=r=>{const{port1:t,port2:e}=new MessageChannel;return new Promise(s=>{const i=()=>{e.onmessage=null,t.close(),e.close(),s()};e.onmessage=()=>i();try{t.postMessage(r,[r])}catch{}finally{i()}})},mg=(r,t,e,s,i,n,o,a,h,l,c)=>(u,d)=>{const f=o(u)?u:n(u);if(i.has(d)){const p=e();return Promise.reject(p)}try{i.add(d)}catch{}return t(h,()=>h(f))?f.decodeAudioData(d).then(p=>(gl(d).catch(()=>{}),t(a,()=>a(p))||c(p),r.add(p),p)):new Promise((p,_)=>{const v=async()=>{try{await gl(d)}catch{}},g=w=>{_(w),v()};try{f.decodeAudioData(d,w=>{typeof w.copyFromChannel!="function"&&(l(w),mh(w)),r.add(w),v().then(()=>p(w))},w=>{g(w===null?s():w)})}catch(w){g(w)}})},vg=(r,t,e,s,i,n,o,a)=>(h,l)=>{const c=t.get(h);if(c===void 0)throw new Error("Missing the expected cycle count.");const u=n(h.context),d=a(u);if(c===l){if(t.delete(h),!d&&o(h)){const f=s(h),{outputs:p}=e(h);for(const _ of p)if(Hn(_)){const v=s(_[0]);r(f,v,_[1],_[2])}else{const v=i(_[0]);f.connect(v,_[1])}}}else t.set(h,c-l)},wg={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},xg=(r,t,e,s,i,n,o)=>class extends r{constructor(h,l){const c=i(h),u={...wg,...l},d=s(c,u),f=n(c),p=f?e(u.maxDelayTime):null;super(h,!1,d,p),this._delayTime=t(this,f,d.delayTime),o(this,u.maxDelayTime)}get delayTime(){return this._delayTime}},yg=(r,t,e,s,i)=>n=>{const o=new WeakMap,a=async(h,l)=>{let c=e(h);const u=_e(c,l);if(!u){const d={channelCount:c.channelCount,channelCountMode:c.channelCountMode,channelInterpretation:c.channelInterpretation,delayTime:c.delayTime.value,maxDelayTime:n};c=t(l,d)}return o.set(l,c),u?await r(l,h.delayTime,c.delayTime):await s(l,h.delayTime,c.delayTime),await i(h,l,c),c};return{render(h,l){const c=o.get(l);return c!==void 0?Promise.resolve(c):a(h,l)}}},bg=r=>(t,e,s,i)=>r(t[i],n=>n[0]===e&&n[1]===s),Cg=r=>(t,e)=>{r(t).delete(e)},Tg=r=>"delayTime"in r,Ag=(r,t,e)=>function s(i,n){const o=Mr(n)?n:e(r,n);if(Tg(o))return[];if(i[0]===o)return[i];if(i.includes(o))return[];const{outputs:a}=t(o);return Array.from(a).map(h=>s([...i,o],h[0])).reduce((h,l)=>h.concat(l),[])},sr=(r,t,e)=>{const s=t[e];if(s===void 0)throw r();return s},Sg=r=>(t,e=void 0,s=void 0,i=0)=>e===void 0?t.forEach(n=>n.disconnect()):typeof e=="number"?sr(r,t,e).disconnect():kr(e)?s===void 0?t.forEach(n=>n.disconnect(e)):i===void 0?sr(r,t,s).disconnect(e,0):sr(r,t,s).disconnect(e,0,i):s===void 0?t.forEach(n=>n.disconnect(e)):sr(r,t,s).disconnect(e,0),Eg={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Pg=(r,t,e,s,i,n,o,a)=>class extends r{constructor(l,c){const u=n(l),d={...Eg,...c},f=s(u,d),p=o(u),_=p?e():null;super(l,!1,f,_),this._attack=t(this,p,f.attack),this._knee=t(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=t(this,p,f.ratio),this._release=t(this,p,f.release),this._threshold=t(this,p,f.threshold),a(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(l){const c=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=l,l>2)throw this._nativeDynamicsCompressorNode.channelCount=c,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(l){const c=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=l,l==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=c,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},Ig=(r,t,e,s,i)=>()=>{const n=new WeakMap,o=async(a,h)=>{let l=e(a);const c=_e(l,h);if(!c){const u={attack:l.attack.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,knee:l.knee.value,ratio:l.ratio.value,release:l.release.value,threshold:l.threshold.value};l=t(h,u)}return n.set(h,l),c?(await r(h,a.attack,l.attack),await r(h,a.knee,l.knee),await r(h,a.ratio,l.ratio),await r(h,a.release,l.release),await r(h,a.threshold,l.threshold)):(await s(h,a.attack,l.attack),await s(h,a.knee,l.knee),await s(h,a.ratio,l.ratio),await s(h,a.release,l.release),await s(h,a.threshold,l.threshold)),await i(a,h,l),l};return{render(a,h){const l=n.get(h);return l!==void 0?Promise.resolve(l):o(a,h)}}},Mg=()=>new DOMException("","EncodingError"),Rg=r=>t=>new Promise((e,s)=>{if(r===null){s(new SyntaxError);return}const i=r.document.head;if(i===null)s(new SyntaxError);else{const n=r.document.createElement("script"),o=new Blob([t],{type:"application/javascript"}),a=URL.createObjectURL(o),h=r.onerror,l=()=>{r.onerror=h,URL.revokeObjectURL(a)};r.onerror=(c,u,d,f,p)=>{if(u===a||u===r.location.href&&d===1&&f===1)return l(),s(p),!1;if(h!==null)return h(c,u,d,f,p)},n.onerror=()=>{l(),s(new SyntaxError)},n.onload=()=>{l(),e()},n.src=a,n.type="module",i.appendChild(n)}}),Dg=r=>class{constructor(e){this._nativeEventTarget=e,this._listeners=new WeakMap}addEventListener(e,s,i){if(s!==null){let n=this._listeners.get(s);n===void 0&&(n=r(this,s),typeof s=="function"&&this._listeners.set(s,n)),this._nativeEventTarget.addEventListener(e,n,i)}}dispatchEvent(e){return this._nativeEventTarget.dispatchEvent(e)}removeEventListener(e,s,i){const n=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(e,n===void 0?null:n,i)}},kg=r=>(t,e,s)=>{Object.defineProperties(r,{currentFrame:{configurable:!0,get(){return Math.round(t*e)}},currentTime:{configurable:!0,get(){return t}}});try{return s()}finally{r!==null&&(delete r.currentFrame,delete r.currentTime)}},Fg=r=>async t=>{try{const e=await fetch(t);if(e.ok)return[await e.text(),e.url]}catch{}throw r()},Bg={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Og=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=i(a),c={...Bg,...h},u=s(l,c),d=n(l),f=d?e():null;super(a,!1,u,f),this._gain=t(this,d,u.gain,ve,Me)}get gain(){return this._gain}},Ng=(r,t,e,s,i)=>()=>{const n=new WeakMap,o=async(a,h)=>{let l=e(a);const c=_e(l,h);if(!c){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,gain:l.gain.value};l=t(h,u)}return n.set(h,l),c?await r(h,a.gain,l.gain):await s(h,a.gain,l.gain),await i(a,h,l),l};return{render(a,h){const l=n.get(h);return l!==void 0?Promise.resolve(l):o(a,h)}}},Lg=(r,t)=>e=>t(r,e),Ug=r=>t=>{const e=r(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return e.renderer},zg=r=>t=>{var e;return(e=r.get(t))!==null&&e!==void 0?e:0},Vg=r=>t=>{const e=r(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return e.renderer},Wg=r=>t=>r.get(t),ee=()=>new DOMException("","InvalidStateError"),Hg=r=>t=>{const e=r.get(t);if(e===void 0)throw ee();return e},qg=(r,t)=>e=>{let s=r.get(e);if(s!==void 0)return s;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new t(1,1,44100),r.set(e,s),s},Gg=r=>t=>{const e=r.get(t);if(e===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return e},oo=()=>new DOMException("","InvalidAccessError"),Xg=r=>{r.getFrequencyResponse=(t=>(e,s,i)=>{if(e.length!==s.length||s.length!==i.length)throw oo();return t.call(r,e,s,i)})(r.getFrequencyResponse)},jg={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Yg=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=s(a),c=i(l),u={...jg,...h},d=t(l,c?null:a.baseLatency,u),f=c?e(u.feedback,u.feedforward):null;super(a,!1,d,f),Xg(d),this._nativeIIRFilterNode=d,n(this,1)}getFrequencyResponse(a,h,l){return this._nativeIIRFilterNode.getFrequencyResponse(a,h,l)}},Ru=(r,t,e,s,i,n,o,a,h,l,c)=>{const u=l.length;let d=a;for(let f=0;f<u;f+=1){let p=e[0]*l[f];for(let _=1;_<i;_+=1){const v=d-_&h-1;p+=e[_]*n[v],p-=r[_]*o[v]}for(let _=i;_<s;_+=1)p+=e[_]*n[d-_&h-1];for(let _=i;_<t;_+=1)p-=r[_]*o[d-_&h-1];n[d]=l[f],o[d]=p,d=d+1&h-1,c[f]=p}return d},$g=(r,t,e,s)=>{const i=e instanceof Float64Array?e:new Float64Array(e),n=s instanceof Float64Array?s:new Float64Array(s),o=i.length,a=n.length,h=Math.min(o,a);if(i[0]!==1){for(let p=0;p<o;p+=1)n[p]/=i[0];for(let p=1;p<a;p+=1)i[p]/=i[0]}const l=32,c=new Float32Array(l),u=new Float32Array(l),d=t.createBuffer(r.numberOfChannels,r.length,r.sampleRate),f=r.numberOfChannels;for(let p=0;p<f;p+=1){const _=r.getChannelData(p),v=d.getChannelData(p);c.fill(0),u.fill(0),Ru(i,o,n,a,h,c,u,0,l,_,v)}return d},Zg=(r,t,e,s,i)=>(n,o)=>{const a=new WeakMap;let h=null;const l=async(c,u)=>{let d=null,f=t(c);const p=_e(f,u);if(u.createIIRFilter===void 0?d=r(u,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=u.createIIRFilter(o,n)),a.set(u,d===null?f:d),d!==null){if(h===null){if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");const v=new e(c.context.destination.channelCount,c.context.length,u.sampleRate);h=(async()=>{await s(c,v,v.destination);const g=await i(v);return $g(g,u,n,o)})()}const _=await h;return d.buffer=_,d.start(0),d}return await s(c,u,f),f};return{render(c,u){const d=a.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},Qg=(r,t,e,s,i,n)=>o=>(a,h)=>{const l=r.get(a);if(l===void 0){if(!o&&n(a)){const c=s(a),{outputs:u}=e(a);for(const d of u)if(Hn(d)){const f=s(d[0]);t(c,f,d[1],d[2])}else{const f=i(d[0]);c.disconnect(f,d[1])}}r.set(a,h)}else r.set(a,l+h)},Jg=(r,t)=>e=>{const s=r.get(e);return t(s)||t(e)},Kg=(r,t)=>e=>r.has(e)||t(e),tm=(r,t)=>e=>r.has(e)||t(e),em=(r,t)=>e=>{const s=r.get(e);return t(s)||t(e)},sm=r=>t=>r!==null&&t instanceof r,im=r=>t=>r!==null&&typeof r.AudioNode=="function"&&t instanceof r.AudioNode,nm=r=>t=>r!==null&&typeof r.AudioParam=="function"&&t instanceof r.AudioParam,rm=(r,t)=>e=>r(e)||t(e),om=r=>t=>r!==null&&t instanceof r,am=r=>r!==null&&r.isSecureContext,hm=(r,t,e,s)=>class extends r{constructor(n,o){const a=e(n),h=t(a,o);if(s(a))throw TypeError();super(n,!0,h,null),this._nativeMediaElementAudioSourceNode=h}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},lm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},cm=(r,t,e,s)=>class extends r{constructor(n,o){const a=e(n);if(s(a))throw new TypeError;const h={...lm,...o},l=t(a,h);super(n,!1,l,null),this._nativeMediaStreamAudioDestinationNode=l}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},um=(r,t,e,s)=>class extends r{constructor(n,o){const a=e(n),h=t(a,o);if(s(a))throw new TypeError;super(n,!0,h,null),this._nativeMediaStreamAudioSourceNode=h}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},dm=(r,t,e)=>class extends r{constructor(i,n){const o=e(i),a=t(o,n);super(i,!0,a,null)}},fm=(r,t,e,s,i,n)=>class extends e{constructor(a,h){super(a),this._nativeContext=a,no.set(this,a),s(a)&&i.set(a,new Set),this._destination=new r(this,h),this._listener=t(this,a),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(a){const h=typeof a=="function"?n(this,a):null;this._nativeContext.onstatechange=h;const l=this._nativeContext.onstatechange;this._onstatechange=l!==null&&l===h?a:l}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},Pn=r=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const e=r.decodeAudioData(t.buffer,()=>{});return e===void 0?!1:(e.catch(()=>{}),!0)}catch{}return!1},pm=(r,t)=>(e,s,i)=>{const n=new Set;return e.connect=(o=>(a,h=0,l=0)=>{const c=n.size===0;if(t(a))return o.call(e,a,h,l),r(n,[a,h,l],u=>u[0]===a&&u[1]===h&&u[2]===l,!0),c&&s(),a;o.call(e,a,h),r(n,[a,h],u=>u[0]===a&&u[1]===h,!0),c&&s()})(e.connect),e.disconnect=(o=>(a,h,l)=>{const c=n.size>0;if(a===void 0)o.apply(e),n.clear();else if(typeof a=="number"){o.call(e,a);for(const d of n)d[1]===a&&n.delete(d)}else{t(a)?o.call(e,a,h,l):o.call(e,a,h);for(const d of n)d[0]===a&&(h===void 0||d[1]===h)&&(l===void 0||d[2]===l)&&n.delete(d)}const u=n.size===0;c&&u&&i()})(e.disconnect),e},Ct=(r,t,e)=>{const s=t[e];s!==void 0&&s!==r[e]&&(r[e]=s)},Qt=(r,t)=>{Ct(r,t,"channelCount"),Ct(r,t,"channelCountMode"),Ct(r,t,"channelInterpretation")},ml=r=>typeof r.getFloatTimeDomainData=="function",_m=r=>{r.getFloatTimeDomainData=t=>{const e=new Uint8Array(t.length);r.getByteTimeDomainData(e);const s=Math.max(e.length,r.fftSize);for(let i=0;i<s;i+=1)t[i]=(e[i]-128)*.0078125;return t}},gm=(r,t)=>(e,s)=>{const i=e.createAnalyser();if(Qt(i,s),!(s.maxDecibels>s.minDecibels))throw t();return Ct(i,s,"fftSize"),Ct(i,s,"maxDecibels"),Ct(i,s,"minDecibels"),Ct(i,s,"smoothingTimeConstant"),r(ml,()=>ml(i))||_m(i),i},mm=r=>r===null?null:r.hasOwnProperty("AudioBuffer")?r.AudioBuffer:null,Dt=(r,t,e)=>{const s=t[e];s!==void 0&&s!==r[e].value&&(r[e].value=s)},vm=r=>{r.start=(t=>{let e=!1;return(s=0,i=0,n)=>{if(e)throw ee();t.call(r,s,i,n),e=!0}})(r.start)},xh=r=>{r.start=(t=>(e=0,s=0,i)=>{if(typeof i=="number"&&i<0||s<0||e<0)throw new RangeError("The parameters can't be negative.");t.call(r,e,s,i)})(r.start)},yh=r=>{r.stop=(t=>(e=0)=>{if(e<0)throw new RangeError("The parameter can't be negative.");t.call(r,e)})(r.stop)},wm=(r,t,e,s,i,n,o,a,h,l,c)=>(u,d)=>{const f=u.createBufferSource();return Qt(f,d),Dt(f,d,"playbackRate"),Ct(f,d,"buffer"),Ct(f,d,"loop"),Ct(f,d,"loopEnd"),Ct(f,d,"loopStart"),t(e,()=>e(u))||vm(f),t(s,()=>s(u))||h(f),t(i,()=>i(u))||l(f,u),t(n,()=>n(u))||xh(f),t(o,()=>o(u))||c(f,u),t(a,()=>a(u))||yh(f),r(u,f),f},xm=r=>r===null?null:r.hasOwnProperty("AudioContext")?r.AudioContext:r.hasOwnProperty("webkitAudioContext")?r.webkitAudioContext:null,ym=(r,t)=>(e,s,i)=>{const n=e.destination;if(n.channelCount!==s)try{n.channelCount=s}catch{}i&&n.channelCountMode!=="explicit"&&(n.channelCountMode="explicit"),n.maxChannelCount===0&&Object.defineProperty(n,"maxChannelCount",{value:s});const o=r(e,{channelCount:s,channelCountMode:n.channelCountMode,channelInterpretation:n.channelInterpretation,gain:1});return t(o,"channelCount",a=>()=>a.call(o),a=>h=>{a.call(o,h);try{n.channelCount=h}catch(l){if(h>n.maxChannelCount)throw l}}),t(o,"channelCountMode",a=>()=>a.call(o),a=>h=>{a.call(o,h),n.channelCountMode=h}),t(o,"channelInterpretation",a=>()=>a.call(o),a=>h=>{a.call(o,h),n.channelInterpretation=h}),Object.defineProperty(o,"maxChannelCount",{get:()=>n.maxChannelCount}),o.connect(n),o},bm=r=>r===null?null:r.hasOwnProperty("AudioWorkletNode")?r.AudioWorkletNode:null,Cm=r=>{const{port1:t}=new MessageChannel;try{t.postMessage(r)}finally{t.close()}},Tm=(r,t,e,s,i)=>(n,o,a,h,l,c)=>{if(a!==null)try{const u=new a(n,h,c),d=new Map;let f=null;if(Object.defineProperties(u,{channelCount:{get:()=>c.channelCount,set:()=>{throw r()}},channelCountMode:{get:()=>"explicit",set:()=>{throw r()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&u.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&u.addEventListener("processorerror",f)}}}),u.addEventListener=(p=>(..._)=>{if(_[0]==="processorerror"){const v=typeof _[1]=="function"?_[1]:typeof _[1]=="object"&&_[1]!==null&&typeof _[1].handleEvent=="function"?_[1].handleEvent:null;if(v!==null){const g=d.get(_[1]);g!==void 0?_[1]=g:(_[1]=w=>{w.type==="error"?(Object.defineProperties(w,{type:{value:"processorerror"}}),v(w)):v(new ErrorEvent(_[0],{...w}))},d.set(v,_[1]))}}return p.call(u,"error",_[1],_[2]),p.call(u,..._)})(u.addEventListener),u.removeEventListener=(p=>(..._)=>{if(_[0]==="processorerror"){const v=d.get(_[1]);v!==void 0&&(d.delete(_[1]),_[1]=v)}return p.call(u,"error",_[1],_[2]),p.call(u,_[0],_[1],_[2])})(u.removeEventListener),c.numberOfOutputs!==0){const p=e(n,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return u.connect(p).connect(n.destination),i(u,()=>p.disconnect(),()=>p.connect(n.destination))}return u}catch(u){throw u.code===11?s():u}if(l===void 0)throw s();return Cm(c),t(n,o,l,c)},Du=(r,t)=>r===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(r*t))))),Am=r=>new Promise((t,e)=>{const{port1:s,port2:i}=new MessageChannel;s.onmessage=({data:n})=>{s.close(),i.close(),t(n)},s.onmessageerror=({data:n})=>{s.close(),i.close(),e(n)},i.postMessage(r)}),Sm=async(r,t)=>{const e=await Am(t);return new r(e)},Em=(r,t,e,s)=>{let i=na.get(r);i===void 0&&(i=new WeakMap,na.set(r,i));const n=Sm(e,s);return i.set(t,n),n},Pm=(r,t,e,s,i,n,o,a,h,l,c,u,d)=>(f,p,_,v)=>{if(v.numberOfInputs===0&&v.numberOfOutputs===0)throw h();const g=Array.isArray(v.outputChannelCount)?v.outputChannelCount:Array.from(v.outputChannelCount);if(g.some(U=>U<1))throw h();if(g.length!==v.numberOfOutputs)throw t();if(v.channelCountMode!=="explicit")throw h();const w=v.channelCount*v.numberOfInputs,C=g.reduce((U,j)=>U+j,0),b=_.parameterDescriptors===void 0?0:_.parameterDescriptors.length;if(w+b>6||C>6)throw h();const x=new MessageChannel,A=[],y=[];for(let U=0;U<v.numberOfInputs;U+=1)A.push(o(f,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1})),y.push(i(f,{channelCount:v.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:v.channelCount}));const S=[];if(_.parameterDescriptors!==void 0)for(const{defaultValue:U,maxValue:j,minValue:Gt,name:Tt}of _.parameterDescriptors){const rt=n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:v.parameterData[Tt]!==void 0?v.parameterData[Tt]:U===void 0?0:U});Object.defineProperties(rt.offset,{defaultValue:{get:()=>U===void 0?0:U},maxValue:{get:()=>j===void 0?ve:j},minValue:{get:()=>Gt===void 0?Me:Gt}}),S.push(rt)}const I=s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,w+b)}),R=Du(p,f.sampleRate),D=a(f,R,w+b,Math.max(1,C)),M=i(f,{channelCount:Math.max(1,C),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,C)}),B=[];for(let U=0;U<v.numberOfOutputs;U+=1)B.push(s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:g[U]}));for(let U=0;U<v.numberOfInputs;U+=1){A[U].connect(y[U]);for(let j=0;j<v.channelCount;j+=1)y[U].connect(I,j,U*v.channelCount+j)}const F=new Iu(_.parameterDescriptors===void 0?[]:_.parameterDescriptors.map(({name:U},j)=>{const Gt=S[j];return Gt.connect(I,0,w+j),Gt.start(0),[U,Gt.offset]}));I.connect(D);let L=v.channelInterpretation,O=null;const P=v.numberOfOutputs===0?[D]:B,Y={get bufferSize(){return R},get channelCount(){return v.channelCount},set channelCount(U){throw e()},get channelCountMode(){return v.channelCountMode},set channelCountMode(U){throw e()},get channelInterpretation(){return L},set channelInterpretation(U){for(const j of A)j.channelInterpretation=U;L=U},get context(){return D.context},get inputs(){return A},get numberOfInputs(){return v.numberOfInputs},get numberOfOutputs(){return v.numberOfOutputs},get onprocessorerror(){return O},set onprocessorerror(U){typeof O=="function"&&Y.removeEventListener("processorerror",O),O=typeof U=="function"?U:null,typeof O=="function"&&Y.addEventListener("processorerror",O)},get parameters(){return F},get port(){return x.port2},addEventListener(...U){return D.addEventListener(U[0],U[1],U[2])},connect:r.bind(null,P),disconnect:l.bind(null,P),dispatchEvent(...U){return D.dispatchEvent(U[0])},removeEventListener(...U){return D.removeEventListener(U[0],U[1],U[2])}},W=new Map;x.port1.addEventListener=(U=>(...j)=>{if(j[0]==="message"){const Gt=typeof j[1]=="function"?j[1]:typeof j[1]=="object"&&j[1]!==null&&typeof j[1].handleEvent=="function"?j[1].handleEvent:null;if(Gt!==null){const Tt=W.get(j[1]);Tt!==void 0?j[1]=Tt:(j[1]=rt=>{c(f.currentTime,f.sampleRate,()=>Gt(rt))},W.set(Gt,j[1]))}}return U.call(x.port1,j[0],j[1],j[2])})(x.port1.addEventListener),x.port1.removeEventListener=(U=>(...j)=>{if(j[0]==="message"){const Gt=W.get(j[1]);Gt!==void 0&&(W.delete(j[1]),j[1]=Gt)}return U.call(x.port1,j[0],j[1],j[2])})(x.port1.removeEventListener);let q=null;Object.defineProperty(x.port1,"onmessage",{get:()=>q,set:U=>{typeof q=="function"&&x.port1.removeEventListener("message",q),q=typeof U=="function"?U:null,typeof q=="function"&&(x.port1.addEventListener("message",q),x.port1.start())}}),_.prototype.port=x.port1;let G=null;Em(f,Y,_,v).then(U=>G=U);const he=Br(v.numberOfInputs,v.channelCount),le=Br(v.numberOfOutputs,g),K=_.parameterDescriptors===void 0?[]:_.parameterDescriptors.reduce((U,{name:j})=>({...U,[j]:new Float32Array(128)}),{});let pt=!0;const ie=()=>{v.numberOfOutputs>0&&D.disconnect(M);for(let U=0,j=0;U<v.numberOfOutputs;U+=1){const Gt=B[U];for(let Tt=0;Tt<g[U];Tt+=1)M.disconnect(Gt,j+Tt,Tt);j+=g[U]}},H=new Map;D.onaudioprocess=({inputBuffer:U,outputBuffer:j})=>{if(G!==null){const Gt=u(Y);for(let Tt=0;Tt<R;Tt+=128){for(let rt=0;rt<v.numberOfInputs;rt+=1)for(let Mt=0;Mt<v.channelCount;Mt+=1)Fr(U,he[rt],Mt,Mt,Tt);_.parameterDescriptors!==void 0&&_.parameterDescriptors.forEach(({name:rt},Mt)=>{Fr(U,K,rt,w+Mt,Tt)});for(let rt=0;rt<v.numberOfInputs;rt+=1)for(let Mt=0;Mt<g[rt];Mt+=1)le[rt][Mt].byteLength===0&&(le[rt][Mt]=new Float32Array(128));try{const rt=he.map((Be,Rs)=>{if(Gt[Rs].size>0)return H.set(Rs,R/128),Be;const To=H.get(Rs);return To===void 0?[]:(Be.every(Cd=>Cd.every(Td=>Td===0))&&(To===1?H.delete(Rs):H.set(Rs,To-1)),Be)});pt=c(f.currentTime+Tt/f.sampleRate,f.sampleRate,()=>G.process(rt,le,K));for(let Be=0,Rs=0;Be<v.numberOfOutputs;Be+=1){for(let ln=0;ln<g[Be];ln+=1)Mu(j,le[Be],ln,Rs+ln,Tt);Rs+=g[Be]}}catch(rt){pt=!1,Y.dispatchEvent(new ErrorEvent("processorerror",{colno:rt.colno,filename:rt.filename,lineno:rt.lineno,message:rt.message}))}if(!pt){for(let rt=0;rt<v.numberOfInputs;rt+=1){A[rt].disconnect(y[rt]);for(let Mt=0;Mt<v.channelCount;Mt+=1)y[Tt].disconnect(I,Mt,rt*v.channelCount+Mt)}if(_.parameterDescriptors!==void 0){const rt=_.parameterDescriptors.length;for(let Mt=0;Mt<rt;Mt+=1){const Be=S[Mt];Be.disconnect(I,0,w+Mt),Be.stop()}}I.disconnect(D),D.onaudioprocess=null,Qs?ie():yi();break}}}};let Qs=!1;const Js=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),xi=()=>D.connect(Js).connect(f.destination),yi=()=>{D.disconnect(Js),Js.disconnect()},yd=()=>{if(pt){yi(),v.numberOfOutputs>0&&D.connect(M);for(let U=0,j=0;U<v.numberOfOutputs;U+=1){const Gt=B[U];for(let Tt=0;Tt<g[U];Tt+=1)M.connect(Gt,j+Tt,Tt);j+=g[U]}}Qs=!0},bd=()=>{pt&&(xi(),ie()),Qs=!1};return xi(),d(Y,yd,bd)},ku=(r,t)=>{const e=r.createBiquadFilter();return Qt(e,t),Dt(e,t,"Q"),Dt(e,t,"detune"),Dt(e,t,"frequency"),Dt(e,t,"gain"),Ct(e,t,"type"),e},Im=(r,t)=>(e,s)=>{const i=e.createChannelMerger(s.numberOfInputs);return r!==null&&r.name==="webkitAudioContext"&&t(e,i),Qt(i,s),i},Mm=r=>{const t=r.numberOfOutputs;Object.defineProperty(r,"channelCount",{get:()=>t,set:e=>{if(e!==t)throw ee()}}),Object.defineProperty(r,"channelCountMode",{get:()=>"explicit",set:e=>{if(e!=="explicit")throw ee()}}),Object.defineProperty(r,"channelInterpretation",{get:()=>"discrete",set:e=>{if(e!=="discrete")throw ee()}})},qn=(r,t)=>{const e=r.createChannelSplitter(t.numberOfOutputs);return Qt(e,t),Mm(e),e},Rm=(r,t,e,s,i)=>(n,o)=>{if(n.createConstantSource===void 0)return e(n,o);const a=n.createConstantSource();return Qt(a,o),Dt(a,o,"offset"),t(s,()=>s(n))||xh(a),t(i,()=>i(n))||yh(a),r(n,a),a},sn=(r,t)=>(r.connect=t.connect.bind(t),r.disconnect=t.disconnect.bind(t),r),Dm=(r,t,e,s)=>(i,{offset:n,...o})=>{const a=i.createBuffer(1,2,44100),h=t(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),l=e(i,{...o,gain:n}),c=a.getChannelData(0);c[0]=1,c[1]=1,h.buffer=a,h.loop=!0;const u={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(p){l.channelCount=p},get channelCountMode(){return l.channelCountMode},set channelCountMode(p){l.channelCountMode=p},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(p){l.channelInterpretation=p},get context(){return l.context},get inputs(){return[]},get numberOfInputs(){return h.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get offset(){return l.gain},get onended(){return h.onended},set onended(p){h.onended=p},addEventListener(...p){return h.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return h.dispatchEvent(p[0])},removeEventListener(...p){return h.removeEventListener(p[0],p[1],p[2])},start(p=0){h.start.call(h,p)},stop(p=0){h.stop.call(h,p)}},d=()=>h.connect(l),f=()=>h.disconnect(l);return r(i,h),s(sn(u,l),d,f)},km=(r,t)=>(e,s)=>{const i=e.createConvolver();if(Qt(i,s),s.disableNormalization===i.normalize&&(i.normalize=!s.disableNormalization),Ct(i,s,"buffer"),s.channelCount>2||(t(i,"channelCount",n=>()=>n.call(i),n=>o=>{if(o>2)throw r();return n.call(i,o)}),s.channelCountMode==="max"))throw r();return t(i,"channelCountMode",n=>()=>n.call(i),n=>o=>{if(o==="max")throw r();return n.call(i,o)}),i},Fu=(r,t)=>{const e=r.createDelay(t.maxDelayTime);return Qt(e,t),Dt(e,t,"delayTime"),e},Fm=r=>(t,e)=>{const s=t.createDynamicsCompressor();if(Qt(s,e),e.channelCount>2||e.channelCountMode==="max")throw r();return Dt(s,e,"attack"),Dt(s,e,"knee"),Dt(s,e,"ratio"),Dt(s,e,"release"),Dt(s,e,"threshold"),s},Pe=(r,t)=>{const e=r.createGain();return Qt(e,t),Dt(e,t,"gain"),e},Bm=r=>(t,e,s)=>{if(t.createIIRFilter===void 0)return r(t,e,s);const i=t.createIIRFilter(s.feedforward,s.feedback);return Qt(i,s),i};function Om(r,t){const e=t[0]*t[0]+t[1]*t[1];return[(r[0]*t[0]+r[1]*t[1])/e,(r[1]*t[0]-r[0]*t[1])/e]}function Nm(r,t){return[r[0]*t[0]-r[1]*t[1],r[0]*t[1]+r[1]*t[0]]}function vl(r,t){let e=[0,0];for(let s=r.length-1;s>=0;s-=1)e=Nm(e,t),e[0]+=r[s];return e}const Lm=(r,t,e,s)=>(i,n,{channelCount:o,channelCountMode:a,channelInterpretation:h,feedback:l,feedforward:c})=>{const u=Du(n,i.sampleRate),d=l instanceof Float64Array?l:new Float64Array(l),f=c instanceof Float64Array?c:new Float64Array(c),p=d.length,_=f.length,v=Math.min(p,_);if(p===0||p>20)throw s();if(d[0]===0)throw t();if(_===0||_>20)throw s();if(f[0]===0)throw t();if(d[0]!==1){for(let S=0;S<_;S+=1)f[S]/=d[0];for(let S=1;S<p;S+=1)d[S]/=d[0]}const g=e(i,u,o,o);g.channelCount=o,g.channelCountMode=a,g.channelInterpretation=h;const w=32,C=[],b=[],x=[];for(let S=0;S<o;S+=1){C.push(0);const I=new Float32Array(w),R=new Float32Array(w);I.fill(0),R.fill(0),b.push(I),x.push(R)}g.onaudioprocess=S=>{const I=S.inputBuffer,R=S.outputBuffer,D=I.numberOfChannels;for(let M=0;M<D;M+=1){const B=I.getChannelData(M),F=R.getChannelData(M);C[M]=Ru(d,p,f,_,v,b[M],x[M],C[M],w,B,F)}};const A=i.sampleRate/2;return sn({get bufferSize(){return u},get channelCount(){return g.channelCount},set channelCount(S){g.channelCount=S},get channelCountMode(){return g.channelCountMode},set channelCountMode(S){g.channelCountMode=S},get channelInterpretation(){return g.channelInterpretation},set channelInterpretation(S){g.channelInterpretation=S},get context(){return g.context},get inputs(){return[g]},get numberOfInputs(){return g.numberOfInputs},get numberOfOutputs(){return g.numberOfOutputs},addEventListener(...S){return g.addEventListener(S[0],S[1],S[2])},dispatchEvent(...S){return g.dispatchEvent(S[0])},getFrequencyResponse(S,I,R){if(S.length!==I.length||I.length!==R.length)throw r();const D=S.length;for(let M=0;M<D;M+=1){const B=-Math.PI*(S[M]/A),F=[Math.cos(B),Math.sin(B)],L=vl(f,F),O=vl(d,F),P=Om(L,O);I[M]=Math.sqrt(P[0]*P[0]+P[1]*P[1]),R[M]=Math.atan2(P[1],P[0])}},removeEventListener(...S){return g.removeEventListener(S[0],S[1],S[2])}},g)},Um=(r,t)=>r.createMediaElementSource(t.mediaElement),zm=(r,t)=>{const e=r.createMediaStreamDestination();return Qt(e,t),e.numberOfOutputs===1&&Object.defineProperty(e,"numberOfOutputs",{get:()=>0}),e},Vm=(r,{mediaStream:t})=>{const e=t.getAudioTracks();e.sort((n,o)=>n.id<o.id?-1:n.id>o.id?1:0);const s=e.slice(0,1),i=r.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(i,"mediaStream",{value:t}),i},Wm=(r,t)=>(e,{mediaStreamTrack:s})=>{if(typeof e.createMediaStreamTrackSource=="function")return e.createMediaStreamTrackSource(s);const i=new MediaStream([s]),n=e.createMediaStreamSource(i);if(s.kind!=="audio")throw r();if(t(e))throw new TypeError;return n},Hm=r=>r===null?null:r.hasOwnProperty("OfflineAudioContext")?r.OfflineAudioContext:r.hasOwnProperty("webkitOfflineAudioContext")?r.webkitOfflineAudioContext:null,qm=(r,t,e,s,i,n)=>(o,a)=>{const h=o.createOscillator();return Qt(h,a),Dt(h,a,"detune"),Dt(h,a,"frequency"),a.periodicWave!==void 0?h.setPeriodicWave(a.periodicWave):Ct(h,a,"type"),t(e,()=>e(o))||xh(h),t(s,()=>s(o))||n(h,o),t(i,()=>i(o))||yh(h),r(o,h),h},Gm=r=>(t,e)=>{const s=t.createPanner();return s.orientationX===void 0?r(t,e):(Qt(s,e),Dt(s,e,"orientationX"),Dt(s,e,"orientationY"),Dt(s,e,"orientationZ"),Dt(s,e,"positionX"),Dt(s,e,"positionY"),Dt(s,e,"positionZ"),Ct(s,e,"coneInnerAngle"),Ct(s,e,"coneOuterAngle"),Ct(s,e,"coneOuterGain"),Ct(s,e,"distanceModel"),Ct(s,e,"maxDistance"),Ct(s,e,"panningModel"),Ct(s,e,"refDistance"),Ct(s,e,"rolloffFactor"),s)},Xm=(r,t,e,s,i,n,o,a,h,l)=>(c,{coneInnerAngle:u,coneOuterAngle:d,coneOuterGain:f,distanceModel:p,maxDistance:_,orientationX:v,orientationY:g,orientationZ:w,panningModel:C,positionX:b,positionY:x,positionZ:A,refDistance:y,rolloffFactor:S,...I})=>{const R=c.createPanner();if(I.channelCount>2||I.channelCountMode==="max")throw o();Qt(R,I);const D={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M=e(c,{...D,channelInterpretation:"speakers",numberOfInputs:6}),B=s(c,{...I,gain:1}),F=s(c,{...D,gain:1}),L=s(c,{...D,gain:0}),O=s(c,{...D,gain:0}),P=s(c,{...D,gain:0}),Y=s(c,{...D,gain:0}),W=s(c,{...D,gain:0}),q=i(c,256,6,1),G=n(c,{...D,curve:new Float32Array([1,1]),oversample:"none"});let nt=[v,g,w],he=[b,x,A];const le=new Float32Array(1);q.onaudioprocess=({inputBuffer:H})=>{const Qs=[h(H,le,0),h(H,le,1),h(H,le,2)];Qs.some((xi,yi)=>xi!==nt[yi])&&(R.setOrientation(...Qs),nt=Qs);const Js=[h(H,le,3),h(H,le,4),h(H,le,5)];Js.some((xi,yi)=>xi!==he[yi])&&(R.setPosition(...Js),he=Js)},Object.defineProperty(L.gain,"defaultValue",{get:()=>0}),Object.defineProperty(O.gain,"defaultValue",{get:()=>0}),Object.defineProperty(P.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Y.gain,"defaultValue",{get:()=>0}),Object.defineProperty(W.gain,"defaultValue",{get:()=>0});const K={get bufferSize(){},get channelCount(){return R.channelCount},set channelCount(H){if(H>2)throw o();B.channelCount=H,R.channelCount=H},get channelCountMode(){return R.channelCountMode},set channelCountMode(H){if(H==="max")throw o();B.channelCountMode=H,R.channelCountMode=H},get channelInterpretation(){return R.channelInterpretation},set channelInterpretation(H){B.channelInterpretation=H,R.channelInterpretation=H},get coneInnerAngle(){return R.coneInnerAngle},set coneInnerAngle(H){R.coneInnerAngle=H},get coneOuterAngle(){return R.coneOuterAngle},set coneOuterAngle(H){R.coneOuterAngle=H},get coneOuterGain(){return R.coneOuterGain},set coneOuterGain(H){if(H<0||H>1)throw t();R.coneOuterGain=H},get context(){return R.context},get distanceModel(){return R.distanceModel},set distanceModel(H){R.distanceModel=H},get inputs(){return[B]},get maxDistance(){return R.maxDistance},set maxDistance(H){if(H<0)throw new RangeError;R.maxDistance=H},get numberOfInputs(){return R.numberOfInputs},get numberOfOutputs(){return R.numberOfOutputs},get orientationX(){return F.gain},get orientationY(){return L.gain},get orientationZ(){return O.gain},get panningModel(){return R.panningModel},set panningModel(H){R.panningModel=H},get positionX(){return P.gain},get positionY(){return Y.gain},get positionZ(){return W.gain},get refDistance(){return R.refDistance},set refDistance(H){if(H<0)throw new RangeError;R.refDistance=H},get rolloffFactor(){return R.rolloffFactor},set rolloffFactor(H){if(H<0)throw new RangeError;R.rolloffFactor=H},addEventListener(...H){return B.addEventListener(H[0],H[1],H[2])},dispatchEvent(...H){return B.dispatchEvent(H[0])},removeEventListener(...H){return B.removeEventListener(H[0],H[1],H[2])}};u!==K.coneInnerAngle&&(K.coneInnerAngle=u),d!==K.coneOuterAngle&&(K.coneOuterAngle=d),f!==K.coneOuterGain&&(K.coneOuterGain=f),p!==K.distanceModel&&(K.distanceModel=p),_!==K.maxDistance&&(K.maxDistance=_),v!==K.orientationX.value&&(K.orientationX.value=v),g!==K.orientationY.value&&(K.orientationY.value=g),w!==K.orientationZ.value&&(K.orientationZ.value=w),C!==K.panningModel&&(K.panningModel=C),b!==K.positionX.value&&(K.positionX.value=b),x!==K.positionY.value&&(K.positionY.value=x),A!==K.positionZ.value&&(K.positionZ.value=A),y!==K.refDistance&&(K.refDistance=y),S!==K.rolloffFactor&&(K.rolloffFactor=S),(nt[0]!==1||nt[1]!==0||nt[2]!==0)&&R.setOrientation(...nt),(he[0]!==0||he[1]!==0||he[2]!==0)&&R.setPosition(...he);const pt=()=>{B.connect(R),r(B,G,0,0),G.connect(F).connect(M,0,0),G.connect(L).connect(M,0,1),G.connect(O).connect(M,0,2),G.connect(P).connect(M,0,3),G.connect(Y).connect(M,0,4),G.connect(W).connect(M,0,5),M.connect(q).connect(c.destination)},ie=()=>{B.disconnect(R),a(B,G,0,0),G.disconnect(F),F.disconnect(M),G.disconnect(L),L.disconnect(M),G.disconnect(O),O.disconnect(M),G.disconnect(P),P.disconnect(M),G.disconnect(Y),Y.disconnect(M),G.disconnect(W),W.disconnect(M),M.disconnect(q),q.disconnect(c.destination)};return l(sn(K,R),pt,ie)},jm=r=>(t,{disableNormalization:e,imag:s,real:i})=>{const n=s instanceof Float32Array?s:new Float32Array(s),o=i instanceof Float32Array?i:new Float32Array(i),a=t.createPeriodicWave(o,n,{disableNormalization:e});if(Array.from(s).length<2)throw r();return a},Gn=(r,t,e,s)=>r.createScriptProcessor(t,e,s),Ym=(r,t)=>(e,s)=>{const i=s.channelCountMode;if(i==="clamped-max")throw t();if(e.createStereoPanner===void 0)return r(e,s);const n=e.createStereoPanner();return Qt(n,s),Dt(n,s,"pan"),Object.defineProperty(n,"channelCountMode",{get:()=>i,set:o=>{if(o!==i)throw t()}}),n},$m=(r,t,e,s,i,n)=>{const a=new Float32Array([1,1]),h=Math.PI/2,l={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},c={...l,oversample:"none"},u=(p,_,v,g)=>{const w=new Float32Array(16385),C=new Float32Array(16385);for(let I=0;I<16385;I+=1){const R=I/16384*h;w[I]=Math.cos(R),C[I]=Math.sin(R)}const b=e(p,{...l,gain:0}),x=s(p,{...c,curve:w}),A=s(p,{...c,curve:a}),y=e(p,{...l,gain:0}),S=s(p,{...c,curve:C});return{connectGraph(){_.connect(b),_.connect(A.inputs===void 0?A:A.inputs[0]),_.connect(y),A.connect(v),v.connect(x.inputs===void 0?x:x.inputs[0]),v.connect(S.inputs===void 0?S:S.inputs[0]),x.connect(b.gain),S.connect(y.gain),b.connect(g,0,0),y.connect(g,0,1)},disconnectGraph(){_.disconnect(b),_.disconnect(A.inputs===void 0?A:A.inputs[0]),_.disconnect(y),A.disconnect(v),v.disconnect(x.inputs===void 0?x:x.inputs[0]),v.disconnect(S.inputs===void 0?S:S.inputs[0]),x.disconnect(b.gain),S.disconnect(y.gain),b.disconnect(g,0,0),y.disconnect(g,0,1)}}},d=(p,_,v,g)=>{const w=new Float32Array(16385),C=new Float32Array(16385),b=new Float32Array(16385),x=new Float32Array(16385),A=Math.floor(16385/2);for(let P=0;P<16385;P+=1)if(P>A){const Y=(P-A)/(16384-A)*h;w[P]=Math.cos(Y),C[P]=Math.sin(Y),b[P]=0,x[P]=1}else{const Y=P/(16384-A)*h;w[P]=1,C[P]=0,b[P]=Math.cos(Y),x[P]=Math.sin(Y)}const y=t(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),S=e(p,{...l,gain:0}),I=s(p,{...c,curve:w}),R=e(p,{...l,gain:0}),D=s(p,{...c,curve:C}),M=s(p,{...c,curve:a}),B=e(p,{...l,gain:0}),F=s(p,{...c,curve:b}),L=e(p,{...l,gain:0}),O=s(p,{...c,curve:x});return{connectGraph(){_.connect(y),_.connect(M.inputs===void 0?M:M.inputs[0]),y.connect(S,0),y.connect(R,0),y.connect(B,1),y.connect(L,1),M.connect(v),v.connect(I.inputs===void 0?I:I.inputs[0]),v.connect(D.inputs===void 0?D:D.inputs[0]),v.connect(F.inputs===void 0?F:F.inputs[0]),v.connect(O.inputs===void 0?O:O.inputs[0]),I.connect(S.gain),D.connect(R.gain),F.connect(B.gain),O.connect(L.gain),S.connect(g,0,0),B.connect(g,0,0),R.connect(g,0,1),L.connect(g,0,1)},disconnectGraph(){_.disconnect(y),_.disconnect(M.inputs===void 0?M:M.inputs[0]),y.disconnect(S,0),y.disconnect(R,0),y.disconnect(B,1),y.disconnect(L,1),M.disconnect(v),v.disconnect(I.inputs===void 0?I:I.inputs[0]),v.disconnect(D.inputs===void 0?D:D.inputs[0]),v.disconnect(F.inputs===void 0?F:F.inputs[0]),v.disconnect(O.inputs===void 0?O:O.inputs[0]),I.disconnect(S.gain),D.disconnect(R.gain),F.disconnect(B.gain),O.disconnect(L.gain),S.disconnect(g,0,0),B.disconnect(g,0,0),R.disconnect(g,0,1),L.disconnect(g,0,1)}}},f=(p,_,v,g,w)=>{if(_===1)return u(p,v,g,w);if(_===2)return d(p,v,g,w);throw i()};return(p,{channelCount:_,channelCountMode:v,pan:g,...w})=>{if(v==="max")throw i();const C=r(p,{...w,channelCount:1,channelCountMode:v,numberOfInputs:2}),b=e(p,{...w,channelCount:_,channelCountMode:v,gain:1}),x=e(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:g});let{connectGraph:A,disconnectGraph:y}=f(p,_,b,x,C);Object.defineProperty(x.gain,"defaultValue",{get:()=>0}),Object.defineProperty(x.gain,"maxValue",{get:()=>1}),Object.defineProperty(x.gain,"minValue",{get:()=>-1});const S={get bufferSize(){},get channelCount(){return b.channelCount},set channelCount(M){b.channelCount!==M&&(I&&y(),{connectGraph:A,disconnectGraph:y}=f(p,M,b,x,C),I&&A()),b.channelCount=M},get channelCountMode(){return b.channelCountMode},set channelCountMode(M){if(M==="clamped-max"||M==="max")throw i();b.channelCountMode=M},get channelInterpretation(){return b.channelInterpretation},set channelInterpretation(M){b.channelInterpretation=M},get context(){return b.context},get inputs(){return[b]},get numberOfInputs(){return b.numberOfInputs},get numberOfOutputs(){return b.numberOfOutputs},get pan(){return x.gain},addEventListener(...M){return b.addEventListener(M[0],M[1],M[2])},dispatchEvent(...M){return b.dispatchEvent(M[0])},removeEventListener(...M){return b.removeEventListener(M[0],M[1],M[2])}};let I=!1;const R=()=>{A(),I=!0},D=()=>{y(),I=!1};return n(sn(S,C),R,D)}},Zm=(r,t,e,s,i,n,o)=>(a,h)=>{const l=a.createWaveShaper();if(n!==null&&n.name==="webkitAudioContext"&&a.createGain().gain.automationRate===void 0)return e(a,h);Qt(l,h);const c=h.curve===null||h.curve instanceof Float32Array?h.curve:new Float32Array(h.curve);if(c!==null&&c.length<2)throw t();Ct(l,{curve:c},"curve"),Ct(l,h,"oversample");let u=null,d=!1;return o(l,"curve",_=>()=>_.call(l),_=>v=>(_.call(l,v),d&&(s(v)&&u===null?u=r(a,l):!s(v)&&u!==null&&(u(),u=null)),v)),i(l,()=>{d=!0,s(l.curve)&&(u=r(a,l))},()=>{d=!1,u!==null&&(u(),u=null)})},Qm=(r,t,e,s,i)=>(n,{curve:o,oversample:a,...h})=>{const l=n.createWaveShaper(),c=n.createWaveShaper();Qt(l,h),Qt(c,h);const u=e(n,{...h,gain:1}),d=e(n,{...h,gain:-1}),f=e(n,{...h,gain:1}),p=e(n,{...h,gain:-1});let _=null,v=!1,g=null;const w={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(x){u.channelCount=x,d.channelCount=x,l.channelCount=x,f.channelCount=x,c.channelCount=x,p.channelCount=x},get channelCountMode(){return l.channelCountMode},set channelCountMode(x){u.channelCountMode=x,d.channelCountMode=x,l.channelCountMode=x,f.channelCountMode=x,c.channelCountMode=x,p.channelCountMode=x},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(x){u.channelInterpretation=x,d.channelInterpretation=x,l.channelInterpretation=x,f.channelInterpretation=x,c.channelInterpretation=x,p.channelInterpretation=x},get context(){return l.context},get curve(){return g},set curve(x){if(x!==null&&x.length<2)throw t();if(x===null)l.curve=x,c.curve=x;else{const A=x.length,y=new Float32Array(A+2-A%2),S=new Float32Array(A+2-A%2);y[0]=x[0],S[0]=-x[A-1];const I=Math.ceil((A+1)/2),R=(A+1)/2-1;for(let D=1;D<I;D+=1){const M=D/I*R,B=Math.floor(M),F=Math.ceil(M);y[D]=B===F?x[B]:(1-(M-B))*x[B]+(1-(F-M))*x[F],S[D]=B===F?-x[A-1-B]:-((1-(M-B))*x[A-1-B])-(1-(F-M))*x[A-1-F]}y[I]=A%2===1?x[I-1]:(x[I-2]+x[I-1])/2,l.curve=y,c.curve=S}g=x,v&&(s(g)&&_===null?_=r(n,u):_!==null&&(_(),_=null))},get inputs(){return[u]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get oversample(){return l.oversample},set oversample(x){l.oversample=x,c.oversample=x},addEventListener(...x){return u.addEventListener(x[0],x[1],x[2])},dispatchEvent(...x){return u.dispatchEvent(x[0])},removeEventListener(...x){return u.removeEventListener(x[0],x[1],x[2])}};o!==null&&(w.curve=o instanceof Float32Array?o:new Float32Array(o)),a!==w.oversample&&(w.oversample=a);const C=()=>{u.connect(l).connect(f),u.connect(d).connect(c).connect(p).connect(f),v=!0,s(g)&&(_=r(n,u))},b=()=>{u.disconnect(l),l.disconnect(f),u.disconnect(d),d.disconnect(c),c.disconnect(p),p.disconnect(f),v=!1,_!==null&&(_(),_=null)};return i(sn(w,f),C,b)},be=()=>new DOMException("","NotSupportedError"),Jm={numberOfChannels:1},Km=(r,t,e,s,i)=>class extends r{constructor(o,a,h){let l;if(typeof o=="number"&&a!==void 0&&h!==void 0)l={length:a,numberOfChannels:o,sampleRate:h};else if(typeof o=="object")l=o;else throw new Error("The given parameters are not valid.");const{length:c,numberOfChannels:u,sampleRate:d}={...Jm,...l},f=s(u,c,d);t(Pn,()=>Pn(f))||f.addEventListener("statechange",(()=>{let p=0;const _=v=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",_),v.stopImmediatePropagation(),this._waitForThePromiseToSettle(v)):p+=1)};return _})()),super(f,u),this._length=c,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(e()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,Au(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},tv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},ev=(r,t,e,s,i,n,o)=>class extends r{constructor(h,l){const c=i(h),u={...tv,...l},d=e(c,u),f=n(c),p=f?s():null,_=h.sampleRate/2;super(h,!1,d,p),this._detune=t(this,f,d.detune,153600,-153600),this._frequency=t(this,f,d.frequency,_,-_),this._nativeOscillatorNode=d,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&u.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=u.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(h){const l=typeof h=="function"?o(this,h):null;this._nativeOscillatorNode.onended=l;const c=this._nativeOscillatorNode.onended;this._onended=c!==null&&c===l?h:c}get type(){return this._nativeOscillatorNode.type}set type(h){this._nativeOscillatorNode.type=h,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(h){this._nativeOscillatorNode.setPeriodicWave(h),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=h)}start(h=0){if(this._nativeOscillatorNode.start(h),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=h),this.context.state!=="closed"){Vi(this);const l=()=>{this._nativeOscillatorNode.removeEventListener("ended",l),bs(this)&&Vn(this)};this._nativeOscillatorNode.addEventListener("ended",l)}}stop(h=0){this._nativeOscillatorNode.stop(h),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=h)}},sv=(r,t,e,s,i)=>()=>{const n=new WeakMap;let o=null,a=null,h=null;const l=async(c,u)=>{let d=e(c);const f=_e(d,u);if(!f){const p={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,detune:d.detune.value,frequency:d.frequency.value,periodicWave:o===null?void 0:o,type:d.type};d=t(u,p),a!==null&&d.start(a),h!==null&&d.stop(h)}return n.set(u,d),f?(await r(u,c.detune,d.detune),await r(u,c.frequency,d.frequency)):(await s(u,c.detune,d.detune),await s(u,c.frequency,d.frequency)),await i(c,u,d),d};return{set periodicWave(c){o=c},set start(c){a=c},set stop(c){h=c},render(c,u){const d=n.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},iv={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},nv=(r,t,e,s,i,n,o)=>class extends r{constructor(h,l){const c=i(h),u={...iv,...l},d=e(c,u),f=n(c),p=f?s():null;super(h,!1,d,p),this._nativePannerNode=d,this._orientationX=t(this,f,d.orientationX,ve,Me),this._orientationY=t(this,f,d.orientationY,ve,Me),this._orientationZ=t(this,f,d.orientationZ,ve,Me),this._positionX=t(this,f,d.positionX,ve,Me),this._positionY=t(this,f,d.positionY,ve,Me),this._positionZ=t(this,f,d.positionZ,ve,Me),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(h){this._nativePannerNode.coneInnerAngle=h}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(h){this._nativePannerNode.coneOuterAngle=h}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(h){this._nativePannerNode.coneOuterGain=h}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(h){this._nativePannerNode.distanceModel=h}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(h){this._nativePannerNode.maxDistance=h}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(h){this._nativePannerNode.panningModel=h}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(h){this._nativePannerNode.refDistance=h}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(h){this._nativePannerNode.rolloffFactor=h}},rv=(r,t,e,s,i,n,o,a,h,l)=>()=>{const c=new WeakMap;let u=null;const d=async(f,p)=>{let _=null,v=n(f);const g={channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation},w={...g,coneInnerAngle:v.coneInnerAngle,coneOuterAngle:v.coneOuterAngle,coneOuterGain:v.coneOuterGain,distanceModel:v.distanceModel,maxDistance:v.maxDistance,panningModel:v.panningModel,refDistance:v.refDistance,rolloffFactor:v.rolloffFactor},C=_e(v,p);if("bufferSize"in v)_=s(p,{...g,gain:1});else if(!C){const b={...w,orientationX:v.orientationX.value,orientationY:v.orientationY.value,orientationZ:v.orientationZ.value,positionX:v.positionX.value,positionY:v.positionY.value,positionZ:v.positionZ.value};v=i(p,b)}if(c.set(p,_===null?v:_),_!==null){if(u===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const D=new o(6,f.context.length,p.sampleRate),M=t(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});M.connect(D.destination),u=(async()=>{const B=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(F,L)=>{const O=e(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L===0?1:0});return await a(D,F,O.offset),O}));for(let F=0;F<6;F+=1)B[F].connect(M,0,F),B[F].start(0);return l(D)})()}const b=await u,x=s(p,{...g,gain:1});await h(f,p,x);const A=[];for(let D=0;D<b.numberOfChannels;D+=1)A.push(b.getChannelData(D));let y=[A[0][0],A[1][0],A[2][0]],S=[A[3][0],A[4][0],A[5][0]],I=s(p,{...g,gain:1}),R=i(p,{...w,orientationX:y[0],orientationY:y[1],orientationZ:y[2],positionX:S[0],positionY:S[1],positionZ:S[2]});x.connect(I).connect(R.inputs[0]),R.connect(_);for(let D=128;D<b.length;D+=128){const M=[A[0][D],A[1][D],A[2][D]],B=[A[3][D],A[4][D],A[5][D]];if(M.some((F,L)=>F!==y[L])||B.some((F,L)=>F!==S[L])){y=M,S=B;const F=D/p.sampleRate;I.gain.setValueAtTime(0,F),I=s(p,{...g,gain:0}),R=i(p,{...w,orientationX:y[0],orientationY:y[1],orientationZ:y[2],positionX:S[0],positionY:S[1],positionZ:S[2]}),I.gain.setValueAtTime(1,F),x.connect(I).connect(R.inputs[0]),R.connect(_)}}return _}return C?(await r(p,f.orientationX,v.orientationX),await r(p,f.orientationY,v.orientationY),await r(p,f.orientationZ,v.orientationZ),await r(p,f.positionX,v.positionX),await r(p,f.positionY,v.positionY),await r(p,f.positionZ,v.positionZ)):(await a(p,f.orientationX,v.orientationX),await a(p,f.orientationY,v.orientationY),await a(p,f.orientationZ,v.orientationZ),await a(p,f.positionX,v.positionX),await a(p,f.positionY,v.positionY),await a(p,f.positionZ,v.positionZ)),en(v)?await h(f,p,v.inputs[0]):await h(f,p,v),v};return{render(f,p){const _=c.get(p);return _!==void 0?Promise.resolve(_):d(f,p)}}},ov={disableNormalization:!1},av=(r,t,e,s)=>class Bu{constructor(n,o){const a=t(n),h=s({...ov,...o}),l=r(a,h);return e.add(l),l}static[Symbol.hasInstance](n){return n!==null&&typeof n=="object"&&Object.getPrototypeOf(n)===Bu.prototype||e.has(n)}},hv=(r,t)=>(e,s,i)=>(r(s).replay(i),t(s,e,i)),lv=(r,t,e)=>async(s,i,n)=>{const o=r(s);await Promise.all(o.activeInputs.map((a,h)=>Array.from(a).map(async([l,c])=>{const d=await t(l).render(l,i),f=s.context.destination;!e(l)&&(s!==f||!e(s))&&d.connect(n,c,h)})).reduce((a,h)=>[...a,...h],[]))},cv=(r,t,e)=>async(s,i,n)=>{const o=t(s);await Promise.all(Array.from(o.activeInputs).map(async([a,h])=>{const c=await r(a).render(a,i);e(a)||c.connect(n,h)}))},uv=(r,t,e,s)=>i=>r(Pn,()=>Pn(i))?Promise.resolve(r(s,s)).then(n=>{if(!n){const o=e(i,512,0,1);i.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>i.currentTime,o.connect(i.destination)}return i.startRendering()}):new Promise(n=>{const o=t(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=a=>{o.disconnect(),n(a.renderedBuffer)},o.connect(i.destination),i.startRendering()}),dv=r=>(t,e)=>{r.set(t,e)},fv=r=>(t,e)=>r.set(t,e),pv=(r,t,e,s,i,n,o,a)=>(h,l)=>e(h).render(h,l).then(()=>Promise.all(Array.from(s(l)).map(c=>e(c).render(c,l)))).then(()=>i(l)).then(c=>(typeof c.copyFromChannel!="function"?(o(c),mh(c)):t(n,()=>n(c))||a(c),r.add(c),c)),_v={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},gv=(r,t,e,s,i,n)=>class extends r{constructor(a,h){const l=i(a),c={..._v,...h},u=e(l,c),d=n(l),f=d?s():null;super(a,!1,u,f),this._pan=t(this,d,u.pan)}get pan(){return this._pan}},mv=(r,t,e,s,i)=>()=>{const n=new WeakMap,o=async(a,h)=>{let l=e(a);const c=_e(l,h);if(!c){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,pan:l.pan.value};l=t(h,u)}return n.set(h,l),c?await r(h,a.pan,l.pan):await s(h,a.pan,l.pan),en(l)?await i(a,h,l.inputs[0]):await i(a,h,l),l};return{render(a,h){const l=n.get(h);return l!==void 0?Promise.resolve(l):o(a,h)}}},vv=r=>()=>{if(r===null)return!1;try{new r({length:1,sampleRate:44100})}catch{return!1}return!0},wv=(r,t)=>async()=>{if(r===null)return!0;if(t===null)return!1;const e=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new t(1,128,44100),i=URL.createObjectURL(e);let n=!1,o=!1;try{await s.audioWorklet.addModule(i);const a=new r(s,"a",{numberOfOutputs:0}),h=s.createOscillator();a.port.onmessage=()=>n=!0,a.onprocessorerror=()=>o=!0,h.connect(a),h.start(0),await s.startRendering(),await new Promise(l=>setTimeout(l))}catch{}finally{URL.revokeObjectURL(i)}return n&&!o},xv=(r,t)=>()=>{if(t===null)return Promise.resolve(!1);const e=new t(1,1,44100),s=r(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{e.oncomplete=()=>{s.disconnect(),i(e.currentTime!==0)},e.startRendering()})},yv=()=>new DOMException("","UnknownError"),bv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Cv=(r,t,e,s,i,n,o)=>class extends r{constructor(h,l){const c=i(h),u={...bv,...l},d=e(c,u),p=n(c)?s():null;super(h,!0,d,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=d,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(h){if(h===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(h.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=h}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(h){this._nativeWaveShaperNode.oversample=h}},Tv=(r,t,e)=>()=>{const s=new WeakMap,i=async(n,o)=>{let a=t(n);if(!_e(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,curve:a.curve,oversample:a.oversample};a=r(o,l)}return s.set(o,a),en(a)?await e(n,o,a.inputs[0]):await e(n,o,a),a};return{render(n,o){const a=s.get(o);return a!==void 0?Promise.resolve(a):i(n,o)}}},Av=()=>typeof window>"u"?null:window,Sv=(r,t)=>e=>{e.copyFromChannel=(s,i,n=0)=>{const o=r(n),a=r(i);if(a>=e.numberOfChannels)throw t();const h=e.length,l=e.getChannelData(a),c=s.length;for(let u=o<0?-o:0;u+o<h&&u<c;u+=1)s[u]=l[u+o]},e.copyToChannel=(s,i,n=0)=>{const o=r(n),a=r(i);if(a>=e.numberOfChannels)throw t();const h=e.length,l=e.getChannelData(a),c=s.length;for(let u=o<0?-o:0;u+o<h&&u<c;u+=1)l[u+o]=s[u]}},Ev=r=>t=>{t.copyFromChannel=(e=>(s,i,n=0)=>{const o=r(n),a=r(i);if(o<t.length)return e.call(t,s,a,o)})(t.copyFromChannel),t.copyToChannel=(e=>(s,i,n=0)=>{const o=r(n),a=r(i);if(o<t.length)return e.call(t,s,a,o)})(t.copyToChannel)},Pv=r=>(t,e)=>{const s=e.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=s),r(t,"buffer",i=>()=>{const n=i.call(t);return n===s?null:n},i=>n=>i.call(t,n===null?s:n))},Iv=(r,t)=>(e,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw r()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw r()}});const i=e.createBufferSource();t(s,()=>{const a=s.numberOfInputs;for(let h=0;h<a;h+=1)i.connect(s,0,h)},()=>i.disconnect(s))},Ou=(r,t,e)=>r.copyFromChannel===void 0?r.getChannelData(e)[0]:(r.copyFromChannel(t,e),t[0]),Nu=r=>{if(r===null)return!1;const t=r.length;return t%2!==0?r[Math.floor(t/2)]!==0:r[t/2-1]+r[t/2]!==0},Xn=(r,t,e,s)=>{let i=r;for(;!i.hasOwnProperty(t);)i=Object.getPrototypeOf(i);const{get:n,set:o}=Object.getOwnPropertyDescriptor(i,t);Object.defineProperty(r,t,{get:e(n),set:s(o)})},Mv=r=>({...r,outputChannelCount:r.outputChannelCount!==void 0?r.outputChannelCount:r.numberOfInputs===1&&r.numberOfOutputs===1?[r.channelCount]:Array.from({length:r.numberOfOutputs},()=>1)}),Rv=r=>({...r,channelCount:r.numberOfOutputs}),Dv=r=>{const{imag:t,real:e}=r;return t===void 0?e===void 0?{...r,imag:[0,0],real:[0,0]}:{...r,imag:Array.from(e,()=>0),real:e}:e===void 0?{...r,imag:t,real:Array.from(t,()=>0)}:{...r,imag:t,real:e}},Lu=(r,t,e)=>{try{r.setValueAtTime(t,e)}catch(s){if(s.code!==9)throw s;Lu(r,t,e+1e-7)}},kv=r=>{const t=r.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},Fv=r=>{const t=r.createBufferSource(),e=r.createBuffer(1,1,44100);t.buffer=e;try{t.start(0,1)}catch{return!1}return!0},Bv=r=>{const t=r.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},bh=r=>{const t=r.createOscillator();try{t.start(-1)}catch(e){return e instanceof RangeError}return!1},Uu=r=>{const t=r.createBuffer(1,1,44100),e=r.createBufferSource();e.buffer=t,e.start(),e.stop();try{return e.stop(),!0}catch{return!1}},Ch=r=>{const t=r.createOscillator();try{t.stop(-1)}catch(e){return e instanceof RangeError}return!1},Ov=r=>{const{port1:t,port2:e}=new MessageChannel;try{t.postMessage(r)}finally{t.close(),e.close()}},Nv=r=>{r.start=(t=>(e=0,s=0,i)=>{const n=r.buffer,o=n===null?s:Math.min(n.duration,s);n!==null&&o>n.duration-.5/r.context.sampleRate?t.call(r,e,0,0):t.call(r,e,o,i)})(r.start)},zu=(r,t)=>{const e=t.createGain();r.connect(e);const s=(i=>()=>{i.call(r,e),r.removeEventListener("ended",s)})(r.disconnect);r.addEventListener("ended",s),sn(r,e),r.stop=(i=>{let n=!1;return(o=0)=>{if(n)try{i.call(r,o)}catch{e.gain.setValueAtTime(0,o)}else i.call(r,o),n=!0}})(r.stop)},nn=(r,t)=>e=>{const s={value:r};return Object.defineProperties(e,{currentTarget:s,target:s}),typeof t=="function"?t.call(r,e):t.handleEvent.call(r,e)},Lv=n_(mi),Uv=c_(mi),zv=bg(ro),Vu=new WeakMap,Vv=zg(Vu),Ke=J_(new Map,new WeakMap),hs=Av(),Wu=gm(Ke,ds),Th=Ug(xe),ae=lv(xe,Th,pi),Wv=__(Wu,xt,ae),gt=Hg(no),Ps=Hm(hs),ft=om(Ps),Hu=new WeakMap,qu=Dg(nn),jn=xm(hs),Ah=sm(jn),Sh=im(hs),Gu=nm(hs),In=bm(hs),Ut=z_(r_(vu),l_(Lv,Uv,Rr,zv,Dr,xe,Vv,zn,xt,mi,bs,pi,lr),Ke,Qg(sa,Dr,xe,xt,En,bs),ds,oo,be,vg(Rr,sa,xe,xt,En,gt,bs,ft),Ag(Hu,xe,Je),qu,gt,Ah,Sh,Gu,ft,In),Hv=p_(Ut,Wv,ds,Wu,gt,ft),Eh=new WeakSet,wl=mm(hs),Xu=ug(new Uint32Array(1)),Ph=Sv(Xu,ds),Ih=Ev(Xu),ju=m_(Eh,Ke,be,wl,Ps,vv(wl),Ph,Ih),ao=u_(Pe),Yu=cv(Th,Wn,pi),fs=rg(Yu),rn=wm(ao,Ke,kv,Fv,Bv,bh,Uu,Ch,Nv,Pv(Xn),zu),ps=hv(Vg(Wn),Yu),qv=x_(fs,rn,xt,ps,ae),ts=V_(o_(wu),Hu,gh,W_,Jp,Kp,t_,e_,s_,Ko,gu,jn,Lu),Gv=w_(Ut,qv,ts,ee,rn,gt,ft,nn),Xv=I_(Ut,M_,ds,ee,ym(Pe,Xn),gt,ft,ae),jv=Q_(fs,ku,xt,ps,ae),vi=fv(Vu),Yv=Z_(Ut,ts,jv,oo,ku,gt,ft,vi),Ys=pm(mi,Sh),$v=Iv(ee,Ys),$s=Im(jn,$v),Zv=eg($s,xt,ae),Qv=tg(Ut,Zv,$s,gt,ft),Jv=ng(qn,xt,ae),Kv=ig(Ut,Jv,qn,gt,ft,Rv),t0=Dm(ao,rn,Pe,Ys),on=Rm(ao,Ke,t0,bh,Ch),e0=cg(fs,on,xt,ps,ae),s0=lg(Ut,ts,e0,on,gt,ft,nn),$u=km(be,Xn),i0=pg($u,xt,ae),n0=fg(Ut,i0,$u,gt,ft,vi),r0=yg(fs,Fu,xt,ps,ae),o0=xg(Ut,ts,r0,Fu,gt,ft,vi),Zu=Fm(be),a0=Ig(fs,Zu,xt,ps,ae),h0=Pg(Ut,ts,a0,Zu,be,gt,ft,vi),l0=Ng(fs,Pe,xt,ps,ae),c0=Og(Ut,ts,l0,Pe,gt,ft),u0=Lm(oo,ee,Gn,be),ho=uv(Ke,Pe,Gn,xv(Pe,Ps)),d0=Zg(rn,xt,Ps,ae,ho),f0=Bm(u0),p0=Yg(Ut,f0,d0,gt,ft,vi),_0=R_(ts,$s,on,Gn,be,Ou,ft,Xn),Qu=new WeakMap,g0=fm(Xv,_0,qu,ft,Qu,nn),Ju=qm(ao,Ke,bh,Uu,Ch,zu),m0=sv(fs,Ju,xt,ps,ae),v0=ev(Ut,ts,Ju,m0,gt,ft,nn),Ku=ag(rn),w0=Qm(Ku,ee,Pe,Nu,Ys),lo=Zm(Ku,ee,w0,Nu,Ys,jn,Xn),x0=Xm(Rr,ee,$s,Pe,Gn,lo,be,Dr,Ou,Ys),td=Gm(x0),y0=rv(fs,$s,on,Pe,td,xt,Ps,ps,ae,ho),b0=nv(Ut,ts,td,y0,gt,ft,vi),C0=jm(ds),T0=av(C0,gt,new WeakSet,Dv),A0=$m($s,qn,Pe,lo,be,Ys),ed=Ym(A0,be),S0=mv(fs,ed,xt,ps,ae),E0=gv(Ut,ts,ed,S0,gt,ft),P0=Tv(lo,xt,ae),I0=Cv(Ut,ee,lo,P0,gt,ft,vi),sd=am(hs),Mh=kg(hs),id=new WeakMap,M0=qg(id,Ps),R0=sd?h_(Ke,be,Rg(hs),Mh,Fg(i_),gt,M0,ft,In,new WeakMap,new WeakMap,wv(In,Ps),hs):void 0,D0=rm(Ah,ft),k0=mg(Eh,Ke,gg,Mg,new WeakSet,gt,D0,Ir,Pn,Ph,Ih),nd=Y_(R0,Hv,ju,Gv,Yv,Qv,Kv,s0,n0,k0,o0,h0,c0,p0,g0,v0,b0,T0,E0,I0),F0=hm(Ut,Um,gt,ft),B0=cm(Ut,zm,gt,ft),O0=um(Ut,Vm,gt,ft),N0=Wm(ee,ft),L0=dm(Ut,N0,gt),U0=P_(nd,ee,be,yv,F0,B0,O0,L0,jn),Rh=Gg(Qu),z0=d_(Rh),rd=og(ds),V0=Cg(Rh),od=Sg(ds),ad=new WeakMap,W0=Lg(ad,Je),H0=Pm(rd,ds,ee,$s,qn,on,Pe,Gn,be,od,Mh,W0,Ys),q0=Tm(ee,H0,Pe,be,Ys),G0=j_(fs,rd,rn,$s,qn,on,Pe,V0,od,Mh,xt,In,Ps,ps,ae,ho),X0=Wg(id),j0=dv(ad),xl=sd?q_(z0,Ut,ts,G0,q0,xe,X0,gt,ft,In,Mv,j0,Ov,nn):void 0,Y0=_g(be,Ps),$0=pv(Eh,Ke,Th,Rh,ho,Ir,Ph,Ih),Z0=Km(nd,Ke,ee,Y0,$0),Q0=Jg(no,Ah),J0=Kg(_h,Sh),K0=tm(gh,Gu),tw=em(no,ft);function Ne(r){return r===void 0}function st(r){return r!==void 0}function ew(r){return typeof r=="function"}function _i(r){return typeof r=="number"}function ai(r){return Object.prototype.toString.call(r)==="[object Object]"&&r.constructor===Object}function sw(r){return typeof r=="boolean"}function $e(r){return Array.isArray(r)}function Ss(r){return typeof r=="string"}function ir(r){return Ss(r)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(r)}function Q(r,t){if(!r)throw new Error(t)}function Hs(r,t,e=1/0){if(!(t<=r&&r<=e))throw new RangeError(`Value must be within [${t}, ${e}], got: ${r}`)}function hd(r){!r.isOffline&&r.state!=="running"&&Dh('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let ld=!1,yl=!1;function bl(r){ld=r}function iw(r){Ne(r)&&ld&&!yl&&(yl=!0,Dh("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let cd=console;function nw(...r){cd.log(...r)}function Dh(...r){cd.warn(...r)}function rw(r){return new U0(r)}function ow(r,t,e){return new Z0(r,t,e)}const Re=typeof self=="object"?self:null,aw=Re&&(Re.hasOwnProperty("AudioContext")||Re.hasOwnProperty("webkitAudioContext"));function hw(r,t,e){return Q(st(xl),"AudioWorkletNode only works in a secure context (https or localhost)"),new(r instanceof(Re==null?void 0:Re.BaseAudioContext)?Re==null?void 0:Re.AudioWorkletNode:xl)(r,t,e)}function es(r,t,e,s){var i=arguments.length,n=i<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(r,t,e,s);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(n=(i<3?o(n):i>3?o(t,e,n):o(t,e))||n);return i>3&&n&&Object.defineProperty(t,e,n),n}function qt(r,t,e,s){function i(n){return n instanceof e?n:new e(function(o){o(n)})}return new(e||(e=Promise))(function(n,o){function a(c){try{l(s.next(c))}catch(u){o(u)}}function h(c){try{l(s.throw(c))}catch(u){o(u)}}function l(c){c.done?n(c.value):i(c.value).then(a,h)}l((s=s.apply(r,t||[])).next())})}class lw{constructor(t,e,s,i){this._callback=t,this._type=e,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),e=URL.createObjectURL(t),s=new Worker(e);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var e;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((e=this._worker)===null||e===void 0||e.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function gi(r){return K0(r)}function Vs(r){return J0(r)}function cr(r){return tw(r)}function Ci(r){return Q0(r)}function cw(r){return r instanceof ju}function uw(r,t){return r==="value"||gi(t)||Vs(t)||cw(t)}function ki(r,...t){if(!t.length)return r;const e=t.shift();if(ai(r)&&ai(e))for(const s in e)uw(s,e[s])?r[s]=e[s]:ai(e[s])?(r[s]||Object.assign(r,{[s]:{}}),ki(r[s],e[s])):Object.assign(r,{[s]:e[s]});return ki(r,...t)}function dw(r,t){return r.length===t.length&&r.every((e,s)=>t[s]===e)}function Z(r,t,e=[],s){const i={},n=Array.from(t);if(ai(n[0])&&s&&!Reflect.has(n[0],s)&&(Object.keys(n[0]).some(a=>Reflect.has(r,a))||(ki(i,{[s]:n[0]}),e.splice(e.indexOf(s),1),n.shift())),n.length===1&&ai(n[0]))ki(i,n[0]);else for(let o=0;o<e.length;o++)st(n[o])&&(i[e[o]]=n[o]);return ki(r,i)}function fw(r){return r.constructor.getDefaults()}function Fi(r,t){return Ne(r)?t:r}function Cl(r,t){return t.forEach(e=>{Reflect.has(r,e)&&delete r[e]}),r}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class Is{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||Re&&this.toString()===Re.TONE_DEBUG_CLASS)&&nw(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}Is.version=_u;const kh=1e-6;function Wi(r,t){return r>t+kh}function aa(r,t){return Wi(r,t)||We(r,t)}function Or(r,t){return r+kh<t}function We(r,t){return Math.abs(r-t)<kh}function pw(r,t,e){return Math.max(Math.min(r,e),t)}class Le extends Is{constructor(){super(),this.name="Timeline",this._timeline=[];const t=Z(Le.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(Q(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const e=this._timeline[this.length-1];Q(aa(t.time,e.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const e=this._search(t.time);this._timeline.splice(e+1,0,t)}if(this.length>this.memory){const e=this.length-this.memory;this._timeline.splice(0,e)}return this}remove(t){const e=this._timeline.indexOf(t);return e!==-1&&this._timeline.splice(e,1),this}get(t,e="time"){const s=this._search(t,e);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,e="time"){const s=this._search(t,e);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(t){const e=this._timeline.length;if(e>0&&this._timeline[e-1].time<t)return this._timeline[e-1];const s=this._search(t);return s-1>=0?this._timeline[s-1]:null}cancel(t){if(this._timeline.length>1){let e=this._search(t);if(e>=0)if(We(this._timeline[e].time,t)){for(let s=e;s>=0&&We(this._timeline[s].time,t);s--)e=s;this._timeline=this._timeline.slice(0,e)}else this._timeline=this._timeline.slice(0,e+1);else this._timeline=[]}else this._timeline.length===1&&aa(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const e=this._search(t);return e>=0&&(this._timeline=this._timeline.slice(e+1)),this}previousEvent(t){const e=this._timeline.indexOf(t);return e>0?this._timeline[e-1]:null}_search(t,e="time"){if(this._timeline.length===0)return-1;let s=0;const i=this._timeline.length;let n=i;if(i>0&&this._timeline[i-1][e]<=t)return i-1;for(;s<n;){let o=Math.floor(s+(n-s)/2);const a=this._timeline[o],h=this._timeline[o+1];if(We(a[e],t)){for(let l=o;l<this._timeline.length;l++){const c=this._timeline[l];if(We(c[e],t))o=l;else break}return o}else{if(Or(a[e],t)&&Wi(h[e],t))return o;Wi(a[e],t)?n=o:s=o+1}}return-1}_iterate(t,e=0,s=this._timeline.length-1){this._timeline.slice(e,s+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,e){const s=this._search(t);return s!==-1&&this._iterate(e,0,s),this}forEachAfter(t,e){const s=this._search(t);return this._iterate(e,s+1),this}forEachBetween(t,e,s){let i=this._search(t),n=this._search(e);return i!==-1&&n!==-1?(this._timeline[i].time!==t&&(i+=1),this._timeline[n].time===e&&(n-=1),this._iterate(s,i,n)):i===-1&&this._iterate(s,0,n),this}forEachFrom(t,e){let s=this._search(t);for(;s>=0&&this._timeline[s].time>=t;)s--;return this._iterate(e,s+1),this}forEachAtTime(t,e){const s=this._search(t);if(s!==-1&&We(this._timeline[s].time,t)){let i=s;for(let n=s;n>=0&&We(this._timeline[n].time,t);n--)i=n;this._iterate(n=>{e(n)},i,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const ud=[];function co(r){ud.push(r)}function _w(r){ud.forEach(t=>t(r))}const dd=[];function uo(r){dd.push(r)}function gw(r){dd.forEach(t=>t(r))}class Yn extends Is{constructor(){super(...arguments),this.name="Emitter"}on(t,e){return t.split(/\W+/).forEach(i=>{Ne(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(e)}),this}once(t,e){const s=(...i)=>{e(...i),this.off(t,s)};return this.on(t,s),this}off(t,e){return t.split(/\W+/).forEach(i=>{if(Ne(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(Ne(e))this._events[i]=[];else{const n=this._events[i];for(let o=n.length-1;o>=0;o--)n[o]===e&&n.splice(o,1)}}),this}emit(t,...e){if(this._events&&this._events.hasOwnProperty(t)){const s=this._events[t].slice(0);for(let i=0,n=s.length;i<n;i++)s[i].apply(this,e)}return this}static mixin(t){["on","once","off","emit"].forEach(e=>{const s=Object.getOwnPropertyDescriptor(Yn.prototype,e);Object.defineProperty(t.prototype,e,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class fd extends Yn{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class $n extends fd{constructor(){var t,e;super(),this.name="Context",this._constants=new Map,this._timeouts=new Le,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=Z($n.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=rw({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new lw(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((e=arguments[0])===null||e===void 0)&&e.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(_w(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,e,s){return this._context.createBuffer(t,e,s)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,e){return this._context.createIIRFilter(t,e)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,e,s){return this._context.createPeriodicWave(t,e,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return Q(Ci(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return Q(Ci(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return Q(Ci(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){Q(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){Q(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){Q(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){Q(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,e){return hw(this.rawContext,t,e)}addAudioWorkletModule(t){return qt(this,void 0,void 0,function*(){Q(st(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return qt(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return Ci(this._context)?this._context.resume():Promise.resolve()}close(){return qt(this,void 0,void 0,function*(){Ci(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&gw(this)})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const e=this._context.createBuffer(1,128,this._context.sampleRate),s=e.getChannelData(0);for(let n=0;n<s.length;n++)s[n]=t;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=e,i.loop=!0,i.start(0),this._constants.set(t,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let e=this._timeouts.peek();for(;this._timeouts.length&&e&&e.time<=t;)e.callback(),this._timeouts.shift(),e=this._timeouts.peek()}setTimeout(t,e){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:s+e}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(e=>{e.id===t&&this._timeouts.remove(e)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,e){const s=++this._timeoutIds,i=()=>{const n=this.now();this._timeouts.add({callback:()=>{t(),i()},id:s,time:n+e})};return i(),s}}class mw extends fd{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(t,e,s){return{}}createChannelMerger(t){return{}}createChannelSplitter(t){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(t){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(t,e){return{}}createPanner(){return{}}createPeriodicWave(t,e,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(t){return{}}createMediaElementSource(t){return{}}createMediaStreamDestination(){return{}}decodeAudioData(t){return Promise.resolve({})}createAudioWorkletNode(t,e){return{}}get rawContext(){return{}}addAudioWorkletModule(t){return qt(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(t,e){return 0}clearTimeout(t){return this}setInterval(t,e){return 0}clearInterval(t){return this}getConstant(t){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(t){}get destination(){return{}}set destination(t){}now(){return 0}immediate(){return 0}}function Ft(r,t){$e(t)?t.forEach(e=>Ft(r,e)):Object.defineProperty(r,t,{enumerable:!0,writable:!1})}function pd(r,t){$e(t)?t.forEach(e=>pd(r,e)):Object.defineProperty(r,t,{writable:!0})}const dt=()=>{};class mt extends Is{constructor(){super(),this.name="ToneAudioBuffer",this.onload=dt;const t=Z(mt.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Ss(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:dt,onload:dt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:Ge().sampleRate}set(t){return t instanceof mt?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return qt(this,void 0,void 0,function*(){const e=mt.load(t).then(s=>{this.set(s),this.onload(this)});mt.downloads.push(e);try{yield e}finally{const s=mt.downloads.indexOf(e);mt.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const e=$e(t)&&t[0].length>0,s=e?t.length:1,i=e?t[0].length:t.length,n=Ge(),o=n.createBuffer(s,i,n.sampleRate),a=!e&&s===1?[t]:t;for(let h=0;h<s;h++)o.copyToChannel(a[h],h);return this._buffer=o,this}toMono(t){if(_i(t))this.fromArray(this.toArray(t));else{let e=new Float32Array(this.length);const s=this.numberOfChannels;for(let i=0;i<s;i++){const n=this.toArray(i);for(let o=0;o<n.length;o++)e[o]+=n[o]}e=e.map(i=>i/s),this.fromArray(e)}return this}toArray(t){if(_i(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const e=[];for(let s=0;s<this.numberOfChannels;s++)e[s]=this.getChannelData(s);return e}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,e=this.duration){Q(this.loaded,"Buffer is not loaded");const s=Math.floor(t*this.sampleRate),i=Math.floor(e*this.sampleRate);Q(s<i,"The start time must be less than the end time");const n=i-s,o=Ge().createBuffer(this.numberOfChannels,n,this.sampleRate);for(let a=0;a<this.numberOfChannels;a++)o.copyToChannel(this.getChannelData(a).subarray(s,i),a);return new mt(o)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new mt().fromArray(t)}static fromUrl(t){return qt(this,void 0,void 0,function*(){return yield new mt().load(t)})}static load(t){return qt(this,void 0,void 0,function*(){const e=t.match(/\[([^\]\[]+\|.+)\]$/);if(e){const h=e[1].split("|");let l=h[0];for(const c of h)if(mt.supportsType(c)){l=c;break}t=t.replace(e[0],l)}const s=mt.baseUrl===""||mt.baseUrl.endsWith("/")?mt.baseUrl:mt.baseUrl+"/",i=document.createElement("a");i.href=s+t,i.pathname=(i.pathname+i.hash).split("/").map(encodeURIComponent).join("/");const n=yield fetch(i.href);if(!n.ok)throw new Error(`could not load url: ${t}`);const o=yield n.arrayBuffer();return yield Ge().decodeAudioData(o)})}static supportsType(t){const e=t.split("."),s=e[e.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return qt(this,void 0,void 0,function*(){for(yield Promise.resolve();mt.downloads.length;)yield mt.downloads[0]})}}mt.baseUrl="";mt.downloads=[];class Fh extends $n{constructor(){super({clockSource:"offline",context:cr(arguments[0])?arguments[0]:ow(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:cr(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=cr(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return qt(this,void 0,void 0,function*(){let e=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,e++;const s=Math.floor(this.sampleRate/128);t&&e%s===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return qt(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const e=yield this._context.startRendering();return new mt(e)})}close(){return Promise.resolve()}}const _d=new mw;let Si=_d;function Ge(){return Si===_d&&aw&&vw(new $n),Si}function vw(r,t=!1){t&&Si.dispose(),Ci(r)?Si=new $n(r):cr(r)?Si=new Fh(r):Si=r}if(Re&&!Re.TONE_SILENCE_LOGGING){const t=` * Tone.js v${_u} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function ww(r){return Math.pow(10,r/20)}function xw(r){return 20*(Math.log(r)/Math.LN10)}function gd(r){return Math.pow(2,r/12)}let fo=440;function yw(){return fo}function bw(r){fo=r}function ha(r){return Math.round(md(r))}function md(r){return 69+12*Math.log2(r/fo)}function Cw(r){return fo*Math.pow(2,(r-69)/12)}class Bh extends Is{constructor(t,e,s){super(),this.defaultUnits="s",this._val=e,this._units=s,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,e)=>{const s=parseInt(t,10),i=e==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/s)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const e=parseInt(t,10);return this._beatsToUnits(8/(Math.floor(e)*3))},regexp:/^(\d+)t$/i},tr:{method:(t,e,s)=>{let i=0;return t&&t!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(i+=this._beatsToUnits(parseFloat(e))),s&&s!=="0"&&(i+=this._beatsToUnits(parseFloat(s)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Bh&&this.fromType(this._val),Ne(this._val))return this._noArg();if(Ss(this._val)&&Ne(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(ai(this._val)){let t=0;for(const e in this._val)if(st(this._val[e])){const s=this._val[e],i=new this.constructor(this.context,e).valueOf()*s;t+=i}return t}if(st(this._units)){const t=this._expressions[this._units],e=this._val.toString().trim().match(t.regexp);return e?t.method.apply(this,e.slice(1)):t.method.call(this,this._val)}else return Ss(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class Xe extends Bh{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const e=new Xe(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(e))},regexp:/^@(.+)/}})}quantize(t,e=1){const s=new this.constructor(this.context,t).valueOf(),i=this.valueOf(),a=Math.round(i/s)*s-i;return i+a*e}toNotation(){const t=this.toSeconds(),e=["1m"];for(let n=1;n<9;n++){const o=Math.pow(2,n);e.push(o+"n."),e.push(o+"n"),e.push(o+"t")}e.push("0");let s=e[0],i=new Xe(this.context,e[0]).toSeconds();return e.forEach(n=>{const o=new Xe(this.context,n).toSeconds();Math.abs(o-t)<Math.abs(i-t)&&(s=n,i=o)}),s}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let e=this.valueOf()/t;e=parseFloat(e.toFixed(4));const s=Math.floor(e/this._getTimeSignature());let i=e%1*4;e=Math.floor(e)%this._getTimeSignature();const n=i.toString();return n.length>3&&(i=parseFloat(parseFloat(n).toFixed(3))),[s,e,i].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return ha(this.toFrequency())}_now(){return this.context.now()}}class Oe extends Xe{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return yw()}static set A4(t){bw(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Oe.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,e){const i=Tw[t.toLowerCase()]+(parseInt(e,10)+1)*12;return this.defaultUnits==="midi"?i:Oe.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,e,s){let i=1;return t&&t!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(i*=this._beatsToUnits(parseFloat(e))),s&&s!=="0"&&(i*=this._beatsToUnits(parseFloat(s)/4)),i}}})}transpose(t){return new Oe(this.context,this.valueOf()*gd(t))}harmonize(t){return t.map(e=>this.transpose(e))}toMidi(){return ha(this.valueOf())}toNote(){const t=this.toFrequency(),e=Math.log2(t/Oe.A4);let s=Math.round(12*e)+57;const i=Math.floor(s/12);return i<0&&(s+=-12*i),Aw[s%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),e=this.valueOf()/t;return Math.floor(e*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(t*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return Cw(t)}static ftom(t){return ha(t)}}const Tw={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},Aw=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class fn extends Xe{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Se extends Is{constructor(){super();const t=Z(Se.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:Ge()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return iw(t),new Xe(this.context,t).toSeconds()}toFrequency(t){return new Oe(this.context,t).toFrequency()}toTicks(t){return new fn(this.context,t).toTicks()}_getPartialProperties(t){const e=this.get();return Object.keys(e).forEach(s=>{Ne(t[s])&&delete e[s]}),e}get(){const t=fw(this);return Object.keys(t).forEach(e=>{if(Reflect.has(this,e)){const s=this[e];st(s)&&st(s.value)&&st(s.setValueAtTime)?t[e]=s.value:s instanceof Se?t[e]=s._getPartialProperties(t[e]):$e(s)||_i(s)||Ss(s)||sw(s)?t[e]=s:delete t[e]}}),t}set(t){return Object.keys(t).forEach(e=>{Reflect.has(this,e)&&st(this[e])&&(this[e]&&st(this[e].value)&&st(this[e].setValueAtTime)?this[e].value!==t[e]&&(this[e].value=t[e]):this[e]instanceof Se?this[e].set(t[e]):this[e]=t[e])}),this}}class Oh extends Le{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const e=this.get(t);return e!==null?e.state:this._initial}setStateAtTime(t,e,s){return Hs(e,0),this.add(Object.assign({},s,{state:t,time:e})),this}getLastState(t,e){const s=this._search(e);for(let i=s;i>=0;i--){const n=this._timeline[i];if(n.state===t)return n}}getNextState(t,e){const s=this._search(e);if(s!==-1)for(let i=s;i<this._timeline.length;i++){const n=this._timeline[i];if(n.state===t)return n}}}class St extends Se{constructor(){const t=Z(St.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,Q(st(t.param)&&(gi(t.param)||t.param instanceof St),"param must be an AudioParam");!gi(t.param);)t.param=t.param._param;this._swappable=st(t.swappable)?t.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new Le(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,st(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Se.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return st(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return st(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,e){return this.units===e}_assertRange(t){return st(this.maxValue)&&st(this.minValue)&&Hs(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?ww(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?xw(t):t}setValueAtTime(t,e){const s=this.toSeconds(e),i=this._fromType(t);return Q(isFinite(i)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",t,s),this._events.add({time:s,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,s),this}getValueAtTime(t){const e=Math.max(this.toSeconds(t),0),s=this._events.getAfter(e),i=this._events.get(e);let n=this._initialValue;if(i===null)n=this._initialValue;else if(i.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const o=this._events.getBefore(i.time);let a;o===null?a=this._initialValue:a=o.value,i.type==="setTargetAtTime"&&(n=this._exponentialApproach(i.time,a,i.value,i.constant,e))}else if(s===null)n=i.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let o=i.value;if(i.type==="setTargetAtTime"){const a=this._events.getBefore(i.time);a===null?o=this._initialValue:o=a.value}s.type==="linearRampToValueAtTime"?n=this._linearInterpolate(i.time,o,s.time,s.value,e):n=this._exponentialInterpolate(i.time,o,s.time,s.value,e)}else n=i.value;return this._toType(n)}setRampPoint(t){t=this.toSeconds(t);let e=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(e)===0&&(e=this._toType(this._minOutput)),this.setValueAtTime(e,t),this}linearRampToValueAtTime(t,e){const s=this._fromType(t),i=this.toSeconds(e);return Q(isFinite(s)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(s),this._events.add({time:i,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",t,i),this._param.linearRampToValueAtTime(s,i),this}exponentialRampToValueAtTime(t,e){let s=this._fromType(t);s=We(s,0)?this._minOutput:s,this._assertRange(s);const i=this.toSeconds(e);return Q(isFinite(s)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",t,i),this._param.exponentialRampToValueAtTime(s,i),this}exponentialRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(t,s+this.toSeconds(e)),this}linearRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(t,s+this.toSeconds(e)),this}targetRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(t,s,e),this}exponentialApproachValueAtTime(t,e,s){e=this.toSeconds(e),s=this.toSeconds(s);const i=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(t,e,i),this.cancelAndHoldAtTime(e+s*.9),this.linearRampToValueAtTime(t,e+s),this}setTargetAtTime(t,e,s){const i=this._fromType(t);Q(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const n=this.toSeconds(e);return this._assertRange(i),Q(isFinite(i)&&isFinite(n),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({constant:s,time:n,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",t,n,s),this._param.setTargetAtTime(i,n,s),this}setValueCurveAtTime(t,e,s,i=1){s=this.toSeconds(s),e=this.toSeconds(e);const n=this._fromType(t[0])*i;this.setValueAtTime(this._toType(n),e);const o=s/(t.length-1);for(let a=1;a<t.length;a++){const h=this._fromType(t[a])*i;this.linearRampToValueAtTime(this._toType(h),e+a*o)}return this}cancelScheduledValues(t){const e=this.toSeconds(t);return Q(isFinite(e),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(e),this._param.cancelScheduledValues(e),this.log(this.units,"cancelScheduledValues",e),this}cancelAndHoldAtTime(t){const e=this.toSeconds(t),s=this._fromType(this.getValueAtTime(e));Q(isFinite(e),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",e,"value="+s);const i=this._events.get(e),n=this._events.getAfter(e);return i&&We(i.time,e)?n?(this._param.cancelScheduledValues(n.time),this._events.cancel(n.time)):(this._param.cancelAndHoldAtTime(e),this._events.cancel(e+this.sampleTime)):n&&(this._param.cancelScheduledValues(n.time),this._events.cancel(n.time),n.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),e):n.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),e)),this._events.add({time:e,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,e),this}rampTo(t,e=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,e,s):this.linearRampTo(t,e,s),this}apply(t){const e=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(e),e);const s=this._events.get(e);if(s&&s.type==="setTargetAtTime"){const i=this._events.getAfter(s.time),n=i?i.time:e+2,o=(n-e)/10;for(let a=e;a<n;a+=o)t.linearRampToValueAtTime(this.getValueAtTime(a),a)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?t.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?t.setTargetAtTime(i.value,i.time,i.constant):t[i.type](i.value,i.time)}),this}setParam(t){Q(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const e=this.input;return e.disconnect(this._param),this.apply(t),this._param=t,e.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,e,s,i,n){return s+(e-s)*Math.exp(-(n-t)/i)}_linearInterpolate(t,e,s,i,n){return e+(i-e)*((n-t)/(s-t))}_exponentialInterpolate(t,e,s,i,n){return e*Math.pow(i/e,(n-t)/(s-t))}}class et extends Se{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return st(this.input)?gi(this.input)||this.input instanceof St?1:this.input.numberOfInputs:0}get numberOfOutputs(){return st(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return st(t)&&(t instanceof et||Vs(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(s=>{s.channelCount=t.channelCount,s.channelCountMode=t.channelCountMode,s.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();Q(t.length>0,"ToneAudioNode does not have any internal nodes");const e=t[0];return{channelCount:e.channelCount,channelCountMode:e.channelCountMode,channelInterpretation:e.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelInterpretation:t}))}connect(t,e=0,s=0){return an(this,t,e,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Dh("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,e=0,s=0){return Sw(this,t,e,s),this}chain(...t){return la(this,...t),this}fan(...t){return t.forEach(e=>this.connect(e)),this}dispose(){return super.dispose(),st(this.input)&&(this.input instanceof et?this.input.dispose():Vs(this.input)&&this.input.disconnect()),st(this.output)&&(this.output instanceof et?this.output.dispose():Vs(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function la(...r){const t=r.shift();r.reduce((e,s)=>(e instanceof et?e.connect(s):Vs(e)&&an(e,s),s),t)}function an(r,t,e=0,s=0){for(Q(st(r),"Cannot connect from undefined node"),Q(st(t),"Cannot connect to undefined node"),(t instanceof et||Vs(t))&&Q(t.numberOfInputs>0,"Cannot connect to node with no inputs"),Q(r.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof et||t instanceof St;)st(t.input)&&(t=t.input);for(;r instanceof et;)st(r.output)&&(r=r.output);gi(t)?r.connect(t,e):r.connect(t,e,s)}function Sw(r,t,e=0,s=0){if(st(t))for(;t instanceof et;)t=t.input;for(;!Vs(r);)st(r.output)&&(r=r.output);gi(t)?r.disconnect(t,e):Vs(t)?r.disconnect(t,e,s):r.disconnect()}class pe extends et{constructor(){const t=Z(pe.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new St({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),Ft(this,"gain")}static getDefaults(){return Object.assign(et.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Hi extends et{constructor(t){super(t),this.onended=dt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new pe({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(e){const s=this.toSeconds(e);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(et.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:dt})}_startGain(t,e=1){Q(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=t+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(e,t+s):this._gainNode.gain.exponentialApproachValueAtTime(e,t,s)):this._gainNode.gain.setValueAtTime(e,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){Q(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const e=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+e,this._stopTime=Math.max(this._stopTime,this.now()),e>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,e,t):this._gainNode.gain.targetRampTo(0,e,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?e*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==dt&&(this.onended(this),this.onended=dt,!this.context.isOffline)){const t=()=>this.dispose();typeof window.requestIdleCallback<"u"?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),Q(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=dt,this}}class Nh extends Hi{constructor(){const t=Z(Nh.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),an(this._source,this._gainNode),this.offset=new St({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Hi.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._source.start(e),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class se extends et{constructor(){const t=Z(se.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Nh({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(et.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,e=0,s=0){return Lh(this,t,e,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,e){return this._param.setValueAtTime(t,e),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,e){return this._param.linearRampToValueAtTime(t,e),this}exponentialRampToValueAtTime(t,e){return this._param.exponentialRampToValueAtTime(t,e),this}exponentialRampTo(t,e,s){return this._param.exponentialRampTo(t,e,s),this}linearRampTo(t,e,s){return this._param.linearRampTo(t,e,s),this}targetRampTo(t,e,s){return this._param.targetRampTo(t,e,s),this}exponentialApproachValueAtTime(t,e,s){return this._param.exponentialApproachValueAtTime(t,e,s),this}setTargetAtTime(t,e,s){return this._param.setTargetAtTime(t,e,s),this}setValueCurveAtTime(t,e,s,i){return this._param.setValueCurveAtTime(t,e,s,i),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,e,s){return this._param.rampTo(t,e,s),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function Lh(r,t,e,s){(t instanceof St||gi(t)||t instanceof se&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof se&&(t.overridden=!0)),an(r,t,e,s)}class Uh extends St{constructor(){const t=Z(Uh.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new Le(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(St.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,e,s){e=this.toSeconds(e),this.setRampPoint(e);const i=this._fromType(t),n=this._events.get(e),o=Math.round(Math.max(1/s,1));for(let a=0;a<=o;a++){const h=s*a+e,l=this._exponentialApproach(n.time,n.value,i,s,h);this.linearRampToValueAtTime(this._toType(l),h)}return this}setValueAtTime(t,e){const s=this.toSeconds(e);super.setValueAtTime(t,e);const i=this._events.get(s),n=this._events.previousEvent(i),o=this._getTicksUntilEvent(n,s);return i.ticks=Math.max(o,0),this}linearRampToValueAtTime(t,e){const s=this.toSeconds(e);super.linearRampToValueAtTime(t,e);const i=this._events.get(s),n=this._events.previousEvent(i),o=this._getTicksUntilEvent(n,s);return i.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(t,e){e=this.toSeconds(e);const s=this._fromType(t),i=this._events.get(e),n=Math.round(Math.max((e-i.time)*10,1)),o=(e-i.time)/n;for(let a=0;a<=n;a++){const h=o*a+i.time,l=this._exponentialInterpolate(i.time,i.value,e,s,h);this.linearRampToValueAtTime(this._toType(l),h)}return this}_getTicksUntilEvent(t,e){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Ne(t.ticks)){const o=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(o,t.time)}const s=this._fromType(this.getValueAtTime(t.time));let i=this._fromType(this.getValueAtTime(e));const n=this._events.get(e);return n&&n.time===e&&n.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(e-this.sampleTime))),.5*(e-t.time)*(s+i)+t.ticks}getTicksAtTime(t){const e=this.toSeconds(t),s=this._events.get(e);return Math.max(this._getTicksUntilEvent(s,e),0)}getDurationOfTicks(t,e){const s=this.toSeconds(e),i=this.getTicksAtTime(e);return this.getTimeOfTick(i+t)-s}getTimeOfTick(t){const e=this._events.get(t,"ticks"),s=this._events.getAfter(t,"ticks");if(e&&e.ticks===t)return e.time;if(e&&s&&s.type==="linearRampToValueAtTime"&&e.value!==s.value){const i=this._fromType(this.getValueAtTime(e.time)),o=(this._fromType(this.getValueAtTime(s.time))-i)/(s.time-e.time),a=Math.sqrt(Math.pow(i,2)-2*o*(e.ticks-t)),h=(-i+a)/o,l=(-i-a)/o;return(h>0?h:l)+e.time}else return e?e.value===0?1/0:e.time+(t-e.ticks)/e.value:t/this._initialValue}ticksToTime(t,e){return this.getDurationOfTicks(t,e)}timeToTicks(t,e){const s=this.toSeconds(e),i=this.toSeconds(t),n=this.getTicksAtTime(s);return this.getTicksAtTime(s+i)-n}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const e=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(e,0)}}class zh extends se{constructor(){const t=Z(zh.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new Uh({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(se.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,e){return this._param.ticksToTime(t,e)}timeToTicks(t,e){return this._param.timeToTicks(t,e)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,e){return this._param.getDurationOfTicks(t,e)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class Vh extends Se{constructor(){const t=Z(Vh.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new Oh,this._tickOffset=new Le,this._ticksAtTime=new Le,this._secondsAtTime=new Le,this.frequency=new zh({context:this.context,units:t.units,value:t.frequency}),Ft(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Se.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,e){const s=this.toSeconds(t);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),st(e)&&this.setTicksAtTime(e,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(t){const e=this.toSeconds(t);if(this._state.getValueAtTime(e)==="stopped"){const s=this._state.get(e);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(e),this._state.setStateAtTime("stopped",e),this.setTicksAtTime(0,e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const e=this.toSeconds(t),s=this._state.getLastState("stopped",e),i=this._ticksAtTime.get(e),n={state:"paused",time:e};this._state.add(n);let o=i||s,a=i?i.ticks:0,h=null;return this._state.forEachBetween(o.time,e+this.sampleTime,l=>{let c=o.time;const u=this._tickOffset.get(l.time);u&&u.time>=o.time&&(a=u.ticks,c=u.time),o.state==="started"&&l.state!=="started"&&(a+=this.frequency.getTicksAtTime(l.time)-this.frequency.getTicksAtTime(c),l.time!==n.time&&(h={state:l.state,time:l.time,ticks:a})),o=l}),this._state.remove(n),h&&this._ticksAtTime.add(h),a}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const e=this.now(),s=this.frequency.timeToTicks(t,e);this.setTicksAtTime(s,e)}getSecondsAtTime(t){t=this.toSeconds(t);const e=this._state.getLastState("stopped",t),s={state:"paused",time:t};this._state.add(s);const i=this._secondsAtTime.get(t);let n=i||e,o=i?i.seconds:0,a=null;return this._state.forEachBetween(n.time,t+this.sampleTime,h=>{let l=n.time;const c=this._tickOffset.get(h.time);c&&c.time>=n.time&&(o=c.seconds,l=c.time),n.state==="started"&&h.state!=="started"&&(o+=h.time-l,h.time!==s.time&&(a={state:h.state,time:h.time,seconds:o})),n=h}),this._state.remove(s),a&&this._secondsAtTime.add(a),o}setTicksAtTime(t,e){return e=this.toSeconds(e),this._tickOffset.cancel(e),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,e),ticks:t,time:e}),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,e=this.now()){const s=this._tickOffset.get(e),i=this._state.get(e),n=Math.max(s.time,i.time),o=this.frequency.getTicksAtTime(n)+t-s.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(t,e,s){let i=this._state.get(t);this._state.forEachBetween(t,e,o=>{i&&i.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(i.time,t),o.time-this.sampleTime,s),i=o});let n=null;if(i&&i.state==="started"){const o=Math.max(i.time,t),a=this.frequency.getTicksAtTime(o),h=this.frequency.getTicksAtTime(i.time),l=a-h;let c=Math.ceil(l)-l;c=We(c,1)?0:c;let u=this.frequency.getTimeOfTick(a+c);for(;u<e;){try{s(u,Math.round(this.getTicksAtTime(u)))}catch(d){n=d;break}u+=this.frequency.getDurationOfTicks(1,u)}}if(n)throw n;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class po extends Se{constructor(){const t=Z(po.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=dt,this._lastUpdate=0,this._state=new Oh("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new Vh({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Ft(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Se.getDefaults(),{callback:dt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,e){hd(this.context);const s=this.toSeconds(t);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,e),s<this._lastUpdate&&this.emit("start",s,e)),this}stop(t){const e=this.toSeconds(t);return this.log("stop",e),this._state.cancel(e),this._state.setStateAtTime("stopped",e),this._tickSource.stop(e),e<this._lastUpdate&&this.emit("stop",e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._tickSource.pause(e),e<this._lastUpdate&&this.emit("pause",e)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,e){return this._tickSource.setTicksAtTime(t,e),this}getTimeOfTick(t,e=this.now()){return this._tickSource.getTimeOfTick(t,e)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,e){const s=this.toSeconds(e),i=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(i+t,s)}_loop(){const t=this._lastUpdate,e=this.now();this._lastUpdate=e,this.log("loop",t,e),t!==e&&(this._state.forEachBetween(t,e,s=>{switch(s.state){case"started":const i=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,i);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(t,e,(s,i)=>{this.callback(s,i)}))}getStateAtTime(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Yn.mixin(po);class hn extends et{constructor(){const t=Z(hn.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new pe({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,Ft(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(et.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Wh extends et{constructor(){const t=Z(Wh.getDefaults(),arguments);super(t),this.name="Destination",this.input=new hn({context:this.context}),this.output=new pe({context:this.context}),this.volume=this.input.volume,la(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(et.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),la(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}co(r=>{r.destination=new Wh({context:r})});uo(r=>{r.destination.dispose()});class Ew extends et{constructor(){super(...arguments),this.name="Listener",this.positionX=new St({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new St({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new St({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new St({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new St({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new St({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new St({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new St({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new St({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(et.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}co(r=>{r.listener=new Ew({context:r})});uo(r=>{r.listener.dispose()});class Hh extends Is{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=Z(Hh.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(e=>{this._loadingCount++;const s=t.urls[e];this.add(e,s,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:dt,onload:dt,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return Q(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,e])=>e.loaded)}add(t,e,s=dt,i=dt){return Ss(e)?(this.baseUrl&&e.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new mt(this.baseUrl+e,s,i))):this._buffers.set(t.toString(),new mt(e,s,i)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class Ei extends fn{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class Pw extends Se{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new Le,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,e){return this._events.add({callback:t,time:this.toSeconds(e)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const e=this._events.shift();e&&t-e.time<=this.expiration&&e.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}co(r=>{r.draw=new Pw({context:r})});uo(r=>{r.draw.dispose()});class Iw extends Is{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){Q(st(t.time),"Events must have a time property"),Q(st(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let e=new Mw(t.time,t.time+t.duration,t);for(this._root===null?this._root=e:this._root.insert(e),this._length++;e!==null;)e.updateHeight(),e.updateMax(),this._rebalance(e),e=e.parent;return this}remove(t){if(this._root!==null){const e=[];this._root.search(t.time,e);for(const s of e)if(s.event===t){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,e=>this.remove(e)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,e){t.parent!==null?(t.isLeftChild()?t.parent.left=e:t.parent.right=e,this._rebalance(t.parent)):this._setRoot(e)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{const e=t.getBalance();let s,i=null;if(e>0)if(t.left.right===null)s=t.left,s.right=t.right,i=s;else{for(s=t.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,i=s.parent,s.left=t.left,s.right=t.right)}else if(t.right.left===null)s=t.right,s.left=t.left,i=s;else{for(s=t.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,i=s.parent,s.left=t.left,s.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=s:t.parent.right=s:this._setRoot(s),i&&this._rebalance(i)}t.dispose()}_rotateLeft(t){const e=t.parent,s=t.isLeftChild(),i=t.right;i&&(t.right=i.left,i.left=t),e!==null?s?e.left=i:e.right=i:this._setRoot(i)}_rotateRight(t){const e=t.parent,s=t.isLeftChild(),i=t.left;i&&(t.left=i.right,i.right=t),e!==null?s?e.left=i:e.right=i:this._setRoot(i)}_rebalance(t){const e=t.getBalance();e>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):e<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const e=[];if(this._root.search(t,e),e.length>0){let s=e[0];for(let i=1;i<e.length;i++)e[i].low>s.low&&(s=e[i]);return s.event}}return null}forEach(t){if(this._root!==null){const e=[];this._root.traverse(s=>e.push(s)),e.forEach(s=>{s.event&&t(s.event)})}return this}forEachAtTime(t,e){if(this._root!==null){const s=[];this._root.search(t,s),s.forEach(i=>{i.event&&e(i.event)})}return this}forEachFrom(t,e){if(this._root!==null){const s=[];this._root.searchAfter(t,s),s.forEach(i=>{i.event&&e(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class Mw{constructor(t,e,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=t,this.high=e,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,e){t>this.max||(this.left!==null&&this.left.search(t,e),this.low<=t&&this.high>t&&e.push(this),!(this.low>t)&&this.right!==null&&this.right.search(t,e))}searchAfter(t,e){this.low>=t&&(e.push(this),this.left!==null&&this.left.searchAfter(t,e)),this.right!==null&&this.right.searchAfter(t,e)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class Rw extends Is{constructor(t){super(),this.name="TimelineValue",this._timeline=new Le({memory:10}),this._initialValue=t}set(t,e){return this._timeline.add({value:t,time:e}),this}get(t){const e=this._timeline.get(t);return e?e.value:this._initialValue}}class qi extends et{constructor(){super(Z(qi.getDefaults(),arguments,["context"]))}connect(t,e=0,s=0){return Lh(this,t,e,s),this}}class Zn extends qi{constructor(){const t=Z(Zn.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,$e(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):ew(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(se.getDefaults(),{length:1024})}setMap(t,e=1024){const s=new Float32Array(e);for(let i=0,n=e;i<n;i++){const o=i/(n-1)*2-1;s[i]=t(o,i)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){const e=["none","2x","4x"].some(s=>s.includes(t));Q(e,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class qh extends qi{constructor(){const t=Z(qh.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new Zn({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(qi.getDefaults(),{value:1})}_expFunc(t){return e=>Math.pow(Math.abs(e),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class qs{constructor(t,e){this.id=qs._eventId++,this._remainderTime=0;const s=Object.assign(qs.getDefaults(),e);this.transport=t,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:dt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const e=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*e),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}qs._eventId=0;class Gh extends qs{constructor(t,e){super(t,e),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(Gh.getDefaults(),e);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},qs.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Or(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ei(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Or(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ei(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const e=this.transport.getTicksAtTime(t);Wi(e,this.time)&&(this._nextTick=this.floatTime+Math.ceil((e-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class _o extends Se{constructor(){const t=Z(_o.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new Rw(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new Le,this._repeatedEvents=new Iw,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new po({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),Ft(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Se.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,e){if(this._loop.get(t)&&e>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),e=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&e%this._ppq!==0&&e%(this._swingTicks*2)!==0){const s=e%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(s*Math.PI)*this._swingAmount;t+=new Ei(this.context,this._swingTicks*2/3).toSeconds()*i}bl(!0),this._timeline.forEachAtTime(e,s=>s.invoke(t)),bl(!1)}schedule(t,e){const s=new qs(this,{callback:t,time:new fn(this.context,e).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(t,e,s,i=1/0){const n=new Gh(this,{callback:t,duration:new Xe(this.context,i).toTicks(),interval:new Xe(this.context,e).toTicks(),time:new fn(this.context,s).toTicks()});return this._addEvent(n,this._repeatedEvents)}scheduleOnce(t,e){const s=new qs(this,{callback:t,once:!0,time:new fn(this.context,e).toTicks()});return this._addEvent(s,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const e=this._scheduledEvents[t.toString()];e.timeline.remove(e.event),e.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,e){return this._scheduledEvents[t.id.toString()]={event:t,timeline:e},e.add(t),t.id}cancel(t=0){const e=this.toTicks(t);return this._timeline.forEachFrom(e,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(e,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(t,e)=>{e=new Ei(this.context,e).toSeconds(),this.emit("start",t,e)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,e){this.context.resume();let s;return st(e)&&(s=this.toTicks(e)),this._clock.start(t,s),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){$e(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new Xe(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new Xe(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new Ei(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),e=this._clock.getTicksAtTime(t);return new Ei(this.context,e).toBarsBeatsSixteenths()}set position(t){const e=this.toTicks(t);this.ticks=e}get seconds(){return this._clock.seconds}set seconds(t){const e=this.now(),s=this._clock.frequency.timeToTicks(t,e);this.ticks=s}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const e=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(e),i=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,e),n=e+i;this.emit("stop",n),this._clock.setTicksAtTime(t,n),this.emit("start",n,this._clock.getSecondsAtTime(n))}else this.emit("ticks",e),this._clock.setTicksAtTime(t,e)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const e=this.now(),s=this.getTicksAtTime(e),i=t-s%t;return this._clock.nextTickTime(i,e)}}syncSignal(t,e){const s=this.now();let i=this.bpm,n=1/(60/i.getValueAtTime(s)/this.PPQ),o=[];if(t.units==="time"){const h=.015625/n,l=new pe(h),c=new qh(-1),u=new pe(h);i.chain(l,c,u),i=u,n=1/n,o=[l,c,u]}e||(t.getValueAtTime(s)!==0?e=t.getValueAtTime(s)/n:e=0);const a=new pe(e);return i.connect(a),a.connect(t._param),o.push(a),this._syncedSignals.push({initial:t.value,nodes:o,signal:t}),t.value=0,this}unsyncSignal(t){for(let e=this._syncedSignals.length-1;e>=0;e--){const s=this._syncedSignals[e];s.signal===t&&(s.nodes.forEach(i=>i.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(e,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),pd(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Yn.mixin(_o);co(r=>{r.transport=new _o({context:r})});uo(r=>{r.transport.dispose()});class Fe extends et{constructor(t){super(t),this.input=void 0,this._state=new Oh("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=dt,this._syncedStop=dt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new hn({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,Ft(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(et.getDefaults(),{mute:!1,onstop:dt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,e,s){let i=Ne(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")Q(Wi(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,e,s);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const n=this._state.get(i);n&&(n.offset=this.toSeconds(Fi(e,0)),n.duration=s?this.toSeconds(s):void 0);const o=this.context.transport.schedule(a=>{this._start(a,e,s)},i);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else hd(this.context),this._start(i,e,s);return this}stop(t){let e=Ne(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(e=this._clampToCurrentTime(e),this._state.getValueAtTime(e)==="started"||st(this._state.getNextState("started",e))){if(this.log("stop",e),!this._synced)this._stop(e);else{const s=this.context.transport.schedule(this._stop.bind(this),e);this._scheduled.push(s)}this._state.cancel(e),this._state.setStateAtTime("stopped",e)}return this}restart(t,e,s){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,e,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,e)=>{if(Wi(e,0)){const s=this._state.get(e);if(s&&s.state==="started"&&s.time!==e){const i=e-this.toSeconds(s.time);let n;s.duration&&(n=this.toSeconds(s.duration)-i),this._start(t,this.toSeconds(s.offset)+i,n)}}},this._syncedStop=t=>{const e=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(e)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=dt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class go extends Hi{constructor(){const t=Z(go.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,an(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new St({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new mt(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Hi.getDefaults(),{url:new mt,loop:!1,loopEnd:0,loopStart:0,onload:dt,onerror:dt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,e,s,i=1){Q(this.buffer.loaded,"buffer is either not set or not loaded");const n=this.toSeconds(t);this._startGain(n,i),this.loop?e=Fi(e,this.loopStart):e=Fi(e,0);let o=Math.max(this.toSeconds(e),0);if(this.loop){const a=this.toSeconds(this.loopEnd)||this.buffer.duration,h=this.toSeconds(this.loopStart),l=a-h;aa(o,a)&&(o=(o-h)%l+h),We(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Or(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(n,o)),st(s)){let a=this.toSeconds(s);a=Math.max(a,0),this.stop(n+a)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function wi(r,t){return qt(this,void 0,void 0,function*(){const e=t/r.context.sampleRate,s=new Fh(1,e,r.context.sampleRate);return new r.constructor(Object.assign(r.get(),{frequency:2/e,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class Xh extends Hi{constructor(){const t=Z(Xh.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],an(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new St({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new St({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),Ft(this,["frequency","detune"])}static getDefaults(){return Object.assign(Hi.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._oscillator.start(e),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Wt extends Fe{constructor(){const t=Z(Wt.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new se({context:this.context,units:"frequency",value:t.frequency}),Ft(this,"frequency"),this.detune=new se({context:this.context,units:"cents",value:t.detune}),Ft(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(Fe.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const e=this.toSeconds(t),s=new Xh({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(e)}_stop(t){const e=this.toSeconds(t);this._oscillator&&this._oscillator.stop(e)}_restart(t){const e=this.toSeconds(t);return this.log("restart",e),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(e),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Wt._periodicWaveCache.find(e=>e.phase===this._phase&&dw(e.partials,this._partials));{const t=Wt._periodicWaveCache.find(e=>e.type===this._type&&e.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const e=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&e)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const s=this._getCachedPeriodicWave();if(st(s)){const{partials:i,wave:n}=s;this._wave=n,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,n]=this._getRealImaginary(t,this._phase),o=this.context.createPeriodicWave(i,n);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Wt._periodicWaveCache.push({imag:n,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),Wt._periodicWaveCache.length>100&&Wt._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){Hs(t,0);let e=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(e=s[1]),this._type!=="custom")t===0?this.type=e:this.type=e+t.toString();else{const i=new Float32Array(t);this._partials.forEach((n,o)=>i[o]=n),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(t,e){let i=2048;const n=new Float32Array(i),o=new Float32Array(i);let a=1;if(t==="custom"){if(a=this._partials.length+1,this._partialCount=this._partials.length,i=a,this._partials.length===0)return[n,o]}else{const h=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);h?(a=parseInt(h[2],10)+1,this._partialCount=parseInt(h[2],10),t=h[1],a=Math.max(a,2),i=a):this._partialCount=0,this._partials=[]}for(let h=1;h<i;++h){const l=2/(h*Math.PI);let c;switch(t){case"sine":c=h<=a?1:0,this._partials[h-1]=c;break;case"square":c=h&1?2*l:0,this._partials[h-1]=c;break;case"sawtooth":c=l*(h&1?1:-1),this._partials[h-1]=c;break;case"triangle":h&1?c=2*(l*l)*(h-1>>1&1?-1:1):c=0,this._partials[h-1]=c;break;case"custom":c=this._partials[h-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}c!==0?(n[h]=-c*Math.sin(e*h),o[h]=c*Math.cos(e*h)):(n[h]=0,o[h]=0)}return[n,o]}_inverseFFT(t,e,s){let i=0;const n=t.length;for(let o=0;o<n;o++)i+=t[o]*Math.cos(o*s)+e[o]*Math.sin(o*s);return i}getInitialValue(){const[t,e]=this._getRealImaginary(this._type,0);let s=0;const i=Math.PI*2,n=32;for(let o=0;o<n;o++)s=Math.max(this._inverseFFT(t,e,o/n*i),s);return pw(-this._inverseFFT(t,e,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Wt._periodicWaveCache=[];class Dw extends qi{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Zn({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Gi extends se{constructor(){const t=Z(Gi.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new pe({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(se.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class mo extends Fe{constructor(){const t=Z(mo.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new Dw({context:this.context}),this._modulationNode=new pe({context:this.context}),this._carrier=new Wt({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Wt({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new Gi({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Ft(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Wt.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class vo extends Fe{constructor(){const t=Z(vo.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new pe({context:this.context,gain:0}),this._carrier=new Wt({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new se({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new Wt({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new Gi({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new Gi({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Ft(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Wt.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Qn extends Fe{constructor(){const t=Z(Qn.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new pe({context:this.context,gain:0}),this._thresh=new Zn({context:this.context,mapping:e=>e<=0?-1:1}),this.width=new se({context:this.context,units:"audioRange",value:t.width}),this._triangle=new Wt({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Ft(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Fe.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class wo extends Fe{constructor(){const t=Z(wo.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new se({context:this.context,units:"frequency",value:t.frequency}),this.detune=new se({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,Ft(this,["frequency","detune"])}static getDefaults(){return Object.assign(Wt.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(e=>e.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(e=>e.stop(t))}_restart(t){this._forEach(e=>e.restart(t))}_forEach(t){for(let e=0;e<this._oscillators.length;e++)t(this._oscillators[e],e)}get type(){return this._type}set type(t){this._type=t,this._forEach(e=>e.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const e=-t/2,s=t/(this._oscillators.length-1);this._forEach((i,n)=>i.detune.value=e+s*n)}}get count(){return this._oscillators.length}set count(t){if(Hs(t,1),this._oscillators.length!==t){this._forEach(e=>e.dispose()),this._oscillators=[];for(let e=0;e<t;e++){const s=new Wt({context:this.context,volume:-6-t*1.1,type:this._type,phase:this._phase+e/t*360,partialCount:this._partialCount,onstop:e===0?()=>this.onstop(this):dt});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[e]=s}this.spread=this._spread,this.state==="started"&&this._forEach(e=>e.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((e,s)=>e.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(e=>e.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(e=>e.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(e=>e.partialCount=t),this._type=this._oscillators[0].type}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class xo extends Fe{constructor(){const t=Z(xo.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Gi({context:this.context,value:2}),this._pulse=new Qn({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Wt({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Ft(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Fe.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Tl={am:mo,fat:wo,fm:vo,oscillator:Wt,pulse:Qn,pwm:xo};class Nr extends Fe{constructor(){const t=Z(Nr.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new se({context:this.context,units:"frequency",value:t.frequency}),this.detune=new se({context:this.context,units:"cents",value:t.detune}),Ft(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(Wt.getDefaults(),vo.getDefaults(),mo.getDefaults(),wo.getDefaults(),Qn.getDefaults(),xo.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(e=>this._sourceType===e)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const e=Tl[t],s=this.now();if(this._oscillator){const i=this._oscillator;i.stop(s),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new e({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let e="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(e=this._oscillator.type),t==="fm"?this.type="fm"+e:t==="am"?this.type="am"+e:t==="fat"?this.type="fat"+e:t==="oscillator"?this.type=e:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,e){return t instanceof Tl[e]}get baseType(){return this._oscillator.baseType}set baseType(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&t!=="pulse"&&t!=="pwm"&&(this._oscillator.baseType=t)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(t){this._getOscType(this._oscillator,"fat")&&_i(t)&&(this._oscillator.count=t)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(t){this._getOscType(this._oscillator,"fat")&&_i(t)&&(this._oscillator.spread=t)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Ss(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return qt(this,arguments,void 0,function*(t=1024){return wi(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function vd(r,t=1/0){const e=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(n){Hs(n,r,t),e.set(this,n)}})}}function Ms(r,t=1/0){const e=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(n){Hs(this.toSeconds(n),r,t),e.set(this,n)}})}}class yo extends Fe{constructor(){const t=Z(yo.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new mt({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(Fe.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:dt,onerror:dt,playbackRate:1,reverse:!1})}load(t){return qt(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=dt){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,e,s){return super.start(t,e,s),this}_start(t,e,s){this._loop?e=Fi(e,this._loopStart):e=Fi(e,0);const i=this.toSeconds(e),n=s;s=Fi(s,Math.max(this._buffer.duration-i,0));let o=this.toSeconds(s);o=o/this._playbackRate,t=this.toSeconds(t);const a=new go({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(t+o),this._state.setStateAtTime("stopped",t+o,{implicitEnd:!0})),this._activeSources.add(a),this._loop&&Ne(n)?a.start(t,i):a.start(t,i,o-this.toSeconds(this.fadeOut))}_stop(t){const e=this.toSeconds(t);this._activeSources.forEach(s=>s.stop(e))}restart(t,e,s){return super.restart(t,e,s),this}_restart(t,e,s){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(t),this._start(t,e,s)}seek(t,e){const s=this.toSeconds(e);if(this._state.getValueAtTime(s)==="started"){const i=this.toSeconds(t);this._stop(s),this._start(s,i)}return this}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&Hs(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&Hs(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(e=>{e.loop=t}),t)){const e=this._state.getNextState("stopped",this.now());e&&this._state.cancel(e.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const e=this.now(),s=this._state.getNextState("stopped",e);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(t,e)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}es([Ms(0)],yo.prototype,"fadeIn",void 0);es([Ms(0)],yo.prototype,"fadeOut",void 0);class Zs extends et{constructor(){const t=Z(Zs.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new se({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(et.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,e){if(Ss(t))return t;{let s;for(s in nr)if(nr[s][e]===t)return s;return t}}_setCurve(t,e,s){if(Ss(s)&&Reflect.has(nr,s)){const i=nr[s];ai(i)?t!=="_decayCurve"&&(this[t]=i[e]):this[t]=i}else if($e(s)&&t!=="_decayCurve")this[t]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,e=1){this.log("triggerAttack",t,e),t=this.toSeconds(t);let i=this.toSeconds(this.attack);const n=this.toSeconds(this.decay),o=this.getValueAtTime(t);if(o>0){const a=1/i;i=(1-o)/a}if(i<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(e,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(e,i,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(e,i,t);else{this._sig.cancelAndHoldAtTime(t);let a=this._attackCurve;for(let h=1;h<a.length;h++)if(a[h-1]<=o&&o<=a[h]){a=this._attackCurve.slice(h),a[0]=o;break}this._sig.setValueCurveAtTime(a,t,i,e)}if(n&&this.sustain<1){const a=e*this.sustain,h=t+i;this.log("decay",h),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(a,n+h):this._sig.exponentialApproachValueAtTime(a,h,n)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const e=this.getValueAtTime(t);if(e>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,t):(Q($e(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,s,e))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,e,s=1){return e=this.toSeconds(e),this.triggerAttack(e,s),this.triggerRelease(e+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,e=0,s=0){return Lh(this,t,e,s),this}asArray(){return qt(this,arguments,void 0,function*(t=1024){const e=t/this.context.sampleRate,s=new Fh(1,e,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),n=i+this.toSeconds(this.release),o=n*.1,a=n+o,h=new this.constructor(Object.assign(this.get(),{attack:e*this.toSeconds(this.attack)/a,decay:e*this.toSeconds(this.decay)/a,release:e*this.toSeconds(this.release)/a,context:s}));return h._sig.toDestination(),h.triggerAttackRelease(e*(i+o)/a,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}es([Ms(0)],Zs.prototype,"attack",void 0);es([Ms(0)],Zs.prototype,"decay",void 0);es([vd(0,1)],Zs.prototype,"sustain",void 0);es([Ms(0)],Zs.prototype,"release",void 0);const nr=(()=>{let t,e;const s=[];for(t=0;t<128;t++)s[t]=Math.sin(t/127*(Math.PI/2));const i=[],n=6.4;for(t=0;t<127;t++){e=t/127;const d=Math.sin(e*(Math.PI*2)*n-Math.PI/2)+1;i[t]=d/10+e*.83}i[127]=1;const o=[],a=5;for(t=0;t<128;t++)o[t]=Math.ceil(t/127*a)/a;const h=[];for(t=0;t<128;t++)e=t/127,h[t]=.5*(1-Math.cos(Math.PI*e));const l=[];for(t=0;t<128;t++){e=t/127;const d=Math.pow(e,3)*4+.2,f=Math.cos(d*Math.PI*2*e);l[t]=Math.abs(f*(1-e))}function c(d){const f=new Array(d.length);for(let p=0;p<d.length;p++)f[p]=1-d[p];return f}function u(d){return d.slice(0).reverse()}return{bounce:{In:c(l),Out:l},cosine:{In:s,Out:u(s)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:c(i)},sine:{In:h,Out:c(h)},step:{In:o,Out:c(o)}}})();class Xi extends et{constructor(){const t=Z(Xi.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=e=>this._original_triggerRelease(e),this._volume=this.output=new hn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Ft(this,"volume")}static getDefaults(){return Object.assign(et.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,e){const s=this["_original_"+t]=this[t];this[t]=(...i)=>{const n=i[e],o=this.context.transport.schedule(a=>{i[e]=a,s.apply(this,i)},n);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,e,s,i){const n=this.toSeconds(s),o=this.toSeconds(e);return this.triggerAttack(t,n,i),this.triggerRelease(n+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class ji extends Xi{constructor(){const t=Z(ji.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(Xi.getDefaults(),{detune:0,onsilence:dt,portamento:0})}triggerAttack(t,e,s=1){this.log("triggerAttack",t,e,s);const i=this.toSeconds(e);return this._triggerEnvelopeAttack(i,s),this.setNote(t,i),this}triggerRelease(t){this.log("triggerRelease",t);const e=this.toSeconds(t);return this._triggerEnvelopeRelease(e),this}setNote(t,e){const s=this.toSeconds(e),i=t instanceof Oe?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const n=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,n,s)}else this.frequency.setValueAtTime(i,s);return this}}es([Ms(0)],ji.prototype,"portamento",void 0);class jh extends Zs{constructor(){super(Z(jh.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new pe({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Lr extends ji{constructor(){const t=Z(Lr.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new Nr(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new jh(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),Ft(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(ji.getDefaults(),{envelope:Object.assign(Cl(Zs.getDefaults(),Object.keys(et.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Cl(Nr.getDefaults(),[...Object.keys(Fe.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,e){if(this.envelope.triggerAttack(t,e),this.oscillator.start(t),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+s+i)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class bo extends Lr{constructor(){const t=Z(bo.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,Ft(this,["oscillator","envelope"])}static getDefaults(){return ki(ji.getDefaults(),Lr.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,e){const s=this.toSeconds(e),i=this.toFrequency(t instanceof Oe?t.toFrequency():t),n=i*this.octaves;return this.oscillator.frequency.setValueAtTime(n,s),this.oscillator.frequency.exponentialRampToValueAtTime(i,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}es([vd(0)],bo.prototype,"octaves",void 0);es([Ms(0)],bo.prototype,"pitchDecay",void 0);const wd=new Set;function Yh(r){wd.add(r)}function xd(r,t){const e=`registerProcessor("${r}", ${t})`;wd.add(e)}const kw=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Yh(kw);const Fw=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Yh(Fw);const Bw=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Yh(Bw);const Ow="feedback-comb-filter",Nw=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;xd(Ow,Nw);class Co extends Xi{constructor(){const t=Z(Co.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const e={};Object.keys(t.urls).forEach(s=>{const i=parseInt(s,10);if(Q(ir(s)||_i(i)&&isFinite(i),`url key is neither a note or midi pitch: ${s}`),ir(s)){const n=new Oe(this.context,s).toMidi();e[n]=t.urls[s]}else _i(i)&&isFinite(i)&&(e[i]=t.urls[i])}),this._buffers=new Hh({urls:e,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(Xi.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:dt,onerror:dt,release:.1,urls:{}})}_findClosest(t){let s=0;for(;s<96;){if(this._buffers.has(t+s))return-s;if(this._buffers.has(t-s))return s;s++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,e,s=1){return this.log("triggerAttack",t,e,s),Array.isArray(t)||(t=[t]),t.forEach(i=>{const n=md(new Oe(this.context,i).toFrequency()),o=Math.round(n),a=n-o,h=this._findClosest(o),l=o-h,c=this._buffers.get(l),u=gd(h+a),d=new go({url:c,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:u}).connect(this.output);d.start(e,0,c.duration/u,s),$e(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(d),d.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),p=f.indexOf(d);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(t,e){return this.log("triggerRelease",t,e),Array.isArray(t)||(t=[t]),t.forEach(s=>{const i=new Oe(this.context,s).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const n=this._activeSources.get(i);e=this.toSeconds(e),n.forEach(o=>{o.stop(e)}),this._activeSources.set(i,[])}}),this}releaseAll(t){const e=this.toSeconds(t);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(e)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,e,s,i=1){const n=this.toSeconds(s);return this.triggerAttack(t,n,i),$e(e)?(Q($e(t),"notes must be an array when duration is array"),t.forEach((o,a)=>{const h=e[Math.min(a,e.length-1)];this.triggerRelease(o,n+this.toSeconds(h))})):this.triggerRelease(t,n+this.toSeconds(e)),this}add(t,e,s){if(Q(ir(t)||isFinite(t),`note must be a pitch or midi: ${t}`),ir(t)){const i=new Oe(this.context,t).toMidi();this._buffers.add(i,e,s)}else this._buffers.add(t,e,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(e=>e.dispose())}),this._activeSources.clear(),this}}es([Ms(0)],Co.prototype,"attack",void 0);es([Ms(0)],Co.prototype,"release",void 0);class $h extends et{constructor(){const t=Z($h.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new St({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",Ft(this,"pan")}static getDefaults(){return Object.assign(et.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const Lw="bit-crusher",Uw=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;xd(Lw,Uw);class zt extends et{constructor(){const t=Z(zt.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new pe({context:this.context}),zt._allSolos.has(this.context)||zt._allSolos.set(this.context,new Set),zt._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(et.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),zt._allSolos.get(this.context).forEach(e=>e._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){zt._soloed.has(this.context)||zt._soloed.set(this.context,new Set),zt._soloed.get(this.context).add(this)}_removeSolo(){zt._soloed.has(this.context)&&zt._soloed.get(this.context).delete(this)}_isSoloed(){return zt._soloed.has(this.context)&&zt._soloed.get(this.context).has(this)}_noSolos(){return!zt._soloed.has(this.context)||zt._soloed.has(this.context)&&zt._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),zt._allSolos.get(this.context).delete(this),this._removeSolo(),this}}zt._allSolos=new Map;zt._soloed=new Map;class Zh extends et{constructor(){const t=Z(Zh.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new $h({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new hn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,Ft(this,["pan","volume"])}static getDefaults(){return Object.assign(et.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Pi extends et{constructor(){const t=Z(Pi.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new zt({solo:t.solo,context:this.context}),this._panVol=this.output=new Zh({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Ft(this,["pan","volume"])}static getDefaults(){return Object.assign(et.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return Pi.buses.has(t)||Pi.buses.set(t,new pe({context:this.context})),Pi.buses.get(t)}send(t,e=0){const s=this._getBus(t),i=new pe({context:this.context,units:"decibels",gain:e});return this.connect(i),i.connect(s),i}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Pi.buses=new Map;Ge().transport;Ge().destination;Ge().destination;Ge().listener;Ge().draw;Ge();class zw extends pu{constructor(e,s,i,n,o,a){super(o,e,s,i,n);bt(this,"targetX");this.body.mass=a,this.canSteer=!0,this.lastError=0,this.hitByPLayer=!1,this.targetX=e.x;const h=o.split("").reduce((l,c)=>l+c.charCodeAt(0),0)%2;this.direction=h===0?-1:1}selectRandomLane(e){const s=e.currentScene.getLanes();s.length>0&&(s.includes(this.targetX+this.direction*e.currentScene.tileWidth)?this.targetX+=this.direction*e.currentScene.tileWidth:s.includes(this.targetX-this.direction*e.currentScene.tileWidth)&&(this.targetX-=this.direction*e.currentScene.tileWidth)),this.direction*=-1}onInitialize(e){super.onInitialize(e),this.selectRandomLane(e);const s=new ar({randomRange:[0,2e3],interval:2e3,repeats:!0,action:()=>{this.selectRandomLane(e)}});e.currentScene.add(s),s.start(),this.on("exitviewport",()=>{const n=this.scene.camera.pos.y+this.scene.engine.screen.resolution.height/2;this.pos.y>n&&this.kill()}),this.on("collisionstart",i=>{if(i.other.owner.carType==="camaro")if(i.other.owner.collider.bounds.overlaps(this.collider.bounds,15))this.scene.addExplosion(this.pos,this.body.mass),this.kill();else{Ae.Crash1.play(Math.random()*.2+.1),this.canSteer=!1,this.hitByPLayer=!0,this.body.applyLinearImpulse(Jo(0,-5e3));const n=new ar({interval:2e3,repeats:!1,action:()=>{this.canSteer=!0}});this.scene.add(n);const o=new ar({interval:3e3,repeats:!1,action:()=>{this.hitByPLayer=!1}});this.scene.add(o),n.start(),o.start()}})}update(e,s){const i=this.targetX-this.pos.x,n=i-this.lastError;this.lastError=i,this.canSteer&&Math.abs(i+n*20)>10&&(Math.sign(i)<0?this.steerLeft():this.steerRight()),super.update(e,s)}handleObstacleCollision(e){this.hitByPLayer&&(this.scene.addExplosion(this.pos,this.body.mass),this.kill())}}const Vw=[null,5,500,1e3,2500,1e5],Ii=[[],[],[],[],[],[]];for(const[r,t]of Object.entries(uu)){const e=t.class;Ii[e]&&Ii[e].push(r)}function Ww(r,t){if(!Ii[r]||Ii[r].length===0)throw new Error(`No cars available for class ${r}`);const e=Ii[r][Math.floor(Math.random()*Ii[r].length)],s=Vw[r];return new zw(t,Yt.Zero,350,700,e,s)}class Hw extends Fp{constructor(){super();bt(this,"isPlaying",!0);bt(this,"lastRowAdded",0);bt(this,"road",[]);this.lanes=[]}async onInitialize(e){this.backgroundColor=we.Gray,this.tileWidth=100,this.tileHeight=100;const s=new Wp("camaro",new Yt(400,0),new Yt(0,-200),200,400);this.player=s,this.add(s),this.speedometer=new Hp(s),this.add(this.speedometer),this.score=new qp(s),this.add(this.score),this.soundConfig=new Gp,this.add(this.soundConfig);const i=100,n=Math.ceil(e.drawHeight/i);for(let o=0;o<n;o++){const a=o*i;for(let h=0;h<9;h++){const l=new Xp(new Yt(h*100,a));this.add(l)}}this.camera.update=(o,a)=>{this.camera.pos=new Yt(400,this.player.pos.y-100)},this.layout=await this.loadLevelLayout("config/level1.txt"),this.addRows(6),e.input.keyboard.on("press",o=>{o.key===bi.S&&e.toggleEffect()}),this.add(new Yp),e.events.on("gameStateChange",o=>{o.gameState===zs.GAMEOVER&&(this.isPlaying=!1)}),e.setGameState(zs.PLAYING)}addRows(e){for(;this.lastRowAdded<e;)this.lastRowAdded++,this.generateRow(this.lastRowAdded)}obstacleLeftScreen(e){this.addRows(e+6)}async loadLevelLayout(e){return(await(await fetch(e)).text()).trim().split(`
`)}generateRow(e){const s=this.layout[e].split(""),i=[];s.forEach((n,o)=>{if(o%2===0){const a=o/2*this.tileWidth,h=-e*this.tileHeight;if(n==="G"){const l=new fu(a,h,this.tileWidth,this.tileHeight,e);this.add(l)}}else{i.push(o/2*this.tileWidth);const a=parseInt(n);if(a>0){const h=o/2*this.tileWidth,l=-e*this.tileHeight;this.add(Ww(a,new Yt(h,l)))}}}),this.road.push(i)}getLanes(e=0){const s=Math.floor(-e/this.tileHeight+.5);return s<this.road.length?this.road[s]:[]}addExplosion(e,s){const i=new jp(s);i.pos=e,this.add(i),this.score.multiplierValue+=BigInt(s)}}class qw extends Rp{constructor(){super({width:800,height:500,maxFps:60,displayMode:Mp.FitScreen,physics:{solver:Bp.Realistic}});bt(this,"isEffectOn",!1);bt(this,"gameState",zs.INIT);this.start(du).then(()=>this.startGame())}onInitialize(e){e.events.on("gameStateChange",s=>{this.gameState=s.gameState})}async startGame(){const e=new Hw;this.add("level",e),await this.goToScene("level")}toggleEffect(){this.isEffectOn=!this.isEffectOn,console.log("effect on",this.isEffectOn),this.events.emit("gameSoundChange",new zp(this.isEffectOn?Ui.EFFECT_ON:Ui.EFFECT_OFF))}setGameState(e,s=!1){console.log("GAMESTATECHANGE: ",e,s),this.events.emit("gameStateChange",new Vp(e,s))}}new qw;
